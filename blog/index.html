<!DOCTYPE html><html lang="en"><head><title data-react-helmet="true">Latest Blog Posts | Bitdefender Research</title><meta data-react-helmet="true" name="description" content="List of all the recent blog posts by Bitdefender&#x27;s Machine Learning &amp; Crypto Research Unit."/><meta data-react-helmet="true" name="keywords" content="machine-learning,research,bitdefender,posts"/><meta data-react-helmet="true" property="og:title" content="Latest Blog Posts | Bitdefender Research"/><meta data-react-helmet="true" property="og:description" content="List of all the recent blog posts by Bitdefender&#x27;s Machine Learning &amp; Crypto Research Unit."/><meta data-react-helmet="true" property="og:site_name" content="https://bit-ml.github.io"/><meta data-react-helmet="true" property="article:tag" content="machine-learning"/><meta data-react-helmet="true" property="article:tag" content="research"/><meta data-react-helmet="true" property="article:tag" content="bitdefender"/><meta data-react-helmet="true" property="article:tag" content="posts"/><meta data-react-helmet="true" property="og:image" content="https://bit-ml.github.iohttps://bit-ml.github.io/tile.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:site" content="@Bitdefender"/><meta data-react-helmet="true" name="twitter:title" content="Latest Blog Posts | Bitdefender Research"/><meta data-react-helmet="true" name="twitter:description" content="List of all the recent blog posts by Bitdefender&#x27;s Machine Learning &amp; Crypto Research Unit."/><meta data-react-helmet="true" name="twitter:image" content="https://bit-ml.github.iohttps://bit-ml.github.io/tile.png"/><meta data-react-helmet="true" itemProp="description" content="List of all the recent blog posts by Bitdefender&#x27;s Machine Learning &amp; Crypto Research Unit."/><meta data-react-helmet="true" itemProp="keywords" content="machine-learning,research,bitdefender,posts"/><meta data-react-helmet="true" itemProp="image" content="https://bit-ml.github.iohttps://bit-ml.github.io/tile.png"/><link rel="preload" as="script" href="https://bit-ml.github.io/bootstrap.627376fc.js"/><link rel="preload" as="script" href="https://bit-ml.github.io/templates/src/pages/Blog.f1b2c635.js"/><link rel="preload" as="script" href="https://bit-ml.github.io/main.6dead43a.js"/><link rel="preload" as="style" href="https://bit-ml.github.io/styles.c960d3bf.css"/><link rel="stylesheet" href="https://bit-ml.github.io/styles.c960d3bf.css"/><meta charSet="UTF-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="apple-touch-icon" href="icon.png"/><style data-styled-components="iHRNpA XnyzJ gDEKjd">
/* sc-component-id: sc-global-552716834 */
html{line-height:1.15;-webkit-text-size-adjust:100%;} body{margin:0;} h1{font-size:2em;margin:0.67em 0;} hr{box-sizing:content-box;height:0;overflow:visible;} pre{font-family:monospace,monospace;font-size:1em;} a{background-color:transparent;-webkit-text-decoration:none;text-decoration:none;} abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;} b,strong{font-weight:bolder;} code,kbd,samp{font-family:monospace,monospace;font-size:1em;} small{font-size:80%;} sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;} sub{bottom:-0.25em;} sup{top:-0.5em;} figure{margin:0;} img{border-style:none;max-width:100%;} button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;} button,input{overflow:visible;} button,select{text-transform:none;} button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button;} button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;} button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText;} fieldset{padding:0.35em 0.75em 0.625em;} legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;} progress{vertical-align:baseline;} textarea{overflow:auto;} [type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;} [type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto;} [type="search"]{-webkit-appearance:textfield;outline-offset:-2px;} [type="search"]::-webkit-search-decoration{-webkit-appearance:none;} ::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;} details{display:block;} summary{display:list-item;} template{display:none;} [hidden]{display:none;} html{font-size:19px;box-sizing:border-box;} *,*::before,*::after{box-sizing:inherit;} body{font-family:"Roboto",Helvetica,Arial,sans-serif;line-height:1.78rem;padding:0;background:#FFF;} h1{display:block;margin:0.67em 0;} .math-display{overflow-x:auto;} @media (min-width:74.6875em){.math-display{overflow-x:initial;}} .remark-highlight{font-size:14px;} @media (min-width:74.6875em){.remark-highlight{font-size:16px;}} p.hint.tip,p.hint.error,p.hint.warn{-webkit-letter-spacing:0;-moz-letter-spacing:0;-ms-letter-spacing:0;letter-spacing:0;box-sizing:border-box;font-size:inherit;line-height:1.6rem;word-spacing:0.05rem;background-color:rgba(238,238,238,0.5);border-bottom-right-radius:2px;border-top-right-radius:2px;padding:8px 12px 8px 24px;margin-bottom:16px;position:relative;} p.hint.tip:before,p.hint.error:before,p.hint.warn:before{border-radius:100%;color:#fff;content:'!';font-size:14px;font-weight:700;left:-12px;line-height:20px;position:absolute;height:20px;width:20px;text-align:center;top:12px;} p.hint.tip{border-left:4px solid #27ab83;} p.hint.tip:before{display:none;} p.hint.warn{border-left:4px solid #f0b429;} p.hint.warn:before{background-color:#f0b429;} p.hint.error{border-left:4px solid #ef4e4e;} p.hint.error:before{background-color:#ef4e4e;content:'×';} .content table{border-collapse:collapse;border-spacing:0;empty-cells:show;border:1px solid #cbcbcb;font-size:12px;line-height:1.0rem;} @media (min-width:74.6875em){.content table{font-size:19px;line-height:1.78rem;}} .content caption{color:#000;font:italic 85%/1 arial,sans-serif;padding:1em 0;text-align:center;} .content td,.content th{border-left:1px solid #cbcbcb;border-width:0 0 0 1px;font-size:inherit;margin:0;overflow:visible;padding:0.5em 1em;} .content thead{background-color:#e0e0e0;color:#000;text-align:left;vertical-align:bottom;} .content td{background-color:#f2f2f2;} .content tr:nth-child(2n-1) td{background-color:transparent;} .content td{border-bottom:1px solid #cbcbcb;} .content tbody > tr:last-child > td{border-bottom-width:0;} .content td,.content th{border-width:0 0 1px 0;border-bottom:1px solid #cbcbcb;} .content tbody > tr:last-child > td{border-bottom-width:0;}
/* sc-component-id: Navigation__Nav-sc-qabwmo-0 */
.gDEKjd{width:100%;background:transparent;padding:0 1rem;font-family:"Roboto",Helvetica,Arial,sans-serif;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;} .gDEKjd a{padding:0.5rem 0 0.25rem 0;font-style:normal;font-weight:500;line-height:23px;font-size:14px;text-align:right;text-transform:uppercase;color:#333;} .gDEKjd a:last-child{padding:0.5rem;padding-right:0;} @media (min-width:74.6875em){.gDEKjd{padding:0 5rem;-webkit-box-pack:end;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end;}.gDEKjd a{padding:0.5rem 1rem 0.25rem 1rem;}}
/* sc-component-id: Featured__StyledButtonBack-sc-xm4c49-5 */
.iHRNpA{position:absolute;top:50%;left:-5px;margin-left:10px;margin-top:-20px;width:40px;height:40px;padding:10px;background:none;border:none;outline:none;border-radius:40px;} @media (min-width:46.0625em){.iHRNpA{left:10px;width:70px;height:70px;padding:15px;}} @media (min-width:64.0625em){.iHRNpA{left:10px;width:70px;height:70px;padding:15px;}}
/* sc-component-id: Featured__StyledButtonNext-sc-xm4c49-6 */
.XnyzJ{position:absolute;top:50%;right:-5px;margin-right:10px;margin-top:-20px;width:40px;height:40px;padding:10px;background:none;border:none;outline:none;border-radius:40px;} @media (min-width:46.0625em){.XnyzJ{right:10px;width:70px;height:70px;padding:15px;}} @media (min-width:64.0625em){.XnyzJ{right:10px;width:70px;height:70px;padding:15px;}}</style><style data-styled-components="gAlnrj bLkZHz isDZEF">
/* sc-component-id: Blog__BlogWrapper-sc-1owziq9-0 */
.gAlnrj{margin:0 auto;max-width:720px;padding:0 1rem;} @media (min-width:74.6875em){.gAlnrj{padding-left:0 0 0 100px;}}
/* sc-component-id: Blog__Heading-sc-1owziq9-1 */
.bLkZHz{font-family:'Exo 2',sans-serif;margin:4rem 0;font-style:normal;font-weight:700;line-height:3rem;font-size:2.2rem;-webkit-letter-spacing:0.03em;-moz-letter-spacing:0.03em;-ms-letter-spacing:0.03em;letter-spacing:0.03em;color:#333333;}
/* sc-component-id: Blog__BlogList-sc-1owziq9-2 */
.isDZEF{padding-left:0;} .isDZEF>li{font-family:"Roboto",Helvetica,Arial,sans-serif;font-style:normal;font-weight:500;font-size:1.2rem;-webkit-letter-spacing:0.03em;-moz-letter-spacing:0.03em;-ms-letter-spacing:0.03em;letter-spacing:0.03em;list-style:none;margin-bottom:1rem;} .isDZEF>li> a{color:#333;} .isDZEF>li> a:hover{color:#E6212B;}</style></head><body><div id="root"><div class="content" data-reactroot=""><div><header><nav class="Navigation__Nav-sc-qabwmo-0 gDEKjd"><a href="https://bit-ml.github.io/">Home</a><a href="https://bit-ml.github.io/#research">Research</a><a href="https://bit-ml.github.io/#teams">Team</a><a href="https://bit-ml.github.io/teaching/lectures-and-courses">Teaching</a></nav></header><main><section class="Blog__BlogWrapper-sc-1owziq9-0 gAlnrj"><h1 class="Blog__Heading-sc-1owziq9-1 bLkZHz">Recent Posts</h1><ul class="Blog__BlogList-sc-1owziq9-2 isDZEF"><li><a href="https://bit-ml.github.io/blog/post/large-language-models-for-malware-analysis/">Large Language Models for Malware Analysis</a></li><li><a href="https://bit-ml.github.io/blog/post/pretrained-atari-agents/">:joystick: Pretrained Atari Agents</a></li><li><a href="https://bit-ml.github.io/blog/post/bgv-fully-homomorphic-encryption-scheme-in-python/">The BGV fully homomorphic encryption scheme</a></li><li><a href="https://bit-ml.github.io/blog/post/bitdefender_at_eeml2019/">Bitdefender at EEML2019</a></li><li><a href="https://bit-ml.github.io/blog/post/homomorphic-encryption-toy-implementation-in-python/">Homomorphic Encryption: a Toy Implementation in Python</a></li><li><a href="https://bit-ml.github.io/blog/post/private-set-intersection-an-implementation-in-python/">Private Set Intersection from Homomorphic Encryption: A Python Implementation</a></li><li><a href="https://bit-ml.github.io/blog/post/recurrent-space-time-graph-neural-nets/">Recurrent Space-time Graph Neural Network</a></li><li><a href="https://bit-ml.github.io/blog/post/bitdefender_at_tmlss2018/">Bitdefender at TMLSS2018</a></li></ul></section></main></div></div></div><script type="text/javascript">window.__CSS_CHUNKS__ = {"main":"https://bit-ml.github.io/styles.c960d3bf.css"}</script><script type="text/javascript">
    window.__routeInfo = {"path":"blog","templateID":1,"sharedPropsHashes":{"posts":"Gonlu"},"localProps":null,"allProps":{"posts":[{"data":{"slug":"large-language-models-for-malware-analysis","authors":"Florin Brad, Ioana Pintilie, Marius Dragoi, Dragos Tantaru","categories":"blog","featured_img":"/galleries/asm_llm2024/markus-spiske-uPXs5Vx5bIg-unsplash-min.jpeg","date":"January-12-2024","title":"Large Language Models for Malware Analysis","id":0},"messages":[],"history":["./content/collections/posts/asm_llm2024.md","content/collections/posts/asm_llm2024.html"],"cwd":"/Users/fbrad/bit/bit-ml","contents":"<h1>Large Language Models for Malware Analysis</h1>\n<p>Large Language Models (LLMs) took the world by storm in 2023, revolutionizing the way people search and generate text content. LLMs for code have also made inroads in helping people understand code or write code based on requests in natural language. For instance, translating requests to <a href=\"https://yale-lily.github.io/spider\">SQL queries</a> has rapidly advanced since the advent of GPT4.</p>\n<p>Most popular code LLMs focus on generating or understanding high-level programming languages such as Python, C++, Java etc. <a href=\"https://arxiv.org/abs/2308.12950\">[1]</a>,<a href=\"https://arxiv.org/abs/2305.06161\">[2]</a>,<a href=\"https://arxiv.org/abs/2306.08568\">[3]</a>,<a href=\"https://arxiv.org/abs/2308.07124\">[4]</a>. However code LLMs tailored to malware analysis should be adapted to better understand assembly code as well. Recent works also explore this avenue <a href=\"https://arxiv.org/abs/2312.09601\">[5]</a>,<a href=\"https://arxiv.org/abs/2310.16853\">[6]</a>,<a href=\"https://arxiv.org/abs/2311.13721\">[7]</a>.</p>\n<p>To this end we start from existing general-purpose LLMs such as <a href=\"https://huggingface.co/mosaicml/mpt-7b\">MPT7B</a>, which has been trained on both English text and code. We adapt them to x86-64 assembly data, by finetuning them using the Causal Language Modeling task and the <a href=\"https://arxiv.org/abs/2106.09685\">LoRA</a> method. We then inspect these models to evaluate the quality of their embeddings and their generation capabilities. We call these models <strong>asmLLMs</strong>.</p>\n<h2>asmLLMs for feature extraction</h2>\n<p>Features learned by pretrained models are crucial for downstream tasks such as anomaly detection, search or classification. Most LLMs (either general purpose or code-based) have little assembly data in their pretraining corpus relative to the entire corpus. Finetuning LLMs on more assembly data should then result in better features. To test this, we developed several downstream classification tasks, where the input is assembly code. Classifiers trained on features from the <strong>asmLLM</strong> should then outperform classifiers trained on features from base LLMs.</p>\n<p>To build examples for our tasks, we took C++ solutions from the code contest dataset <a href=\"https://arxiv.org/pdf/2105.12655v2.pdf\">CodeNet 1000</a> and converted them to assembly. The three classification tasks are:</p>\n<ul>\n<li><em>Complexity prediction</em>, where the input is the assembly corresponding to a C++ function, and the label is the <a href=\"https://manpages.ubuntu.com/manpages/focal/man1/pmccabe.1.html\">cyclomatic complexity</a> of that function (13 classes)</li>\n<li><em>Problem identification</em>, where the input is the assembly corresponding to a C++ submission to a code contest, and the label is the ID of the contest problem (20 classes)</li>\n<li><em>Accuracy prediction</em>, where the input is the assembly corresponding to a C++ submission to a code contest, and the label is the score achieved by the submission on the benchmark. Instead of predicting the score, the model predicts a class from a set of 5 classes, where each class corresponds to different bins of performance: [0-20) score, [20-40) score, ..., [80-100].</li>\n</ul>\n<p><img src=\"/galleries/asm_llm2024/asmllm_downstream.png\" alt=\"asm_down\"></p>\n<p>The asmLLM in <a href=\"asm_down\">Figure 1</a> is an MPT7B-base finetuned on assembly data using sequences of length 2K. To embed an input, it is first split into chunks of length 2K or 4K tokens. The input embedding is then computed as the average over these chunk embeddings. Results show that classifiers benefit from features from asmLLMs, especially when using larger contexts (4K tokens vs 2K tokens).</p>\n<h2>asmLLMs for generative tasks</h2>\n<h3>Code repair</h3>\n<p>While <strong>asmLLMs</strong> can be used as feature extractors, we are also interested in generative settings such as code-to-code or code-to-text. A typical code-to-code task is code repair, where given a faulty piece of code, the correct version of the code is produced. To test this on assembly, we generate a synthetic dataset where we alter a percentage of the assembly tokens, by modifying instructions (e.g. <strong>mov</strong> -> <strong>lea</strong>), registers (<strong>rax</strong> -> <strong>rsp</strong>) or offsets. We then perform instruction tuning on the asmLLM using (altered assembly, correct assembly) pairs and a 4K token context.</p>\n<p><img src=\"/galleries/asm_llm2024/asmllm_code_repair.png\" alt=\"asm_repair\"></p>\n<p>We notice in Figure 2 that the instruction tuned asmLLM model can correctly predict altered instructions (<strong>movzx</strong> -> <strong>mov</strong>) or registers (<strong>ch</strong>-><strong>rax</strong>).</p>\n<h3>Code summarization</h3>\n<p>To inspect the code of executable files, malware analysts use a wide array of tools, including powerful decompilers and disassemblers. While top performing LLMs such as GPT-4 are good at explaining high-level languages such as Python or C++, they are less likely to get the big picture of assembly code and instead describe it line by line usually. We are thus interested in the code summarization task, where explaining large chunks of assembly code can help analysts delve into binaries more efficiently.</p>\n<p>For this task, we generate a synthetic instruction tuning dataset called OSS-ASM, which consists of (assembly code, explanation) pairs. We first use the OSS-instruct<a href=\"https://arxiv.org/pdf/2312.02120.pdf\">[8]</a> method to produce (C++ code, explanation) pairs by seeding LLMs with assembly snippets from various technical resources. We then convert the C++ code to x86-64 assembly.</p>\n<table>\n<thead>\n<tr>\n<th>Model</th>\n<th>Rouge-L</th>\n<th>BLEU</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>GPT-3.5 turbo</td>\n<td>23.22</td>\n<td>2.85</td>\n</tr>\n<tr>\n<td>GPT-4</td>\n<td>26.56</td>\n<td>4.03</td>\n</tr>\n<tr>\n<td><a href=\"https://huggingface.co/mosaicml/$mpt-7b\">MPT7B-base</a> + instruction tuning OSS-ASM</td>\n<td>33.22</td>\n<td>11.89</td>\n</tr>\n<tr>\n<td><a href=\"https://huggingface.co/mosaicml/mpt-7b-instruct\">MPT7B-instruct</a> + instruction tuning OSS-ASM</td>\n<td>33.92</td>\n<td>12.29</td>\n</tr>\n<tr>\n<td><strong>asmLLM</strong> + instruction tuning OSS-ASM</td>\n<td><strong>35.72</strong></td>\n<td><strong>13.65</strong></td>\n</tr>\n</tbody>\n</table>\n<p>The <strong>asmLLM</strong> model in the table above is a MPT7B-base, finetuned on a subset of 500M tokens of x86-64 assembly, with LoRA rank r=64 and context length L=4096 tokens. GPT-3.5 and GPT-4 are tested in a zero-shot setup, while the other three models are instruction tuned on the OSS-ASM dataset. Results show that adapting base LLMs on assembly data improves the performance on downstream generative tasks such as code summarization.</p>\n<p>Along with results in Figure 1, this highlights the importance of pretraining LLMs on domain-specific data, particularly when dealing with languages that are less represented in large training sets, such as assembly.</p>\n<p><strong>asmLLMs</strong> can become an essential item in a malware analysis toolkit, accelerating the inspection of binaries and improving the threat response time. Future work involves learning across different computer architectures, increasing the diversity of the instruction tuning data and tackling obfuscated code.</p>\n<h2>References</h2>\n<ol>\n<li>Code Llama: Open Foundation Models for Code, <a href=\"https://arxiv.org/abs/2308.12950\">https://arxiv.org/abs/2308.12950</a></li>\n<li>StarCoder: may the source be with you!, <a href=\"https://arxiv.org/abs/2305.06161\">https://arxiv.org/abs/2305.06161</a></li>\n<li>WizardCoder: Empowering Code Large Language Models with Evol-Instruct, <a href=\"https://arxiv.org/abs/2306.08568\">https://arxiv.org/abs/2306.08568</a></li>\n<li>OctoPack: Instruction Tuning Code Large Language Models, <a href=\"https://arxiv.org/abs/2308.07124\">https://arxiv.org/abs/2308.07124</a></li>\n<li>Binary Code Summarization: Benchmarking ChatGPT/GPT-4 and Other Large Language Models, <a href=\"https://arxiv.org/abs/2312.09601\">https://arxiv.org/abs/2312.09601</a></li>\n<li>CP-BCS: Binary Code Summarization Guided by Control Flow Graph and Pseudo Code, <a href=\"https://arxiv.org/abs/2310.16853\">https://arxiv.org/abs/2310.16853</a>,</li>\n<li>Nova+: Generative Language Models for Binaries, <a href=\"https://arxiv.org/abs/2311.13721\">https://arxiv.org/abs/2311.13721</a></li>\n<li>Magicoder: Source Code Is All You Need, <a href=\"https://arxiv.org/abs/2312.02120\">https://arxiv.org/abs/2312.02120</a></li>\n</ol>\n<h2>Credits</h2>\n<p>Photo by <a href=\"https://unsplash.com/@markusspiske?utm_content=creditCopyText&#x26;utm_medium=referral&#x26;utm_source=unsplash\">Markus Spiske</a> on <a href=\"https://unsplash.com/photos/turned-on-laptop-on-table-uPXs5Vx5bIg?utm_content=creditCopyText&#x26;utm_medium=referral&#x26;utm_source=unsplash\">Unsplash</a>.</p>\n"},{"data":{"slug":"pretrained-atari-agents","authors":"Florin Gogianu","categories":"blog, reinforcement-learning","featured_img":"/galleries/atari_agents_2022/collage.png","date":"May-05-2022","title":":joystick: Pretrained Atari Agents","id":1},"messages":[],"history":["./content/collections/posts/atari_agents_2022.md","content/collections/posts/atari_agents_2022.html"],"cwd":"/Users/fbrad/bit/bit-ml","contents":"<h1>🕹️ Pretrained Atari Agents</h1>\n<p>Releasing trained models in computer vision and natural language processing has been a major source of progress for the research in these fields and a significant catalyst for the adaption of deep learning models in the industry. By comparison, RL agents pretrained on otherwise resource and time intensive benchmarks such as Arcade Learning Environment are rather hard to come by.</p>\n<p>Today, our research group within Bitdefender is making available over 2️⃣5️⃣,0️⃣0️⃣0️⃣ agents trained on 60 games in the Arcade Learning Environment. We hope the diversity and the quality of these trained models will help spur new research in multi-task and imitation learning and contribute to the state of reproducibility in deep reinforcement learning.</p>\n<p>The performance of these agents closely matches figures published in the literature and have been used as strong baselines in published and unpublished work. The agents included in this release are Munchausen-DQN and Adam-optimised DQN that compare favourably with more complex agents as well as a C51 agent whose performance matches or exceeds the results reported in the paper that introduced it. We provide three independent training runs for each agent-game combination with the exception of on agent for which we only provide two seeds. We plan to continue releasing new models.</p>\n<p>Another feature of this release is the extreme ease of experimenting with the agents. No RL frameworks are required, the dependency list is kept to a minimum, the code is self-contained and takes just two files, making it a breeze to quickly load a checkpoint, visualize the gameplay at high resolution and record it. The simplicity of the code also makes it possible to easily modify the scripts for your own purposes. Converting these models for use in other deep learning frameworks should also be possible.</p>\n<p>We encourage you coming with suggestions of how to make this repository of trained models better and more useful. Relevant links:</p>\n<ul>\n<li><img src=\"/galleries/atari_agents_2022/octocat.svg\" alt=\"octocat\">   <a href=\"https://github.com/floringogianu/atari-agents#trained-atari-agents\">floringogianu/atari-agents</a></li>\n<li>📂   <a href=\"https://share.bitdefender.com/s/qCF7jFxkgx2qJeT\">download models</a></li>\n</ul>\n<h2>How we trained the agents</h2>\n<p>A major reason for deciding to publish these models is the sheer amount of time required to run DQN-style algorithms on the Atari benchmark. This is especially difficult for small labs.</p>\n<p>For this release we used \"only\" 20 to 40 GPUs (a wide assortment ranging from GTX Titan to newer RTX consumer models) from our cluster at Bitdefender, for a combined running time of about two months for learning all the agents. Considering  a full run on ALE requires 3 seeds <span><span><span>×\\times</span><span aria-hidden=\"true\"><span><span></span><span>×</span></span></span></span></span> 60 games and a single DQN-style agent takes a bit over one week this might seem a bit surprising. What made this possible is that we figured out early that you could launch three to four DQN processes on a single GPU provided the replay buffer is stored in the system RAM. The penalty incurred in terms of wall clock times is easily offset by parallelization in this case.</p>\n<p>This is one of the reason our agents have been trained using our own PyTorch implementations and while the code used is not readily available we consider publishing it if there is demand for it.</p>\n<h3>A word on training and evaluation protocols</h3>\n<p>There are two common training and evaluation protocols encountered in the literature. We named them <code>classic</code> and <code>modern</code> across this project:</p>\n<ul>\n<li><code>classic</code>: it originates from (Mnih, 2015)<sup id=\"user-content-fnref-2\"><a href=\"#fn-2\">2</a></sup> Nature paper and it mostly appears in DeepMind papers.</li>\n<li><code>modern</code>: it originates from (Machado, 2017)<sup id=\"user-content-fnref-1\"><a href=\"#fn-1\">1</a></sup> and a variation of it was adopted by Dopamine<sup id=\"user-content-fnref-6\"><a href=\"#fn-6\">6</a></sup>. Since then it started to show up more often in recent papers.</li>\n</ul>\n<p>The main two differences between the two are the way stochasticity is induced in the environment and how the loss of a life is treated.</p>\n<p>The current crop of agents is summarized below.</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Algorithm</th>\n<th>Protocol</th>\n<th align=\"center\">Games</th>\n<th align=\"center\">Seeds</th>\n<th align=\"left\">Observations</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\"><strong>DQN</strong></td>\n<td><code>modern</code></td>\n<td align=\"center\">60</td>\n<td align=\"center\">3</td>\n<td align=\"left\">DQN agent using the settings from <a href=\"https://github.com/google/dopamine/blob/master/dopamine/jax/agents/dqn/configs/dqn.gin\">dopamine</a>. It's optimised with Adam and uses MSE instead of Huber loss. <strong>A surprisingly strong agent on this protocol</strong>.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>M-DQN</strong></td>\n<td><code>modern</code></td>\n<td align=\"center\">60</td>\n<td align=\"center\">3</td>\n<td align=\"left\">DQN above but using the <strong>Munchausen trick</strong><sup id=\"user-content-fnref-7\"><a href=\"#fn-7\">7</a></sup>. Even stronger performance.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>C51</strong></td>\n<td><code>classic</code></td>\n<td align=\"center\">28/57</td>\n<td align=\"center\">3</td>\n<td align=\"left\">Closely follows the original paper<sup id=\"user-content-fnref-3\"><a href=\"#fn-3\">3</a></sup>.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>DQN Adam</strong></td>\n<td><code>classic</code></td>\n<td align=\"center\">28/57</td>\n<td align=\"center\">2</td>\n<td align=\"left\">A DQN agent trained according to the Rainbow paper<sup id=\"user-content-fnref-4\"><a href=\"#fn-4\">4</a></sup>. The exact settings and plots can be found in our paper<sup id=\"user-content-fnref-5\"><a href=\"#fn-5\">5</a></sup>.</td>\n</tr>\n</tbody>\n</table>\n<p>Right off-the bat you can notice that on the <code>classic</code> protocol there are only 28 games out of the usual 57. We trained the two agents on this protocol over one year ago using the now deprecated <code>atari-py</code> project which officially provided the ALE Python bindings in OpenAI's Gym. Unfortunately the package came with a large number of ROMs that are not supported by the current, official, <a href=\"https://github.com/mgbellemare/Arcade-Learning-Environment\">ale-py</a> library. The agents trained on the <code>modern</code> protocol (as well as the code we provide for visualising agents) all use the new <code>ale-py</code>. Therefore we decided against providing support for the older library event if it meant dropping half of the trained models. A great resource for reading about this issue is Jesse's Farebrother <a href=\"https://brosa.ca/blog/ale-release-v0.7/#rom-management\">ALE v0.7 release notes</a>. Importantly, we found out about the issue while checking the performance of the trained models on the new <code>ale-py</code> back-end and we provide plots showing the remaining 28 agents perform as expected (<a href=\"https://github.com/floringogianu/atari-agents/blob/main/imgs/c51_g28_confirmation.png\">C51_classic</a>, <a href=\"https://github.com/floringogianu/atari-agents/blob/main/imgs/dqn_g28_confirmation.png\">DQN_classic</a>).</p>\n<h2>How many checkpoints?</h2>\n<p>An agent trained on 200M frames usually produces 200 checkpoints times the number of training seeds. In order not to make the download size overly large <strong>we only include 51 checkpoints per training run</strong>. These are sampled geometrically, with denser checkpoints towards the end of the training. This results in the last 20 checkpoints of the full 200 (last 10% of the training run) and then sparser checkpoints towards the beginning of the run, with only 10 out of 51 from the first half. It looks a bit like this:</p>\n<p><img src=\"/galleries/atari_agents_2022/sampling.png\" alt=\"checkpoint sampling\"></p>\n<p>Note it's not mandatory the best performing checkpoint is included since on some combinations of algorithms and agents the peak performance occurs earlier in training. However this sampling should characterize fairly well the performance of an agent most of the time.</p>\n<p>❗✋ If <a href=\"https://github.com/floringogianu/atari-agents/issues\">requested</a>, we can provide the full list of checkpoints for a given agent.</p>\n<p>Agents have been trained using PyTorch and the models are stored as compressed <a href=\"https://pytorch.org/tutorials/recipes/recipes/what_is_state_dict.html\">state_dict</a> pickle files. Since the networks used on ALE are fairly simple these could easily be converted for use in other deep learning frameworks.</p>\n<h2>Just how well trained are these agents?</h2>\n<p>Our PyTorch implementation of DQN trained using Adam on the <code>modern</code> protocol compares favourable to the exact same agent trained using Dopamine. The plots below have been generated using the tools provided by <a href=\"https://github.com/google-research/rliable\">rliable</a>.</p>\n<p><img src=\"/galleries/atari_agents_2022/rliable_comparison.png\" alt=\"dopamine_vs_pytorch\"></p>\n<p>A detailed discussion about the performance of DQN + Adam and C51 trained on the <code>classic</code> protocol can be found in our paper<sup id=\"user-content-fnref-5\"><a href=\"#fn-5\">5</a></sup>, where we used these checkpoints as baselines.</p>\n<h2>References</h2>\n<div>\n<hr>\n<ol>\n<li id=\"user-content-fn-2\"><a href=\"https://www.nature.com/articles/nature14236\">Mnih, et al. 2015, _Human-level control through deep reinforcement learning</a><a href=\"#fnref-2\">↩</a></li>\n<li id=\"user-content-fn-1\"><a href=\"https://arxiv.org/abs/1709.06009\">Machado, et al. 2017, <em>Revisiting the Arcade Learning Environment...</em></a><a href=\"#fnref-1\">↩</a></li>\n<li id=\"user-content-fn-6\"><a href=\"http://arxiv.org/abs/1812.06110\">Castro, et al. 2018, <em>Dopamine: A Research Framework for Deep RL</em></a><a href=\"#fnref-6\">↩</a></li>\n<li id=\"user-content-fn-4\"><a href=\"https://arxiv.org/abs/1710.02298\">Hessel, et al. 2017, <em>Combining Improvements in Deep RL</em></a><a href=\"#fnref-4\">↩</a></li>\n<li id=\"user-content-fn-5\"><a href=\"https://www.semanticscholar.org/paper/Spectral-Normalisation-for-Deep-Reinforcement-an-Gogianu-Berariu/cf04c05f69022f71b60c7b7252af94f11cad5ef1\">Gogianu, et al. 2021, <em>Spectral Normalisation...</em></a><a href=\"#fnref-5\">↩</a></li>\n<li id=\"user-content-fn-3\"><a href=\"http://proceedings.mlr.press/v70/bellemare17a.html\">Bellemare, et al. 2017, <em>A distributional perspective...</em></a><a href=\"#fnref-3\">↩</a></li>\n<li id=\"user-content-fn-7\"><a href=\"https://arxiv.org/abs/2007.14430\">Vieillard, et al. 2020, <em>Munchausen Reinforcement Learning</em></a><a href=\"#fnref-7\">↩</a></li>\n</ol>\n</div>\n"},{"data":{"slug":"bgv-fully-homomorphic-encryption-scheme-in-python","authors":"Dacian Stroia","categories":"blog","featured_img":"/galleries/bgv_scheme2023/lock.jpg","date":"June-29-2023","title":"The BGV fully homomorphic encryption scheme","id":2},"messages":[],"history":["./content/collections/posts/bgv_scheme2023.md","content/collections/posts/bgv_scheme2023.html"],"cwd":"/Users/fbrad/bit/bit-ml","contents":"<h1>The BGV fully homomorphic encryption scheme</h1>\n<p>This is a sister blogpost to the <a href=\"https://bit-ml.github.io/blog/post/homomorphic-encryption-toy-implementation-in-python/\">previous one about a similar scheme (BFV)</a> and it's part of the series that covers fully homomorphic encryption techniques and applications.</p>\n<h2>Introduction</h2>\n<p><span><span><span>\\gdef\\can #1{\\|#1\\|^{\\text{can}}}</span><span aria-hidden=\"true\"></span></span></span></p>\n<p>In this blogpost we will focus on the encryption, decryption, relinearization and the noise analysis of the <a href=\"https://eprint.iacr.org/2011/277.pdf\">Brakerski, Gentry, Vaikuntanathan (BGV)</a> fully homomorphic encryption scheme. A Python implementation of the aforementioned will be provided.</p>\n<p>DISCLAIMER: This toy implementation is not meant to be secure or optimized\nfor efficiency. It's for educational purposes only, and for us to better understand the inner workings.</p>\n<p><strong>What to expect from this blogpost?</strong></p>\n<ol>\n<li>We briefly describe the motivations of fully homomorphic encryption.</li>\n<li>We present the BGV scheme.</li>\n<li>We offer a <a href=\"https://github.com/zademn/EverythingCrypto/blob/master/E3-Homomorphic-Encryption/BGV.ipynb\">Python implementation</a> for the BGV scheme, for educational purposes.</li>\n</ol>\n<p>Now, let's make a short, informal, tour before starting.\n<a href=\"https://en.wikipedia.org/wiki/Homomorphic_encryption\"><strong>Fully homomorphic encryption</strong></a> (FHE) allows us to perform computation on encrypted data. While there are a few cryptographic schemes to achieve this, in this blogpost we explore the <a href=\"https://eprint.iacr.org/2011/277.pdf\"><strong>BGV scheme</strong></a>.</p>\n<p>Firstly, this scheme allows us to encrypt messages into ciphertexts. Intuitively, a message is hidden in a ciphertext if there is no way to get to retrieve the original message from its encryption. To an attacker that sees a ciphertext, that ciphertext should look like \"random garbage\". In order to achieve this we hide the message by \"masking\" it with some noise. We say it's <em>hard</em> for an attacker to retrieve a message from its ciphertext if doing so is at least as hard as solving a computationally unfeasable problem. The problem the security of the BGV scheme is based on is called the <a href=\"https://en.wikipedia.org/wiki/Ring_learning_with_errors\"><strong>Ring Learning with Errors problem</strong></a>.</p>\n<p>Secondly, the scheme allows us to perform arithmetic operations (additions, multiplications) using noisy ciphertexts. However, we will encounter some problems along the way, such as the noise increasing after computations, or the size of the resulting ciphertext increasing. We'll see how to handle these using <strong>modulus switching</strong> (for the former) and <strong>relinearization</strong> (for the latter).</p>\n<p>This post will get a bit mathematical, so before starting we introduce some notation. Any other notation will be defined when introduced.</p>\n<p>Notations:</p>\n<ul>\n<li><span><span><span>m,m′,m∗m, m', m^*</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span></span></span></span></span> - messages.</li>\n<li><span><span><span>c,c′,c∗c, c', c^*</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span></span></span></span></span> - ciphertexts. If ciphertexts have more components, we denote the components with indices: <span><span><span>c=(c0,c1)c = (c_0, c_1)</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span></li>\n<li><span><span><span>λ\\lambda</span><span aria-hidden=\"true\"><span><span></span><span>λ</span></span></span></span></span> - Security parameter.</li>\n<li><span><span><span>Zq\\mathbb Z_q</span><span aria-hidden=\"true\"><span><span></span><span><span>Z</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> - the set of integers from <span><span><span>(−q/2,q/2](-q / 2, q / 2]</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>−</span><span>q</span><span>/</span><span>2</span><span>,</span><span></span><span>q</span><span>/</span><span>2</span><span>]</span></span></span></span></span></li>\n<li><span><span><span>RR</span><span aria-hidden=\"true\"><span><span></span><span>R</span></span></span></span></span> - Ring.\n<ul>\n<li>Ex: <span><span><span>Z\\mathbb Z</span><span aria-hidden=\"true\"><span><span></span><span>Z</span></span></span></span></span> - the integers.</li>\n<li>Ex: <span><span><span>Z[X]/(Xn+1)\\mathbb Z[X] / (X^n + 1)</span><span aria-hidden=\"true\"><span><span></span><span>Z</span><span>[</span><span>X</span><span>]</span><span>/</span><span>(</span><span><span>X</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span></span></span></span></span> - the quotient polynomial ring with integer coefficients: .</li>\n</ul>\n</li>\n<li><span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> - Ring modulo the ideal generated by <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>.\n<ul>\n<li>Ex:  <span><span><span>Zq\\mathbb Z_q</span><span aria-hidden=\"true\"><span><span></span><span><span>Z</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> - the integers mod <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>.</li>\n<li>Ex: <span><span><span>Zq[X]/(Xn+1)\\mathbb Z_q[X]/ (X^n + 1)</span><span aria-hidden=\"true\"><span><span></span><span><span>Z</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>X</span><span>]</span><span>/</span><span>(</span><span><span>X</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span></span></span></span></span> - the quotient polynomial ring with coefficients being integers in <span><span><span>(−q/2,q/2](-q / 2, q / 2]</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>−</span><span>q</span><span>/</span><span>2</span><span>,</span><span></span><span>q</span><span>/</span><span>2</span><span>]</span></span></span></span></span>.</li>\n</ul>\n</li>\n<li><span><span><span>[a]q[a]_q</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>a</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> - <span><span><span>a mod qa \\bmod q</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>q</span></span></span></span></span>, coefficients centered in <span><span><span>(−q/2,q/2](-q / 2, q / 2]</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>−</span><span>q</span><span>/</span><span>2</span><span>,</span><span></span><span>q</span><span>/</span><span>2</span><span>]</span></span></span></span></span>. When applying <span><span><span>[⋅]q[\\cdot ]_q</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>⋅</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> to a polynomial we mean to apply it to all its coefficients individually. When applying <span><span><span>[⋅][\\cdot]</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>⋅</span><span>]</span></span></span></span></span> to a vector of elements, we mean to apply it to each element individually. So <span><span><span>[(a,b)]q=([a]q,[b]q)[(a, b)]_q = ([a]_q, [b]_q)</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>(</span><span>a</span><span>,</span><span></span><span>b</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>[</span><span>a</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>[</span><span>b</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>. We give the similar treatment to reduction <span><span><span> mod q\\bmod q</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>q</span></span></span></span></span> operation</li>\n<li><span><span><span>χ=χ(λ)\\chi = \\chi(\\lambda)</span><span aria-hidden=\"true\"><span><span></span><span>χ</span><span></span><span>=</span><span></span></span><span><span></span><span>χ</span><span>(</span><span>λ</span><span>)</span></span></span></span></span> - Noise distribution, parametrized by <span><span><span>λ\\lambda</span><span aria-hidden=\"true\"><span><span></span><span>λ</span></span></span></span></span> (usually Gaussian).</li>\n<li>For simplicity, when we say we sample a polynomial from some distribution (or a polynomial comes from some distribution) we mean that its coefficients are sampled independently from that distribution.</li>\n<li><span><span><span>e←χe \\leftarrow \\chi</span><span aria-hidden=\"true\"><span><span></span><span>e</span><span></span><span>←</span><span></span></span><span><span></span><span>χ</span></span></span></span></span> - An element <span><span><span>ee</span><span aria-hidden=\"true\"><span><span></span><span>e</span></span></span></span></span> sampled from the distribution <span><span><span>χ\\chi</span><span aria-hidden=\"true\"><span><span></span><span>χ</span></span></span></span></span></li>\n<li><span><span><span>a←RSa \\xleftarrow R S</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span></span><span><span><span><span><span><span></span><span><span>R</span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span></span><span>S</span></span></span></span></span> - An element sampled uniformly from a set <span><span><span>SS</span><span aria-hidden=\"true\"><span><span></span><span>S</span></span></span></span></span>\n<ul>\n<li>Ex: <span><span><span>a←RRqa \\xleftarrow R R_q</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span></span><span><span><span><span><span><span></span><span><span>R</span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> An element <span><span><span>aa</span><span aria-hidden=\"true\"><span><span></span><span>a</span></span></span></span></span> sampled uniformly from the ring <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></li>\n</ul>\n</li>\n<li><span><span><span>a⋅ba \\cdot b</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span></span><span>⋅</span><span></span></span><span><span></span><span>b</span></span></span></span></span>  denotes the multiplication of 2 elements from the ring <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></li>\n<li><span><span><span>tata</span><span aria-hidden=\"true\"><span><span></span><span>t</span><span>a</span></span></span></span></span>  denotes the multiplication of coefficients of <span><span><span>a∈Rqa \\in R_q</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span></span><span>∈</span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> by some scalar <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span>.</li>\n</ul>\n<h2>Fully Homomorphic Encryption (FHE)</h2>\n<p>Before defining fully homomorphic encryption, let's look at some <strong>applications</strong> of it to get a better intuition:</p>\n<p><strong>1. Outsourcing storage and computations</strong></p>\n<ul>\n<li>A company wants to use a cloud provider to store data and do computational heavy lifting.</li>\n<li><em>Task</em>: The company wants to use the information (for example: to do machine learning, extract statistical properties) without locally retrieving it  (defeating the purpose of using the cloud company services). Furthermore, the company doesn't want the cloud provider to see the sensitive data.</li>\n<li><em>Solution</em>: Using homomorphic encryption, the company can encrypt and send the data to the cloud provider and then the cloud provider can process the information (as requested by the company) in the encrypted form, without learning anything about the data.</li>\n<li>Ex: finance, medical apps, consumer privacy in ads.</li>\n</ul>\n<p><strong>2. Private queries</strong></p>\n<ul>\n<li>A client wants to retrieve a query against a large database held by a provider.</li>\n<li><em>Task</em>: The client wants to retrieve a query <strong>without</strong> the database provider learning the query.</li>\n<li><em>Solution</em>: Using homomorphic encryption the client can encrypt the index of the record and then the database can use this encrypted index to fetch (the comparison operation can be done using FHE) and return the encrypted result to the client. Finally, the client can decrypt the record.</li>\n</ul>\n<p><strong>3. Private set intersection</strong></p>\n<ul>\n<li>A client and a server each has a set of elements. The client wants to know which elements from its set are in the server's set.</li>\n<li><em>Task</em>: The client wants to find out the intersection of its elements and the server's, without the server learning anything about the client's elements and vice versa.</li>\n<li><em>Solution (Very simplified)</em>: They translate the comparison operation into a subtraction (<span><span><span>x=y⇒x−y=0x = y \\Rightarrow x - y = 0</span><span aria-hidden=\"true\"><span><span></span><span>x</span><span></span><span>=</span><span></span></span><span><span></span><span>y</span><span></span><span>⇒</span><span></span></span><span><span></span><span>x</span><span></span><span>−</span><span></span></span><span><span></span><span>y</span><span></span><span>=</span><span></span></span><span><span></span><span>0</span></span></span></span></span>). The client encrypts its elements and sends them to the server. Then, the server evalutes these subtractions homomorphically. Because the result of the subtraction is an encrypted result, the server learns nothing. Then the server sends the comparison results back and the client decrypts the results. We have a longer, more in-depth blogpost about it <a href=\"https://bit-ml.github.io/blog/post/private-set-intersection-an-implementation-in-python/\">here</a>. Happy reading!</li>\n<li>Examples: Client: user contacts, Server: whatsapp contacts; Client: own passwords, Server: database with breached passwords.</li>\n</ul>\n<p><em>Intuition</em></p>\n<ul>\n<li>A user has an arithmetic function <span><span><span>ff</span><span aria-hidden=\"true\"><span><span></span><span>f</span></span></span></span></span> and some inputs <span><span><span>(m1,...mn)(m_1, ... m_n)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span><span>m</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>.</li>\n<li>He wants to compute <span><span><span>m∗=f(m1,...mn)m^* = f(m_1, ... m_n)</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>f</span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span><span>m</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> but instead of computing it directly, he wants to encrypt <span><span><span>(m1,...mn)→(c1,...cn)(m_1, ... m_n) \\to (c_1, ... c_n)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span><span>m</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>→</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span><span>c</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> and do the computation on the ciphertext, obtaining a result which eventually decrypts to <span><span><span>m∗=f(m1,...mn)m^* =f(m_1, ... m_n)</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>f</span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span><span>m</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>.</li>\n<li>It's helpful to view the functions as tree of operations. For example (taken from the <a href=\"https://bit-ml.github.io/blog/post/homomorphic-encryption-toy-implementation-in-python/\">BFV blogpost</a>): <span><span><span>f(m1,m2,m3,m4)=(m1×m2+m3)×m4f(m_1,m_2,m_3,m_4)= (m_1 \\times m_2 + m_3) \\times m_4</span><span aria-hidden=\"true\"><span><span></span><span>f</span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>×</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>×</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></li>\n</ul>\n<p><img src=\"https://i.imgur.com/ub2OyXu.png\" alt=\"\"></p>\n<p><strong>Homomorphic Encryption -- Definition</strong><br>\nLet  <span><span><span>(KeyGen,Enc,Dec,Eval)(\\text{KeyGen}, \\text{Enc}, \\text{Dec}, \\text{Eval})</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>KeyGen</span></span><span>,</span><span></span><span><span>Enc</span></span><span>,</span><span></span><span><span>Dec</span></span><span>,</span><span></span><span><span>Eval</span></span><span>)</span></span></span></span></span> be a tuple of procedures.<br>\nLet <span><span><span>f∈Ff \\in \\mathcal F</span><span aria-hidden=\"true\"><span><span></span><span>f</span><span></span><span>∈</span><span></span></span><span><span></span><span>F</span></span></span></span></span> be a function in a family of functions. This function can also be written as a <em>circuit</em> from a family of circuits <span><span><span>C∈CC \\in \\mathcal C</span><span aria-hidden=\"true\"><span><span></span><span>C</span><span></span><span>∈</span><span></span></span><span><span></span><span>C</span></span></span></span></span>.</p>\n<ul>\n<li><span><span><span>(sk,pk)←KeyGen(1λ,1d)(sk, pk) \\gets \\text{KeyGen}(1^\\lambda, 1^d)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>s</span><span>k</span><span>,</span><span></span><span>p</span><span>k</span><span>)</span><span></span><span>←</span><span></span></span><span><span></span><span><span>KeyGen</span></span><span>(</span><span><span>1</span><span><span><span><span><span><span></span><span><span>λ</span></span></span></span></span></span></span></span><span>,</span><span></span><span><span>1</span><span><span><span><span><span><span></span><span><span>d</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> - key generation, <span><span><span>λ\\lambda</span><span aria-hidden=\"true\"><span><span></span><span>λ</span></span></span></span></span> is a security parameter, <span><span><span>dd</span><span aria-hidden=\"true\"><span><span></span><span>d</span></span></span></span></span> is a functionality parameter (degree of the polynomial or depth of the circtuit).</li>\n<li><span><span><span>ci←Enc(pk,mi)c_i \\gets \\text{Enc}(pk, m_i)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>←</span><span></span></span><span><span></span><span><span>Enc</span></span><span>(</span><span>p</span><span>k</span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> - Encryption of a message <span><span><span>mim_i</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> --  known as <strong>fresh ciphertexts</strong>.</li>\n<li><span><span><span>c∗=Eval(pk,f,c1,...cn)c^* = \\text{Eval}(pk, f, c_1, ... c_n)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>Eval</span></span><span>(</span><span>p</span><span>k</span><span>,</span><span></span><span>f</span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span><span>c</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> - Evaluate the function <span><span><span>ff</span><span aria-hidden=\"true\"><span><span></span><span>f</span></span></span></span></span> on the ciphertexts  -- known as <strong>evaluated ciphertexts</strong>.</li>\n</ul>\n<p><strong>Correctness</strong><br>\nWe require the (FHE) scheme to correctly decrypt both fresh and evaluated ciphertexts:\n<span><span><span>Dec(sk,c∗)=m∗=f(m1,...,mn)\\text{Dec}(sk, c^*) = m^* = f(m_1, ..., m_n)</span><span aria-hidden=\"true\"><span><span></span><span><span>Dec</span></span><span>(</span><span>s</span><span>k</span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>f</span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span></p>\n<p><img src=\"/galleries/bgv_scheme2023/fhe_simple_tiny.png\" alt=\"\"></p>\n<p>In the image above, the user with the laptop is interested  evaluating a certain circuit on its data <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span>. Therefore it sends its data, encrypted, to the cloud so that the cloud computes the circuit. By correctness, the user indeed gets the circuit applied on its data <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span>.</p>\n<p><strong>Circuits?</strong><br>\nThe two important operations we care about are addition and multiplication, because with them we can construct any arithmetic operation! Homomorphic encryption schemes started out by encrypting bits, so the equivalent operations for additon and multiplication on bits, <code>xor</code> and <code>and</code> are used.</p>\n<div><span><span><span>⊕=+ mod 2⊗=× mod 2\\oplus = + \\bmod 2 \\\\\n\\otimes = \\times \\bmod 2 </span><span aria-hidden=\"true\"><span><span></span><span>⊕</span><span></span><span>=</span><span></span></span><span><span></span><span>+</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>2</span></span><span></span><span><span></span><span>⊗</span><span></span><span>=</span><span></span></span><span><span></span><span>×</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>2</span></span></span></span></span></div>\n<p>To convey the fact that a circuit supports both <code>xor</code> and <code>and</code> usually a <code>nand</code> gate is used, because <code>nand</code> gates are composed by 1 multiplication and 1 addition and they are logically complete (you can build any circuit with them).\n<span><span><span>nand(a,b)=a×b+1 mod 2\\text{nand}(a, b) = a \\times b + 1 \\bmod 2</span><span aria-hidden=\"true\"><span><span></span><span><span>nand</span></span><span>(</span><span>a</span><span>,</span><span></span><span>b</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>a</span><span></span><span>×</span><span></span></span><span><span></span><span>b</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>2</span></span></span></span></span></p>\n<p>By extending to multiple bits, with the gates we discussed above you can represent any computation using boolean circuits.</p>\n<p>HE can be classified based on the type of functions <span><span><span>ff</span><span aria-hidden=\"true\"><span><span></span><span>f</span></span></span></span></span> that it supports:</p>\n<ul>\n<li><strong>Partially homomorphic encryption</strong><br>\nGiven <span><span><span>Enc(m1)\\text{Enc}(m_1)</span><span aria-hidden=\"true\"><span><span></span><span><span>Enc</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>, and <span><span><span>Enc(m2)\\text{Enc}(m_2)</span><span aria-hidden=\"true\"><span><span></span><span><span>Enc</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> you can do limited operations (either additions or multiplications)</li>\n<li><strong>Somewhat (leveled) homomorphic encryption</strong><br>\nGiven <span><span><span>Enc(m1),...,Enc(mn)\\text{Enc}(m_1), ..., \\text{Enc}(m_n)</span><span aria-hidden=\"true\"><span><span></span><span><span>Enc</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span>,</span><span></span><span><span>Enc</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> you can compute <span><span><span>Enc(f(m1,...mn))\\text{Enc}(f(m_1, ... m_n))</span><span aria-hidden=\"true\"><span><span></span><span><span>Enc</span></span><span>(</span><span>f</span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span><span>m</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>)</span></span></span></span></span> where <span><span><span>ff</span><span aria-hidden=\"true\"><span><span></span><span>f</span></span></span></span></span> is a polynomial of a limited degree.\nOne can do limited number of multiplications (Circuits of a maximum depth).</li>\n<li><strong>Fully homomorphic encryption</strong><br>\nOne can do unlimited multiplications and additions.</li>\n</ul>\n<p>The community put a lot of effort into the analysing FHE schemes: finding good parameters, finding software and hardware optimizations, coming up with possible attacks and adjusting the schemes against them. An interesting read is the <a href=\"https://homomorphicencryption.org/standard/\">homomorphic encryption standard</a>, which compiles good practices and techniques for developing and using existing schemes.</p>\n<h2>Ring Learning With Errors (RLWE)</h2>\n<p>In this section we'll focus on briefly introducing the Ring learning with errors (RLWE) problem. The problem is very complex and we'll only attempt to cover the basic blocks for building an intuition. For the interested reader more details can be found in this <a href=\"https://eprint.iacr.org/2012/230.pdf\">paper</a>.</p>\n<h3>Quick recap on working with polynomials</h3>\n<p>This section is taken from the <a href=\"https://bit-ml.github.io/blog/post/homomorphic-encryption-toy-implementation-in-python/\">BFV blogpost</a>, but we'll repeat it here to save you a click. For this subsection we denote with <span><span><span>Z/qZ={0,...,q−1}\\mathbb Z / q\\mathbb Z = \\{0, ... , q - 1\\}</span><span aria-hidden=\"true\"><span><span></span><span>Z</span><span>/</span><span>q</span><span>Z</span><span></span><span>=</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span>,</span><span></span><span>q</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>}</span></span></span></span></span>.</p>\n<p>The HE scheme we are going to describe deals with <em>adding and multiplying\npolynomials</em>. Here we present a quick example of how to work with\npolynomials, so that we all have the same starting point. If you already know\nhow to do this, you can skip it.</p>\n<p>First thing, let's add and multiply polynomials <em>modulo some polynomial <span><span><span>ff</span><span aria-hidden=\"true\"><span><span></span><span>f</span></span></span></span></span></em>.\nThis \"modulo <span><span><span>ff</span><span aria-hidden=\"true\"><span><span></span><span>f</span></span></span></span></span>\" thing simply means that we add and multiply the polynomials\nin the usual way, but we take the remainders of the results when divided by\n<span><span><span>ff</span><span aria-hidden=\"true\"><span><span></span><span>f</span></span></span></span></span>. When we do these additions and multiplications <span><span><span> mod f\\bmod f</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>f</span></span></span></span></span>, we sometimes\nsay in a fancy way that we are working in the <em>ring</em> <span><span><span>Z[x]/(f)\\mathbb{Z}[x]/(f)</span><span aria-hidden=\"true\"><span><span></span><span><span>Z</span></span><span>[</span><span>x</span><span>]</span><span>/</span><span>(</span><span>f</span><span>)</span></span></span></span></span> of\nreduced polynomials.</p>\n<p>Let's take <span><span><span>f=x4+1f = x^4 +1</span><span aria-hidden=\"true\"><span><span></span><span>f</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span>. If we look at <span><span><span>p(x)=x5p(x) =x^5</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>5</span></span></span></span></span></span></span></span></span></span></span></span>,\nthen <span><span><span>p(x)=x⋅(x4+1)−xp(x) = x \\cdot (x^4 + 1) - x</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>x</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span></span><span>−</span><span></span></span><span><span></span><span>x</span></span></span></span></span>. Therefore, when taking the reminder we get\n<span><span><span>p(x)=−x mod fp(x) = -x \\bmod f</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>−</span><span>x</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>f</span></span></span></span></span>. For faster computations <span><span><span> mod f\\bmod f</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>f</span></span></span></span></span> you can use this trick:\nwhen making <span><span><span> mod f\\bmod f</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>f</span></span></span></span></span>, simply replace <span><span><span>x4x^4</span><span aria-hidden=\"true\"><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span></span></span></span></span> by <span><span><span>−1-1</span><span aria-hidden=\"true\"><span><span></span><span>−</span><span>1</span></span></span></span></span>, <span><span><span>x5x^5</span><span aria-hidden=\"true\"><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>5</span></span></span></span></span></span></span></span></span></span></span></span> by <span><span><span>−x-x</span><span aria-hidden=\"true\"><span><span></span><span>−</span><span>x</span></span></span></span></span> and so on.</p>\n<p>Let's consider two polynomials <span><span><span>a(x)=x3+x2+7a(x) = x^3 + x^2 + 7</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>7</span></span></span></span></span> and <span><span><span>b(x)=x2+11xb(x) = x^2 + 11x</span><span aria-hidden=\"true\"><span><span></span><span>b</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>1</span><span>x</span></span></span></span></span>.\nThen:</p>\n<div><span><span><span>a(x)+b(x) mod f=x3+2x2+11x+7 mod f.a(x)+b(x) \\bmod f = x^3 + 2x^2 + 11x + 7 \\text { mod }f.</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span>(</span><span>x</span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>b</span><span>(</span><span>x</span><span>)</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>f</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>2</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>1</span><span>x</span><span></span><span>+</span><span></span></span><span><span></span><span>7</span><span><span> mod </span></span><span>f</span><span>.</span></span></span></span></span></div>\n<p>Here nothing special happened. Let's multiply them:</p>\n<div><span><span><span>a(x)⋅b(x) mod f=(x3+x2+7)⋅(x2+11x) mod f=x5+11x4+x4+11x3+7x2+77x mod f=−x−11−1+11x3+7x2+77x mod f=11x3+7x2+76x−12 mod f.\\begin{aligned}\na(x) \\cdot b(x) \\bmod f\n    &#x26;= (x^3 + x^2 + 7)\\cdot (x^2 +11x) \\text { mod }f \\\\\n    &#x26;= x^5 + 11x^4 + x^4 + 11x^3 + 7x^2 + 77x \\text { mod }f\\\\\n    &#x26;= -x - 11 - 1 + 11x^3 + 7x^2 + 77x \\text { mod }f \\\\\n    &#x26;= 11x^3 + 7x^2 + 76x - 12 \\text { mod }f.\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>a</span><span>(</span><span>x</span><span>)</span><span></span><span>⋅</span><span></span><span>b</span><span>(</span><span>x</span><span>)</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span><span>f</span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span>)</span><span></span><span>⋅</span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>1</span><span>1</span><span>x</span><span>)</span><span><span> mod </span></span><span>f</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>5</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>1</span><span>1</span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>1</span><span>1</span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span>7</span><span>x</span><span><span> mod </span></span><span>f</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>−</span><span>x</span><span></span><span>−</span><span></span><span>1</span><span>1</span><span></span><span>−</span><span></span><span>1</span><span></span><span>+</span><span></span><span>1</span><span>1</span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span>7</span><span>x</span><span><span> mod </span></span><span>f</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>1</span><span>1</span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span>6</span><span>x</span><span></span><span>−</span><span></span><span>1</span><span>2</span><span><span> mod </span></span><span>f</span><span>.</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>Now let's go one step further and see how we perform these operations of\npolynomials not just modulo <span><span><span>ff</span><span aria-hidden=\"true\"><span><span></span><span>f</span></span></span></span></span>, <em>but also modulo some integer <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span></em>. As you\nmight expect, the coefficients of these polynomials are also reduced modulo\n<span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>, so they always take integer values from <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span> to <span><span><span>q−1.q-1.</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>.</span></span></span></span></span> This time, we say\nthat we are working the ring of reduced polynomials <span><span><span>Z/qZ[x]/(f)\\mathbb{Z} / q\\mathbb Z[x]/(f)</span><span aria-hidden=\"true\"><span><span></span><span><span>Z</span></span><span>/</span><span>q</span><span>Z</span><span>[</span><span>x</span><span>]</span><span>/</span><span>(</span><span>f</span><span>)</span></span></span></span></span>.</p>\n<p>Let's take the previous example, <span><span><span>f=x4+1f = x^4+1</span><span aria-hidden=\"true\"><span><span></span><span>f</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span>, <span><span><span>a(x)=x3+x2+7a(x)=x^3+x^2+7</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>7</span></span></span></span></span>,\n<span><span><span>b(x)=x2+11xb(x)=x^2+11x</span><span aria-hidden=\"true\"><span><span></span><span>b</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>1</span><span>x</span></span></span></span></span> and consider <span><span><span>q=5q =5</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span></span><span>=</span><span></span></span><span><span></span><span>5</span></span></span></span></span>. We can think of <span><span><span>aa</span><span aria-hidden=\"true\"><span><span></span><span>a</span></span></span></span></span> and <span><span><span>bb</span><span aria-hidden=\"true\"><span><span></span><span>b</span></span></span></span></span> as already\ntaken <span><span><span> mod f\\bmod f</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>f</span></span></span></span></span>. If we take them further modulo <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>, then <span><span><span>[a(x)]q=x3+x2+2[a(x)]_q = x^3 +\nx^2 +2</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>a</span><span>(</span><span>x</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>2</span></span></span></span></span> and <span><span><span>[b(x)]q=x2+x[b(x)]_q = x^2+x</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>b</span><span>(</span><span>x</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>x</span></span></span></span></span>. Moreover,</p>\n<div><span><span><span>[a(x)+b(x)]q=x3+x2+2+x2+x=x3+2x2+x+2[a(x) + b(x)]_q = x^3 + x^2 +2+ x^2 + x = x^3 + 2x^2 + x+2</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>a</span><span>(</span><span>x</span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>b</span><span>(</span><span>x</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>2</span><span></span><span>+</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>x</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>2</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>x</span><span></span><span>+</span><span></span></span><span><span></span><span>2</span></span></span></span></span></div>\n<p>and</p>\n<div><span><span><span>[a(x)⋅b(x)]q=(x3+x2+2)⋅(x2+x)=x5+x4+x4+x3+2x2+2x=−x−1−1+x3+2x2+2x=x3+2x2+x+3\\begin{aligned}\n[a(x) \\cdot b(x)]_q\n    &#x26;= (x^3 + x^2+2) \\cdot (x^2 + x)\\\\\n    &#x26;= x^5 + x^4 + x^4 +x^3+2x^2 + 2x\\\\\n    &#x26;= -x -1 -1 + x^3 +2x^2+2x\\\\\n    &#x26;= x^3+2x^2+x+3\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>[</span><span>a</span><span>(</span><span>x</span><span>)</span><span></span><span>⋅</span><span></span><span>b</span><span>(</span><span>x</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>2</span><span>)</span><span></span><span>⋅</span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>x</span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>5</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>2</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>2</span><span>x</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>−</span><span>x</span><span></span><span>−</span><span></span><span>1</span><span></span><span>−</span><span></span><span>1</span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>2</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>2</span><span>x</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>2</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>x</span><span></span><span>+</span><span></span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>To give a powerful visual intuition of polynomials in quotient rings, consider the following polynomial<span><span><span>1+4x+2x3∈Z/5Z[x]/(x4+1)1 + 4x + 2x^3 \\in \\mathbb Z/5\\mathbb Z[x] / (x^4+1)</span><span aria-hidden=\"true\"><span><span></span><span>1</span><span></span><span>+</span><span></span></span><span><span></span><span>4</span><span>x</span><span></span><span>+</span><span></span></span><span><span></span><span>2</span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>∈</span><span></span></span><span><span></span><span>Z</span><span>/</span><span>5</span><span>Z</span><span>[</span><span>x</span><span>]</span><span>/</span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span></span></span></span></span>\nand its visual representation. For this grade 3 polynomial we have four pentagons, for each coefficient. Each pentagon represents <span><span><span>Z/5Z\\mathbb Z/ 5\\mathbb Z</span><span aria-hidden=\"true\"><span><span></span><span>Z</span><span>/</span><span>5</span><span>Z</span></span></span></span></span>. The value of the coefficient is colored with green:</p>\n<p><img src=\"/galleries/bgv_scheme2023/poly_tiny.png\" alt=\"poly\"></p>\n<h3>The security of the BGV scheme</h3>\n<p>Like we said in the introduction, our ciphertexts will be masked with some noise to look as random as possible in order to hide any information an attacker may extract about the message.</p>\n<p>In fact it can be proven that the BGV scheme is secure as long as nobody can solve the Ring Learning With Errors (RLWE) problem described below. The parameters of the scheme must be chosen such that there are no known algorithms to solve the underlying RLWE problem in feasable time.</p>\n<p>Formally, the idea of \"ciphertexts looking like garbage\" is called <a href=\"https://en.wikipedia.org/wiki/Ciphertext_indistinguishability\"><strong>ciphertext indistinguishability</strong></a>. This concept can be formulated using a game between a challenger and an adversary:</p>\n<ul>\n<li>The challenger receives two messages <span><span><span>m0,m1m_0, m_1</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> from the adversary. Then, the challenger encrypts them into <span><span><span>c0,c1c_0, c_1</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</li>\n<li>Then, the challenger secretly flips a bit <span><span><span>b∈{0,1}b\\in \\{0, 1\\}</span><span aria-hidden=\"true\"><span><span></span><span>b</span><span></span><span>∈</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>}</span></span></span></span></span> and sends the ciphertext <span><span><span>cbc_b</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>b</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> to the adversary.</li>\n<li>The adversary must guess the bit <span><span><span>bb</span><span aria-hidden=\"true\"><span><span></span><span>b</span></span></span></span></span>. After running an efficient algorithm, it outputs a bit <span><span><span>b′b'</span><span aria-hidden=\"true\"><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span>. It wins if <span><span><span>b′=bb' = b</span><span aria-hidden=\"true\"><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>b</span></span></span></span></span>.</li>\n</ul>\n<p><img src=\"/galleries/bgv_scheme2023/sec_game_tiny.png\" alt=\"sec_game\"></p>\n<p>If there exists <strong>at least one</strong> adversary that can win the game with a probability significantly larger than 1/2 (a coinflip) using a computationally efficient algorithm (something that can run in our universe's lifetime), the challenger's algorithm is considered insecure. When we prove the security of a scheme, we actually show that if an adversary had such an algorithm that can win the security game, he can take that algorithm and use it to solve a problem that is considered <a href=\"https://en.wikipedia.org/wiki/Computational_hardness_assumption\"><em>computationally hard</em></a>.</p>\n<p>We will now describe the RLWE problem.</p>\n<p>Consider the quotient polynomial ring <span><span><span>Rq=Zq[X]/(Xn+1)R_q = \\mathbb Z_q[X]/ (X^n + 1)</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>Z</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>X</span><span>]</span><span>/</span><span>(</span><span><span>X</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span></span></span></span></span>. This ring has polynomials with degree at most <span><span><span>nn</span><span aria-hidden=\"true\"><span><span></span><span>n</span></span></span></span></span> and integer coefficients in <span><span><span>(−q/2,q/2](-q / 2, q / 2]</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>−</span><span>q</span><span>/</span><span>2</span><span>,</span><span></span><span>q</span><span>/</span><span>2</span><span>]</span></span></span></span></span>.</p>\n<p><strong>The RLWE problem - decision</strong><br>\nThe problem asks to distinguish between the following two distributions:</p>\n<ul>\n<li><span><span><span>(ai,bi)(a_i, b_i)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> with <span><span><span>ai←RRqa_i \\xleftarrow R R_q</span><span aria-hidden=\"true\"><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span><span><span><span><span><span></span><span><span>R</span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, <span><span><span>bi←RRqb_i \\xleftarrow R R_q</span><span aria-hidden=\"true\"><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span><span><span><span><span><span></span><span><span>R</span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</li>\n<li><span><span><span>(ai,bi)(a_i, b_i)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> with <span><span><span>ai←RRqa_i \\xleftarrow R R_q</span><span aria-hidden=\"true\"><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span><span><span><span><span><span></span><span><span>R</span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, <span><span><span>ei←χe_i \\leftarrow \\chi</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>←</span><span></span></span><span><span></span><span>χ</span></span></span></span></span>,  and <span><span><span>bi=ai⋅s+eib_i = a_i \\cdot s + e_i</span><span aria-hidden=\"true\"><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> for some \"small\" secret <span><span><span>s∈Rqs \\in R_q</span><span aria-hidden=\"true\"><span><span></span><span>s</span><span></span><span>∈</span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> sampled before.</li>\n</ul>\n<p>The RLWE problem also has a search version, where given pairs <span><span><span>(ai,bi)(a_i, b_i)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>, <span><span><span>bi=ai⋅s+eib_i = a_i \\cdot s + e_i</span><span aria-hidden=\"true\"><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> you need to find <span><span><span>ss</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span>. In practice, the decision version is more widely used when proving the security of different schemes.</p>\n<p>More details about the RLWE problem can be found in this <a href=\"https://eprint.iacr.org/2012/230.pdf\">paper</a>. In essence, by adding some small noise <span><span><span>eie_i</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, from a Gaussian distribution, we make our secret <span><span><span>ss</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span> unrecoverable even if we have access to many RLWE samples.</p>\n<p>The <a href=\"https://eprint.iacr.org/2011/277.pdf\">original BGV paper</a> presents the algorithms (encryption, decryption, etc) of a HE scheme based on a more general problem, the <em>General Learning with Errors (GLWE)</em>  problem. For simplicity, we work with the RLWE case in this blogpost.</p>\n<h2>The BGV encryption scheme</h2>\n<p>Generate the following parameters</p>\n<ul>\n<li><span><span><span>nn</span><span aria-hidden=\"true\"><span><span></span><span>n</span></span></span></span></span> - degree of <span><span><span>Xn+1X^n + 1</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span>. <span><span><span>nn</span><span aria-hidden=\"true\"><span><span></span><span>n</span></span></span></span></span> is chosen as a power of 2.</li>\n<li><span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span> - ciphertext modulus.</li>\n<li><span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span> - plainext modulus, <span><span><span>t≪qt \\ll q</span><span aria-hidden=\"true\"><span><span></span><span>t</span><span></span><span>≪</span><span></span></span><span><span></span><span>q</span></span></span></span></span>.</li>\n<li><span><span><span>χ\\chi</span><span aria-hidden=\"true\"><span><span></span><span>χ</span></span></span></span></span> - the noise distribution, a discrete Gaussian.</li>\n</ul>\n<p>We consider <span><span><span>Rq=Zq[X]/(Xn+1)R_q = \\mathbb Z_q[X] / (X^n + 1)</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>Z</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>X</span><span>]</span><span>/</span><span>(</span><span><span>X</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span></span></span></span></span>. This ring has polynomials with degree at most <span><span><span>nn</span><span aria-hidden=\"true\"><span><span></span><span>n</span></span></span></span></span> and integer coefficients in <span><span><span>(−q/2,q/2](-q / 2, q / 2]</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>−</span><span>q</span><span>/</span><span>2</span><span>,</span><span></span><span>q</span><span>/</span><span>2</span><span>]</span></span></span></span></span>.</p>\n<p><strong>Note</strong>:</p>\n<ul>\n<li>All polynomial operations are considered <span><span><span> mod q\\bmod q</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>q</span></span></span></span></span> unless otherwise specified, to ease notation.</li>\n<li>When we talk about \"small\" polynomials, we intuitively think about them having  small coefficients.</li>\n<li>Polynomials that come from the noise distribution will be colored with green (ex: <span><span><span>e\\textcolor{darkgreen}{e}</span><span aria-hidden=\"true\"><span><span></span><span>e</span></span></span></span></span>) and the ones that will come from the secret key distribution will be colored with red (Ex: <span><span><span>s,u\\red{s}, \\red{u}</span><span aria-hidden=\"true\"><span><span></span><span>s</span><span>,</span><span></span><span>u</span></span></span></span></span>).</li>\n</ul>\n<p>We will have one secret key <span><span><span>sksk</span><span aria-hidden=\"true\"><span><span></span><span>s</span><span>k</span></span></span></span></span>, a public key with two components <span><span><span>pk=(pk0,pk1)pk = (pk_0, pk_1)</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span>k</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>, a ciphertext with 2 components <span><span><span>c=(c0,c1)c = (c_0, c_1)</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>\nThe messsage will come from the ring <span><span><span>RtR_t</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p><code>SecretKeyGen(params) -> sk</code></p>\n<ul>\n<li>Draw <span><span><span>s\\red{s}</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span> from a secret key distribution which outputs \"small\" elements with overwhelming probability. In practice <span><span><span>s∈{−1,0,1}n\\red{s} \\in \\{-1, 0, 1\\}^n</span><span aria-hidden=\"true\"><span><span></span><span>s</span><span></span><span>∈</span><span></span></span><span><span></span><span>{</span><span>−</span><span>1</span><span>,</span><span></span><span>0</span><span>,</span><span></span><span>1</span><span><span>}</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span>, with the probability of sampling <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span> specified as a parameter and the probabilities of sampling <span><span><span>−1-1</span><span aria-hidden=\"true\"><span><span></span><span>−</span><span>1</span></span></span></span></span> or <span><span><span>11</span><span aria-hidden=\"true\"><span><span></span><span>1</span></span></span></span></span> being equal.</li>\n<li>Return the secret key <span><span><span>sk=ssk = \\red{s}</span><span aria-hidden=\"true\"><span><span></span><span>s</span><span>k</span><span></span><span>=</span><span></span></span><span><span></span><span>s</span></span></span></span></span>.</li>\n</ul>\n<p><code>PubKeyGen(sk, params) -> (pk0, pk1)</code></p>\n<ul>\n<li>Draw a random element <span><span><span>a←RRqa \\xleftarrow R R_q</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span></span><span><span><span><span><span><span></span><span><span>R</span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and the noise <span><span><span>e←χ\\textcolor{darkgreen}{e} \\leftarrow \\chi</span><span aria-hidden=\"true\"><span><span></span><span>e</span><span></span><span>←</span><span></span></span><span><span></span><span>χ</span></span></span></span></span>.</li>\n<li>Return the public key: <span><span><span>pk=(pk0,pk1)=(a⋅s+te,−a)⏟RLWE instance-likepk = (pk_0, pk_1) = \\underbrace{(a \\cdot \\red{s} + t\\textcolor{darkgreen}{e}, -a)}_{\\text{RLWE instance-like}}</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span>k</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span><span>RLWE instance-like</span></span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span>(</span><span>a</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span>t</span><span>e</span><span>,</span><span></span><span>−</span><span>a</span><span>)</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span>.</li>\n</ul>\n<p>Notice that the public key  looks like a RLWE sample, but the error <span><span><span>ee</span><span aria-hidden=\"true\"><span><span></span><span>e</span></span></span></span></span> is multiplied by the plaintext modulus <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span>.</p>\n<p><code>Encrypt(m, pk, params) -> (c0, c1)</code></p>\n<ul>\n<li>Draw the noise <span><span><span>e0,e1←χ\\textcolor{darkgreen}{e_0}, \\textcolor{darkgreen}{e_1} \\leftarrow \\chi</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>←</span><span></span></span><span><span></span><span>χ</span></span></span></span></span> and a \"small\" polynomial <span><span><span>u∈{−1,0,1}n\\red{u} \\in \\{-1, 0, 1\\}^n</span><span aria-hidden=\"true\"><span><span></span><span>u</span><span></span><span>∈</span><span></span></span><span><span></span><span>{</span><span>−</span><span>1</span><span>,</span><span></span><span>0</span><span>,</span><span></span><span>1</span><span><span>}</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span> in the same way as the secret.</li>\n<li>Compute <span><span><span>c0=pk0⋅u+te0+mc_0 = pk_0 \\cdot \\red{u} + t\\textcolor{darkgreen}{e_0} + m</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>u</span><span></span><span>+</span><span></span></span><span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>m</span></span></span></span></span></li>\n<li>Compute <span><span><span>c1=pk1⋅u+te1c_1 = pk_1 \\cdot \\red{u} + t\\textcolor{darkgreen}{e_1}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>u</span><span></span><span>+</span><span></span></span><span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></li>\n<li>Return <span><span><span>c=(c0,c1)c = (c_0, c_1)</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>.</li>\n</ul>\n<p>The ciphertext components <span><span><span>(c0,c1)(c_0, c_1)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> are elements in <span><span><span>Rq=Zq[X]/(Xn+1)R_q = \\mathbb Z_q[X]/(X^n + 1)</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>Z</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>X</span><span>]</span><span>/</span><span>(</span><span><span>X</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span></span></span></span></span>.</p>\n<p><code>Decrypt(c, sk, params)</code></p>\n<ul>\n<li>Compute <span><span><span>m=c0+c1⋅s mod q mod tm = c_0 + c_1 \\cdot \\red{s} \\bmod q \\bmod t</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span></span><span>=</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>q</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>t</span></span></span></span></span></li>\n<li>Return <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span>.</li>\n</ul>\n<p>Let's unroll the equations to check the correctness. All operation are <span><span><span> mod q\\bmod q</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>q</span></span></span></span></span> to ease notation, unless we specify otherwise.</p>\n<p>The public key is:</p>\n<div><span><span><span>pk0=a⋅s+tepk1=−a\\begin{aligned}\npk_0 &#x26;= a \\cdot \\textcolor{red}{s} + t\\textcolor{darkgreen}{e} \\\\\npk_1 &#x26;= -a\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>a</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span>t</span><span>e</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>−</span><span>a</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>The public key hides the secret <span><span><span>ss</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span> as a RLWE sample.</p>\n<p>The encryption equations unrolled are:</p>\n<div><span><span><span>c0=pk0⋅u+te0+m=(a⋅s+te)⋅u+te0+m=a⋅s⋅u+t(e⋅u)+te0+mc1=pk1⋅u+te1=−a⋅u+te1\\begin{aligned}\nc_0 = pk_0 \\cdot \\textcolor{red}{u} + t\\textcolor{darkgreen}{e}_0 + m \\\\\n&#x26;= (a \\cdot \\textcolor{red}{s} + t\\textcolor{darkgreen}{e}) \\cdot \\textcolor{red}{u} + t\\textcolor{darkgreen}{e_0} + m \\\\\n&#x26;= a \\cdot \\textcolor{red}{s} \\cdot \\textcolor{red}{u} + t(\\textcolor{darkgreen}{e} \\cdot \\textcolor{red}{u}) + t\\textcolor{darkgreen}{e_0} + m\n\\\\\nc_1 &#x26;= pk_1 \\cdot \\textcolor{red}{u} + t\\textcolor{darkgreen}{e_1} \\\\\n&#x26;= -a \\cdot \\textcolor{red}{u} + t\\textcolor{darkgreen}{e_1} \\\\\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>m</span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>(</span><span>a</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span>t</span><span>e</span><span>)</span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>m</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>a</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span>t</span><span>(</span><span>e</span><span></span><span>⋅</span><span></span><span>u</span><span>)</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>m</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>−</span><span>a</span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>The decryption equation unrolled is:</p>\n<div><span><span><span>c0+c1⋅s=a⋅s⋅u+t(e⋅u)+te0+m+(−a⋅u+te1)⋅s mod q=a⋅s⋅u+t(e⋅u)+te0+m−a⋅u⋅s+te1⋅s=te1⋅s+t(e⋅u)+te0+m=t(e⋅u+e0+e1⋅s)⏟error+m\\begin{aligned}\nc_0 + c_1 \\cdot \\textcolor{red}{s} &#x26;= a \\cdot \\textcolor{red}{s} \\cdot \\textcolor{red}{u} + t(\\textcolor{darkgreen}{e} \\cdot \\textcolor{red}{u}) + t\\textcolor{darkgreen}{e_0} + m + (-a \\cdot \\textcolor{red}{u} + t\\textcolor{darkgreen}{e_1}) \\cdot \\textcolor{red}{s} \\bmod q \\\\\n&#x26;= \\cancel{a \\cdot \\textcolor{red}{s} \\cdot \\textcolor{red}{u}} + t(\\textcolor{darkgreen}{e} \\cdot \\textcolor{red}{u}) + t\\textcolor{darkgreen}{e_0} + m \\cancel{-a \\cdot \\textcolor{red}{u} \\cdot \\textcolor{red}{s}} + t\\textcolor{darkgreen}{e_1} \\cdot \\textcolor{red}{s} \\\\\n&#x26;= t\\textcolor{darkgreen}{e_1} \\cdot \\textcolor{red}{s} + t(\\textcolor{darkgreen}{e} \\cdot \\textcolor{red}{u}) + t\\textcolor{darkgreen}{e_0} + m \\\\\n&#x26;= \\underbrace{t(\\textcolor{darkgreen}{e} \\cdot \\textcolor{red}{u} + \\textcolor{darkgreen}{e_0} + \\textcolor{darkgreen}{e_1} \\cdot \\textcolor{red}{s})}_{\\text{error}} + m\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>a</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span>t</span><span>(</span><span>e</span><span></span><span>⋅</span><span></span><span>u</span><span>)</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>m</span><span></span><span>+</span><span></span><span>(</span><span>−</span><span>a</span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span><span>q</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span><span><span></span><span><span>a</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>⋅</span><span></span><span>u</span></span></span><span><span></span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>t</span><span>(</span><span>e</span><span></span><span>⋅</span><span></span><span>u</span><span>)</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>m</span><span><span><span><span><span><span></span><span><span>−</span><span>a</span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span>t</span><span>(</span><span>e</span><span></span><span>⋅</span><span></span><span>u</span><span>)</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>m</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span><span><span></span><span><span><span><span>error</span></span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span>t</span><span>(</span><span>e</span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span>)</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>+</span><span></span><span>m</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>The decryption is correct as long as the error we add to <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span> does not wrap the coefficients of <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span> arond the modulus <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>. The noise analysis will be offered later, in its own section.</p>\n<p>Now, we reduce the above <span><span><span> mod t\\bmod t</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>t</span></span></span></span></span> and we get:</p>\n<div><span><span><span>c0+c1⋅s=m mod q mod tc_0+c_1 \\cdot \\textcolor{red}{s} = m \\bmod q \\bmod t</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>=</span><span></span></span><span><span></span><span>m</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>q</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>t</span></span></span></span></span></div>\n<h2>FHE Operations</h2>\n<p>Here we will explore the homomorphic properties of the scheme. We refer to the two input message and ciphertext pairs with <span><span><span>(m,c),(m′,c′)(m, c), (m', c')</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>m</span><span>,</span><span></span><span>c</span><span>)</span><span>,</span><span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> and to the resulting message-ciphertext pair  with <span><span><span>(m∗,c∗)(m^*, c^*)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span>.</p>\n<p>The goal is to find two functions, <span><span><span>add,mul\\text{add}, \\text{mul}</span><span aria-hidden=\"true\"><span><span></span><span><span>add</span></span><span>,</span><span></span><span><span>mul</span></span></span></span></span></span>, that work on ciphertexts, for addition and multiplication, such that:</p>\n<ul>\n<li>when <span><span><span>m∗=m+m′m^* = m + m'</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> we have <span><span><span>c∗=add(c,c′)c^* = \\text{add}(c, c')</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>add</span></span><span>(</span><span>c</span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> and <span><span><span>Dec(c∗)=m∗\\text{Dec}(c^*) = m^*</span><span aria-hidden=\"true\"><span><span></span><span><span>Dec</span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span></span></span></span></span></li>\n<li>when <span><span><span>m∗=m⋅m′m^* = m \\cdot m'</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>m</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> we have <span><span><span>c∗=mul(c,c′)c^* = \\text{mul}(c, c')</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>mul</span></span><span>(</span><span>c</span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> and <span><span><span>Dec(c∗)=m∗\\text{Dec}(c^*) = m^*</span><span aria-hidden=\"true\"><span><span></span><span><span>Dec</span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span></span></span></span></span></li>\n</ul>\n<p>Recall that <span><span><span>cc</span><span aria-hidden=\"true\"><span><span></span><span>c</span></span></span></span></span> and <span><span><span>c′c'</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> encrypt <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span> and <span><span><span>m′m'</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> i.e.:</p>\n<div><span><span><span>c0=pk0⋅u+te0+mc1=pk1⋅u+te1c0′=pk0⋅u′+te0′+mc1′=pk1⋅u′+te1′\\begin{aligned}\nc_0 &#x26;= pk_0 \\cdot \\textcolor{red}{u} + t\\textcolor{darkgreen}{e_0} + m \\\\\nc_1 &#x26;= pk_1 \\cdot \\textcolor{red}{u} + t\\textcolor{darkgreen}{e_1} \\\\\n\\\\\nc'_0 &#x26;= pk_0 \\cdot \\textcolor{red}{u'} + t\\textcolor{darkgreen}{e'_0} + m \\\\\nc'_1 &#x26;= pk_1 \\cdot \\textcolor{red}{u'} + t\\textcolor{darkgreen}{e'_1} \\\\\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>m</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>m</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<h3>FHE Addition</h3>\n<p>The image on the left performs the addition before the encryption, with the messages in clear. This is not what we want. The image on the right is the desirable outcome, where we encrypt the messages, then perform addition on the encrypted messages.</p>\n<p><img src=\"/galleries/bgv_scheme2023/fhe_add_tiny.png\" alt=\"fhe_add\"></p>\n<p>We define <code>add</code>:\n<code>add(c, c') -> c*</code></p>\n<ul>\n<li><span><span><span>c0∗=c0+c0′c^*_0 = c_0 + c'_0</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></li>\n<li><span><span><span>c1∗=c1+c1′c^*_1 = c_1 + c'_1</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></li>\n<li>return <span><span><span>c∗=(c0∗,c1∗)c^* = (c^*_0, c^*_1)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span></li>\n</ul>\n<div><span><span><span>c0∗=c0+c0′=pk0⋅u+te0+m+pk0⋅u′+te0′+m′=pk0⋅(u+u′)+t(e0+e0′)+m+m′=(a⋅s+te)⋅(u+u′)+t(e0+e0′)+m+m′=(a⋅s)⋅(u+u′)+te⋅(u+u′)+t(e0+e0′)+m+m′c1∗=c1+c1′=pk1⋅u+te1+pk1⋅u′+te1′=pk1(u+u′)+t(e1+e1′)=−a(u+u′)+t(e1+e1′)\\begin{aligned}\nc^*_0 &#x26;= c_0 + c'_0 \\\\\n&#x26;= pk_0 \\cdot \\textcolor{red}{u} + t\\textcolor{darkgreen}{e_0} + m + pk_0 \\cdot \\textcolor{red}{u'} + t\\textcolor{darkgreen}{e'_0} + m' \\\\\n&#x26;= pk_0 \\cdot (\\textcolor{red}{u} + \\textcolor{red}{u'}) + t(\\textcolor{darkgreen}{e_0} + \\textcolor{darkgreen}{e'_0}) + m + m' \\\\\n&#x26;= (a \\cdot \\textcolor{red}{s} + t\\textcolor{darkgreen}{e}) \\cdot (\\textcolor{red}{u} + \\textcolor{red}{u'}) + t(\\textcolor{darkgreen}{e_0} + \\textcolor{darkgreen}{e'_0}) + m + m' \\\\\n&#x26;= (a \\cdot \\textcolor{red}{s} ) \\cdot (\\textcolor{red}{u} + \\textcolor{red}{u'}) + t\\textcolor{darkgreen}{e} \\cdot (\\textcolor{red}{u} + \\textcolor{red}{u'}) + t(\\textcolor{darkgreen}{e_0} + \\textcolor{darkgreen}{e'_0}) + m + m'\n\\\\\n\\\\\nc^*_1 &#x26;= c_1 + c'_1 \\\\\n&#x26;= pk_1 \\cdot \\textcolor{red}{u} + t\\textcolor{darkgreen}{e_1} + pk_1 \\cdot \\textcolor{red}{u'} + t\\textcolor{darkgreen}{e'_1} \\\\ \n&#x26;= pk_1(\\textcolor{red}{u} + \\textcolor{red}{u'}) + t(\\textcolor{darkgreen}{e_1} + \\textcolor{darkgreen}{e'_1}) \\\\\n&#x26;= -a(\\textcolor{red}{u} + \\textcolor{red}{u'}) + t(\\textcolor{darkgreen}{e_1} + \\textcolor{darkgreen}{e'_1})\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>m</span><span></span><span>+</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>t</span><span>(</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>m</span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>(</span><span>a</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span>t</span><span>e</span><span>)</span><span></span><span>⋅</span><span></span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>t</span><span>(</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>m</span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>(</span><span>a</span><span></span><span>⋅</span><span></span><span>s</span><span>)</span><span></span><span>⋅</span><span></span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>t</span><span>e</span><span></span><span>⋅</span><span></span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>t</span><span>(</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>m</span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>t</span><span>(</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>−</span><span>a</span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>t</span><span>(</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>And by using <code>Decrypt(c*, sk, params)</code> we have</p>\n<div><span><span><span>c0∗+c1∗⋅s=(a⋅s)⋅(u+u′)+te⋅(u+u′)+t(e0+e0′)+m+m′⏞c0∗++(−a(u+u′)+t(e1+e1′))⏞c1∗⋅s=(a⋅s)⋅(u+u′)+te⋅(u+u′)+t(e0+e0′)+m+m′−−(a⋅s)⋅(u+u′)+t(e1+e1′)⋅s=te⋅(u+u′)+t(e0+e0′)+t(e1+e1′)⋅s+m+m′=t(e⋅(u+u′)+e0+e0′+(e1+e1′)⋅s)⏟error+m+m′\\begin{aligned}\nc^*_0 + c^*_1 \\cdot \\textcolor{red}{s} &#x26;= \\overbrace{(a \\cdot \\textcolor{red}{s} ) \\cdot (\\textcolor{red}{u} + \\textcolor{red}{u'}) + \\textcolor{darkgreen}{te} \\cdot (\\textcolor{red}{u} + \\textcolor{red}{u'}) + t(\\textcolor{darkgreen}{e_0} + \\textcolor{darkgreen}{e'_0}) + m + m'}^{c^*_0} + \\\\\n&#x26;+ \\overbrace{(-a(\\textcolor{red}{u} + \\textcolor{red}{u'}) + t(\\textcolor{darkgreen}{e_1} + \\textcolor{darkgreen}{e'_1}))}^{c^*_1} \\cdot \\textcolor{red}{s} \\\\\n&#x26;= \\cancel{(a \\cdot \\textcolor{red}{s} ) \\cdot (\\textcolor{red}{u} + \\textcolor{red}{u'})} + t\\textcolor{darkgreen}{e} \\cdot (\\textcolor{red}{u} + \\textcolor{red}{u'}) + t(\\textcolor{darkgreen}{e_0} + \\textcolor{darkgreen}{e'_0}) + m + m' - \\\\\n&#x26; \\cancel{-(a \\cdot \\textcolor{red}{s}) \\cdot (\\textcolor{red}{u} + \\textcolor{red}{u'})} +  t(\\textcolor{darkgreen}{e_1} + \\textcolor{darkgreen}{e'_1}) \\cdot \\textcolor{red}{s} \\\\\n&#x26;= t\\textcolor{darkgreen}{e} \\cdot (\\textcolor{red}{u} + \\textcolor{red}{u'}) + t(\\textcolor{darkgreen}{e_0} + \\textcolor{darkgreen}{e'_0}) + t(\\textcolor{darkgreen}{e_1} + \\textcolor{darkgreen}{e'_1}) \\cdot \\textcolor{red}{s}  + m + m' \\\\\n&#x26;=  \\underbrace{t(\\textcolor{darkgreen}{e} \\cdot (\\textcolor{red}{u} + \\textcolor{red}{u'}) + \\textcolor{darkgreen}{e_0} + \\textcolor{darkgreen}{e'_0} + (\\textcolor{darkgreen}{e_1} + \\textcolor{darkgreen}{e'_1}) \\cdot \\textcolor{red}{s} )}_{\\text{error}} + m + m'\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span><span><span></span><span><span><span><span><span><span></span><span><span>(</span><span>a</span><span></span><span>⋅</span><span></span><span>s</span><span>)</span><span></span><span>⋅</span><span></span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>t</span><span>e</span><span></span><span>⋅</span><span></span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>t</span><span>(</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>m</span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span>+</span></span></span><span><span></span><span><span></span><span></span><span>+</span><span></span><span><span><span><span><span><span></span><span><span><span><span><span><span></span><span><span>(</span><span>−</span><span>a</span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>t</span><span>(</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>)</span></span></span><span><span></span><span><span></span><span></span><span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span><span><span></span><span><span>(</span><span>a</span><span></span><span>⋅</span><span></span><span>s</span><span>)</span><span></span><span>⋅</span><span></span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>+</span><span></span><span>t</span><span>e</span><span></span><span>⋅</span><span></span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>t</span><span>(</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>m</span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>−</span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>−</span><span>(</span><span>a</span><span></span><span>⋅</span><span></span><span>s</span><span>)</span><span></span><span>⋅</span><span></span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>+</span><span></span><span>t</span><span>(</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>t</span><span>e</span><span></span><span>⋅</span><span></span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>t</span><span>(</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>t</span><span>(</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span>m</span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span><span><span></span><span><span><span><span>error</span></span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span>t</span><span>(</span><span>e</span><span></span><span>⋅</span><span></span><span>(</span><span>u</span><span></span><span>+</span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>(</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span><span>s</span><span>)</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>+</span><span></span><span>m</span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>Again, by reducing everything <span><span><span> mod t\\bmod t</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>t</span></span></span></span></span> we have</p>\n<div><span><span><span>c0∗+c1∗⋅s=m∗=m+m′ mod tc^*_0 + c^*_1 \\cdot \\red{s} = m^* = m + m' \\bmod t</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>=</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>t</span></span></span></span></span></div>\n<p>with the same remark that for the decryption to be correct the error that we add to <span><span><span>m∗m^*</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span></span></span></span></span> must not wrap <span><span><span>m∗m^*</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span></span></span></span></span> around <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>.</p>\n<p>The resulting ciphertext <span><span><span>c∗c^*</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span></span></span></span></span> is not fresh anymore (just encrypted), and has a bigger noise than any of the previous ciphertexts that were inputs in the addition operation. In general, using non-fresh ciphertexts <span><span><span>c∗c^*</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span></span></span></span></span> to perform future operations will carry over the noise from all the previous operations.</p>\n<p>We'll analyse how the noise grows in a dedicated section at the end.</p>\n<h3>FHE Multiplication</h3>\n<p>As in the addition case, we want the multiplication to be done on the encrypted messages.</p>\n<p><img src=\"/galleries/bgv_scheme2023/fhe_mul_tiny.png\" alt=\"fhe_mul\"></p>\n<p>Before describing how we multiply two ciphertexts we need to reinterpret the decryption equation:\n<span><span><span>c0+c1⋅s≡m mod tc_0 + c_1 \\cdot \\red{s}  \\equiv m \\bmod t</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>≡</span><span></span></span><span><span></span><span>m</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>t</span></span></span></span></span>\nas a linear equation:\n<span><span><span>y=ax+by = ax + b</span><span aria-hidden=\"true\"><span><span></span><span>y</span><span></span><span>=</span><span></span></span><span><span></span><span>a</span><span>x</span><span></span><span>+</span><span></span></span><span><span></span><span>b</span></span></span></span></span>\nin <span><span><span>s\\red{s}</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span>.</p>\n<p>If we look at adding two such linear equations in <span><span><span>ss</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span> we obtain another linear  equation in <span><span><span>s\\red{s}</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span>:\n<span><span><span>c0+c1⋅s+c0′+c1′⋅s=(c0+c0′)⏟c0∗+(c1+c1′)⏟c1∗⋅sc_0 + c_1 \\cdot \\red{s} + c'_0  + c'_1 \\cdot \\red{s} = \\underbrace{(c_0 + c_0')}_{c^*_0}  + \\underbrace{(c_1 + c'_1)}_{c^*_1} \\cdot \\red{s}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span></span></span></span></span></p>\n<p>However, when multiplying two linear equations in <span><span><span>s\\red{s}</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span> we get a quadratic equation (<span><span><span>ax2+bx+cax^2 + bx + c</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>b</span><span>x</span><span></span><span>+</span><span></span></span><span><span></span><span>c</span></span></span></span></span>) in <span><span><span>s\\red{s}</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span>:</p>\n<div><span><span><span>(c0+c1⋅s)⏟=m mod t⋅(c0′+c1′⋅s)⏟=m′ mod t=c1⋅c1′⋅s2+(c0⋅c1′+c1⋅c0′)⋅s+c0⋅c0′\\begin{aligned}\n\\underbrace{(c_0 + c_1 \\cdot \\textcolor{red}{s} )}_{= m \\bmod t} \\cdot \\underbrace{(c'_0 + c'_1 \\cdot \\textcolor{red}{s} )}_{= m' \\bmod t} &#x26;= c_1 \\cdot c'_1 \\cdot \\textcolor{red}{s}^2 + (c_0 \\cdot c'_1 + c_1 \\cdot c'_0) \\cdot \\textcolor{red}{s} +c_0 \\cdot c'_0\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span><span><span><span><span></span><span><span><span>=</span><span>m</span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>t</span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span>)</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span><span><span><span><span></span><span><span><span>=</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>t</span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span>)</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>We can define <code>mul</code> in the following way:\n<code>mul(c, c') -> c*</code></p>\n<ul>\n<li><span><span><span>c0∗=c0⋅c0′c^*_0 = c_0 \\cdot c'_0</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></li>\n<li><span><span><span>c1∗=c0⋅c1′+c1⋅c0′c^*_1 = c_0 \\cdot c'_1 + c_1 \\cdot c'_0</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></li>\n<li><span><span><span>c2∗=c1⋅c1′c^*_2 = c_1 \\cdot c'_1</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></li>\n<li>return <span><span><span>c∗=(c0∗,c1∗,c2∗)c^* = (c^*_0, c^*_1, c^*_2)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span></li>\n</ul>\n<p><strong>Remarks</strong></p>\n<ul>\n<li>Similarly, as in addition, the noise of the resulting ciphertext <span><span><span>c∗c^*</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span></span></span></span></span> increases.</li>\n<li>We increase the number of ciphertext components by 1. This is not sustainable.</li>\n<li>Our decryption equation is linear, however after <code>mul</code> we have a quadratic decryption equation with 3 ciphertexts that doesn't play well with our idea of linear decryption equation.</li>\n</ul>\n<p>To solve the remarks the concept of <strong>relinearization</strong> is introduced.</p>\n<h2>Relinearization</h2>\n<p>The concept was explained in the <a href=\"https://bit-ml.github.io/blog/post/homomorphic-encryption-toy-implementation-in-python/\">BFV blogpost</a> as well.</p>\n<p><em>Intuition</em>: We want to transform the quadratic equation <span><span><span>c0∗+c1∗⋅s+c2∗⋅s2c^*_0 + c^*_1 \\cdot \\red{s} + c^*_2 \\cdot \\red{s}^2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> in <span><span><span>s\\red{s}</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span> into some other linear equation <span><span><span>c^0+c^1⋅s^\\hat c_0 + \\hat c_1 \\cdot \\red{\\hat s}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span>s</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span></span></span></span></span> in some other secret key <span><span><span>s^\\red{\\hat s}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span></span><span>s</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>In order to do this we need to give some extra information (a \"hint\") about the key <span><span><span>s\\red{s}</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span> that will help us get <span><span><span>s^\\red{\\hat s}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span></span><span>s</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>Consider the hint to be the pair:</p>\n<div><span><span><span>(ek0,ek1)=((a⋅s+te)+s2,−a)(ek_0, ek_1) = ((a \\cdot \\textcolor{red}{s} + t\\textcolor{darkgreen}{e}) + \\textcolor{red}{s}^2, -a)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>(</span><span>a</span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span>t</span><span>e</span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>,</span><span></span><span>−</span><span>a</span><span>)</span></span></span></span></span></div>\n<p>This is very similar to how the public key is generated and we can use the <code>PubKeyGen -> (pk0, pk1)</code> to generate it:\n<span><span><span>(pk0+s2,pk1)(pk_0 + \\red{s}^2, pk_1)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>,</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>\nIntuitively, we use a RLWE sample to hide <span><span><span>s2\\red{s}^2</span><span aria-hidden=\"true\"><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>Notice that:</p>\n<div><span><span><span>ek0+ek1⋅s=a⋅s+e+s2−a⋅s=s2+eek_0 + ek_1 \\cdot \\textcolor{red}{s} = \\cancel{\\textcolor{red}{a} \\cdot \\textcolor{red}{s}} + \\textcolor{darkgreen}{e} + \\textcolor{red}{s}^2 - \\cancel{\\textcolor{red}{a} \\cdot \\textcolor{red}{s}} = \\textcolor{red}{s}^2 + \\textcolor{darkgreen}{e}</span><span aria-hidden=\"true\"><span><span></span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span>a</span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>e</span><span></span><span>+</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>−</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span>a</span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>e</span></span></span></span></span></div>\n<p>The easiest way to get the term <span><span><span>c2∗s2c^*_2 \\red{s}^2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> from the above equation is to multiply it by <span><span><span>c2∗c^*_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. However, <span><span><span>c2∗c^*_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> is a random element in <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and it will yield some large noise <span><span><span>c2∗ec^*_2\\textcolor{darkgreen}{e}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>e</span></span></span></span></span>. So we have to do something smarter.</p>\n<h3>Key switching v1</h3>\n<p>Key switching is a variant of relinearization. We start with a ciphertext <span><span><span>cc</span><span aria-hidden=\"true\"><span><span></span><span>c</span></span></span></span></span>.</p>\n<p><strong>Idea</strong>:<br>\nSplit the ciphertext into multiple \"small\" ciphertexts (for now think of small as the ciphertext polynomials having small coefficents). We can do this by decomposing the ciphertext coefficients into a small base <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span>.</p>\n<p><em>Intuition</em>:<br>\nTo build an intuition, we can take the most common bases used in representing numbers:</p>\n<ul>\n<li>Base 10: <span><span><span>12310=3⋅100+2⋅101+1⋅102123_{10} = 3 \\cdot 10^0 + 2 \\cdot 10 ^1 + 1 \\cdot 10^2</span><span aria-hidden=\"true\"><span><span></span><span>1</span><span>2</span><span><span>3</span><span><span><span><span><span><span></span><span><span><span>1</span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>3</span><span></span><span>⋅</span><span></span></span><span><span></span><span>1</span><span><span>0</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>2</span><span></span><span>⋅</span><span></span></span><span><span></span><span>1</span><span><span>0</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span></span><span>⋅</span><span></span></span><span><span></span><span>1</span><span><span>0</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span></li>\n<li>Base 2: <span><span><span>1210=11002=1⋅23+1⋅22+0⋅21+0⋅2012_{10} = 1100_2 = 1 \\cdot 2^3 + 1 \\cdot 2^2 + 0 \\cdot 2^1 + 0 \\cdot 2^0</span><span aria-hidden=\"true\"><span><span></span><span>1</span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>1</span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>1</span><span>1</span><span>0</span><span><span>0</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>1</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>0</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>0</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></li>\n</ul>\n<p>Programmatically, this can be done by dividing the integer by the base <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> <em>repeatedly</em> and collecting the remainders.</p>\n<p>In Python code:</p>\n<div><pre><code><span>def</span><span> </span><span>int2base</span><span>(</span>x<span>:</span><span> </span><span>int</span><span>,</span><span> </span>base<span>:</span><span> </span><span>int</span><span>)</span><span> </span><span>-</span><span>></span><span> </span>List<span>[</span><span>int</span><span>]</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>digits<span> </span><span>=</span><span> </span><span>[</span><span>]</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>while</span><span> </span>x<span> </span><span>></span><span> </span><span>0</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>q<span>,</span><span> </span>r<span> </span><span>=</span><span> </span><span>divmod</span><span>(</span>x<span>,</span><span> </span>base<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>digits<span>.</span>append<span>(</span>r<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>x<span> </span><span>=</span><span> </span>q<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span>digits<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span></span>\n<span></span><span>print</span><span>(</span>int2base<span>(</span><span>123</span><span>,</span><span> </span><span>10</span><span>)</span><span>)</span><span></span>\n<span></span><span>#<span> </span>[3,<span> </span>2,<span> </span>1]</span><span></span>\n<span></span><span>print</span><span>(</span>int2base<span>(</span><span>12</span><span>,</span><span> </span><span>2</span><span>)</span><span>)</span><span></span>\n<span></span><span>#<span> </span>[0,<span> </span>0,<span> </span>1,<span> </span>1]</span>\n</code></pre></div>\n<p>A ciphertext component <span><span><span>c∈Rqc \\in R_q</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span></span><span>∈</span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> is a polynomial of degree less than <span><span><span>nn</span><span aria-hidden=\"true\"><span><span></span><span>n</span></span></span></span></span>, with coefficients in <span><span><span>{0,1,..,q−1}\\{0,1,..,q-1\\}</span><span aria-hidden=\"true\"><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>,</span><span></span><span>.</span><span>.</span><span>,</span><span></span><span>q</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>}</span></span></span></span></span>, which we denote as follows:\n<span><span><span>c(x)=c[0]+c[1]x+...+c[n−1]xn−1c(x) = c[0] + c[1]x + ... + c[n-1]x^{n-1}</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>c</span><span>[</span><span>0</span><span>]</span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span>[</span><span>1</span><span>]</span><span>x</span><span></span><span>+</span><span></span></span><span><span></span><span>.</span><span>.</span><span>.</span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span>[</span><span>n</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>]</span><span><span>x</span><span><span><span><span><span><span></span><span><span><span>n</span><span>−</span><span>1</span></span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p>We want to write the coefficients <span><span><span>(c[0],...,c[n−1])(c[0], ..., c[n-1])</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>c</span><span>[</span><span>0</span><span>]</span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span>,</span><span></span><span>c</span><span>[</span><span>n</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>]</span><span>)</span></span></span></span></span> in base <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span>. Since any coefficient is less than <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>, this decomposition has at most <span><span><span>⌊log⁡Tq⌋+1\\lfloor \\log_T q \\rfloor + 1</span><span aria-hidden=\"true\"><span><span></span><span>⌊</span><span><span>lo<span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>q</span><span>⌋</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> terms. For example <span><span><span>c[0]=∑i=0⌊log⁡Tq⌋Tic[0](i)c[0] = \\sum_{i=0}^{\\lfloor \\log_T q \\rfloor} T^i c[0]^{(i)}</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span>[</span><span>0</span><span>]</span><span></span><span>=</span><span></span></span><span><span></span><span><span>∑</span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span><span>⌊</span><span><span><span>l</span><span>o</span><span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>q</span><span>⌋</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span>c</span><span>[</span><span>0</span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span></span> where <span><span><span>c[0](i)c[0]^{(i)}</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span>[</span><span>0</span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span></span> is the corresponding digit <span><span><span>&#x3C;T&#x3C; T</span><span aria-hidden=\"true\"><span><span></span><span>&#x3C;</span><span></span></span><span><span></span><span>T</span></span></span></span></span> in the decomposition. Using these digits we can construct the polynomials <span><span><span>c(i)c^{(i)}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span></span>:</p>\n<div><span><span><span>c(i)(x)=c[0](i)+c[1](i)x+...+c[n−1](i)xn−1c^{(i)}(x) = c[0]^{(i)} + c[1]^{(i)}x + ... + c[n-1]^{(i)}x^{n-1}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>c</span><span>[</span><span>0</span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span>[</span><span>1</span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span><span>x</span><span></span><span>+</span><span></span></span><span><span></span><span>.</span><span>.</span><span>.</span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span>[</span><span>n</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span><span><span>x</span><span><span><span><span><span><span></span><span><span><span>n</span><span>−</span><span>1</span></span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>Then using these polynomials we can decompose the original polynomial <span><span><span>cc</span><span aria-hidden=\"true\"><span><span></span><span>c</span></span></span></span></span>:</p>\n<div><span><span><span>c=∑i=0⌊log⁡Tq⌋Ti⋅c(i) mod qc = \\sum_{i=0}^{\\lfloor \\log_T q \\rfloor} T^i  \\cdot c^{(i)} \\bmod q</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>⌊</span><span><span><span>l</span><span>o</span><span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>q</span><span>⌋</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>q</span></span></span></span></span></div>\n<p>The polynomials <span><span><span>c(i)c^{(i)}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span></span> are elements of <span><span><span>RTR_T</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and for a reasonable small <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> they have small coefficients (<span><span><span>&#x3C;T&#x3C; T</span><span aria-hidden=\"true\"><span><span></span><span>&#x3C;</span><span></span></span><span><span></span><span>T</span></span></span></span></span>). For each one of them we generate the hints:</p>\n<div><span><span><span>(ek0(i),ek1(i))=(ai⋅s+tei+Tis2,−ai)(ek_0^{(i)}, ek_1^{(i)}) = (a_i \\cdot \\textcolor{red}{s} + t\\textcolor{darkgreen}{e_i} + T^i\\textcolor{red}{s}^2, -a_i)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>,</span><span></span><span>−</span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span></div>\n<p>with <span><span><span>ai←RRqa_i \\xleftarrow{R} R_q</span><span aria-hidden=\"true\"><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span><span><span><span><span><span></span><span><span><span>R</span></span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and <span><span><span>ei←χ\\textcolor{darkgreen}{e_i} \\leftarrow \\chi</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>←</span><span></span></span><span><span></span><span>χ</span></span></span></span></span>.</p>\n<p>Now we go back to our ciphertext <span><span><span>c∗=(c0∗,c1∗,c2∗)c^* = (c_0^*, c_1^*, c_2^*)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>, the result of <code>EvalMul</code>. We decompose <span><span><span>c2∗c^*_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> in the base <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> and we get:</p>\n<div><span><span><span>c2∗=∑i=0⌊log⁡Tq⌋Ti⋅c2∗(i) mod qc^*_2 = \\sum_{i=0}^{\\lfloor \\log_T q \\rfloor} T^i  \\cdot {c^*_2}^{(i)} \\bmod q</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>⌊</span><span><span><span>l</span><span>o</span><span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>q</span><span>⌋</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>q</span></span></span></span></span></div>\n<p>Then we construct the new ciphertext <span><span><span>c^\\hat c</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span></span></span></span></span> with the <strong>two</strong> components:</p>\n<div><span><span><span>c^0=c0∗+∑i=0⌊log⁡Tq⌋ek0(i)⋅c2∗(i)=c0∗+∑i=0⌊log⁡Tq⌋((ai⋅s+tei)+Tis2)⋅c2∗(i)c^1=c1∗+∑i=0⌊log⁡Tq⌋ek1(i)⋅c2∗(i)=c1∗+∑i=0⌊log⁡Tq⌋−ai⋅c2∗(i)\\begin{aligned}\n\\hat c_0 &#x26;= c^*_0 + \\sum_{i=0}^{\\lfloor \\log_T q \\rfloor} ek_0^{(i)} \\cdot {c^*_2}^{(i)} = c^*_0 + \\sum_{i=0}^{\\lfloor \\log_T q \\rfloor} ((a_i \\cdot \\textcolor{red}{s} + t\\textcolor{darkgreen}{e_i}) + T^i\\textcolor{red}{s}^2 )\\cdot {c^*_2}^{(i)}\\\\\n\\hat c_1 &#x26;= c^*_1 + \\sum_{i=0}^{\\lfloor \\log_T q \\rfloor} ek_1^{(i)} \\cdot {c^*_2}^{(i)} = c^*_1 + \\sum_{i=0}^{\\lfloor \\log_T q \\rfloor} -a_i \\cdot {c^*_2}^{(i)} \n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>⌊</span><span><span><span>l</span><span>o</span><span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>q</span><span>⌋</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>⌊</span><span><span><span>l</span><span>o</span><span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>q</span><span>⌋</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span>(</span><span>(</span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>⌊</span><span><span><span>l</span><span>o</span><span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>q</span><span>⌋</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>⌊</span><span><span><span>l</span><span>o</span><span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>q</span><span>⌋</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>−</span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>Using the above relations, we obtain the following linear equation:</p>\n<div><span><span><span>c^0+c^1⋅s=c0∗+c1∗⋅s+c2∗⋅s2⏟m⋅m′+∑i=0⌊log⁡Tq⌋tei⋅c2∗(i)⏟relinearization error\\hat c_0 + \\hat c_1 \\cdot \\textcolor{red}{s} = \\underbrace{c^*_0 + c^*_1 \\cdot \\textcolor{red}{s} + c^*_2 \\cdot \\textcolor{red}{s}^2}_{m \\cdot m'} + \\underbrace{ \\sum_{i=0}^{\\lfloor \\log_T q \\rfloor} t\\textcolor{darkgreen}{e_i} \\cdot {c^*_2}^{(i)}}_{\\text{relinearization error}}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>m</span><span>⋅</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span><span>relinearization error</span></span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>⌊</span><span><span><span>l</span><span>o</span><span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>q</span><span>⌋</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></div>\n<p>(the terms containing <span><span><span>ai⋅sa_i \\cdot \\red{s}</span><span aria-hidden=\"true\"><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span></span></span></span></span> from <span><span><span>c^0\\hat c_0</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and <span><span><span>−ai⋅s-a_i \\cdot \\red{s}</span><span aria-hidden=\"true\"><span><span></span><span>−</span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span></span></span></span></span> from <span><span><span>c^1⋅s\\hat c_1 \\cdot \\red{s}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span></span></span></span></span>  cancel out, <span><span><span>c2∗c^*_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> is reconstructed and we are left with an error term).</p>\n<p>Because the relinearization error is a multiple of <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span>, it goes away when we decrypt and reduce <span><span><span> mod t\\bmod t</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>t</span></span></span></span></span> as long as the relinearization error does not wrap <span><span><span>m∗=m⋅m′m^* = m\\cdot m'</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>m</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> around <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>.</p>\n<p><strong>Remarks</strong></p>\n<ul>\n<li>We need to relinearize after a multiplication.</li>\n<li>A smaller <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> means we have a smaller noise, but more relinearization keys are needed.</li>\n<li><span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> is chosen based on what we want to optimize. We usually want to choose <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> to introduce a noise around the size of the noise in the ciphertexts. Once the noise grows we can use <span><span><span>T2T^2</span><span aria-hidden=\"true\"><span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> or something else. We can also choose a big <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> at the start (which introduces lots of starting noise) and we don't need to change it later.</li>\n</ul>\n<h3>Modulus switching</h3>\n<p><strong>Task</strong>:\nYou want to reduce the noise that accumulates in the ciphertext, after performing homomorphic operations. The modulus switching technique allows us to decrease the noise, to ensure the decryption is still correct after performing homomorphic operations. More analysis is provided in a dedicated section below.</p>\n<p><strong>Idea</strong>: The technique uses two moduli <span><span><span>Q,qQ, q</span><span aria-hidden=\"true\"><span><span></span><span>Q</span><span>,</span><span></span><span>q</span></span></span></span></span> with <span><span><span>q&#x3C;Qq &#x3C; Q</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span></span><span>&#x3C;</span><span></span></span><span><span></span><span>Q</span></span></span></span></span> and <span><span><span>q∣Qq | Q</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span>∣</span><span>Q</span></span></span></span></span>. This  involves changing the ring where the ciphertexts live, <span><span><span>RQR_Q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, with a ring <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, that is parametrized by the smaller modulus. When you perform this change, the coefficient ring  <span><span><span>ZQ\\mathbb Z_Q</span><span aria-hidden=\"true\"><span><span></span><span><span>Z</span><span><span><span><span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> is \"approximated\" by some ring <span><span><span>Zq\\mathbb Z_q</span><span aria-hidden=\"true\"><span><span></span><span><span>Z</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, in the intuitive sense that the numbers become smaller (the numbers are scaled down by some factor). As we will see this means that the noise will be smaller in absolute value. Although, the noise will relatively  stay the same, since <span><span><span>q&#x3C;Qq &#x3C; Q</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span></span><span>&#x3C;</span><span></span></span><span><span></span><span>Q</span></span></span></span></span>, we mostly care about the magnitude of the noise, especially in multiplications.</p>\n<p>You can perform this repeatedly with many moduli <span><span><span>{q0,q1,...,qL}\\{q_0, q_1, ..., q_L\\}</span><span aria-hidden=\"true\"><span><span></span><span>{</span><span><span>q</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>q</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span>,</span><span></span><span><span>q</span><span><span><span><span><span><span></span><span><span>L</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>}</span></span></span></span></span> with decreasing values to lower the noise after each multiplication.</p>\n<p>The easiest way to do this is to scale down the ciphertext's components by <span><span><span>q/Qq / Q</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span>/</span><span>Q</span></span></span></span></span> and <strong>smartly round</strong> in a way to keep the decryption equation correct. To ensure this, we want the scaling to keep the following propriety: <span><span><span>c~i=ci mod t\\tilde c_i = c_i \\bmod t</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>t</span></span></span></span></span> , where <span><span><span>c~i≈(q/Q)ci\\tilde c_i \\approx (q / Q) c_i</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>(</span><span>q</span><span>/</span><span>Q</span><span>)</span><span><span>c</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> where <span><span><span>i∈{0,1}i \\in \\{0, 1\\}</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span></span><span>∈</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>}</span></span></span></span></span>.</p>\n<p>The two requirements that we want to have are</p>\n<ol>\n<li>The decryption should be correct (decryption mod <span><span><span>QQ</span><span aria-hidden=\"true\"><span><span></span><span>Q</span></span></span></span></span> should be the same as decryption mod <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>): <span><span><span>[c0+c1⋅s]Q=[c~0+c~1⋅s]q mod t[c_0 + c_1 \\cdot \\red{s}]_Q = [\\tilde c_0 + \\tilde c_1 \\cdot \\red{s}]_q \\bmod t</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span><span>]</span><span><span><span><span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>[</span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>t</span></span></span></span></span>.</li>\n<li>The noise scales down.</li>\n</ol>\n<p><strong>Rounding</strong><br>\nIn order for the decryption to be correct we must adjust <span><span><span>cic_i</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> before scaling by  <span><span><span>q/Qq / Q</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span>/</span><span>Q</span></span></span></span></span>. To do this we add a <strong>small correction term</strong> <span><span><span>δi\\delta_i</span><span aria-hidden=\"true\"><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> per component. We require <span><span><span>δi\\delta_i</span><span aria-hidden=\"true\"><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> to:</p>\n<ol>\n<li>Only influence the error, hence <span><span><span>δi≡0 mod t\\delta_i \\equiv 0 \\bmod t</span><span aria-hidden=\"true\"><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>≡</span><span></span></span><span><span></span><span>0</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>t</span></span></span></span></span> (it will disappear when decrypting)</li>\n<li>Make the ciphertext to be divisible by <span><span><span>Q/q Q / q</span><span aria-hidden=\"true\"><span><span></span><span>Q</span><span>/</span><span>q</span></span></span></span></span>:\n<div><span><span><span>ci+δi≡0 mod Qq⇒δi≡−ci mod Qqc_i + \\delta_i \\equiv 0 \\bmod \\dfrac Q q  \\Rightarrow \\delta_i \\equiv -c_i \\bmod \\dfrac Q q</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>≡</span><span></span></span><span><span></span><span>0</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span>q</span></span><span><span></span><span></span></span><span><span></span><span>Q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>⇒</span><span></span></span><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>≡</span><span></span></span><span><span></span><span>−</span><span><span>c</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span>q</span></span><span><span></span><span></span></span><span><span></span><span>Q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></div>\n</li>\n</ol>\n<p>One easy choice to set the correction terms such that both properties hold is <span><span><span>δi=t[−cit−1]Q/q\\delta_i = t [-c_i t^{-1}]_{Q/q}</span><span aria-hidden=\"true\"><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>t</span><span>[</span><span>−</span><span><span>c</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>−</span><span>1</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>Q</span><span>/</span><span>q</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> where <span><span><span>t−1t^{-1}</span><span aria-hidden=\"true\"><span><span></span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>−</span><span>1</span></span></span></span></span></span></span></span></span></span></span></span></span> is the inverse of <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span> modulo <span><span><span>Q/qQ / q</span><span aria-hidden=\"true\"><span><span></span><span>Q</span><span>/</span><span>q</span></span></span></span></span>.</p>\n<p>In the end, we define the components <span><span><span>c~i\\tilde c_i</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> of the  modulus switched ciphertext:\n<span><span><span>c~i=qQ(ci+δi)\\tilde c_i = \\dfrac q Q(c_i + \\delta_i)</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span></p>\n<p>Now, let's check the decryption equation is actually correct. For a <span><span><span>k∈Rk \\in R</span><span aria-hidden=\"true\"><span><span></span><span>k</span><span></span><span>∈</span><span></span></span><span><span></span><span>R</span></span></span></span></span>:</p>\n<div><span><span><span>[c~0+c~1⋅s]q=c~0+c~1⋅s−kq=qQ(c0+δ0)+qQ(c1+δ1)⋅s−kq=qQ(c0+c1⋅s+δ0+δ1⋅s)−kq=qQ([c0+c1⋅s]Q+kQ+δ0+δ1⋅s)−kq=qQ[c0+c1⋅s]Q⏟≡m mod t+qQ(δ0+δ1⋅s)⏟≡0 mod t+kq−kq≡qQm mod t\\begin{aligned}\n[\\tilde c_0 + \\tilde c_1 \\cdot \\textcolor{red}{s}]_q \n&#x26;= \\tilde c_0 + \\tilde c_1 \\cdot \\textcolor{red}{s} - kq \\\\\n&#x26;= \\dfrac q Q(c_0 + \\delta_0) + \\dfrac q Q (c_1 + \\delta_1) \\cdot \\textcolor{red}{s} - kq \\\\\n&#x26;= \\dfrac q Q(c_0 + c_1 \\cdot \\textcolor{red}{s} + \\delta_0 + \\delta_1 \\cdot \\textcolor{red}{s}) - kq \\\\\n&#x26;= \\dfrac q Q([{c_0 + c_1 \\cdot \\textcolor{red}{s}}]_Q + kQ + \\delta_0 + \\delta_1 \\cdot \\textcolor{red}{s}) - kq \\\\ \n&#x26;= \\dfrac q Q \\underbrace{[{c_0 + c_1 \\cdot \\textcolor{red}{s}}]_Q}_{\\equiv m \\bmod t}  + \\underbrace{\\dfrac q Q (\\delta_0 + \\delta_1 \\cdot \\textcolor{red}{s})}_{\\equiv 0 \\bmod t} + kq - kq \\\\\n&#x26;\\equiv \\dfrac q Q m \\bmod t\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>[</span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>−</span><span></span><span>k</span><span>q</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>−</span><span></span><span>k</span><span>q</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span>)</span><span></span><span>−</span><span></span><span>k</span><span>q</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span>[</span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>k</span><span>Q</span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span>)</span><span></span><span>−</span><span></span><span>k</span><span>q</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span><span><span><span><span></span><span><span><span>≡</span><span>m</span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>t</span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span>[</span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>+</span><span></span><span><span><span><span><span><span></span><span><span><span>≡</span><span>0</span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>t</span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span>)</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>+</span><span></span><span>k</span><span>q</span><span></span><span>−</span><span></span><span>k</span><span>q</span></span></span><span><span></span><span><span></span><span></span><span>≡</span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>m</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>When doing <span><span><span>c0+c1⋅s=[c0+c1⋅s]Q+kQc_0 + c_1 \\cdot \\red{s} = [c_0 + c_1 \\cdot \\red{s}]_Q + kQ</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>=</span><span></span></span><span><span></span><span>[</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span><span>]</span><span><span><span><span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>k</span><span>Q</span></span></span></span></span>\nwe mention that <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span> is the same as in <span><span><span>[c~0+c~1⋅s]q=c~0+c~1⋅s−kq[\\tilde c_0 + \\tilde c_1 \\cdot \\red{s}]_q = \\tilde c_0 + \\tilde c_1 \\cdot \\red{s} - kq</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>−</span><span></span></span><span><span></span><span>k</span><span>q</span></span></span></span></span> under some conditions (see lemma 1 from <a href=\"https://eprint.iacr.org/2011/277.pdf\">here</a>).</p>\n<p>In the end we decrypt <span><span><span>qQm\\dfrac q Q m</span><span aria-hidden=\"true\"><span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>m</span></span></span></span></span> instead of <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span>. In practice this can be solved by multiplying by <span><span><span>Q/qQ/q</span><span aria-hidden=\"true\"><span><span></span><span>Q</span><span>/</span><span>q</span></span></span></span></span> before encryption or after decryption, or to take <span><span><span>Q/q≡1 mod tQ/q \\equiv 1 \\bmod t</span><span aria-hidden=\"true\"><span><span></span><span>Q</span><span>/</span><span>q</span><span></span><span>≡</span><span></span></span><span><span></span><span>1</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>t</span></span></span></span></span> (however such a <span><span><span>Q/qQ/q</span><span aria-hidden=\"true\"><span><span></span><span>Q</span><span>/</span><span>q</span></span></span></span></span> can be harder to find).</p>\n<h3>Key switching v2</h3>\n<p>Now that we know about modulus switching we introduce a second version to do key switching in BGV. Recall that the key switching technique is used in relinearization, for decreasing the size of the ciphertext obtained in multiplication.</p>\n<p><strong>Idea</strong>: Given two moduli <span><span><span>q,Qq, Q</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span>,</span><span></span><span>Q</span></span></span></span></span>  with <span><span><span>q&#x3C;Qq &#x3C; Q</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span></span><span>&#x3C;</span><span></span></span><span><span></span><span>Q</span></span></span></span></span> and <span><span><span>q∣Qq | Q</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span>∣</span><span>Q</span></span></span></span></span>, we start with elements in <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and we make a detour in a ring <span><span><span>RQR_Q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> with a bigger modulus <span><span><span>QQ</span><span aria-hidden=\"true\"><span><span></span><span>Q</span></span></span></span></span> where we perform our relinearization. Then we perform modulus switching to go back to our small ring <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>We generate the <em>hint</em>:</p>\n<div><span><span><span>(ek0,ek1)=((a⋅s+te+Qqs2),−a) mod Q(ek_0, ek_1) = ((a \\cdot \\textcolor{red}{s} + t\\textcolor{darkgreen}{e} + \\frac{Q}{q} \\textcolor{red}{s}^2), -a) \\bmod Q</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>(</span><span>a</span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span>t</span><span>e</span><span></span><span>+</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>−</span><span>a</span><span>)</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>Q</span></span></span></span></span></div>\n<p>Recall that <span><span><span>c∗=(c0∗,c1∗,c2∗)c^* = (c^*_0, c^*_1, c^*_2)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> is the result of the <code>mul</code>. Then we compute the components of the new ciphertext <span><span><span>c^\\hat c</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span></span></span></span></span>:</p>\n<div><span><span><span>c^0=Qqc0∗+c2∗⋅ek0 mod Qc^1=Qqc1∗+c2∗⋅ek1 mod Q\\begin{aligned}\n\\hat c_0 &#x26;= \\frac Q q c_0^* + c_2^* \\cdot ek_0 \\bmod Q\\\\\n\\hat c_1 &#x26;= \\frac Q q c_1^* + c_2^* \\cdot ek_1 \\bmod Q\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span></span><span><span><span><span><span><span></span><span>q</span></span><span><span></span><span></span></span><span><span></span><span>Q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span><span>Q</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span></span><span><span><span><span><span><span></span><span>q</span></span><span><span></span><span></span></span><span><span></span><span>Q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>Lastly, we scale them both using modulus switching: <span><span><span>c^i=qQ(c^i+δi)\\hat c_i = \\dfrac q Q (\\hat c_i + \\delta_i)</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> with <span><span><span>δi=t[−cit−1]Q/q\\delta_i = t[-c_i t^{-1}]_{Q/q}</span><span aria-hidden=\"true\"><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>t</span><span>[</span><span>−</span><span><span>c</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>−</span><span>1</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>Q</span><span>/</span><span>q</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, like before.</p>\n<p>The relinearization equation looks like this:</p>\n<div><span><span><span>c^0+c^1⋅s=c0∗+c1∗⋅s+c2∗⋅s2⏟m⋅m′+qQ(tc2∗⋅e+δ0+δ1⋅s)⏟relinearization error\\hat c_0 + \\hat c_1 \\cdot \\textcolor{red}{s} = \\underbrace{c_0^* + c_1^* \\cdot \\textcolor{red}{s} + c_2^* \\cdot \\textcolor{red}{s}^2}_{m\\cdot m'} + \\underbrace{\\dfrac q Q (t c_2^* \\cdot \\textcolor{darkgreen}{e} + \\delta_0 + \\delta_1 \\cdot \\textcolor{red}{s})}_{\\text{relinearization error}}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>m</span><span>⋅</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span><span>relinearization error</span></span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span>t</span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>e</span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span>)</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></div>\n<p>Because the relinearization error is a multiple of <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span> (remember that we chose <span><span><span>δi\\delta_i</span><span aria-hidden=\"true\"><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> to be multiples of <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span> too, to not influence the error), it will go away when we decrypt and reduce <span><span><span> mod t\\bmod t</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>t</span></span></span></span></span> as long as the relinearization error does not wrap <span><span><span>m∗=m⋅m′m^* = m\\cdot m'</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>∗</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>m</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> around <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>.</p>\n<div><span><span><span>c^0+c^1⋅s=qQ(Qqc0∗+c2∗⋅ek0+δ0)+(qQ(Qqc1∗+c2∗⋅ek1)+δ1)⋅s=qQ(Qqc0∗+c2∗⋅(a⋅s+te+Qqs2)+δ0)++(qQ(Qqc1∗+c2∗⋅(−a))+δ1)⋅s=c0∗+c1∗⋅s+c2∗⋅s2+qQ(tc2∗⋅e+δ0+δ1⋅s)=mm′ mod t\\begin{aligned}\n\\hat c_0 + \\hat c_1 \\cdot \\textcolor{red}{s} \n&#x26;= \\frac{q}{Q} \\left( \\frac{Q}{q} c_0^* + c_2^* \\cdot ek_0 + \\delta_0 \\right) + \\left(\\frac{q}{Q} \\left ( \\frac{Q}{q} c_1^*  + c_2^* \\cdot ek_1 \\right) + \\delta_1 \\right) \\cdot \\textcolor{red}{s} \\\\\n&#x26;= \\frac{q}{Q} \\left( \\frac{Q}{q} c_0^* + c_2^* \\cdot \\left( a \\cdot \\textcolor{red}{s} + t\\textcolor{darkgreen}{e} + \\frac{Q}{q} \\textcolor{red}{s}^2 \\right) + \\delta_0 \\right) + \\\\\n&#x26;+ \\left(\\frac{q}{Q} \\left ( \\frac{Q}{q} c_1^*  + c_2^* \\cdot (-a)\\right)  + \\delta_1 \\right) \\cdot \\textcolor{red}{s} \\\\\n&#x26;= c_0^* + c_1^* \\cdot \\textcolor{red}{s} + c_2^* \\cdot s^2 + \\frac{q}{Q} (tc_2^* \\cdot \\textcolor{darkgreen}{e} + \\delta_0 + \\delta_1 \\cdot \\textcolor{red}{s}) \\\\\n&#x26;= mm' \\bmod t\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>^</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>Q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span><span><span>(</span></span><span><span></span><span><span><span><span><span><span></span><span><span>q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>)</span></span></span><span></span><span>+</span><span></span><span><span><span>(</span></span><span><span></span><span><span><span><span><span><span></span><span><span>Q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span><span><span>(</span></span><span><span></span><span><span><span><span><span><span></span><span><span>q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>e</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>)</span></span></span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>)</span></span></span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>Q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span><span><span>(</span></span><span><span></span><span><span><span><span><span><span></span><span><span>q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span><span>(</span></span><span>a</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span>t</span><span>e</span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>)</span></span></span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>)</span></span></span><span></span><span>+</span></span></span><span><span></span><span><span></span><span></span><span>+</span><span></span><span><span><span>(</span></span><span><span></span><span><span><span><span><span><span></span><span><span>Q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span><span><span>(</span></span><span><span></span><span><span><span><span><span><span></span><span><span>q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>(</span><span>−</span><span>a</span><span>)</span><span><span>)</span></span></span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>)</span></span></span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>Q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span>t</span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>e</span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<h2>Noise analysis</h2>\n<p>The main motivation of analysing the noise growth is because we want to set the parameters of the scheme based on it.</p>\n<p>Relevant papers:</p>\n<ul>\n<li><a href=\"https://www.esat.kuleuven.be/cosic/publications/thesis-316.pdf\">Ilia Iliashenko thesis</a></li>\n<li><a href=\"https://eprint.iacr.org/2015/889.pdf\">CS15</a></li>\n<li><a href=\"https://eprint.iacr.org/2019/493.pdf\">Evaluating the effectiveness of heuristic worst-case noise analysis in FHE</a></li>\n<li><a href=\"https://eprint.iacr.org/2012/099.pdf\">GHS</a></li>\n<li><a href=\"https://eprint.iacr.org/2022/706.pdf\">Finding and Evaluating Parameters for BGV</a></li>\n</ul>\n<h3>Measuring Noise</h3>\n<p>When doing operations (such as addition, multiplication) with noisy ciphertexts, the total noise accumulates. In the end we want our decryption to be correct. However, this can only happen if the accumulated noise does not exceed some <strong>bound</strong>.</p>\n<p><img src=\"/galleries/bgv_scheme2023/fhe_noise_tiny.png\" alt=\"fhe_noise\"></p>\n<p><em>Intuition</em>: We want to \"measure\" this accumulated noise by looking at \"how much\" a polynomial can impact an operation it's involved in. For example, we can analyze the impact of the polynomials <span><span><span>eie_i</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> which represent the RLWE noise or of the secret <span><span><span>ss</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span>. We can represent the polynomial's impact with a number.</p>\n<p>We can \"measure\" the impact of the polynomials using the:</p>\n<ol>\n<li><strong>Infinity norm</strong>: <span><span><span>∥a∥∞=max⁡∣ai∣\\|a\\|_\\infty = \\max{|a_i|}</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span>a</span><span><span>∥</span><span><span><span><span><span><span></span><span><span>∞</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>max</span><span></span><span><span>∣</span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∣</span></span></span></span></span></span>, which is the value of the biggest coefficient in absolute value.</li>\n<li><strong>Canonical norm</strong>: <span><span><span>∥a∥can\\can a</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span>a</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span></span></span></span></span>. In order to define it we use the so called <strong>canonical embedding</strong> of the polynomial.</li>\n</ol>\n<p>While the infinity norm is easy to understand, the canonical embedding is a bit more mathematically involved. Instead of searching for a way to measure the impact of a polynomial <span><span><span>a∈Ra \\in R</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span></span><span>∈</span><span></span></span><span><span></span><span>R</span></span></span></span></span>, we transfer the polynomial in another space, such as <span><span><span>Cn\\mathbb C^n</span><span aria-hidden=\"true\"><span><span></span><span><span>C</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span>, and we search for a better measure there.</p>\n<p>Recall that we work with polynomials from the ring <span><span><span>Rq=Zq[X]/(Xn+1)R_q = \\mathbb Z_q[X]/(X^n + 1)</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>Z</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>X</span><span>]</span><span>/</span><span>(</span><span><span>X</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span></span></span></span></span> with <span><span><span>nn</span><span aria-hidden=\"true\"><span><span></span><span>n</span></span></span></span></span> a power of <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span>.</p>\n<p><strong>Canonical embedding</strong><br>\nWe have the quotient polynomial <span><span><span>Xn+1X^n + 1</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> of <span><span><span>RR</span><span aria-hidden=\"true\"><span><span></span><span>R</span></span></span></span></span> which has the complex roots <span><span><span>{ζ0,…,ζn−1}\\{\\zeta_0, \\dots, \\zeta_{n-1}\\}</span><span aria-hidden=\"true\"><span><span></span><span>{</span><span><span>ζ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span><span>ζ</span><span><span><span><span><span><span></span><span><span><span>n</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>}</span></span></span></span></span> with <span><span><span>ζin=−1⇒ζi2n=1\\zeta_i^n = -1 \\Rightarrow \\zeta_i^{2n} = 1</span><span aria-hidden=\"true\"><span><span></span><span><span>ζ</span><span><span><span><span><span><span></span><span><span>i</span></span></span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>−</span><span>1</span><span></span><span>⇒</span><span></span></span><span><span></span><span><span>ζ</span><span><span><span><span><span><span></span><span><span>i</span></span></span><span><span></span><span><span><span>2</span><span>n</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>1</span></span></span></span></span>.<br>\nThen we take a polynomial <span><span><span>a∈Ra \\in R</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span></span><span>∈</span><span></span></span><span><span></span><span>R</span></span></span></span></span>:<br>\n<span><span><span>a(X)=a0+a1X+...an−1Xn−1a(X) = a_0 + a_1X + ... a_{n-1}X^{n-1}</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span>(</span><span>X</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>X</span><span></span><span>+</span><span></span></span><span><span></span><span>.</span><span>.</span><span>.</span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>n</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>n</span><span>−</span><span>1</span></span></span></span></span></span></span></span></span></span></span></span></span>\nand we evaluate <span><span><span>aa</span><span aria-hidden=\"true\"><span><span></span><span>a</span></span></span></span></span> in every root <span><span><span>ζi\\zeta_i</span><span aria-hidden=\"true\"><span><span></span><span><span>ζ</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. This leads to a vector <span><span><span>(a(ζ0),...a(ζn−1))∈Cn\\left(a(\\zeta_0), ... a(\\zeta_{n-1})\\right) \\in \\mathbb C^n</span><span aria-hidden=\"true\"><span><span></span><span><span>(</span><span>a</span><span>(</span><span><span>ζ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span>a</span><span>(</span><span><span>ζ</span><span><span><span><span><span><span></span><span><span><span>n</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>)</span></span><span></span><span>∈</span><span></span></span><span><span></span><span><span>C</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span>. We call this vector the <strong>canonical embedding</strong> of <span><span><span>aa</span><span aria-hidden=\"true\"><span><span></span><span>a</span></span></span></span></span>.<br>\nThe <a href=\"https://eprint.iacr.org/2012/230.pdf\">canonical embedding</a> is defined as</p>\n<div><span><span><span>σ:R→Cn,σ(a)=(a(ζ0),...a(ζn−1))\\sigma: R \\to \\mathbb C^n,\n\\quad \\sigma(a) = \\left(a(\\zeta_0), ... a(\\zeta_{n-1})\\right)</span><span aria-hidden=\"true\"><span><span></span><span>σ</span><span></span><span>:</span><span></span></span><span><span></span><span>R</span><span></span><span>→</span><span></span></span><span><span></span><span><span>C</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span>,</span><span></span><span></span><span>σ</span><span>(</span><span>a</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>(</span><span>a</span><span>(</span><span><span>ζ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span>a</span><span>(</span><span><span>ζ</span><span><span><span><span><span><span></span><span><span><span>n</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>)</span></span></span></span></span></span></div>\n<p><strong>Canonical norm</strong><br>\nSince now we have obtained a new vector in <span><span><span>Cn\\mathbb C^n</span><span aria-hidden=\"true\"><span><span></span><span><span>C</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span> we can look at its infinity norm and define the <strong>canonical norm</strong> <span><span><span>∥a∥can=∥σ(a)∥∞\\can a = \\|\\sigma(a)\\|_\\infty</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span>a</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>∥</span><span>σ</span><span>(</span><span>a</span><span>)</span><span><span>∥</span><span><span><span><span><span><span></span><span><span>∞</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>In practice, the canonical norm is used to compute the noise bounds, because it provides a better decryption noise bound.</p>\n<ol>\n<li>There is a relationship between these norms: <span><span><span>∥a∥∞≤c2n⋅∥a∥can\\|a\\|_{\\infty} \\leq c_{2n}\\cdot \\can a</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span>a</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span>∞</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>≤</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>n</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>∥</span><span>a</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span></span></span></span></span> for some constant <span><span><span>c2nc_{2n}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>n</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, which is <span><span><span>11</span><span aria-hidden=\"true\"><span><span></span><span>1</span></span></span></span></span> when <span><span><span>nn</span><span aria-hidden=\"true\"><span><span></span><span>n</span></span></span></span></span> is a power of <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> (see <a href=\"https://eprint.iacr.org/2011/535.pdf\">this</a>). With this inequality in mind, it suffices to assure correct decryption by setting the canonical norm of the noise to be less than <span><span><span>q/2q/2</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span>/</span><span>2</span></span></span></span></span>.</li>\n<li>When doing multiplications, the noise bound offered by the canonical norm increases slower than the bound offered by the infinity norm. We have these two inequalities:</li>\n</ol>\n<div><span><span><span>∥ab∥∞≤γ∥a∥∞∥b∥∞∥ab∥can≤∥a∥can∥b∥can\\begin{aligned}\n\\|ab\\|_\\infty &#x26;\\leq \\gamma\\|a\\|_\\infty \\|b\\|_\\infty  \\\\ \n\\can {ab} &#x26;\\leq \\can a \\can b\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>∥</span><span>a</span><span>b</span><span><span>∥</span><span><span><span><span><span><span></span><span><span>∞</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span>∥</span><span>a</span><span>b</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>≤</span><span></span><span>γ</span><span>∥</span><span>a</span><span><span>∥</span><span><span><span><span><span><span></span><span><span>∞</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∥</span><span>b</span><span><span>∥</span><span><span><span><span><span><span></span><span><span>∞</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>≤</span><span></span><span>∥</span><span>a</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span>∥</span><span>b</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>where <span><span><span>γ>1\\gamma > 1</span><span aria-hidden=\"true\"><span><span></span><span>γ</span><span></span><span>></span><span></span></span><span><span></span><span>1</span></span></span></span></span> is the so-called <em>expansion factor</em> of the ring <span><span><span>RR</span><span aria-hidden=\"true\"><span><span></span><span>R</span></span></span></span></span>. For more details, see <a href=\"https://escholarship.org/content/qt0141w93p/qt0141w93p.pdf\">this</a>.</p>\n<p><strong>Noise bounds</strong><br>\nSuppose we choose <span><span><span>a∈Ra \\in R</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span></span><span>∈</span><span></span></span><span><span></span><span>R</span></span></span></span></span> with coefficients sampled independently from one of the distributions (discrete Gaussian, random, ternary). Let <span><span><span>VaV_a</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span>a</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> be the variance of each coefficient <span><span><span>(a0,...an)(a_0, ... a_n)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span><span>a</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> in <span><span><span>aa</span><span aria-hidden=\"true\"><span><span></span><span>a</span></span></span></span></span>. In <a href=\"https://www.esat.kuleuven.be/cosic/publications/thesis-316.pdf\">Ilia Iliashenko's thesis</a> and in the <a href=\"https://eprint.iacr.org/2022/706.pdf\">Finding and Evaluating Parameters for BGV</a> paper it's shown that we can choose a number <span><span><span>DD</span><span aria-hidden=\"true\"><span><span></span><span>D</span></span></span></span></span> such that\n<span><span><span>∥a∥can≤DnVa \\can a \\leq D \\sqrt{n V_a}</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span>a</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>≤</span><span></span></span><span><span></span><span>D</span><span><span><span><span><span><span></span><span><span>n</span><span><span>V</span><span><span><span><span><span><span></span><span><span>a</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span>\nholds with overwhelming probability. In practice, we set <span><span><span>D=6D = 6</span><span aria-hidden=\"true\"><span><span></span><span>D</span><span></span><span>=</span><span></span></span><span><span></span><span>6</span></span></span></span></span>.</p>\n<p>When analysing the noise growth we'll make use of the following proprieties. For two polynomials <span><span><span>a,b∈Ra, b \\in R</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span>,</span><span></span><span>b</span><span></span><span>∈</span><span></span></span><span><span></span><span>R</span></span></span></span></span> with variances <span><span><span>Va,VbV_a, V_b</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span>a</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span>b</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and some constant <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span> we have:</p>\n<ul>\n<li><span><span><span>Va+b=Va+VbV_{a+b} = V_a + V_b</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>a</span><span>+</span><span>b</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span>a</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span>b</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> ,</li>\n<li><span><span><span>Vka=k2VaV_{ka} = k^2V_a</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>k</span><span>a</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>k</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>V</span><span><span><span><span><span><span></span><span><span>a</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>,</li>\n<li><span><span><span>Va⋅b=nVaVbV_{a \\cdot b} = nV_aV_b</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>a</span><span>⋅</span><span>b</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>n</span><span><span>V</span><span><span><span><span><span><span></span><span><span>a</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>V</span><span><span><span><span><span><span></span><span><span>b</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</li>\n</ul>\n<p>For the distributions that we work with we have the <strong>coefficient</strong> variances:</p>\n<ul>\n<li>Discrete Gaussian distribution with standard deviation <span><span><span>σ: VDG=σ2\\sigma: \\ V_{\\mathcal {DG}} = \\sigma^2</span><span aria-hidden=\"true\"><span><span></span><span>σ</span><span></span><span>:</span><span> </span><span></span></span><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span>D</span><span>G</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span>.</li>\n<li>Ternary distribution: <span><span><span>V3=2/3V_3 = 2/3</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>2</span><span>/</span><span>3</span></span></span></span></span>.</li>\n<li>Uniform distribution with integer coefficients in <span><span><span>(−q/2,q/2]: Vq≈q2/12(-q/2, q/2]: \\ V_q \\approx q^2 / 12</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>−</span><span>q</span><span>/</span><span>2</span><span>,</span><span></span><span>q</span><span>/</span><span>2</span><span>]</span><span></span><span>:</span><span> </span><span></span></span><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span><span>q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>/</span><span>1</span><span>2</span></span></span></span></span>.</li>\n</ul>\n<h3>Noise for operations</h3>\n<p>We now have the building blocks (starting values and operations) to analyse the noise for each operation. The goal of analysing the noise buildup is to choose the scheme parameters such that the scheme properties (fhe, decryption) hold and the scheme remains secure. Following the paper <a href=\"https://eprint.iacr.org/2022/706.pdf\">Finding and Evaluating Parameters for BGV</a> we have:</p>\n<p><strong>Fresh ciphertext noise</strong><br>\nIn order to make sure the decryption is correct we must make sure the error</p>\n<div><span><span><span>v=c0+c1⋅s=t(e⋅u+e0+e1⋅s)⏟r+m=r+m mod qv = c_0 + c_1 \\cdot \\textcolor{red}{s} = \\underbrace{t(\\textcolor{darkgreen}{e} \\cdot \\textcolor{red}{u} + \\textcolor{darkgreen}{e_0} + \\textcolor{darkgreen}{e_1} \\cdot \\textcolor{red}{s})}_{r} + m = r + m \\bmod q</span><span aria-hidden=\"true\"><span><span></span><span>v</span><span></span><span>=</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>r</span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span>t</span><span>(</span><span>e</span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span>)</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>m</span><span></span><span>=</span><span></span></span><span><span></span><span>r</span><span></span><span>+</span><span></span></span><span><span></span><span>m</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>q</span></span></span></span></span></div>\n<p>does not wrap around the modulus (i.e <span><span><span>∥v∥∞≤c2n∥v∥can≤q/2\\|v\\|_{\\infty} \\leq c_{2n}\\can v \\leq q/2</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span>v</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span>∞</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>≤</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>n</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∥</span><span>v</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>≤</span><span></span></span><span><span></span><span>q</span><span>/</span><span>2</span></span></span></span></span> ). The message <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span> is thought to come uniformly from <span><span><span>RtR_t</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>Recall that</p>\n<ul>\n<li>The errors <span><span><span>e,e0,e1\\textcolor{darkgreen}{e}, \\textcolor{darkgreen}{e_0}, \\textcolor{darkgreen}{e_1}</span><span aria-hidden=\"true\"><span><span></span><span>e</span><span>,</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> come from a discrete Gaussian => <span><span><span>Ve=Ve0=Ve1=σ2V_{\\textcolor{darkgreen}{e}} = V_{\\textcolor{darkgreen}{e_0}} = V_{\\textcolor{darkgreen}{e_1}} = \\sigma^2</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>e</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span>.</li>\n<li>The secret <span><span><span>s\\red{s}</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span> and <span><span><span>u\\red{u}</span><span aria-hidden=\"true\"><span><span></span><span>u</span></span></span></span></span> come from a ternary distribution => <span><span><span>Vs=Vu=2/3V_{\\red{s}} = V_{\\red{u}} = 2/3</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>s</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>u</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>2</span><span>/</span><span>3</span></span></span></span></span>.</li>\n<li>The message <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span> comes from <span><span><span>RtR_t</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and we assume that the coefficients are uniformly distributed in <span><span><span>Zt\\mathbb Z_t</span><span aria-hidden=\"true\"><span><span></span><span><span>Z</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> => <span><span><span>Vm=t2/12V_m = t^2 / 12</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span>m</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>/</span><span>1</span><span>2</span></span></span></span></span>.</li>\n</ul>\n<div><span><span><span>Vv=Vm+t(e⋅u+e0+e1⋅s)=Vm+t2Ve⋅u+e0+e1⋅s=t212+t2(nσ223+σ2+nσ223)=t2(112+σ2(43n+1))\\begin{aligned}\nV_v &#x26;= V_{m + t(\\textcolor{darkgreen}{e}\\cdot \\textcolor{red}{u} + \\textcolor{darkgreen}{e_0} + \\textcolor{darkgreen}{e_1} \\cdot \\textcolor{red}{s})} \\\\\n&#x26;= V_m + t^2V_{\\textcolor{darkgreen}{e} \\cdot \\textcolor{red}{u} + \\textcolor{darkgreen}{e_0} + \\textcolor{darkgreen}{e_1} \\cdot \\textcolor{red}{s}}  \\\\\n&#x26;= \\frac{t^2}{12} + t^2 \\left(n\\sigma^2 \\frac{2}{3} + \\sigma^2 + n\\sigma^2 \\frac{2}{3}\\right)  \\\\\n&#x26;= t^2 \\left(\\frac{1}{12} + \\sigma^2 \\left(\\frac{4}{3}n + 1\\right)\\right)\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span>V</span><span><span><span><span><span><span></span><span><span>v</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>m</span><span>+</span><span>t</span><span>(</span><span>e</span><span>⋅</span><span>u</span><span>+</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>+</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>⋅</span><span>s</span><span>)</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span>m</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>e</span><span>⋅</span><span>u</span><span>+</span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>+</span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>⋅</span><span>s</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>+</span><span></span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span><span><span>(</span></span><span>n</span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span>3</span></span></span><span><span></span><span></span></span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>+</span><span></span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>n</span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span>3</span></span></span><span><span></span><span></span></span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>)</span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span><span><span>(</span></span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>+</span><span></span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span><span><span>(</span></span><span><span></span><span><span><span><span><span><span></span><span><span>3</span></span></span><span><span></span><span></span></span><span><span></span><span><span>4</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>n</span><span></span><span>+</span><span></span><span>1</span><span><span>)</span></span></span><span><span>)</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>Hence:\n<span><span><span>∥v∥can≤DnVv\\can v \\leq D\\sqrt {nV_v}</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span>v</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>≤</span><span></span></span><span><span></span><span>D</span><span><span><span><span><span><span></span><span><span>n</span><span><span>V</span><span><span><span><span><span><span></span><span><span>v</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></p>\n<p>The parameters for the scheme and distributions, <span><span><span>q,t,σ,nq, t, \\sigma, n</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span>,</span><span></span><span>t</span><span>,</span><span></span><span>σ</span><span>,</span><span></span><span>n</span></span></span></span></span>,  are chosen such that the decryption is correct.</p>\n<p><strong>Addition</strong><br>\nFor two ciphertexts <span><span><span>(c,c′)(c, c')</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>c</span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> encrypting <span><span><span>(m,m′)(m, m')</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>m</span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> we have the corresponding errors <span><span><span>(v,v′)(v, v')</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>v</span><span>,</span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span></span></span></span></span>. The error after ciphertext addition is <span><span><span>vaddv_{\\text{add}}</span><span aria-hidden=\"true\"><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>add</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>If we use the decryption equation we have</p>\n<div><span><span><span>vadd=v+v′=(c0+c1⋅s)+(c0′+c1′⋅s)=r+m+r′+m′ mod qv_{\\text{add}} = v + v' = (c_0 + c_1 \\cdot \\red{s}) + (c_0' + c_1' \\cdot \\red{s}) = r + m + r' + m' \\bmod q</span><span aria-hidden=\"true\"><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>add</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>v</span><span></span><span>+</span><span></span></span><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>r</span><span></span><span>+</span><span></span></span><span><span></span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span><span>r</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>q</span></span></span></span></span></div>\n<p>We have <span><span><span>m+m′=[m+m′]t+gtm + m' = [m + m']_t + gt</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>[</span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>g</span><span>t</span></span></span></span></span> with <span><span><span>g∈Rg \\in R</span><span aria-hidden=\"true\"><span><span></span><span>g</span><span></span><span>∈</span><span></span></span><span><span></span><span>R</span></span></span></span></span> and <span><span><span>∥g∥∞=1\\|g\\|_{\\infty} = 1</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span>g</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span>∞</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>1</span></span></span></span></span> (because both <span><span><span>∥m∥∞,∥m′∥∞&#x3C;t/2\\|m\\|_{\\infty}, \\|m'\\|_{\\infty} &#x3C; t / 2</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span>m</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span>∞</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>∥</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span>∞</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>&#x3C;</span><span></span></span><span><span></span><span>t</span><span>/</span><span>2</span></span></span></span></span>). By replacing in the equation above we obtain:\n<span><span><span>v+v′=[m+m′]t+r+r′+gt mod qv + v' = [m + m']_t + r + r' + gt \\bmod q</span><span aria-hidden=\"true\"><span><span></span><span>v</span><span></span><span>+</span><span></span></span><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>[</span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>r</span><span></span><span>+</span><span></span></span><span><span></span><span><span>r</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>g</span><span>t</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>q</span></span></span></span></span></p>\n<p>We see that the noise <span><span><span>r+r′+gtr + r' + gt</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span></span><span>+</span><span></span></span><span><span></span><span><span>r</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>g</span><span>t</span></span></span></span></span> grows linearly.</p>\n<p>Finally, using the canonical norm we have the following:</p>\n<div><span><span><span>∥vadd∥can≤∥v∥can+∥v′∥can\\can {v_{\\text{add}}} \\leq \\can v + \\can {v'}</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>add</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>≤</span><span></span></span><span><span></span><span>∥</span><span>v</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p><strong>Multiplication</strong><br>\nSimilarly for multiplication, if we use the decryption equation we have:</p>\n<div><span><span><span>vmul=v⋅v′=(c0+c1⋅s)⋅(c0′+c1′⋅s)=(r+m)+(r′+m′)=mm′+mr′+m′r+rr′ mod q\\begin{aligned}\nv_{\\text{mul}} \n&#x26;= v \\cdot v' = (c_0 + c_1 \\cdot \\red{s}) \\cdot (c_0' + c_1' \\cdot \\red{s}) \\\\\n&#x26;= (r + m) + (r' + m') = mm' + mr' + m'r + rr' \\bmod q\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>mul</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>v</span><span></span><span>⋅</span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span>)</span><span></span><span>⋅</span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>(</span><span>r</span><span></span><span>+</span><span></span><span>m</span><span>)</span><span></span><span>+</span><span></span><span>(</span><span><span>r</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>m</span><span><span>r</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>r</span><span></span><span>+</span><span></span><span>r</span><span><span>r</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>If we look at the error term <span><span><span>mr′+m′r+rr′mr' + m'r + rr'</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span><span>r</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>r</span><span></span><span>+</span><span></span></span><span><span></span><span>r</span><span><span>r</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> we see that in the leading term <span><span><span>rr′rr'</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span><span>r</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> we multiply the noises, therefore the noise grows quadratically.</p>\n<p>Using the canonical norm, we have:</p>\n<div><span><span><span>∥vmul∥can≤∥v∥can∥v′∥can\\can {v_{\\text{mul}}} \\leq \\can v\\can {v'}</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>mul</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>≤</span><span></span></span><span><span></span><span>∥</span><span>v</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p><strong>Modulus switching</strong><br>\nFor modulus switch we scale the noise down and then we add the small error that comes with the correction terms <span><span><span>δ0,δ1\\delta_0, \\delta_1</span><span aria-hidden=\"true\"><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.\nRecall that</p>\n<ul>\n<li>We set <span><span><span>δi=t[−cit−1]Q/q\\delta_i = t[-c_it^{-1}]_{Q/q}</span><span aria-hidden=\"true\"><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>t</span><span>[</span><span>−</span><span><span>c</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>−</span><span>1</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>Q</span><span>/</span><span>q</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. We assume the terms <span><span><span>[−cit−1]Q/q[-c_it^{-1}]_{Q/q}</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>−</span><span><span>c</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>−</span><span>1</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>Q</span><span>/</span><span>q</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> are uniformly distributed mod <span><span><span>Q/qQ / q</span><span aria-hidden=\"true\"><span><span></span><span>Q</span><span>/</span><span>q</span></span></span></span></span>, then multiplied by <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span> => <span><span><span>Vδ0=Vδ1=t2Q212q2V_{\\delta_0} = V_{\\delta_1} = \\dfrac {t^2Q^2} {12q^2}</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span><span><span>q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>Q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span>.</li>\n</ul>\n<div><span><span><span>vswitch=[c~0+c~1⋅s]q=qQ[c0+c1⋅s]Q+qQ(δ0+δ1⋅s)=qQv+qQ(δ0+δ1⋅s)v_{\\text{switch}} = [\\tilde c_0 + \\tilde c_1 \\cdot \\red{s}]_q = \\dfrac q Q [c_0 + c_1 \\cdot \\red{s}]_Q  + \\dfrac q Q (\\delta_0 + \\delta_1 \\cdot \\red{s}) = \\dfrac q Q v  + \\dfrac q Q (\\delta_0 + \\delta_1 \\cdot \\red{s})</span><span aria-hidden=\"true\"><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>switch</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>[</span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span><span><span><span><span><span></span><span>c</span></span><span><span></span><span><span>~</span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>[</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span><span>]</span><span><span><span><span><span><span></span><span><span>Q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>v</span><span></span><span>+</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span>)</span></span></span></span></span></div>\n<p>Using the canonical norm we get:</p>\n<div><span><span><span>∥vswitch∥can≤qQ∥v∥can+qQ∥δ0+δ1⋅s∥can≤qQ∥v∥can+Dtn12(1+23n)\\can {v_{\\text{switch}}} \\leq \\dfrac q Q \\can v + \\dfrac q Q \\can {\\delta_0 + \\delta_1 \\cdot \\red{s}} \\leq \\dfrac q Q \\can v + Dt\\sqrt{\\dfrac n {12} \\left (1 + \\dfrac 2 3 n \\right)}</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>switch</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>≤</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>∥</span><span>v</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>∥</span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>≤</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>∥</span><span>v</span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>D</span><span>t</span><span><span><span><span><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span>n</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span><span><span>(</span></span><span>1</span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span>3</span></span><span><span></span><span></span></span><span><span></span><span>2</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>n</span><span><span>)</span></span></span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></div>\n<p>We can see that the noise is scaled down by almost <span><span><span>q/Qq / Q</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span>/</span><span>Q</span></span></span></span></span>.</p>\n<p><strong>Key switching - Base decomposition</strong><br>\nIn relinearization we deal with <span><span><span>c0+c1⋅s+c2⋅s2c_0 + c_1 \\cdot \\red{s} + c_2 \\cdot \\red{s}^2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span>. Here we decompose <span><span><span>c2⋅s2c_2 \\cdot \\red{s}^2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> in base <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> and hide the <em>hints</em> about <span><span><span>s2\\red{s}^2</span><span aria-hidden=\"true\"><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> using  RingLWE-like samples involving errors  <span><span><span>ei\\textcolor{darkgreen}{e_i}</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. Remember from  key switching technique using base decomposition that we have a relinearization error: <span><span><span>∑i=0⌊log⁡Tq⌋tei⋅c2∗(i)\\sum_{i=0}^{\\lfloor \\log_T q \\rfloor} t\\textcolor{darkgreen}{e_i} \\cdot {c^*_2}^{(i)}</span><span aria-hidden=\"true\"><span><span></span><span><span>∑</span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span><span>⌊</span><span><span><span>l</span><span>o</span><span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>q</span><span>⌋</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span></span>. The variance of any term <span><span><span>tei⋅c2∗(i)t\\textcolor{darkgreen}{e_i} \\cdot {c^*_2}^{(i)}</span><span aria-hidden=\"true\"><span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span></span> from the sum is <span><span><span>Vtei⋅c2∗(i)V_{t \\textcolor{darkgreen}{e_i} \\cdot {c^*_2}^{(i)}}</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>⋅</span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>Recall that</p>\n<ul>\n<li>The errors <span><span><span>ei\\textcolor{darkgreen}{e_i}</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> come from a discrete Gaussian distribution => <span><span><span>Vei=σ2V_{\\textcolor{darkgreen}{e_i}}= \\sigma^2</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span>.</li>\n<li>We can assume that the polynomials in base <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> behave like random polynomials extracted from <span><span><span>RTR_T</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> => <span><span><span>Vc2∗=T2/12V_{{c^*_2}} = T^2 / 12</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>/</span><span>1</span><span>2</span></span></span></span></span>.</li>\n</ul>\n<div><span><span><span>vks=c0∗+c1∗⋅s+c2∗⋅s2⏟vmul+∑i=0⌊log⁡Tq⌋tei⋅c2∗(i)v_{\\text{ks}} = \\underbrace{c^*_0 + c^*_1 \\cdot \\red{s} + c^*_2 \\cdot \\red{s}^2}_{v_{\\text{mul}}} +  \\sum_{i=0}^{\\lfloor \\log_T q \\rfloor} t\\textcolor{darkgreen}{e_i} \\cdot {c^*_2}^{(i)}</span><span aria-hidden=\"true\"><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>ks</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>mul</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>⌊</span><span><span><span>l</span><span>o</span><span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>q</span><span>⌋</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>t</span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>If we use the canonical norm:</p>\n<div><span><span><span>∥vks∥can≤∥vmul∥can+Dnlog⁡T(q)Vt⋅ei⋅c2∗(i)=∥vmul∥can+Dtn2log⁡T(q)VeiVc2∗(i)=∥vmul∥can+DtnTlog⁡T(q)σ212\\begin{aligned}\n\\can {v_{\\text{ks}}} &#x26; \\leq \\can {v_{\\text{mul}}} + D\\sqrt{n \\log_T (q)V_{t \\cdot \\textcolor{darkgreen}{e_i} \\cdot {c^*_2}^{(i)}}} \\\\\n&#x26;= \\can {v_{\\text{mul}}} + Dt\\sqrt{n^2 \\log_T (q)V_{\\textcolor{darkgreen}{e_i}} V_{{c^*_2}^{(i)}}}  \\\\ \n&#x26;= \\can {v_{\\text{mul}}} + DtnT\\sqrt{ \\log_T (q)\\dfrac {\\sigma^2} {12}}\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>ks</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>≤</span><span></span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>mul</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>D</span><span><span><span><span><span><span></span><span><span>n</span><span></span><span><span>lo<span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>q</span><span>)</span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>t</span><span>⋅</span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>⋅</span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>mul</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>D</span><span>t</span><span><span><span><span><span><span></span><span><span><span>n</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span><span>lo<span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>q</span><span>)</span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span><span>(</span><span>i</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>mul</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>D</span><span>t</span><span>n</span><span>T</span><span><span><span><span><span><span></span><span><span><span>lo<span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>q</span><span>)</span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p><strong>Key switching - Modulus switch</strong><br>\nIn the relinearisation version that employs modulus switching, we have the following error term: <span><span><span>qQ(tc2∗⋅e+δ0+δ1⋅s)\\dfrac q Q (tc_2^* \\cdot \\textcolor{darkgreen}{e} + \\delta_0 + \\delta_1 \\cdot \\red{s})</span><span aria-hidden=\"true\"><span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span>t</span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>e</span><span></span><span>+</span><span></span></span><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span>)</span></span></span></span></span>.\nRecall that:</p>\n<ul>\n<li>The ciphertext component <span><span><span>c2∗c_2^*</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> comes from <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> => <span><span><span>Vc2∗=q2/12V_{c_2^*} = q^2 / 12</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>/</span><span>1</span><span>2</span></span></span></span></span>.</li>\n<li>The errors <span><span><span>e\\textcolor{darkgreen}{e}</span><span aria-hidden=\"true\"><span><span></span><span>e</span></span></span></span></span> comes from a discrete Gaussian => <span><span><span>Ve=σ2V_{\\textcolor{darkgreen}{e}}= \\sigma^2</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>e</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span>.</li>\n<li>The secret <span><span><span>s\\red{s}</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span> comes from a ternary distribution => <span><span><span>Vs=2/3V_{\\red{s}}= 2/3</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>s</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>2</span><span>/</span><span>3</span></span></span></span></span>.</li>\n<li>We set <span><span><span>δi=t[−cit−1]Q/q\\delta_i = t[-c_it^{-1}]_{Q/q}</span><span aria-hidden=\"true\"><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>t</span><span>[</span><span>−</span><span><span>c</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>−</span><span>1</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>Q</span><span>/</span><span>q</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. We assume the terms <span><span><span>[−cit−1]Q/q[-c_it^{-1}]_{Q/q}</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>−</span><span><span>c</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>−</span><span>1</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>Q</span><span>/</span><span>q</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> are uniformly distributed mod <span><span><span>Q/qQ / q</span><span aria-hidden=\"true\"><span><span></span><span>Q</span><span>/</span><span>q</span></span></span></span></span>, then multiplied by <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span> => <span><span><span>Vδ0=Vδ1=t2Q212q2V_{\\delta_0} = V_{\\delta_1} = \\dfrac {t^2Q^2} {12q^2}</span><span aria-hidden=\"true\"><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span><span><span>q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>Q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span>.</li>\n</ul>\n<div><span><span><span>vks=c0∗+c1∗⋅s+c2∗⋅s2⏟vmul+qQ(tc2∗⋅e+δ0+δ1⋅s)v_{\\text{ks}} = \\underbrace{c_0^* + c_1^* \\cdot \\red{s} + c_2^* \\cdot \\red{s}^2}_{v_{\\text{mul}}} + \\dfrac q Q (tc_2^* \\cdot \\textcolor{darkgreen}{e} + \\delta_0 + \\delta_1 \\cdot \\red{s})</span><span aria-hidden=\"true\"><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>ks</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>mul</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span><span></span><span><span><span><span><span><span></span><span><span></span><span></span><span></span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span>t</span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>e</span><span></span><span>+</span><span></span></span><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span>)</span></span></span></span></span></div>\n<p>The variance of this error term is:</p>\n<div><span><span><span>VqQ(tc2∗i⋅e+δ0+δ1⋅s)=(qQ)2(t2nVc2∗Ve+Vδ0+nVδ1Vs)=(qQ)2(t2nq212σ2+t2Q212q2+nt2Q212q223)=(qQ)2(t2nq212σ2)+t212+nt21223=(qQ)2(t2nq212σ2)+t212(1+23n)\\begin{aligned}\nV_{\\frac q Q (t{c_2^*}_i \\cdot \\textcolor{darkgreen}{e} + \\delta_0 + \\delta_1 \\cdot \\textcolor{red}{s})} \n&#x26;= \\left(\\frac q Q \\right)^2 (t^2 nV_{c_2^*}V_{\\textcolor{darkgreen}{e}} + V_{\\delta_0} + nV_{\\delta_1}V_{\\textcolor{red}{s}}) \\\\\n&#x26;= \\left(\\frac q Q \\right)^2 \\left(t^2  n \\frac {q^2} {12} \\sigma^2 +  \\dfrac {t^2Q^2} {12q^2} + n  \\dfrac {t^2Q^2} {12q^2} \\dfrac 2 3\\right) \\\\\n&#x26;= \\left(\\frac q Q \\right)^2 \\left(t^2  n \\frac {q^2} {12} \\sigma^2 \\right)  +\\dfrac {t^2} {12} + n  \\dfrac {t^2} {12} \\dfrac 2 3 \\\\\n&#x26;= \\left(\\frac q Q \\right)^2 \\left(t^2  n \\frac {q^2} {12} \\sigma^2 \\right)  +\\dfrac {t^2} {12} \\left(1+ \\dfrac 2 3 n \\right)\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span></span><span><span><span><span><span><span></span><span><span>Q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>(</span><span>t</span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>⋅</span><span>e</span><span>+</span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>+</span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>⋅</span><span>s</span><span>)</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span>(</span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>(</span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>n</span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>∗</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>e</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span>δ</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>n</span><span><span>V</span><span><span><span><span><span><span></span><span><span><span><span>δ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>V</span><span><span><span><span><span><span></span><span><span><span>s</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span>(</span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span><span><span>(</span></span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>n</span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span><span><span>q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>Q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>+</span><span></span><span>n</span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span><span><span>q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>Q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span></span><span><span><span><span><span><span></span><span>3</span></span><span><span></span><span></span></span><span><span></span><span>2</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>)</span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span>(</span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span><span><span>(</span></span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>n</span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>)</span></span></span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>+</span><span></span><span>n</span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span></span><span><span><span><span><span><span></span><span>3</span></span><span><span></span><span></span></span><span><span></span><span>2</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span>(</span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span><span><span>(</span></span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>n</span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>)</span></span></span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span><span><span>(</span></span><span>1</span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span>3</span></span><span><span></span><span></span></span><span><span></span><span>2</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>n</span><span><span>)</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>Now we can bound:</p>\n<div><span><span><span>∥vks∥can≤∥vmul∥can+Dn(qQ)2(t2nq212σ2+t212(1+23n))≤∥vmul∥can+DqQtn(nq212σ2+112(1+23n))\\begin{aligned}\n\\can {v_{\\text{ks}}} \n&#x26; \\leq \\can {v_{\\text{mul}}} + D\\sqrt{n \\left(\\frac q Q \\right)^2 \\left(t^2  n \\frac {q^2} {12} \\sigma^2 + \\frac {t^2} {12} \\left(1+ \\dfrac 2 3 n\\right) \\right)} \\\\\n&#x26; \\leq \\can {v_{\\text{mul}}} + D \\frac q Q t\\sqrt{n \\left(n \\frac{q^2} {12} \\sigma^2 + \\frac {1} {12} \\left(1+ \\dfrac 2 3 n\\right) \\right)}\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>ks</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>≤</span><span></span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>mul</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>D</span><span><span><span><span><span><span></span><span><span>n</span><span></span><span><span><span><span>(</span></span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span><span><span>(</span></span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>n</span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span><span><span>(</span></span><span>1</span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span>3</span></span><span><span></span><span></span></span><span><span></span><span>2</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>n</span><span><span>)</span></span></span><span><span>)</span></span></span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>≤</span><span></span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span><span>mul</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>∥</span><span><span><span><span><span><span></span><span><span><span><span>can</span></span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>D</span><span><span></span><span><span><span><span><span><span></span><span>Q</span></span><span><span></span><span></span></span><span><span></span><span>q</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>t</span><span><span><span><span><span><span></span><span><span>n</span><span></span><span><span><span>(</span></span><span>n</span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>q</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>σ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>1</span><span>2</span></span></span><span><span></span><span></span></span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span><span><span>(</span></span><span>1</span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span>3</span></span><span><span></span><span></span></span><span><span></span><span>2</span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>n</span><span><span>)</span></span></span><span><span>)</span></span></span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<h1>Code</h1>\n<p>And now that we have discussed all the ingredients and spices of the BGV encryption scheme, it's time to bake it, sorry, implement it.</p>\n<p>We provide a <a href=\"https://github.com/zademn/EverythingCrypto/blob/master/E3-Homomorphic-Encryption/BGV.ipynb\">proof of concept implementation</a>, in Python. The aim of the code is to mirror the equations easily. This means that if we see <span><span><span>a⋅s+ea \\cdot s + e</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span>e</span></span></span></span></span> in the theory part we prefer to see <code>a * s + e</code> in code instead of <code>polyadd(polymul(a, s), e)</code>.</p>\n<p>DISCLAIMER: The code should be used for educational purposes only, and never in production.</p>\n<p>We represent polynomials using a class: <code>QuotientRingPoly</code>. Every polynomial is defined by three attributes:</p>\n<ul>\n<li><code>coef: np.ndarray</code> - Vector of the polynomial's coefficients. <code>coef[-1]</code> is the free coefficient, <code>coef[0]</code> is the leading coefficient. It's always padded to have <code>n</code> elements.</li>\n<li><code>coef_modulus: int</code> - Modulus of the ring where its coefficients live in.</li>\n<li><code>poly_modulus: int | np.ndarray</code> - Modulus of the polynomial ring where it belongs: <code>X^n + 1</code></li>\n</ul>\n<p><code>QuotientRingPoly</code> has the <code>._reduce(self)</code> method which reduces any polynomial to an element in the ring.</p>\n<p>We overloaded the operators <code>+, -, *, //, %</code>:</p>\n<ul>\n<li>Operators work between two <code>QuotientRingPoly</code> using the default polynomial operation rules.</li>\n<li>Operators work between a <code>QuotientRingPoly</code> and an <code>int | float</code> coefficient-wise.</li>\n</ul>\n<p>The attributes <code>coef</code> and <code>coef_modulus</code> can be assigned too. After assigning, the <code>_reduce()</code> method will be called. This is helpful to easily change the ring of the polynomial.</p>\n<p><strong>Remarks</strong></p>\n<ul>\n<li>To work with big integers, we use the python built in <code>int</code> class. To use this with numpy we set <code>dtype = object</code> for every array creation.</li>\n<li>We have helper functions <code>roundv</code> and <code>intv</code> (round vector, int vector) that vectorize the <code>round</code> and <code>int</code> operations, allowing us to help with rounding and converting vector elements to python's builtin <code>int</code> class.</li>\n</ul>\n<h1>Resources</h1>\n<ul>\n<li><a href=\"https://eprint.iacr.org/2011/277.pdf\">BGV paper</a> - Original paper</li>\n<li><a href=\"https://eprint.iacr.org/2011/344.pdf\">BV paper</a></li>\n<li><a href=\"https://homomorphicencryption.org/standard/\">FHE standard</a></li>\n<li><a href=\"https://eprint.iacr.org/2015/889.pdf\">CS15</a> - for comparisons between FHE schemes</li>\n<li><a href=\"https://www.esat.kuleuven.be/cosic/publications/thesis-316.pdf\">Ilia Iliashenko thesis</a> - for noise analysis</li>\n<li><a href=\"https://eprint.iacr.org/2019/493.pdf\">Evaluating the effectiveness of heuristic worst-case noise analysis in FHE</a></li>\n<li><a href=\"https://eprint.iacr.org/2012/099.pdf\">GHS</a></li>\n<li><a href=\"https://eprint.iacr.org/2022/706.pdf\">Finding and Evaluating Parameters for BGV</a></li>\n<li><a href=\"https://bit-ml.github.io/blog/post/homomorphic-encryption-toy-implementation-in-python/\">Bitdefender BFV blogpost</a></li>\n<li><a href=\"https://www.inferati.com/blog/fhe-schemes-bgv\">Inferati blogpost</a></li>\n</ul>\n"},{"data":{"slug":"bitdefender_at_eeml2019","authors":"Tudor Berariu","categories":"event","galleries":"eeml2019_pictures:6","featured_img":"/galleries/eeml2019_pictures/full_house.jpg","date":"September-20-2019","title":"Bitdefender at EEML2019","id":3},"messages":[],"history":["./content/collections/posts/eeml2019.md","content/collections/posts/eeml2019.html"],"cwd":"/Users/fbrad/bit/bit-ml","contents":"<h1>Bitdefender at EEML2019</h1>\n<p>This summer Bitdefender’s Machine Learning Research Team participated in the\nsecond edition of the Eastern European Machine Learning Summer School, this\nyear’s highlight event for our fast growing machine learning community in\nRomania.</p>\n<p><img src=\"/galleries/eeml2019_pictures/group.jpg\" alt=\"eeml2019_group_photo\" title=\"EEML2019 group photo.\"></p>\n<h2>What is EEML?</h2>\n<p>The EEML Summer School gathers top researchers from universities and\ncompanies, offering an intensive week full of lectures and practicals to\nparticipants ranging from undergrad students to post-doc researchers.</p>\n<p>The summer school was successful in its mission to connect Eastern Europe\nwith the rest of the world, welcoming attendees from 42 different countries.\nBeing true to the schools values on inclusiveness, women represented almost a\nthird of the participants, more than the usual ratio encountered in STEM.</p>\n<p>Furthermore, at the national level, EEML offered the chance to meet and\nstrengthen the collaboration between research hubs in Iași, Cluj-Napoca,\nTimișoara, and Brașov.</p>\n<p>Bringing everyone together for a full week makes EEML an ideal place to\nexchange ideas with others working on similar topics, to draw inspiration\nfrom others’ approach to their problems, and this adds a valuable extra to\nthe overall learning experience.</p>\n<h2>Bitdefender among organizers</h2>\n<p>EEML’s mission was laid out by a group of successful romanian researchers\nthat wanted to ensure eastern european talent pool gets access to the same\nresources as the more established academic centers in the western world.\nDoina Precup, Răzvan Pașcanu, and Viorica Pătrăucean were the leading\norganizers of the summer school, and their dedication made everything\npossible.</p>\n<p>Bitdefender was one of the Gold Sponsors of EEML proving its commitment to\nadvance the local research community and invest in local education. Beside\nthat, our own Elena Burceanu was one of the organizers of EEML, putting a lot\nof time and effort into making sure that every little detail will happen like\nclockwork.</p>\n<p><img src=\"/galleries/eeml2019_pictures/bitdefender_booth.jpg\" alt=\"bitdefender_booth\" title=\"Elena and Ștefan at the Bitdefender booth.\"></p>\n<p>EEML is a huge event so it was all hands on deck. Therefore we put the\nvolunteer yellow shirts on, took a deep breath, a sip of coffee and joined\nthe efforts. Our colleagues helped participants finding their way from the\nairport to the accommodation, prepared the welcome bags, they made sure every\nvideo projector works, and that there are spare batteries for the microphones\nin the lecture room.</p>\n<p><img src=\"/galleries/eeml2019_pictures/volunteers.jpg\" alt=\"eeml_volunteers\" title=\"EEML volunteers welcoming the participants.\"></p>\n<p>The summer school kicked off with a humorous presentation about the Romanian\nculture from our own Florin Brad. That moment provided everyone with the\nenergy to go through the full week.</p>\n<p></p>\n<p>In Florin's own words:</p>\n<h2>The lectures</h2>\n<p>The lectures at EEML covered a broad range of topics in Machine Learning\naiming to both build the theoretical foundations for the newcomers and also\nhint to the research frontiers in the domain.</p>\n<p>Furthermore, the diverse background of the speakers enabled a wide variety of\nlectures, ranging from pragmatic descriptions of the latest research results\nto theoretical crash courses in the different areas covered by the summer\nschool.</p>\n<h2>Posters</h2>\n<p>EEML participants were encouraged to present their current work in a poster\nsession that spanned over two evenings (actually well into the night). That\nwas a great opportunity for them to get feedback from the seniors.</p>\n<p>Our team unveiled three internal research efforts. Iulia Duță and Andrei\nNicolicioiu presented their novel recurrent space-time graph neural networks\nfor video understanding (also accepted at NeurIPS!!!). Emanuela Haller\ndiscussed her work on spacetime graph optimization for video object\nsegmentation. Florin Gogianu introduced his idea to use uncertainty to\nprioritize past experiences for training agents through reinforcement\nlearning.</p>\n<h2>Teaching assistants</h2>\n<p>EEML practicals were challenging applications of the theory discussed during\nthe lectures. The subjects were quite diverse covering Image classification,\nreinforcement learning, recurrent neural nets for language models, or\ngenerative models such as variational autoencoders. The teaching assistants\nhad the job to guide the participants into solving this tasks, and leave the\nsummer school with a consistent experience in training deep neural models\nusing Tensorflow. The TAs were researchers from prestigious universities, and\ncompanies such as DeepMind, and Bitdefender.</p>\n<p>Our own colleagues, some of which are also teaching at University Politehnica\nof Bucharest or University of Bucharest (Iulia, Florin, Andrei, Ștefan, Ema,\nTudor) got involved in guiding the participants through the new stuff in each\nlaboratory.</p>\n<h2>Epilogue</h2>\n<p>EEML was a huge opportunity for Bucharest to join and interact with the\nrelevant actors in the machine learning community. Bitdefender is proud to be\nso deeply involved in bringing this event to our city.</p>\n"},{"data":{"slug":"homomorphic-encryption-toy-implementation-in-python","authors":"Mădălina Bolboceanu, Miruna Roșca, Radu Țițiu","categories":"blog","featured_img":"/galleries/homomorphic2020/enigma_dec.jpg","date":"November-16-2020","title":"Homomorphic Encryption: a Toy Implementation in Python","id":4},"messages":[],"history":["./content/collections/posts/homomorphic2020.md","content/collections/posts/homomorphic2020.html"],"cwd":"/Users/fbrad/bit/bit-ml","contents":"<h1>Homomorphic Encryption: a Toy Implementation in Python</h1>\n<p><strong>Motivation:</strong>\nWe made this blog post as self-contained as possible, even though it was\ninitially thought as a follow-up of <a href=\"https://blog.openmined.org/build-an-homomorphic-encryption-scheme-from-scratch-with-python/#buildanhomomorphicencryptionscheme\">this tutorial given by\nOpenMined</a>.\nThe starting point of our Python implementation is <a href=\"https://gist.github.com/youben11/f00bc95c5dde5e11218f14f7110ad289\">this github\ngist</a>,\nwhich follows the Homomorphic Encryption scheme from\n<a href=\"https://eprint.iacr.org/2012/144.pdf\">[FV12]</a>. The motivation behind <a href=\"https://github.com/bit-ml/he-scheme\">our\nimplementation</a> was for us to understand\nin detail the two techniques of\n<a href=\"https://eprint.iacr.org/2012/144.pdf\">[FV12]</a> used for ciphertext\nmultiplication, namely <em>relinearization</em> and <em>modulus-switching</em>. This\nessential operation of ciphertext multiplication was missing in the previous\nimplementation. We thought we might share this understanding through a blog\npost as well since it may be of interest to anyone using the [FV12] scheme in\n<a href=\"https://github.com/OpenMined/TenSEAL\">TenSeal</a> or\n<a href=\"https://github.com/Microsoft/SEAL\">Seal</a> libraries.</p>\n<p><strong>Disclaimer:</strong> Our toy implementation is not meant to be secure or\noptimized for efficiency. We did it to better understand the inner workings\nof the [FV12] scheme, so you can use it as a learning tool. Our full\nimplementation can be found <a href=\"https://github.com/bit-ml/he-scheme\">here</a>.</p>\n<p><strong>Curious about how to work with data you can't see?</strong> In the first part of\nthis blog post we are going to broadly explain what Homomorphic Encryption is\nand some closely related concepts. In the second part we will follow an\nexample of such a scheme, namely the\n<a href=\"https://eprint.iacr.org/2012/144.pdf\">[FV12]</a> scheme, and discuss some of\nthe details of our implementation.</p>\n<h2>1. What is Homomorphic Encryption?</h2>\n<p>Homomorphic Encryption (HE) enables a user to perform meaningful computations\non sensitive data <strong>while ensuring the privacy of the data</strong>. This may sound\nparadoxical to anyone who has ever worked with encrypted data before: if you\nwant to perform useful computations on the encrypted data (e.g. encrypted\nunder classical algorithms like AES), you need to decrypt it first. But once\ndecryption takes place, the privacy of the data is compromised. So how is it\npossible for HE to overcome this seeming contradiction? 🔮 Well,\nthe solution is highly non-trivial, as it took the cryptographic community\nmore than 30 years to come up with a construction. The first\n<a href=\"https://www.cs.cmu.edu/~odonnell/hits09/gentry-homomorphic-encryption.pdf\">solution</a>\nwas proposed by Craig Gentry in 2009 and was of theoretical interest only.\nSince then, a lot of research has been done (e.g.\n<a href=\"https://eprint.iacr.org/2011/277\">[BGV11]</a>,\n<a href=\"https://eprint.iacr.org/2012/144\">[FV12]</a>,\n<a href=\"https://eprint.iacr.org/2016/421\">[CKKS16]</a>,\n<a href=\"https://github.com/lducas/FHEW\">[FHEW]</a>,\n<a href=\"https://tfhe.github.io/tfhe/\">[TFHE]</a>,\n<a href=\"https://eprint.iacr.org/2013/340\">[GSW13]</a>) to make these ideas more\npractical. By the end of this post you should have a basic understanding of\nhow such a construction may work.</p>\n<p>Besides the traditional encryption (<span><span><span>Enc\\mathsf{Enc}</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span></span></span></span></span>), decryption\n(<span><span><span>Dec\\mathsf{Dec}</span><span aria-hidden=\"true\"><span><span></span><span><span>D</span><span>e</span><span>c</span></span></span></span></span></span>) and key generation (<span><span><span>Keygen\\mathsf{Keygen}</span><span aria-hidden=\"true\"><span><span></span><span><span>K</span><span>e</span><span>y</span><span>g</span><span>e</span><span>n</span></span></span></span></span></span>) algorithms, an HE\nscheme also uses <em>an evaluation algorithm</em> (<span><span><span>Eval\\mathsf{Eval}</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>v</span><span>a</span><span>l</span></span></span></span></span></span>). <strong>This is the\ndistinguishing feature that makes computations on encrypted data possible.</strong>\n💥 Let's consider the following example: Alice holds some personal\ninformation <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span> (e.g. her medical records and her family's medical history).\nThere is also a company that makes very good predictions based on this kind\nof information, using a refined model, expressed as the functionality <span><span><span>FF</span><span aria-hidden=\"true\"><span><span></span><span>F</span></span></span></span></span>\n(e.g. a well chosen machine learning model). On one hand, Alice is very interested in these\npredictions but is also reluctant to trust the company with her sensitive\ninformation. On the other hand, the company can't just give their model to\nAlice to make the predictions herself. A solution using Homomorphic\nEncryption is given in the picture below. Some important things to notice are:</p>\n<ul>\n<li>Alice sends her data <strong>encrypted</strong>, so the company never learns anything about <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span>.</li>\n<li>Computing on the encrypted data <span><span><span>CC</span><span aria-hidden=\"true\"><span><span></span><span>C</span></span></span></span></span> does <strong>not involve</strong> Alice's secret key <span><span><span>sksk</span><span aria-hidden=\"true\"><span><span></span><span>s</span><span>k</span></span></span></span></span>. Only her public key <span><span><span>pkpk</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span>k</span></span></span></span></span> is used.</li>\n<li>To obtain <span><span><span>C′C'</span><span aria-hidden=\"true\"><span><span></span><span><span>C</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> as the encryption of <span><span><span>F(x)F(x)</span><span aria-hidden=\"true\"><span><span></span><span>F</span><span>(</span><span>x</span><span>)</span></span></span></span></span>, the evaluation algorithm uses the description of <span><span><span>FF</span><span aria-hidden=\"true\"><span><span></span><span>F</span></span></span></span></span> to do computations on <span><span><span>CC</span><span aria-hidden=\"true\"><span><span></span><span>C</span></span></span></span></span> (which encrypts <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span>).</li>\n<li>By using her secret key, <span><span><span>sksk</span><span aria-hidden=\"true\"><span><span></span><span>s</span><span>k</span></span></span></span></span>, Alice manages to recover the information that interests her, namely <span><span><span>F(x)F(x)</span><span aria-hidden=\"true\"><span><span></span><span>F</span><span>(</span><span>x</span><span>)</span></span></span></span></span>.</li>\n</ul>\n<p><img src=\"/galleries/homomorphic2020/alice.png\" alt=\"alice_overview\"></p>\n<h3>A closer look at the Eval algorithm 🔎</h3>\n<p>All the existing HE constructions are <em>homomorphic</em> with respect to two basic\noperations: some kind of <em>addition</em> and some kind of <em>multiplication</em> (e.g.\n<span><span><span>++</span><span aria-hidden=\"true\"><span><span></span><span>+</span></span></span></span></span> and <span><span><span>×\\times</span><span aria-hidden=\"true\"><span><span></span><span>×</span></span></span></span></span> over the integers or the binary operations <span><span><span>XOR\\mathsf{XOR}</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span>O</span><span>R</span></span></span></span></span></span>\nand <span><span><span>AND\\mathsf{AND}</span><span aria-hidden=\"true\"><span><span></span><span><span>A</span><span>N</span><span>D</span></span></span></span></span></span>, etc.). What we mean is that the scheme allows the\nefficient computation of <span><span><span>caddc_{add}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>a</span><span>d</span><span>d</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> from the individual ciphertexts\n<span><span><span>c1=Enc(pk,m1)c_1=\\mathsf{Enc}(pk,m_1)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span>k</span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> and <span><span><span>c2=Enc(pk,m2)c_2=\\mathsf{Enc}(pk,m_2)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span>k</span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> such that the\ndecryption of <span><span><span>caddc_{add}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>a</span><span>d</span><span>d</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> yields <span><span><span>m1+m2m_1+m_2</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p><img src=\"/galleries/homomorphic2020/eval_sum.png\" alt=\"summation\"></p>\n<p>Analogously, the ciphertext <span><span><span>cmulc_{mul}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>m</span><span>u</span><span>l</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> corresponding to multiplication, that\ndecrypts to <span><span><span>m1×m2m_1\\times m_2</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>×</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, is efficiently computable from the individual\nciphertexts <span><span><span>c1=Enc(pk,m1)c_1=\\mathsf{Enc}(pk,m_1)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span>k</span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> and <span><span><span>c2=Enc(pk,m2)c_2=\\mathsf{Enc}(pk,m_2)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span>k</span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>,\nrespectively.</p>\n<p><img src=\"/galleries/homomorphic2020/eval_mul.png\" alt=\"multiplication\"></p>\n<p>For instance:</p>\n<ul>\n<li>the <a href=\"https://en.wikipedia.org/wiki/RSA_(cryptosystem)\"><strong>RSA</strong></a> encryption: <span><span><span>Ence,NRSA(m):=me mod N\\mathsf{Enc}^{\\mathsf{RSA}}_{e,N}(m):=m^e \\bmod N</span><span aria-hidden=\"true\"><span><span></span><span><span><span>E</span><span>n</span><span>c</span></span><span><span><span><span><span><span></span><span><span><span>e</span><span>,</span><span>N</span></span></span></span><span><span></span><span><span><span><span>R</span><span>S</span><span>A</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>m</span><span>)</span><span></span><span>:</span></span><span><span></span><span>=</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>e</span></span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>N</span></span></span></span></span>  is multiplicatively homomorphic as <span><span><span>m1e⋅m2e mod N=(m1⋅m2)e mod Nm_1^e \\cdot m_2^e \\bmod N = (m_1 \\cdot m_2)^{e} \\bmod N</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>e</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>e</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>N</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>)</span><span><span><span><span><span><span></span><span><span><span>e</span></span></span></span></span></span></span></span></span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>N</span></span></span></span></span></li>\n<li>the <a href=\"https://en.wikipedia.org/wiki/ElGamal_encryption\"><strong>El-Gamal</strong></a> encryption: <span><span><span>Encg,hEG(m)=(gr,hr⋅m)\\mathsf{Enc}^{\\mathsf{EG}}_{g,h}(m)=(g^r,h^r\\cdot m)</span><span aria-hidden=\"true\"><span><span></span><span><span><span>E</span><span>n</span><span>c</span></span><span><span><span><span><span><span></span><span><span><span>g</span><span>,</span><span>h</span></span></span></span><span><span></span><span><span><span><span>E</span><span>G</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>m</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>g</span><span><span><span><span><span><span></span><span><span>r</span></span></span></span></span></span></span></span><span>,</span><span></span><span><span>h</span><span><span><span><span><span><span></span><span><span>r</span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>m</span><span>)</span></span></span></span></span>. It is easy to verify that the multiplicative property holds:</li>\n</ul>\n<p><span><span><span>(gr1,hr1⋅m1)⋅(gr2,hr2⋅m2)=(gr1+r2,hr1+r2⋅(m1⋅m2)). (g^{r_1},h^{r_1}\\cdot m_1)\\cdot (g^{r_2},h^{r_2}\\cdot m_2) =(g^{r_1+r_2},h^{r_1+r_2}\\cdot (m_1\\cdot m_2)).</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>g</span><span><span><span><span><span><span></span><span><span><span><span>r</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>,</span><span></span><span><span>h</span><span><span><span><span><span><span></span><span><span><span><span>r</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span><span>g</span><span><span><span><span><span><span></span><span><span><span><span>r</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>,</span><span></span><span><span>h</span><span><span><span><span><span><span></span><span><span><span><span>r</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>g</span><span><span><span><span><span><span></span><span><span><span><span>r</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>+</span><span><span>r</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>,</span><span></span><span><span>h</span><span><span><span><span><span><span></span><span><span><span><span>r</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>+</span><span><span>r</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>)</span><span>.</span></span></span></span></span></p>\n<p>All the existing HE schemes support only two types of computations on the encrypted data: some forms of addition and multiplication. This means that the <span><span><span>Eval\\mathsf{Eval}</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>v</span><span>a</span><span>l</span></span></span></span></span></span> algorithm works only for functionalities <span><span><span>FF</span><span aria-hidden=\"true\"><span><span></span><span>F</span></span></span></span></span> that can be expressed using additions (<span><span><span>++</span><span aria-hidden=\"true\"><span><span></span><span>+</span></span></span></span></span>) and multiplications (<span><span><span>×\\times</span><span aria-hidden=\"true\"><span><span></span><span>×</span></span></span></span></span>). Another way of saying this is that HE schemes support only arithmetic circuits with addition/multiplication gates. Below we can view as an arithmetic circuit the functionality <span><span><span>F(m1,m2,m3,m4)=m1×m2×m4+m3×m4F(m_1,m_2,m_3,m_4)= m_1\\times m_2\\times m_4 + m_3\\times m_4</span><span aria-hidden=\"true\"><span><span></span><span>F</span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>×</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>×</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>×</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p><img src=\"/galleries/homomorphic2020/arithmetic_circuit.png\" alt=\"arithmetic_circuit\"></p>\n<h3>Why focus on homomorphisms with respect to <em>two</em> operations?</h3>\n<p>In principle, any functionality can be expressed using only two basic operations. For example, any binary circuit can be obtained using <a href=\"https://en.wikipedia.org/wiki/NAND_gate\">NAND</a> gates exclusively. In turn, a NAND operation consists of one addition and one multiplication: <span><span><span>NAND(a,b)=a×b+1 mod 2\\mathsf{NAND}(a,b)=a\\times b + 1\\bmod 2</span><span aria-hidden=\"true\"><span><span></span><span><span>N</span><span>A</span><span>N</span><span>D</span></span><span>(</span><span>a</span><span>,</span><span></span><span>b</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>a</span><span></span><span>×</span><span></span></span><span><span></span><span>b</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>2</span></span></span></span></span>, for any bits <span><span><span>a,b∈{0,1}a,b \\in \\{0,1\\}</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span>,</span><span></span><span>b</span><span></span><span>∈</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>}</span></span></span></span></span>.</p>\n<p>💡 Therefore it is enough to have an HE scheme that supports an\nunlimited number of additions and multiplications to be able to make any\nefficient computation we can think of on encrypted data.</p>\n<h3>Homomorphic Encryption and \"noisy\" ciphertexts</h3>\n<p>The most practical HE constructions rely on the hardness of the <a href=\"https://en.wikipedia.org/wiki/Ring_learning_with_errors\">Ring\nLearning With Errors\n(RLWE)</a> problem for\ntheir security, as is the case with many <a href=\"https://en.wikipedia.org/wiki/Lattice-based_cryptography\">lattice-based\ncryptographic</a>\nconstructions. The inherent <strong>\"noise\"</strong> of the RLWE problem is inherited by\nall the schemes that are based on it. In particular, this \"noise\" element is\npresent in every HE ciphertext and has a great impact on the parameters of\nthe scheme.</p>\n<p><img src=\"/galleries/homomorphic2020/noisy_cyphertext.png\" alt=\"noisy_cyphertext\"></p>\n<p>The noise grows with every addition or multiplication we do on the\nciphertexts. This is very relevant as decryption stops working correctly once\nthe noise exceeds a certain threshold.</p>\n<p>Because of this phenomenon, the number of multiplications and additions that\ncan be carried out correctly on the ciphertext is limited. 💥 The\nparameters of such a scheme can be generated such that it can handle a\nminimum number of operations. But this minimum number must be decided in\nadvance to set the parameters accordingly. We usually call such a scheme\n<em>Somewhat Homomorphic Encryption</em> (SHE) scheme. When the construction allows\nan unbounded number of operations, we call such a scheme <em>Fully Homomorphic\nEncryption</em> (FHE). Even though we are not going to discuss it any further, we\nhave to mention that it's possible to obtain FHE from SHE. In fact, Gentry\n<a href=\"https://www.cs.cmu.edu/~odonnell/hits09/gentry-homomorphic-encryption.pdf\">showed</a>\nhow to transform any SHE (that can homomorphically evaluate its own\ndecryption circuit) to FHE, through a computationally expensive process\ncalled <em>bootstrapping</em>. For applications that don't require many homomorphic\nevaluations SHE is preferred, as we want to avoid the computational overhead\nof the boostrapping.</p>\n<h2>2. A SHE scheme example</h2>\n<p>For the remaining of this blog post we will try to make the concepts that we\nhave already presented more concrete, by discussing a <em>toy implementation</em> of\nthe SHE scheme construction of <a href=\"https://eprint.iacr.org/2012/144\">[FV12]</a>.\nOur main goal is to understand how <em>relinearization</em> and <em>modulus-switching</em>\nare used to obtain ciphertext multiplication.</p>\n<p><strong>Notations:</strong> For an integer <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>, by <span><span><span>Zq\\mathbb{Z}_q</span><span aria-hidden=\"true\"><span><span></span><span><span><span>Z</span></span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> we mean the set\n<span><span><span>{0,1,…,q−1}\\{0,1,\\ldots,q-1\\}</span><span aria-hidden=\"true\"><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span>q</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>}</span></span></span></span></span>. We denote by <span><span><span>[a]q[a]_q</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>a</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> the remainder of <span><span><span>aa</span><span aria-hidden=\"true\"><span><span></span><span>a</span></span></span></span></span> <em>modulo</em> <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>.\nFor example <span><span><span>[18]7=4[18]_7 = 4</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>1</span><span>8</span><span><span>]</span><span><span><span><span><span><span></span><span><span>7</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>4</span></span></span></span></span>. When rounding to the nearest integer, we use\n<span><span><span>⌊⋅⌉\\lfloor \\cdot \\rceil</span><span aria-hidden=\"true\"><span><span></span><span>⌊</span><span>⋅</span><span>⌉</span></span></span></span></span>. The basic elements we work with will not be integers,\nbut merely <em>polynomials with integer coefficients</em>. We also work with <em>noisy\npolynomials</em>, whose coefficients are sampled according to some error\ndistribution <span><span><span>χ\\chi</span><span aria-hidden=\"true\"><span><span></span><span>χ</span></span></span></span></span>. We bound such errors by their largest absolute value of\ntheir coefficients, denoted as <span><span><span>∥⋅∥\\|\\cdot\\|</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span></span><span>⋅</span><span></span></span><span><span></span><span>∥</span></span></span></span></span>.</p>\n<h3>Quick recap on working with polynomials</h3>\n<p>The HE scheme we are going to describe deals with <em>adding and multiplying\npolynomials</em>. Here we present a quick example of how to work with\npolynomials, so that we all have the same starting point. If you already know\nhow to do this, you can skip it.</p>\n<p>First thing, let's add and multiply polynomials <em>modulo some polynomial <span><span><span>ff</span><span aria-hidden=\"true\"><span><span></span><span>f</span></span></span></span></span></em>.\nThis \"modulo <span><span><span>ff</span><span aria-hidden=\"true\"><span><span></span><span>f</span></span></span></span></span>\" thing simply means that we add and multiply the polynomials\nin the usual way, but we take the remainders of the results when divided by\n<span><span><span>ff</span><span aria-hidden=\"true\"><span><span></span><span>f</span></span></span></span></span>. When we do these additions and multiplications <span><span><span> mod f\\bmod f</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>f</span></span></span></span></span>, we sometimes\nsay in a fancy way that we are working in the <em>ring</em> <span><span><span>Z[x]/(f)\\mathbb{Z}[x]/(f)</span><span aria-hidden=\"true\"><span><span></span><span><span>Z</span></span><span>[</span><span>x</span><span>]</span><span>/</span><span>(</span><span>f</span><span>)</span></span></span></span></span> of\nreduced polynomials.💍</p>\n<p>Let's take <span><span><span>f=x4+1f = x^4 +1</span><span aria-hidden=\"true\"><span><span></span><span>f</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span>. If we look at <span><span><span>p(x)=x5p(x) =x^5</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>5</span></span></span></span></span></span></span></span></span></span></span></span>,\nthen <span><span><span>p(x)=x⋅(x4+1)−xp(x) = x \\cdot (x^4 + 1) - x</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>x</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span></span><span>−</span><span></span></span><span><span></span><span>x</span></span></span></span></span>. Therefore, when taking the reminder we get\n<span><span><span>p(x)=−x mod fp(x) = -x \\bmod f</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>−</span><span>x</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>f</span></span></span></span></span>. For faster computations <span><span><span> mod f\\bmod f</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>f</span></span></span></span></span> you can use this trick:\nwhen making <span><span><span> mod f\\bmod f</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>f</span></span></span></span></span>, simply replace <span><span><span>x4x^4</span><span aria-hidden=\"true\"><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span></span></span></span></span> by <span><span><span>−1-1</span><span aria-hidden=\"true\"><span><span></span><span>−</span><span>1</span></span></span></span></span>, <span><span><span>x5x^5</span><span aria-hidden=\"true\"><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>5</span></span></span></span></span></span></span></span></span></span></span></span> by <span><span><span>−x-x</span><span aria-hidden=\"true\"><span><span></span><span>−</span><span>x</span></span></span></span></span> and so on.</p>\n<p>Let's consider two polynomials <span><span><span>a(x)=x3+x2+7a(x) = x^3 + x^2 + 7</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>7</span></span></span></span></span> and <span><span><span>b(x)=x2+11xb(x) = x^2 + 11x</span><span aria-hidden=\"true\"><span><span></span><span>b</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>1</span><span>x</span></span></span></span></span>.\nThen:</p>\n<div><span><span><span>a(x)+b(x) mod f=x3+2x2+11x+7 mod f.a(x)+b(x) \\bmod f = x^3 + 2x^2 + 11x + 7 \\text { mod }f.</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span>(</span><span>x</span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>b</span><span>(</span><span>x</span><span>)</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span></span><span><span></span><span>f</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>2</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>1</span><span>x</span><span></span><span>+</span><span></span></span><span><span></span><span>7</span><span><span> mod </span></span><span>f</span><span>.</span></span></span></span></span></div>\n<p>Here nothing special happened. Let's multiply them:</p>\n<div><span><span><span>a(x)⋅b(x) mod f=(x3+x2+7)⋅(x2+11x) mod f=x5+11x4+x4+11x3+7x2+77x mod f=−x−11−1+11x3+7x2+77x mod f=11x3+7x2+76x−12 mod f.\\begin{aligned}\na(x) \\cdot b(x) \\bmod f\n    &#x26;= (x^3 + x^2 + 7)\\cdot (x^2 +11x) \\text { mod }f \\\\\n    &#x26;= x^5 + 11x^4 + x^4 + 11x^3 + 7x^2 + 77x \\text { mod }f\\\\\n    &#x26;= -x - 11 - 1 + 11x^3 + 7x^2 + 77x \\text { mod }f \\\\\n    &#x26;= 11x^3 + 7x^2 + 76x - 12 \\text { mod }f.\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>a</span><span>(</span><span>x</span><span>)</span><span></span><span>⋅</span><span></span><span>b</span><span>(</span><span>x</span><span>)</span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span></span><span>f</span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span>)</span><span></span><span>⋅</span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>1</span><span>1</span><span>x</span><span>)</span><span><span> mod </span></span><span>f</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>5</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>1</span><span>1</span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>1</span><span>1</span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span>7</span><span>x</span><span><span> mod </span></span><span>f</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>−</span><span>x</span><span></span><span>−</span><span></span><span>1</span><span>1</span><span></span><span>−</span><span></span><span>1</span><span></span><span>+</span><span></span><span>1</span><span>1</span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span>7</span><span>x</span><span><span> mod </span></span><span>f</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>1</span><span>1</span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>7</span><span>6</span><span>x</span><span></span><span>−</span><span></span><span>1</span><span>2</span><span><span> mod </span></span><span>f</span><span>.</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>These operations are implemented\n<a href=\"https://github.com/bit-ml/he-scheme/blob/main/rlwe_he_scheme_updated.py#L7\">here</a>\nand make use of the cool\n<a href=\"https://numpy.org/doc/stable/reference/routines.polynomials.html\">Numpy</a>\nlibrary:</p>\n<div><pre><code><span>import</span><span> </span>numpy<span> </span><span>as</span><span> </span>np<span></span>\n<span></span><span>from</span><span> </span>numpy<span>.</span>polynomial<span> </span><span>import</span><span> </span>polynomial<span> </span><span>as</span><span> </span>poly<span></span>\n<span></span><span></span>\n<span></span><span>#------Functions<span> </span>for<span> </span>polynomial<span> </span>evaluations<span> </span>mod<span> </span>poly_mod<span> </span>only------</span><span></span>\n<span></span><span>def</span><span> </span><span>polymul_wm</span><span>(</span>x<span>,</span><span> </span>y<span>,</span><span> </span>poly_mod<span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>\"\"\"Multiply<span> </span>two<span> </span>polynomials<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Args:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>x,<span> </span>y:<span> </span>two<span> </span>polynomials<span> </span>to<span> </span>be<span> </span>multiplied.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>poly_mod:<span> </span>polynomial<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Returns:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>A<span> </span>polynomial<span> </span>in<span> </span>Z[X]/(poly_mod).<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>\"\"\"</span><span> </span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span>poly<span>.</span>polydiv<span>(</span>poly<span>.</span>polymul<span>(</span>x<span>,</span><span> </span>y<span>)</span><span>,</span><span> </span>poly_mod<span>)</span><span>[</span><span>1</span><span>]</span><span> </span><span></span>\n<span></span><span>def</span><span> </span><span>polyadd_wm</span><span>(</span>x<span>,</span><span> </span>y<span>,</span><span> </span>poly_mod<span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>\"\"\"Add<span> </span>two<span> </span>polynomials<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Args:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>x,<span> </span>y:<span> </span>two<span> </span>polynomials<span> </span>to<span> </span>be<span> </span>added.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>poly_mod:<span> </span>polynomial<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Returns:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>A<span> </span>polynomial<span> </span>in<span> </span>Z[X]/(poly_mod).<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>\"\"\"</span><span> </span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span>poly<span>.</span>polydiv<span>(</span>poly<span>.</span>polyadd<span>(</span>x<span>,</span><span> </span>y<span>)</span><span>,</span><span> </span>poly_mod<span>)</span><span>[</span><span>1</span><span>]</span><span> </span><span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>\n</code></pre></div>\n<p>Now let's go one step further and see how we perform these operations of\npolynomials not just modulo <span><span><span>ff</span><span aria-hidden=\"true\"><span><span></span><span>f</span></span></span></span></span>, <em>but also modulo some integer <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span></em>. As you\nmight expect, the coefficients of these polynomials are also reduced modulo\n<span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>, so they always take integer values from <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span> to <span><span><span>q−1.q-1.</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>.</span></span></span></span></span> This time, we say\nthat we are working the ring of reduced polynomials <span><span><span>Zq[x]/(f)\\mathbb{Z}_q[x]/(f)</span><span aria-hidden=\"true\"><span><span></span><span><span><span>Z</span></span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>x</span><span>]</span><span>/</span><span>(</span><span>f</span><span>)</span></span></span></span></span>.\n💍</p>\n<p>Let's take the previous example, <span><span><span>f=x4+1f = x^4+1</span><span aria-hidden=\"true\"><span><span></span><span>f</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span>, <span><span><span>a(x)=x3+x2+7a(x)=x^3+x^2+7</span><span aria-hidden=\"true\"><span><span></span><span>a</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>7</span></span></span></span></span>,\n<span><span><span>b(x)=x2+11xb(x)=x^2+11x</span><span aria-hidden=\"true\"><span><span></span><span>b</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>1</span><span>x</span></span></span></span></span> and consider <span><span><span>q=5q =5</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span></span><span>=</span><span></span></span><span><span></span><span>5</span></span></span></span></span>. We can think of <span><span><span>aa</span><span aria-hidden=\"true\"><span><span></span><span>a</span></span></span></span></span> and <span><span><span>bb</span><span aria-hidden=\"true\"><span><span></span><span>b</span></span></span></span></span> as already\ntaken <span><span><span> mod f\\bmod f</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>f</span></span></span></span></span>. If we take them further modulo <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>, then <span><span><span>[a(x)]q=x3+x2+2[a(x)]_q = x^3 +\nx^2 +2</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>a</span><span>(</span><span>x</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>2</span></span></span></span></span> and <span><span><span>[b(x)]q=x2+x[b(x)]_q = x^2+x</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>b</span><span>(</span><span>x</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>x</span></span></span></span></span>. Moreover,</p>\n<div><span><span><span>[a(x)+b(x)]q=x3+x2+2+x2+x=x3+2x2+x+2[a(x) + b(x)]_q = x^3 + x^2 +2+ x^2 + x = x^3 + 2x^2 + x+2</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>a</span><span>(</span><span>x</span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>b</span><span>(</span><span>x</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>2</span><span></span><span>+</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>x</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>2</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>x</span><span></span><span>+</span><span></span></span><span><span></span><span>2</span></span></span></span></span></div>\n<p>and</p>\n<div><span><span><span>[a(x)⋅b(x)]q=(x3+x2+2)⋅(x2+x)=x5+x4+x4+x3+2x2+2x=−x−1−1+x3+2x2+2x=x3+2x2+x+3\\begin{aligned}\n[a(x) \\cdot b(x)]_q\n    &#x26;= (x^3 + x^2+2) \\cdot (x^2 + x)\\\\\n    &#x26;= x^5 + x^4 + x^4 +x^3+2x^2 + 2x\\\\\n    &#x26;= -x -1 -1 + x^3 +2x^2+2x\\\\\n    &#x26;= x^3+2x^2+x+3\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>[</span><span>a</span><span>(</span><span>x</span><span>)</span><span></span><span>⋅</span><span></span><span>b</span><span>(</span><span>x</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>2</span><span>)</span><span></span><span>⋅</span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>x</span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>5</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>2</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>2</span><span>x</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>−</span><span>x</span><span></span><span>−</span><span></span><span>1</span><span></span><span>−</span><span></span><span>1</span><span></span><span>+</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>2</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>2</span><span>x</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>2</span><span><span>x</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>x</span><span></span><span>+</span><span></span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>where at the last but one equality we performed modulo <span><span><span>f=x4+1f = x^4+1</span><span aria-hidden=\"true\"><span><span></span><span>f</span><span></span><span>=</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> and at the last one, modulo <span><span><span>q=5q=5</span><span aria-hidden=\"true\"><span><span></span><span>q</span><span></span><span>=</span><span></span></span><span><span></span><span>5</span></span></span></span></span>.</p>\n<p>These operations already mentioned are <span><span><span>polyadd\\texttt{polyadd}</span><span aria-hidden=\"true\"><span><span></span><span><span>polyadd</span></span></span></span></span></span> and\n<span><span><span>polymul\\texttt{polymul}</span><span aria-hidden=\"true\"><span><span></span><span><span>polymul</span></span></span></span></span></span> implemented\n<a href=\"https://github.com/Bitdefender-Crypto-Team/he-scheme/blob/main/rlwe_he_scheme_updated.py\">here</a>.</p>\n<h3>The Fan-Vercauteren ([FV12]) scheme</h3>\n<p>Next, we recall the basic (<span><span><span>Keygen\\mathsf{Keygen}</span><span aria-hidden=\"true\"><span><span></span><span><span>K</span><span>e</span><span>y</span><span>g</span><span>e</span><span>n</span></span></span></span></span></span>, <span><span><span>Enc\\mathsf{Enc}</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span></span></span></span></span>, <span><span><span>Dec\\mathsf{Dec}</span><span aria-hidden=\"true\"><span><span></span><span><span>D</span><span>e</span><span>c</span></span></span></span></span></span>)\nalgorithms of <a href=\"https://eprint.iacr.org/2012/144.pdf\"><strong>the [FV12] scheme</strong></a>.\nThese (almost identical) algorithms have already been described\n<a href=\"https://blog.openmined.org/build-an-homomorphic-encryption-scheme-from-scratch-with-python/#buildanhomomorphicencryptionscheme\">here</a>,\nbut for the sake of completeness, we present them as well. Then we will\nexplain in detail the core of the <span><span><span>Eval\\mathsf{Eval}</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>v</span><span>a</span><span>l</span></span></span></span></span></span> algorithm: the addition and\nmultiplication of the ciphertexts. <em>Spoiler alert</em>: We will primarily focus\non the two <em>Relinearization</em> techniques that enable ciphertext\nmultiplication.</p>\n<p>Let <span><span><span>nn</span><span aria-hidden=\"true\"><span><span></span><span>n</span></span></span></span></span> be power of 2. We call a positive integer <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span> the <em>plaintext\nmodulus</em> and a positive integer <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span> as the <em>ciphertext modulus</em>. We set\n<span><span><span>Δ=⌊q/t⌋\\Delta = \\lfloor q/t \\rfloor</span><span aria-hidden=\"true\"><span><span></span><span>Δ</span><span></span><span>=</span><span></span></span><span><span></span><span>⌊</span><span>q</span><span>/</span><span>t</span><span>⌋</span></span></span></span></span>. The scheme involves adding and multiplying\npolynomials in <span><span><span>Rt=Zt[x]/(xn+1)R_t = \\mathbb{Z}_t[x]/(x^n+1)</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span>Z</span></span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>x</span><span>]</span><span>/</span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span></span></span></span></span>, on the plaintext side, and\nadding and multiplying polynomials in <span><span><span>Rq=Zq[x]/(xn+1)R_q = \\mathbb{Z}_q[x]/(x^n+1)</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span>Z</span></span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>x</span><span>]</span><span>/</span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span></span></span></span></span>, on the\nciphertext side. We also denote by <span><span><span>RR</span><span aria-hidden=\"true\"><span><span></span><span>R</span></span></span></span></span> the ring <span><span><span>Z[x]/(xn+1).\\mathbb{Z}[x]/(x^n+1).</span><span aria-hidden=\"true\"><span><span></span><span><span>Z</span></span><span>[</span><span>x</span><span>]</span><span>/</span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>.</span></span></span></span></span></p>\n<p><strong>Disclaimer</strong>: From now on all polynomial operations are\nassumed to be mod <span><span><span>xn+1x^n+1</span><span aria-hidden=\"true\"><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span>, even if we don't mention it every time.</p>\n<p>Here is the <strong>high level of the scheme</strong>:</p>\n<p><img src=\"/galleries/homomorphic2020/he_scheme5.png\" alt=\"he_scheme5\"></p>\n<p>➡️ <span><span><span>Keygen\\mathsf{Keygen}</span><span aria-hidden=\"true\"><span><span></span><span><span>K</span><span>e</span><span>y</span><span>g</span><span>e</span><span>n</span></span></span></span></span></span>: The <em>secret key</em> <span><span><span>sksk</span><span aria-hidden=\"true\"><span><span></span><span>s</span><span>k</span></span></span></span></span> is a secret binary polynomial <span><span><span>ss</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span> in <span><span><span>RR</span><span aria-hidden=\"true\"><span><span></span><span>R</span></span></span></span></span>, i.e. its coefficients are either 0 or 1. The <em>public key</em> <span><span><span>pkpk</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span>k</span></span></span></span></span> is created as follows: we sample <span><span><span>aa</span><span aria-hidden=\"true\"><span><span></span><span>a</span></span></span></span></span> uniformly over <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and an error <span><span><span>ee</span><span aria-hidden=\"true\"><span><span></span><span>e</span></span></span></span></span> according to some error distribution <span><span><span>χ\\chi</span><span aria-hidden=\"true\"><span><span></span><span>χ</span></span></span></span></span> over <span><span><span>RR</span><span aria-hidden=\"true\"><span><span></span><span>R</span></span></span></span></span> and output <span><span><span>pk=([−(a⋅s+e)]q,a)∈Rq×Rqpk = ([-(a\\cdot s+e)]_q,a) \\in R_q \\times R_q</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span>k</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>[</span><span>−</span><span>(</span><span>a</span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span>e</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>a</span><span>)</span><span></span><span>∈</span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>×</span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>Notice that hardness of the\n<a href=\"https://en.wikipedia.org/wiki/Ring_learning_with_errors#The_RLWE_Problem\">RLWE</a>\nproblem prevents the computation of the secret <span><span><span>ss</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span> from the public key.</p>\n<p>The way we generate the uniform polynomials and the binary polynomials is\nimplemented as <span><span><span>gen_uniform_poly\\texttt{gen\\_uniform\\_poly}</span><span aria-hidden=\"true\"><span><span></span><span><span>gen_uniform_poly</span></span></span></span></span></span> and as\n<span><span><span>gen_binary_poly\\texttt{gen\\_binary\\_poly}</span><span aria-hidden=\"true\"><span><span></span><span><span>gen_binary_poly</span></span></span></span></span></span> respectively. The error distribution <span><span><span>χ\\chi</span><span aria-hidden=\"true\"><span><span></span><span>χ</span></span></span></span></span> is\nusually taken as a discretized variant of the\n<a href=\"https://en.wikipedia.org/wiki/Normal_distribution\"><em>Normal distribution</em></a>, over\n<span><span><span>Zn\\mathbb{Z}^n</span><span aria-hidden=\"true\"><span><span></span><span><span><span>Z</span></span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span>, and is implemented as <span><span><span>gen_normal_poly\\texttt{gen\\_normal\\_poly}</span><span aria-hidden=\"true\"><span><span></span><span><span>gen_normal_poly</span></span></span></span></span></span>.\nThey can be found\n<a href=\"https://github.com/bit-ml/he-scheme/blob/main/rlwe_he_scheme_updated.py#L118\">here</a>.</p>\n<div><pre><code><span>def</span><span> </span><span>keygen</span><span>(</span>size<span>,</span><span> </span>modulus<span>,</span><span> </span>poly_mod<span>,</span><span> </span>std1<span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>\"\"\"Generate<span> </span>a<span> </span>public<span> </span>and<span> </span>secret<span> </span>keys.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Args:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>size:<span> </span>size<span> </span>of<span> </span>the<span> </span>polynoms<span> </span>for<span> </span>the<span> </span>public<span> </span>and<span> </span>secret<span> </span>keys.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>modulus:<span> </span>coefficient<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>poly_mod:<span> </span>polynomial<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>std1:<span> </span>standard<span> </span>deviation<span> </span>of<span> </span>the<span> </span>error.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Returns:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Public<span> </span>and<span> </span>secret<span> </span>key.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>\"\"\"</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>s<span> </span><span>=</span><span> </span>gen_binary_poly<span>(</span>size<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>a<span> </span><span>=</span><span> </span>gen_uniform_poly<span>(</span>size<span>,</span><span> </span>modulus<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>e<span> </span><span>=</span><span> </span>gen_normal_poly<span>(</span>size<span>,</span><span> </span><span>0</span><span>,</span><span> </span>std1<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>b<span> </span><span>=</span><span> </span>polyadd<span>(</span>polymul<span>(</span><span>-</span>a<span>,</span><span> </span>s<span>,</span><span> </span>modulus<span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span> </span><span>-</span>e<span>,</span><span> </span>modulus<span>,</span><span> </span>poly_mod<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span><span>(</span>b<span>,</span><span> </span>a<span>)</span><span>,</span><span> </span>s<span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>\n</code></pre></div>\n<p>➡️ <span><span><span>Enc\\mathsf{Enc}</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span></span></span></span></span>: To encrypt a <em>plaintext</em> <span><span><span>m∈Rtm \\in R_t</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span></span><span>∈</span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, we let <span><span><span>pk=(pk0,pk1)pk = (pk_0, pk_1)</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span>k</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>, sample <span><span><span>u,e1,e2u, e_1, e_2</span><span aria-hidden=\"true\"><span><span></span><span>u</span><span>,</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> according to <span><span><span>χ\\chi</span><span aria-hidden=\"true\"><span><span></span><span>χ</span></span></span></span></span> over <span><span><span>RR</span><span aria-hidden=\"true\"><span><span></span><span>R</span></span></span></span></span> and output the <em>ciphertext</em></p>\n<div><span><span><span>Enc(pk,m)=([pk0⋅u+e1+Δ⋅m]q,[pk1⋅u+e2]q)∈Rq×Rq\\mathsf{Enc}(pk,m) = ([pk_0 \\cdot u +e_1 + \\Delta \\cdot m]_q,[pk_1 \\cdot u + e_2]_q) \\in R_q \\times R_q</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span>k</span><span>,</span><span></span><span>m</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>[</span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>u</span><span></span><span>+</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>m</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>[</span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>u</span><span></span><span>+</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>∈</span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>×</span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></div>\n<p>Due to the <a href=\"https://en.wikipedia.org/wiki/Ring_learning_with_errors#The_RLWE_Problem\">RLWE</a> assumption, the ciphertexts \"look\" uniformly random to a possible attacker, so they don't reveal any information about the plaintext.</p>\n<p>In the piece of <a href=\"https://github.com/bit-ml/he-scheme/blob/main/rlwe_he_scheme_updated.py#L188\">code</a> below, the message we want to encrypt, <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span>, is an integer vector of length at most <span><span><span>nn</span><span aria-hidden=\"true\"><span><span></span><span>n</span></span></span></span></span>, with entries in the set <span><span><span>{0,1,…,t−1}\\{0, 1,\\ldots, t-1\\}</span><span aria-hidden=\"true\"><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span>t</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>}</span></span></span></span></span>. Before we encode it as a polynomial in <span><span><span>m∈Rtm \\in R_t</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span></span><span>∈</span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, we pad it with enough zeros to make it a length <span><span><span>nn</span><span aria-hidden=\"true\"><span><span></span><span>n</span></span></span></span></span> vector.</p>\n<div><pre><code><span>def</span><span> </span><span>encrypt</span><span>(</span>pk<span>,</span><span> </span>size<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>,</span><span> </span>m<span>,</span><span> </span>std1<span>)</span><span>:</span><span> </span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>\"\"\"Encrypt<span> </span>an<span> </span>integer<span> </span>vector<span> </span>pt.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Args:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>pk:<span> </span>public-key.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>size:<span> </span>size<span> </span>of<span> </span>polynomials.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>q:<span> </span>ciphertext<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>t:<span> </span>plaintext<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>poly_mod:<span> </span>polynomial<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>m:<span> </span>plaintext<span> </span>message,<span> </span>as<span> </span>an<span> </span>integer<span> </span>vector<span> </span>(of<span> </span>length<span> </span>&#x3C;=<span> </span>size)<span> </span>with<span> </span>entries<span> </span>mod<span> </span>t.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Returns:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Tuple<span> </span>representing<span> </span>a<span> </span>ciphertext.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>\"\"\"</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>m<span> </span><span>=</span><span> </span>np<span>.</span>array<span>(</span>m<span> </span><span>+</span><span> </span><span>[</span><span>0</span><span>]</span><span> </span><span>*</span><span> </span><span>(</span>size<span> </span><span>-</span><span> </span><span>len</span><span>(</span>m<span>)</span><span>)</span><span>,</span><span> </span>dtype<span>=</span>np<span>.</span>int64<span>)</span><span> </span><span>%</span><span> </span>t<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>delta<span> </span><span>=</span><span> </span>q<span> </span><span>//</span><span> </span>t<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>scaled_m<span> </span><span>=</span><span> </span>delta<span> </span><span>*</span><span> </span>m<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>e1<span> </span><span>=</span><span> </span>gen_normal_poly<span>(</span>size<span>,</span><span> </span><span>0</span><span>,</span><span> </span>std1<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>e2<span> </span><span>=</span><span> </span>gen_normal_poly<span>(</span>size<span>,</span><span> </span><span>0</span><span>,</span><span> </span>std1<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>u<span> </span><span>=</span><span> </span>gen_binary_poly<span>(</span>size<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>ct0<span> </span><span>=</span><span> </span>polyadd<span>(</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>polyadd<span>(</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>polymul<span>(</span>pk<span>[</span><span>0</span><span>]</span><span>,</span><span> </span>u<span>,</span><span> </span>q<span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>e1<span>,</span><span> </span>q<span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>scaled_m<span>,</span><span> </span>q<span>,</span><span> </span>poly_mod<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>ct1<span> </span><span>=</span><span> </span>polyadd<span>(</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>polymul<span>(</span>pk<span>[</span><span>1</span><span>]</span><span>,</span><span> </span>u<span>,</span><span> </span>q<span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>e2<span>,</span><span> </span>q<span>,</span><span> </span>poly_mod<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span><span>(</span>ct0<span>,</span><span> </span>ct1<span>)</span><span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>\n</code></pre></div>\n<p>➡️ <span><span><span>Dec\\mathsf{Dec}</span><span aria-hidden=\"true\"><span><span></span><span><span>D</span><span>e</span><span>c</span></span></span></span></span></span>: Given a ciphertext <span><span><span>ct=Enc(pk,m)=(ct0,ct1)ct = \\mathsf{Enc}(pk,m)=(ct_0, ct_1)</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span>t</span><span></span><span>=</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span>k</span><span>,</span><span></span><span>m</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>, we decrypt it using the secret key <span><span><span>sk=ssk=s</span><span aria-hidden=\"true\"><span><span></span><span>s</span><span>k</span><span></span><span>=</span><span></span></span><span><span></span><span>s</span></span></span></span></span> as follows:</p>\n<div><span><span><span>Dec(sk,ct)=[⌊t⋅[ct0+ct1⋅s]qq⌉]t∈Rt\\mathsf{Dec}(sk,ct) = \\Bigg[ \\Bigg\\lfloor \\frac{t\\cdot [ct_0+ct_1\\cdot s]_q}{q} \\Bigg\\rceil \\Bigg]_t \\in R_t</span><span aria-hidden=\"true\"><span><span></span><span><span>D</span><span>e</span><span>c</span></span><span>(</span><span>s</span><span>k</span><span>,</span><span></span><span>c</span><span>t</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>[</span></span><span><span>⌊</span></span><span><span></span><span><span><span><span><span><span></span><span><span>q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>t</span><span></span><span>⋅</span><span></span><span>[</span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>⌉</span></span><span><span><span>]</span></span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>∈</span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></div>\n<p>⛔ Let's stop for a bit and check together how the <span><span><span>Dec\\mathsf{Dec}</span><span aria-hidden=\"true\"><span><span></span><span><span>D</span><span>e</span><span>c</span></span></span></span></span></span> algorithm works. The intuition behind it is that <span><span><span>pk0+pk1⋅skpk_0 + pk_1\\cdot sk</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span>k</span></span></span></span></span> is \"small\". This implies that <span><span><span>ct0+ct1⋅skct_0 + ct_1\\cdot sk</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span>k</span></span></span></span></span> is \"close\" to the scaled message <span><span><span>Δ⋅m\\Delta \\cdot m</span><span aria-hidden=\"true\"><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>m</span></span></span></span></span>. To recover the message <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span>, we get rid of <span><span><span>Δ\\Delta</span><span aria-hidden=\"true\"><span><span></span><span>Δ</span></span></span></span></span> <span><span><span>(≈q/t)(\\approx q/t)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>≈</span><span></span></span><span><span></span><span>q</span><span>/</span><span>t</span><span>)</span></span></span></span></span> and then apply rounding to shave off the \"small\" noise. Let's check that this intuition actually works.</p>\n<p>First, we set the notation <span><span><span>ct(s):=ct0+ct1⋅sct(s) := ct_0 + ct_1 \\cdot s</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span>t</span><span>(</span><span>s</span><span>)</span><span></span><span>:</span></span><span><span></span><span>=</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span></span></span></span></span>, which we'll frequently use for the rest of the post. If we perform this computation, we will end up getting <em>a noisy scaled variant of the plaintext</em>, namely <span><span><span>Δ⋅m+v\\Delta \\cdot m+v</span><span aria-hidden=\"true\"><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span>v</span></span></span></span></span>!</p>\n<p>If we go back to see how <span><span><span>ctct</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span>t</span></span></span></span></span> and <span><span><span>pkpk</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span>k</span></span></span></span></span> were defined, we get:</p>\n<div><span><span><span>[ct(s)]q=[(pk0⋅u+e1+Δ⋅m)+(pk1⋅u+e2)⋅s]q=[−(a⋅s+e)⋅u+e1+Δ⋅m+a⋅u⋅s+e2⋅s]q=Δ⋅m−e⋅u+e1+e2⋅s=Δ⋅m+v,\\begin{aligned}\n[ct(s)]_q &#x26;= [(pk_0 \\cdot u + e_1 + \\Delta \\cdot m) + (pk_1 \\cdot u + e_2) \\cdot s]_q\\\\\n    &#x26;= [-(a\\cdot s + e)\\cdot u+e_1 + \\Delta \\cdot m + a \\cdot u \\cdot s + e_2 \\cdot s]_q\\\\\n    &#x26;= \\Delta \\cdot m - e \\cdot u + e_1 + e_2 \\cdot s\\\\\n    &#x26;= \\Delta \\cdot m + v,\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>[</span><span>c</span><span>t</span><span>(</span><span>s</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>[</span><span>(</span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>Δ</span><span></span><span>⋅</span><span></span><span>m</span><span>)</span><span></span><span>+</span><span></span><span>(</span><span>p</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span><span>s</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>[</span><span>−</span><span>(</span><span>a</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span>e</span><span>)</span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>Δ</span><span></span><span>⋅</span><span></span><span>m</span><span></span><span>+</span><span></span><span>a</span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>Δ</span><span></span><span>⋅</span><span></span><span>m</span><span></span><span>−</span><span></span><span>e</span><span></span><span>⋅</span><span></span><span>u</span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>Δ</span><span></span><span>⋅</span><span></span><span>m</span><span></span><span>+</span><span></span><span>v</span><span>,</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>which is nothing but the scaled plaintext <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span> with some <em>\"small\" noise</em> <span><span><span>vv</span><span aria-hidden=\"true\"><span><span></span><span>v</span></span></span></span></span>.</p>\n<p>Because we always have <span><span><span>∥Δ⋅m+v∥&#x3C;q\\|\\Delta\\cdot m + v\\| &#x3C; q</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span>v</span><span>∥</span><span></span><span>&#x3C;</span><span></span></span><span><span></span><span>q</span></span></span></span></span>, reducing it <span><span><span> mod q\\bmod q</span><span aria-hidden=\"true\"><span><span></span><span></span><span><span><span>m</span><span>o</span><span>d</span></span></span><span></span><span>q</span></span></span></span></span> has no effect (e.g. <span><span><span>[4]7=4[4]_{7} = 4</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>4</span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>7</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>4</span></span></span></span></span>). As long as the noise <span><span><span>∥v∥&#x3C;Δ/2\\|v\\|&#x3C;\\Delta/2</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span>v</span><span>∥</span><span></span><span>&#x3C;</span><span></span></span><span><span></span><span>Δ</span><span>/</span><span>2</span></span></span></span></span>, we can always recover the correct <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span>.</p>\n<p><img src=\"/galleries/homomorphic2020/dec_details.png\" alt=\"decoder_details\"></p>\n<p>For example, in the picture above, any green point will decrypt to <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> when we scale it by <span><span><span>t/qt/q</span><span aria-hidden=\"true\"><span><span></span><span>t</span><span>/</span><span>q</span></span></span></span></span> <span><span><span>(≈1/Δ)(\\approx 1/\\Delta)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>≈</span><span></span></span><span><span></span><span>1</span><span>/</span><span>Δ</span><span>)</span></span></span></span></span> and round it. Analogously, any dark-brown point will decrypt to <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>.</p>\n<p>We can implement this evaluation, as <span><span><span>scaled_pt\\texttt{scaled\\_pt}</span><span aria-hidden=\"true\"><span><span></span><span><span>scaled_pt</span></span></span></span></span></span> below, by performing polynomial operations in <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. You will see that this equation,</p>\n<div><span><span><span>[ct(s)]q=[ct0+ct1⋅s]q=Δ⋅m+v,[ct(s)]_q = [ct_0 + ct_1 \\cdot s]_q = \\Delta \\cdot m + v,</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>c</span><span>t</span><span>(</span><span>s</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>[</span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span>v</span><span>,</span></span></span></span></span></div>\n<p>which we will call <em>the decryption equation</em>, becomes really useful in deriving ways of computing on ciphertexts. Here we provide the <a href=\"https://github.com/bit-ml/he-scheme/blob/main/rlwe_he_scheme_updated.py#L219\">code</a> for the <span><span><span>Dec\\mathsf{Dec}</span><span aria-hidden=\"true\"><span><span></span><span><span>D</span><span>e</span><span>c</span></span></span></span></span></span> algorithm:</p>\n<div><pre><code><span>def</span><span> </span><span>decrypt</span><span>(</span>sk<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>,</span><span> </span>ct<span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>\"\"\"Decrypt<span> </span>a<span> </span>ciphertext.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Args:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>sk:<span> </span>secret-key.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>size:<span> </span>size<span> </span>of<span> </span>polynomials.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>q:<span> </span>ciphertext<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>t:<span> </span>plaintext<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>poly_mod:<span> </span>polynomial<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>ct:<span> </span>ciphertext.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Returns:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Integer<span> </span>vector<span> </span>representing<span> </span>the<span> </span>plaintext.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>\"\"\"</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>scaled_pt<span> </span><span>=</span><span> </span>polyadd<span>(</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>polymul<span>(</span>ct<span>[</span><span>1</span><span>]</span><span>,</span><span> </span>sk<span>,</span><span> </span>q<span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>ct<span>[</span><span>0</span><span>]</span><span>,</span><span> </span>q<span>,</span><span> </span>poly_mod<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>decrypted_poly<span> </span><span>=</span><span> </span>np<span>.</span><span>round</span><span>(</span>t<span> </span><span>*</span><span> </span>scaled_pt<span> </span><span>/</span><span> </span>q<span>)</span><span> </span><span>%</span><span> </span>t<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span>np<span>.</span>int64<span>(</span>decrypted_poly<span>)</span><span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>\n</code></pre></div>\n<h3>Homomorphic operations of [FV12]</h3>\n<p>As explained in the first part, the <span><span><span>Eval\\mathsf{Eval}</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>v</span><span>a</span><span>l</span></span></span></span></span></span> algorithm works only for functionalities that can be expressed using addition <span><span><span>(+)(+)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>+</span><span>)</span></span></span></span></span> or multiplication <span><span><span>(×)(\\times)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>×</span><span>)</span></span></span></span></span>.</p>\n<p>Let's take two ciphertexts <span><span><span>ct=Enc(pk,m)ct = \\mathsf{Enc}(pk,m)</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span>t</span><span></span><span>=</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span>k</span><span>,</span><span></span><span>m</span><span>)</span></span></span></span></span> and <span><span><span>ct′=Enc(pk,m′)ct' = \\mathsf{Enc}(pk,m')</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span>k</span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span></span></span></span></span>. We want to see how to construct ciphertexts that decrypt both the addition, <span><span><span>m+m′m+m'</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span>, and the multiplication, <span><span><span>m⋅m′m\\cdot m'</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span>. Also, keep in mind that when performing operations on <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span> and <span><span><span>m′m'</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span>, we are actually doing them <em>modulo <span><span><span>xn+1x^n+1</span><span aria-hidden=\"true\"><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span></em> and <em>modulo <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span></em>, since these are the plaintext operations from <span><span><span>Rt=Zt[x]/(xn+1)R_t = \\mathbb{Z}_t[x]/(x^n+1)</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span>Z</span></span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>x</span><span>]</span><span>/</span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span></span></span></span></span>.</p>\n<p>Let's write the decryption equations of <span><span><span>ctct</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span>t</span></span></span></span></span> and <span><span><span>ct′ct'</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span>:</p>\n<div><span><span><span>[ct(s)]q=Δ⋅m+v and [ct′(s)]q=Δ⋅m′+v′.[ct(s)]_q = \\Delta \\cdot m + v \\text{ and } [ct'(s)]_q = \\Delta \\cdot m' + v'.</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>c</span><span>t</span><span>(</span><span>s</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span>v</span><span><span> and </span></span><span>[</span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>(</span><span>s</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>.</span></span></span></span></span></div>\n<p>➡️ <strong>Addition:</strong> If we simply add the decryption equations, we get</p>\n<div><span><span><span>[ct(s)]q+[ct′(s)]q=Δ⋅(m+m′)+v+v′.[ct(s)]_q + [ct'(s)]_q = \\Delta \\cdot (m+m') + v  + v'.</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>c</span><span>t</span><span>(</span><span>s</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>[</span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>(</span><span>s</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>v</span><span></span><span>+</span><span></span></span><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>.</span></span></span></span></span></div>\n<p>But wait a sec, we need to decrypt to <span><span><span>m1+m2m_1+m_2</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> modulo <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span>! Notice that <span><span><span>m+m′=t⋅ϵ+[m+m′]tm + m' = t \\cdot \\epsilon + [m+m']_t</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>t</span><span></span><span>⋅</span><span></span></span><span><span></span><span>ϵ</span><span></span><span>+</span><span></span></span><span><span></span><span>[</span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, for some binary polynomial <span><span><span>ϵ\\epsilon</span><span aria-hidden=\"true\"><span><span></span><span>ϵ</span></span></span></span></span>. Using the notation <span><span><span>rt(q):=q−Δ⋅tr_t(q):= q- \\Delta \\cdot t</span><span aria-hidden=\"true\"><span><span></span><span><span>r</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>q</span><span>)</span><span></span><span>:</span></span><span><span></span><span>=</span><span></span></span><span><span></span><span>q</span><span></span><span>−</span><span></span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>t</span></span></span></span></span> (this is just the remainder of <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span> divided by <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span>) we get:</p>\n<div><span><span><span>[ct(s)+ct′(s)]q=Δ⋅[m+m′]t+vadd mod q,\\begin{aligned}\n[ct(s) + ct'(s)]_q = \\Delta \\cdot [m+m']_t + v_{add} \\text{ mod }q,\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>[</span><span>c</span><span>t</span><span>(</span><span>s</span><span>)</span><span></span><span>+</span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>(</span><span>s</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span><span>Δ</span><span></span><span>⋅</span><span></span><span>[</span><span>m</span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>a</span><span>d</span><span>d</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span> mod </span></span><span>q</span><span>,</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>where <span><span><span>vadd=v+v′−rt(q)⋅ϵv_{add} = v+v'-r_t(q) \\cdot \\epsilon</span><span aria-hidden=\"true\"><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>a</span><span>d</span><span>d</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>v</span><span></span><span>+</span><span></span></span><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>−</span><span></span></span><span><span></span><span><span>r</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>q</span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>ϵ</span></span></span></span></span>.Click here if you want to see why this follows.</p>\n<div><span><span><span>[ct(s)+ct′(s)]q=Δ⋅[m+m′]t+Δ⋅t⋅ϵ+v+v′=Δ⋅[m+m′]t+(q−rt(q))⋅ϵ+v+v′≡Δ⋅[m+m′]t+vadd mod q.\\begin{aligned}\n[ct(s) + ct'(s)]_q \n    =&#x26; \\Delta \\cdot [m+m']_t + \\Delta \\cdot t \\cdot \\epsilon + v  + v' \\\\\n    =&#x26; \\Delta \\cdot [m+m']_t + (q-r_t(q)) \\cdot \\epsilon + v+v' \\\\\n    \\equiv&#x26; \\Delta \\cdot [m+m']_t + v_{add} \\text{ mod }q.\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>[</span><span>c</span><span>t</span><span>(</span><span>s</span><span>)</span><span></span><span>+</span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>(</span><span>s</span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span></span></span><span><span></span><span><span>=</span></span></span><span><span></span><span><span>≡</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span><span>[</span><span>m</span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>Δ</span><span></span><span>⋅</span><span></span><span>t</span><span></span><span>⋅</span><span></span><span>ϵ</span><span></span><span>+</span><span></span><span>v</span><span></span><span>+</span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span><span>[</span><span>m</span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>(</span><span>q</span><span></span><span>−</span><span></span><span><span>r</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>q</span><span>)</span><span>)</span><span></span><span>⋅</span><span></span><span>ϵ</span><span></span><span>+</span><span></span><span>v</span><span></span><span>+</span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span><span>[</span><span>m</span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>a</span><span>d</span><span>d</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span> mod </span></span><span>q</span><span>.</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>This suggests to set the new ciphertext as <span><span><span>cadd=(ct0+ct0′, ct1+ct1′)c_{add}=(ct_0+ct'_0, \\text{ }ct_1+ct'_1)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>a</span><span>d</span><span>d</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span> </span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>, which can be computed without the knowledge of the secret key <span><span><span>ss</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span>. Therefore, <span><span><span>cadd=ct+ct′c_{add} = ct + ct'</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>a</span><span>d</span><span>d</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>c</span><span>t</span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> decrypts to the sum, <span><span><span>[m+m′]t[m+m']_t</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>m</span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, as long as the new \"noise\", <span><span><span>vaddv_{add}</span><span aria-hidden=\"true\"><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>a</span><span>d</span><span>d</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, is smaller than <span><span><span>Δ/2\\Delta/2</span><span aria-hidden=\"true\"><span><span></span><span>Δ</span><span>/</span><span>2</span></span></span></span></span>.</p>\n<p>💡 The <strong>noise growth</strong> for <strong>addition</strong> is quite slow as <span><span><span>∥vadd∥&#x3C;∥v∥+∥v′∥+t&#x3C;2B+t\\|v_{add}\\|&#x3C;\\|v\\|+\\|v'\\| + t &#x3C; 2B+t</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>a</span><span>d</span><span>d</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∥</span><span></span><span>&#x3C;</span><span></span></span><span><span></span><span>∥</span><span>v</span><span>∥</span><span></span><span>+</span><span></span></span><span><span></span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>∥</span><span></span><span>+</span><span></span></span><span><span></span><span>t</span><span></span><span>&#x3C;</span><span></span></span><span><span></span><span>2</span><span>B</span><span></span><span>+</span><span></span></span><span><span></span><span>t</span></span></span></span></span>, where <span><span><span>BB</span><span aria-hidden=\"true\"><span><span></span><span>B</span></span></span></span></span> is an upper bound on the \"noise\" of the ciphertexts that were added. This means we can probably do many additions before decryption stops working.</p>\n<p>To <a href=\"https://github.com/bit-ml/he-scheme/blob/main/rlwe_he_scheme_updated.py#L261\">add ciphertexts</a>, it seems like we only need to add polynomials in <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. So, ciphertext addition is a piece of cake 🍰.</p>\n<div><pre><code><span>def</span><span> </span><span>add_cipher</span><span>(</span>ct1<span>,</span><span> </span>ct2<span>,</span><span> </span>q<span>,</span><span> </span>poly_mod<span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>\"\"\"Add<span> </span>a<span> </span>ciphertext<span> </span>and<span> </span>a<span> </span>ciphertext.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Args:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>ct1,<span> </span>ct2:<span> </span>ciphertexts.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>q:<span> </span>ciphertext<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>poly_mod:<span> </span>polynomial<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Returns:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Tuple<span> </span>representing<span> </span>a<span> </span>ciphertext.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>\"\"\"</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>new_ct0<span> </span><span>=</span><span> </span>polyadd<span>(</span>ct1<span>[</span><span>0</span><span>]</span><span>,</span><span> </span>ct2<span>[</span><span>0</span><span>]</span><span>,</span><span> </span>q<span>,</span><span> </span>poly_mod<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>new_ct1<span> </span><span>=</span><span> </span>polyadd<span>(</span>ct1<span>[</span><span>1</span><span>]</span><span>,</span><span> </span>ct2<span>[</span><span>1</span><span>]</span><span>,</span><span> </span>q<span>,</span><span> </span>poly_mod<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span><span>(</span>new_ct0<span>,</span><span> </span>new_ct1<span>)</span><span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>\n</code></pre></div>\n<p>➡️ <strong>Multiplication:</strong> Producing a new ciphertext that decrypts the product of the two messages is not that easy. But we should still try 🤞. The first idea that comes to mind is to simply multiply the decryption equations. It worked for addition, so maybe it works here as well.</p>\n<div><span><span><span>ct(s)⋅ct′(s)=Δ2⋅mm′+Δ⋅(mv′+m′v)+vv′.  (1)ct(s) \\cdot ct'(s) = \\Delta^2 \\cdot mm' + \\Delta\\cdot (mv'+m'v) + vv'. \\text{ } \\ (1)</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span>t</span><span>(</span><span>s</span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>(</span><span>s</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>Δ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>m</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>v</span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>v</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>.</span><span><span> </span></span><span> </span><span>(</span><span>1</span><span>)</span></span></span></span></span></div>\n<p>If we scale by <span><span><span>t/qt/q</span><span aria-hidden=\"true\"><span><span></span><span>t</span><span>/</span><span>q</span></span></span></span></span> to get rid of one <span><span><span>Δ\\Delta</span><span aria-hidden=\"true\"><span><span></span><span>Δ</span></span></span></span></span>, we get something that looks like what we want.</p>\n<div><span><span><span>tq⋅ct(s)⋅ct′(s)≈Δ⋅mm′+(mv′+m′v)\\frac{t}{q}\\cdot ct(s) \\cdot ct'(s) \\approx \\Delta \\cdot mm' + (mv'+m'v)</span><span aria-hidden=\"true\"><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>q</span></span></span><span><span></span><span></span></span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>c</span><span>t</span><span>(</span><span>s</span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>(</span><span>s</span><span>)</span><span></span><span>≈</span><span></span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>(</span><span>m</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>v</span><span>)</span></span></span></span></span></div>\n<p>It seems we are on the right track. Let's examine these expressions further. Recall the notations <span><span><span>ct(s)=ct0+ct1⋅sct(s) = ct_0 + ct_1\\cdot s</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span>t</span><span>(</span><span>s</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span></span></span></span></span> and  <span><span><span>ct′(s)=ct0′+ct1′⋅s.ct'(s) = ct'_0 + ct'_1\\cdot s.</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>(</span><span>s</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span>.</span></span></span></span></span> Both of them are <em>linear</em> in <span><span><span>ss</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span>, but their multiplication is <em>quadratic</em> in <span><span><span>ss</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span>:</p>\n<div><span><span><span>ct⋅ct′(s)=ct0⋅ct0′+(ct0⋅ct1′+ct1⋅ct0′)s+ct1⋅ct1′s2,ct\\cdot ct'(s) = ct_0\\cdot ct'_0 + (ct_0\\cdot ct'_1 + ct_1\\cdot ct'_0)s +ct_1\\cdot ct'_1s^2, </span><span aria-hidden=\"true\"><span><span></span><span>c</span><span>t</span><span></span><span>⋅</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>(</span><span>s</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>(</span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>,</span></span></span></span></span></div>\n<p>which we will write, in short, as <span><span><span>ct⋅ct′(s)=c0×+c1×⋅s+c2×⋅s2.ct \\cdot ct' (s) = c_0^\\times + c_1^{\\times}\\cdot s + c_2^{\\times} \\cdot s^2.</span><span aria-hidden=\"true\"><span><span></span><span>c</span><span>t</span><span></span><span>⋅</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>(</span><span>s</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>×</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>×</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span><span>×</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>.</span></span></span></span></span></p>\n<p>But what about the right hand side?  Keep in mind that we work with plaintexts <span><span><span>m,m′∈Rtm, m' \\in R_t</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>∈</span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, so we should take <span><span><span>mm′mm'</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> with <em>coefficients modulo <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span></em>. Therefore, we can apply the same trick as we did for addition: we divide by <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span> and write <span><span><span>mm′=trm+[mm′]tmm' = tr_m + [mm']_t</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>t</span><span><span>r</span><span><span><span><span><span><span></span><span><span>m</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>[</span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, where <span><span><span>rmr_m</span><span aria-hidden=\"true\"><span><span></span><span><span>r</span><span><span><span><span><span><span></span><span><span>m</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> is an integer polynomial. Skipping a lot of details, we end up with:</p>\n<div><span><span><span>t/q⋅ct⋅ct′(s)=Δ⋅[mm′]t+u2t/q \\cdot ct \\cdot ct'(s) = \\Delta \\cdot [mm']_t + u_2</span><span aria-hidden=\"true\"><span><span></span><span>t</span><span>/</span><span>q</span><span></span><span>⋅</span><span></span></span><span><span></span><span>c</span><span>t</span><span></span><span>⋅</span><span></span></span><span><span></span><span>c</span><span><span>t</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>(</span><span>s</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>[</span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></div>\n<p>for <span><span><span>u2u_2</span><span aria-hidden=\"true\"><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> a polynomial with <em>rational</em> coefficients. Looks like we're getting closer to obtaining the decryption equation. We can now write the original expression <span><span><span>(1)(1)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>1</span><span>)</span></span></span></span></span> as:</p>\n<div><span><span><span>t/q⋅c0×+t/q⋅c1×⋅s+t/q⋅c2×⋅s2=Δ⋅[mm′]t+u2t/q \\cdot c_0^\\times + t/q \\cdot c_1^{\\times} \\cdot s + t/q \\cdot c_2^{\\times} \\cdot s^2 = \\Delta \\cdot [mm']_t + u_2</span><span aria-hidden=\"true\"><span><span></span><span>t</span><span>/</span><span>q</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span>×</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>t</span><span>/</span><span>q</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>×</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span>t</span><span>/</span><span>q</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span><span>×</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>[</span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></div>\n<p>Hm.. these coefficients look like <em>rational polynomials</em>.  Recall that the ciphertext has <em>integer polynomials</em> as elements. So we round each coefficient appearing in the left hand side to their nearest integers and then reduce the whole equation modulo <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>:</p>\n<div><span><span><span>[⌊t/q⋅c0×⌉]q+[⌊t/q⋅c1×⌉]q⋅s+[⌊t/q⋅c2×⌉]q⋅s2=Δ⋅[mm′]t+u3  (2)[\\lfloor t/q \\cdot c_0^{\\times} \\rceil]_q + [\\lfloor t/q \\cdot c_1^{\\times}\\rceil]_q \\cdot s + [\\lfloor t/q \\cdot c_2^{\\times}\\rceil]_q \\cdot s^2 = \\Delta \\cdot [mm']_t + u_3 \\text{ } \\ (2)</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>⌊</span><span>t</span><span>/</span><span>q</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>×</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>⌉</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>[</span><span>⌊</span><span>t</span><span>/</span><span>q</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>×</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>⌉</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span>[</span><span>⌊</span><span>t</span><span>/</span><span>q</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span><span>×</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>⌉</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>[</span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span> </span></span><span> </span><span>(</span><span>2</span><span>)</span></span></span></span></span></div>\n<p>where <span><span><span>u3u_3</span><span aria-hidden=\"true\"><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> is a \"small\" integer polynomial, that represents the \"noise\" after one multiplication.</p>\n<p>💡 The <strong>noise growth</strong> for <strong>multiplication</strong> grows a lot faster:\n<span><span><span>∥u3∥≤2⋅n⋅t⋅B⋅(2n+1)⋅(n+1)+8t2⋅n2,\\|u_3\\| \\leq 2 \\cdot n \\cdot t \\cdot B \\cdot (2n+1)\\cdot (n+1) + 8t^2 \\cdot n^2,</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span><span>u</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∥</span><span></span><span>≤</span><span></span></span><span><span></span><span>2</span><span></span><span>⋅</span><span></span></span><span><span></span><span>n</span><span></span><span>⋅</span><span></span></span><span><span></span><span>t</span><span></span><span>⋅</span><span></span></span><span><span></span><span>B</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>2</span><span>n</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>n</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>8</span><span><span>t</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>n</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>,</span></span></span></span></span>\nwhere <span><span><span>BB</span><span aria-hidden=\"true\"><span><span></span><span>B</span></span></span></span></span> is an upper bound for the \"noise\" of the ciphertexts that were multiplied. We refer the enthusiastic reader for more details to <a href=\"https://eprint.iacr.org/2012/144.pdf\">[[FV12] Lem. 2]</a>.</p>\n<p>Phew, seems like we are done: we can consider as a ciphertext decrypting to <span><span><span>[mm′]t[mm']_t</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> the tuple of scaled and rounded coefficients mod <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span> from left hand side of <span><span><span>(2)(2)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>2</span><span>)</span></span></span></span></span>, denoted by <span><span><span>(c0,c1,c2)(c_0, c_1, c_2)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>. Of course, for a correct decryption, <span><span><span>u3u_3</span><span aria-hidden=\"true\"><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> should have small enough coefficients. You can see below how these coefficients are <a href=\"https://github.com/bit-ml/he-scheme/blob/main/rlwe_he_scheme_updated.py#L293\">computed</a> in Python:</p>\n<div><pre><code><span>def</span><span> </span><span>multiplication_coeffs</span><span>(</span>ct1<span>,</span><span> </span>ct2<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>\"\"\"Multiply<span> </span>two<span> </span>ciphertexts.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Args:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>ct1:<span> </span>first<span> </span>ciphertext.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>ct2:<span> </span>second<span> </span>ciphertext<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>q:<span> </span>ciphertext<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>t:<span> </span>plaintext<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>poly_mod:<span> </span>polynomial<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Returns:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Triplet<span> </span>(c0,c1,c2)<span> </span>encoding<span> </span>the<span> </span>multiplied<span> </span>ciphertexts.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>\"\"\"</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>c_0<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>np<span>.</span><span>round</span><span>(</span>polymul_wm<span>(</span>ct1<span>[</span><span>0</span><span>]</span><span>,</span><span> </span>ct2<span>[</span><span>0</span><span>]</span><span>,</span><span> </span>poly_mod<span>)</span><span> </span><span>*</span><span> </span>t<span> </span><span>/</span><span> </span>q<span>)</span><span>)</span><span> </span><span>%</span><span> </span>q<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>c_1<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>np<span>.</span><span>round</span><span>(</span>polyadd_wm<span>(</span>polymul_wm<span>(</span>ct1<span>[</span><span>0</span><span>]</span><span>,</span><span> </span>ct2<span>[</span><span>1</span><span>]</span><span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span> </span>polymul_wm<span>(</span>ct1<span>[</span><span>1</span><span>]</span><span>,</span><span> </span>ct2<span>[</span><span>0</span><span>]</span><span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span> </span>poly_mod<span>)</span><span> </span><span>*</span><span> </span>t<span> </span><span>/</span><span> </span>q<span>)</span><span>)</span><span> </span><span>%</span><span> </span>q<span> </span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>c_2<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>np<span>.</span><span>round</span><span>(</span>polymul_wm<span>(</span>ct1<span>[</span><span>1</span><span>]</span><span>,</span><span> </span>ct2<span>[</span><span>1</span><span>]</span><span>,</span><span> </span>poly_mod<span>)</span><span> </span><span>*</span><span> </span>t<span> </span><span>/</span><span> </span>q<span>)</span><span>)</span><span> </span><span>%</span><span> </span>q<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span>c_0<span>,</span><span> </span>c_1<span>,</span><span> </span>c_2<span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>\n</code></pre></div>\n<p>But, as a popular movie character would say, <strong>\"Houston, we have a problem\"</strong>. This tuple of coefficients has size 3, <strong>not 2 as the usual ciphertext</strong>. Moreover, the size of such tuple will grow linearly in the number of further multiplications performed on the ciphertexts. In order to restore the size of the ciphertext as 2, we will make use of the so called <em>relinearization technique</em>. 💥</p>\n<h3>Relinearization</h3>\n<p>💡 The idea of <strong>Relinearization</strong> is to reduce the triplet\n<span><span><span>(c0,c1,c2)(c_0,c_1,c_2)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> to a ciphertext pair <span><span><span>(c0′,c1′)∈Rq×Rq(c_0',c_1') \\in R_q \\times R_q</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>∈</span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>×</span><span></span></span><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> that\nrecovers <span><span><span>[mm′]t[mm']_t</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> when decrypted with the usual decryption\nalgorithm. We would like to produce a pair <span><span><span>(c0′,c1′)(c_0',c_1')</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>, without using the\nsecret <span><span><span>ss</span><span aria-hidden=\"true\"><span><span></span><span>s</span></span></span></span></span>, such that:\n<span><span><span>[c0′+s⋅c1′]q=[c0+c1⋅s+c2⋅s2+r]q[c_0' + s\\cdot c_1']_q = [c_0 + c_1\\cdot s + c_2 \\cdot s^2 + r ]_q</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>s</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span><span>′</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>[</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>r</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>,\nwhere <span><span><span>rr</span><span aria-hidden=\"true\"><span><span></span><span>r</span></span></span></span></span> is a \"small\" error. The correct decryption will be possible, as the\n\"small\" error <span><span><span>rr</span><span aria-hidden=\"true\"><span><span></span><span>r</span></span></span></span></span> will vanish because of the rounding in decryption.</p>\n<p>As the name suggests it, we transform the degree 2 polynomial, <span><span><span>c0+c1⋅s+c2⋅s2c_0+c_1\\cdot s+c_2 \\cdot s^2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> into a linear polynomial, i.e. of degree 1. This involves giving extra info about  <span><span><span>s2s^2</span><span aria-hidden=\"true\"><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span>. Using a special public key, called <em>relinearization key</em>, we can <em>linearize</em> <span><span><span>c2⋅s2c_2 \\cdot s^2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> (up to some small error) as</p>\n<div><span><span><span>[c20+c21⋅s]q=[c2⋅s2+erelin]q.[c_{20}+c_{21} \\cdot s]_q = [c_2\\cdot s^2 + e_{relin}]_q.</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>[</span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>r</span><span>e</span><span>l</span><span>i</span><span>n</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>.</span></span></span></span></span></div>\n<p>Therefore, by Equation <span><span><span>(2)(2)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>2</span><span>)</span></span></span></span></span>, we can get a standard ciphertext pair as</p>\n<div><span><span><span>cmul=(c0+c20,c1+c21),c_{mul} =(c_0+c_{20}, c_1+c_{21}), </span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>m</span><span>u</span><span>l</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span></span></span></span></span></div>\n<p>that correctly decrypts to <span><span><span>[mm′]t[mm']_t</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, as you can see below:</p>\n<div><span><span><span>[c0+c20+s⋅(c1+c21)]q=[c0+c1⋅s+c2⋅s2+erelin]q=Δ⋅[mm′]t+vmult,\\begin{aligned}\n[c_0 + c_{20} + s\\cdot (c_1 + c_{21})]_q = [c_0 + c_1 \\cdot s + c_2 \\cdot s^2 + e_{relin}]_q = \\Delta \\cdot [mm']_t + v_{mult},\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>[</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>s</span><span></span><span>⋅</span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span><span>[</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>r</span><span>e</span><span>l</span><span>i</span><span>n</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span><span>Δ</span><span></span><span>⋅</span><span></span><span>[</span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>m</span><span>u</span><span>l</span><span>t</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>where <span><span><span>vmult=u3+erelin.v_{mult} = u_3 + e_{relin}.</span><span aria-hidden=\"true\"><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>m</span><span>u</span><span>l</span><span>t</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>r</span><span>e</span><span>l</span><span>i</span><span>n</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>.</span></span></span></span></span> Therefore, <span><span><span>cmulc_{mul}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>m</span><span>u</span><span>l</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> decrypts correctly\nto <span><span><span>[mm′]t[mm']_t</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> if <span><span><span>∥vmult∥\\|v_{mult}\\|</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>m</span><span>u</span><span>l</span><span>t</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∥</span></span></span></span></span> is less than <span><span><span>Δ/2\\Delta/2</span><span aria-hidden=\"true\"><span><span></span><span>Δ</span><span>/</span><span>2</span></span></span></span></span>. So yay! we finally\nknow how to get a ciphertext encoding multiplication!</p>\n<h3>Different versions of relinearization</h3>\n<p>To complete this discussion, we need to see how to construct the linear\napproximation of <span><span><span>c2⋅s2c_2 \\cdot s^2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> and find out what the relinearization key is\nabout. For this, we will go a bit deeper into (technical) details. Don't\npanic, we'll take you step by step. 😄</p>\n<p>We are going to present two versions of linearizing <span><span><span>c2⋅s2c_2\\cdot s^2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span>. First,\nkeep in mind that <span><span><span>s2s^2</span><span aria-hidden=\"true\"><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> should not be known, so we give the relinearization\nkey as a <em>masked version</em> of <span><span><span>s2s^2</span><span aria-hidden=\"true\"><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>Let's think of the following situation: say we include in the public key the\nfollowing <em>relinearization</em> key:</p>\n<div><span><span><span>rlk=(rlk0,rlk1)=([−(a⋅s+e)+s2]q,a),rlk = (rlk_0, rlk_1) = ([-(a\\cdot s+e)+s^2]_q,a),</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span>l</span><span>k</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>[</span><span>−</span><span>(</span><span>a</span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span>e</span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>a</span><span>)</span><span>,</span></span></span></span></span></div>\n<p>for some uniform <span><span><span>aa</span><span aria-hidden=\"true\"><span><span></span><span>a</span></span></span></span></span> in <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and a small error <span><span><span>ee</span><span aria-hidden=\"true\"><span><span></span><span>e</span></span></span></span></span>.</p>\n<p>❗ Intuitively, the secret <span><span><span>s2s^2</span><span aria-hidden=\"true\"><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> is hidden by something that looks\nlike an\n<a href=\"https://en.wikipedia.org/wiki/Ring_learning_with_errors#The_RLWE_Problem\">RLWE</a>\nsample. Notice that,</p>\n<div><span><span><span>rlk0+rlk1⋅s=s2+e.rlk_0 + rlk_1 \\cdot s = s^2 + e.</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>=</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>e</span><span>.</span></span></span></span></span></div>\n<p>To obtain the approximation of <span><span><span>c2⋅s2c_2\\cdot s^2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> we should multiply the above\nexpression by <span><span><span>c2c_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. By doing so, we end up with the rather large-norm term\n<span><span><span>c2⋅ec_2\\cdot e</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>e</span></span></span></span></span>, due to the size of the coefficients of <span><span><span>c2c_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. We cannot allow\nsuch a large \"noise\" as it will interfere with decryption. To avoid this\n\"noise\" blow-up we will employ two techniques described below.</p>\n<h3>💥 Relinearization: Version 1</h3>\n<p>One strategy is to use base <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> decomposition of the coefficients of <span><span><span>c2c_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> to\nslice <span><span><span>c2c_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> into components of small norm. To do this, we pick a base <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> and\nwrite each coefficient of <span><span><span>c2c_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> in this base. Recall that <span><span><span>c2c_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> is a integer\npolynomial, modulo <span><span><span>xn+1x^n+1</span><span aria-hidden=\"true\"><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span>, so of degree at most <span><span><span>n−1n-1</span><span aria-hidden=\"true\"><span><span></span><span>n</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span></span></span></span></span>. If we write <span><span><span>c2c_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> as\na polynomial:</p>\n<div><span><span><span>c2(x)=c2[0]+c2[1]⋅x+…+c2[n−1]⋅xn−1c_2(x) = c_2[0] + c_2[1]\\cdot x+\\ldots+c_2[n-1]\\cdot x^{n-1}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>0</span><span>]</span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>1</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span>x</span><span></span><span>+</span><span></span></span><span><span></span><span>…</span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>n</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span><span>n</span><span>−</span><span>1</span></span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>then we can decompose each coefficient <span><span><span>c2[i]c_2[i]</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>i</span><span>]</span></span></span></span></span> in base <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span>. Notice that\nsince <span><span><span>c2c_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> has coefficients in <span><span><span>[0,q−1][0,q-1]</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>0</span><span>,</span><span></span><span>q</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>]</span></span></span></span></span>, the maximum power appearing in\nthese representations is <span><span><span>TℓT^{\\ell}</span><span aria-hidden=\"true\"><span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span><span>ℓ</span></span></span></span></span></span></span></span></span></span></span></span></span>, where <span><span><span>ℓ=⌊log⁡T(q)⌋\\ell = \\lfloor \\log_T(q)\\rfloor</span><span aria-hidden=\"true\"><span><span></span><span>ℓ</span><span></span><span>=</span><span></span></span><span><span></span><span>⌊</span><span><span>lo<span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>q</span><span>)</span><span>⌋</span></span></span></span></span>.\nFor base decomposition we <a href=\"https://github.com/bit-ml/he-scheme/blob/main/rlwe_he_scheme_updated.py#L102\">use</a> the function <span><span><span>int2base\\texttt{int2base}</span><span aria-hidden=\"true\"><span><span></span><span><span>int2base</span></span></span></span></span></span>:</p>\n<div><pre><code><span>def</span><span> </span><span>int2base</span><span>(</span>n<span>,</span><span> </span>b<span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>\"\"\"Generates<span> </span>the<span> </span>base<span> </span>decomposition<span> </span>of<span> </span>an<span> </span>integer<span> </span>n.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Args:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>n:<span> </span>integer<span> </span>to<span> </span>be<span> </span>decomposed.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>b:<span> </span>base.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Returns:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>array<span> </span>of<span> </span>coefficients<span> </span>from<span> </span>the<span> </span>base<span> </span>decomposition<span> </span>of<span> </span>n<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>with<span> </span>the<span> </span>coeff[i]<span> </span>being<span> </span>the<span> </span>coeff<span> </span>of<span> </span>b<span> </span>^<span> </span>i.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>\"\"\"</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>if</span><span> </span>n<span> </span><span>&#x3C;</span><span> </span>b<span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span><span>[</span>n<span>]</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>else</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span><span>[</span>n<span> </span><span>%</span><span> </span>b<span>]</span><span> </span><span>+</span><span> </span>int2base<span>(</span>n<span> </span><span>//</span><span> </span>b<span>,</span><span> </span>b<span>)</span><span> </span><span> </span><span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>\n</code></pre></div>\n<p>The relinearization key, <span><span><span>rlkrlk</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span>l</span><span>k</span></span></span></span></span> in this version, consists of masked variants\nof <span><span><span>Ti⋅s2,T^i \\cdot s^2,</span><span aria-hidden=\"true\"><span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>,</span></span></span></span></span> instead of <span><span><span>s2s^2</span><span aria-hidden=\"true\"><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span>. More precisely, for <span><span><span>0≤i≤ℓ0 \\leq i \\leq\n\\ell</span><span aria-hidden=\"true\"><span><span></span><span>0</span><span></span><span>≤</span><span></span></span><span><span></span><span>i</span><span></span><span>≤</span><span></span></span><span><span></span><span>ℓ</span></span></span></span></span>, this is defined as follows:</p>\n<div><span><span><span>(rlk0[i],rlk1[i])=([−(ai⋅s+ei)+Ti⋅s2]q,ai)(rlk_0[i], rlk_1[i]) = ([-(a_i \\cdot s + e_i) + T^i\\cdot s^2]_{q}, a_i)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>i</span><span>]</span><span>,</span><span></span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>i</span><span>]</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>[</span><span>−</span><span>(</span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>q</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span></div>\n<p>for <span><span><span>aia_i</span><span aria-hidden=\"true\"><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> chosen uniformly in <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and <span><span><span>eie_i</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> chosen according to the\ndistribution <span><span><span>χ\\chi</span><span aria-hidden=\"true\"><span><span></span><span>χ</span></span></span></span></span> over <span><span><span>RR</span><span aria-hidden=\"true\"><span><span></span><span>R</span></span></span></span></span> (yep, same error distribution as in the\ndescription of the scheme). Below you can find the <a href=\"https://github.com/bit-ml/he-scheme/blob/main/rlwe_he_scheme_updated.py#L135\">implementation</a> of the\nfunction that generates the evaluation (relinearization) key\n<span><span><span>(rlk0[i],rlk1[i])0≤i≤ℓ(rlk_0[i],rlk_1[i])_{0\\leq i\\leq\\ell}</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>i</span><span>]</span><span>,</span><span></span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>i</span><span>]</span><span><span>)</span><span><span><span><span><span><span></span><span><span><span>0</span><span>≤</span><span>i</span><span>≤</span><span>ℓ</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<div><pre><code><span>def</span><span> </span><span>evaluate_keygen_v1</span><span>(</span>sk<span>,</span><span> </span>size<span>,</span><span> </span>modulus<span>,</span><span> </span>T<span>,</span><span> </span>poly_mod<span>,</span><span> </span>std2<span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>\"\"\"Generate<span> </span>a<span> </span>relinearization<span> </span>key<span> </span>using<span> </span>version<span> </span>1.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Args:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>sk:<span> </span>secret<span> </span>key.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>size:<span> </span>size<span> </span>of<span> </span>the<span> </span>polynomials.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>modulus:<span> </span>coefficient<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>T:<span> </span>base.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>poly_mod:<span> </span>polynomial<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>std2:<span> </span>standard<span> </span>deviation<span> </span>for<span> </span>the<span> </span>error<span> </span>distribution.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Returns:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>rlk:<span> </span>relinearization<span> </span>key.<span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>\"\"\"</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>n<span> </span><span>=</span><span> </span><span>len</span><span>(</span>poly_mod<span>)</span><span> </span><span>-</span><span> </span><span>1</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>l<span> </span><span>=</span><span> </span>np<span>.</span><span>int</span><span>(</span>np<span>.</span>log<span>(</span>modulus<span>)</span><span> </span><span>/</span><span> </span>np<span>.</span>log<span>(</span>T<span>)</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>rlk0<span> </span><span>=</span><span> </span>np<span>.</span>zeros<span>(</span><span>(</span>l<span> </span><span>+</span><span> </span><span>1</span><span>,</span><span> </span>n<span>)</span><span>,</span><span> </span>dtype<span>=</span>np<span>.</span>int64<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>rlk1<span> </span><span>=</span><span> </span>np<span>.</span>zeros<span>(</span><span>(</span>l<span> </span><span>+</span><span> </span><span>1</span><span>,</span><span> </span>n<span>)</span><span>,</span><span> </span>dtype<span>=</span>np<span>.</span>int64<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>for</span><span> </span>i<span> </span><span>in</span><span> </span><span>range</span><span>(</span>l<span> </span><span>+</span><span> </span><span>1</span><span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>a<span> </span><span>=</span><span> </span>gen_uniform_poly<span>(</span>size<span>,</span><span> </span>modulus<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>e<span> </span><span>=</span><span> </span>gen_normal_poly<span>(</span>size<span>,</span><span> </span><span>0</span><span>,</span><span> </span>std2<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>secret_part<span> </span><span>=</span><span> </span>T<span> </span><span>**</span><span> </span>i<span> </span><span>*</span><span> </span>poly<span>.</span>polymul<span>(</span>sk<span>,</span><span> </span>sk<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>b<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>polyadd<span>(</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>polymul_wm<span>(</span><span>-</span>a<span>,</span><span> </span>sk<span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>polyadd_wm<span>(</span><span>-</span>e<span>,</span><span> </span>secret_part<span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span> </span>modulus<span>,</span><span> </span>poly_mod<span>)</span><span>)</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>b<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>np<span>.</span>concatenate<span>(</span><span> </span><span>(</span>b<span>,</span><span> </span><span>[</span><span>0</span><span>]</span><span> </span><span>*</span><span> </span><span>(</span>n<span> </span><span>-</span><span> </span><span>len</span><span>(</span>b<span>)</span><span>)</span><span> </span><span>)</span><span> </span><span>)</span><span>)</span><span> </span><span>#<span> </span>pad<span> </span>b<span> </span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>a<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>np<span>.</span>concatenate<span>(</span><span> </span><span>(</span>a<span>,</span><span> </span><span>[</span><span>0</span><span>]</span><span> </span><span>*</span><span> </span><span>(</span>n<span> </span><span>-</span><span> </span><span>len</span><span>(</span>a<span>)</span><span>)</span><span> </span><span>)</span><span> </span><span>)</span><span>)</span><span> </span><span>#<span> </span>pad<span> </span>a<span> </span><span> </span><span> </span><span> </span></span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>rlk0<span>[</span>i<span>]</span><span> </span><span>=</span><span> </span>b<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>rlk1<span>[</span>i<span>]</span><span> </span><span>=</span><span> </span>a<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span>rlk0<span>,</span><span> </span>rlk1<span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>\n</code></pre></div>\n<p>Now, given <span><span><span>rlkrlk</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span>l</span><span>k</span></span></span></span></span>, let's look at how we compute the linear approximation of\n<span><span><span>c2⋅s2c_2 \\cdot s^2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span>. Let the polynomials <span><span><span>c2(i)c_2(i)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>i</span><span>)</span></span></span></span></span> be the base <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> decomposition\nof <span><span><span>c2c_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, such that:</p>\n<div><span><span><span>c2=∑i=0ℓc2(i)⋅Ti.c_2 = \\displaystyle \\sum_{i=0}^{\\ell} c_2(i)\\cdot T^i.</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>ℓ</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>i</span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span>.</span></span></span></span></span></div>\n<p>We can get the linear approximation given by <span><span><span>(c20,c21)(c_{20}, c_{21})</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>, where:</p>\n<div><span><span><span>c20=∑i=0ℓrlk0[i]⋅c2(i) and c21=∑i=0ℓrlk1[i]⋅c2(i).c_{20} = \\sum_{i=0}^{\\ell} rlk_0[i]\\cdot c_2(i) \\text{ and } c_{21} = \\sum_{i=0}^{\\ell} rlk_1[i]\\cdot c_2(i).</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>ℓ</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>i</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>i</span><span>)</span><span><span> and </span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>ℓ</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>i</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>i</span><span>)</span><span>.</span></span></span></span></span></div>\n<p>Therefore, <span><span><span>c20+c21⋅s=c2⋅s2+erelin_v1c_{20} + c_{21} \\cdot s = c_2 \\cdot s^2 + e_{\\text{relin\\_v1}}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>=</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin_v1</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>\nwhere <span><span><span>erelin_v1e_{\\text{relin\\_v1}}</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin_v1</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> is an error term from <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<div><span><span><span>c20+c21⋅s=∑i=0ℓ[−(ai⋅s+ei)+Ti⋅s2]c2(i)+∑i=0ℓai⋅s⋅c2(i)=−∑i=0ℓei⋅c2(i)+c2⋅s2.\\begin{aligned}\nc_{20} + c_{21} \\cdot s\n    &#x26;= \\sum_{i=0}^{\\ell} [-(a_i\\cdot s+e_i)+T^i\\cdot s^2] c_2(i) + \\sum_{i=0}^{\\ell} a_i \\cdot s \\cdot c_2(i)\\\\\n    &#x26;= -\\sum_{i=0}^{\\ell} e_i \\cdot c_2(i) + c_2 \\cdot s^2.\n \\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>ℓ</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span>[</span><span>−</span><span>(</span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>]</span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>i</span><span>)</span><span></span><span>+</span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>ℓ</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>⋅</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>i</span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>−</span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>ℓ</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>i</span><span>)</span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>.</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>💡 By doing base <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> decomposition we get a \"small\" <strong>relinearization noise</strong>:\n<span><span><span>∥erelin_v1∥≤(ℓ+1)⋅B⋅T⋅n/2\\|e_{\\text{relin\\_v1}}\\| \\leq (\\ell+1)\\cdot B \\cdot T \\cdot n/2</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin_v1</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∥</span><span></span><span>≤</span><span></span></span><span><span></span><span>(</span><span>ℓ</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>B</span><span></span><span>⋅</span><span></span></span><span><span></span><span>T</span><span></span><span>⋅</span><span></span></span><span><span></span><span>n</span><span>/</span><span>2</span></span></span></span></span>\nwhere <span><span><span>BB</span><span aria-hidden=\"true\"><span><span></span><span>B</span></span></span></span></span> is an upper bound on the errors <span><span><span>eie_i</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>❓ Now the question is how to compute the polynomials <span><span><span>c2(i)c_2(i)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>i</span><span>)</span></span></span></span></span>. The coefficients of these polynomials prove to be nothing but the columns of the matrix <span><span><span>Reps\\texttt{Reps}</span><span aria-hidden=\"true\"><span><span></span><span><span>Reps</span></span></span></span></span></span>.</p>\n<p><span><span><span>c2[i]=Reps[i][0]+Reps[i][1]⋅T+…+Reps[i][ℓ]⋅Tℓ.c_2[i] = \\mathtt{Reps}[i][0] + \\mathtt{Reps}[i][1] \\cdot T+ \\ldots + \\mathtt{Reps}[i][\\ell] \\cdot T^{\\ell}.</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>i</span><span>]</span><span></span><span>=</span><span></span></span><span><span></span><span><span>R</span><span>e</span><span>p</span><span>s</span></span><span>[</span><span>i</span><span>]</span><span>[</span><span>0</span><span>]</span><span></span><span>+</span><span></span></span><span><span></span><span><span>R</span><span>e</span><span>p</span><span>s</span></span><span>[</span><span>i</span><span>]</span><span>[</span><span>1</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span>T</span><span></span><span>+</span><span></span></span><span><span></span><span>…</span><span></span><span>+</span><span></span></span><span><span></span><span><span>R</span><span>e</span><span>p</span><span>s</span></span><span>[</span><span>i</span><span>]</span><span>[</span><span>ℓ</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span><span>ℓ</span></span></span></span></span></span></span></span></span><span>.</span></span></span></span></span></p>\n<p>If we multiply this by <span><span><span>xix^i</span><span aria-hidden=\"true\"><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span></span></span></span></span>, we get:</p>\n<div><span><span><span>c2[i]⋅xi=Reps[i][0]⋅xi+Reps[i][1]⋅xi⋅T+…+Reps[i][ℓ]⋅xi⋅Tℓ.c_2[i] \\cdot x^i =\n    \\mathtt{Reps}[i][0] \\cdot x^i +\n    \\mathtt{Reps}[i][1] \\cdot x^i \\cdot T+ \\ldots +\n    \\mathtt{Reps}[i][\\ell] \\cdot x^i \\cdot T^{\\ell}.</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>i</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>R</span><span>e</span><span>p</span><span>s</span></span><span>[</span><span>i</span><span>]</span><span>[</span><span>0</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>R</span><span>e</span><span>p</span><span>s</span></span><span>[</span><span>i</span><span>]</span><span>[</span><span>1</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>T</span><span></span><span>+</span><span></span></span><span><span></span><span>…</span><span></span><span>+</span><span></span></span><span><span></span><span><span>R</span><span>e</span><span>p</span><span>s</span></span><span>[</span><span>i</span><span>]</span><span>[</span><span>ℓ</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span><span>ℓ</span></span></span></span></span></span></span></span></span><span>.</span></span></span></span></span></div>\n<p>Summing up all these for each <span><span><span>0≤i≤n−10\\leq i \\leq n-1</span><span aria-hidden=\"true\"><span><span></span><span>0</span><span></span><span>≤</span><span></span></span><span><span></span><span>i</span><span></span><span>≤</span><span></span></span><span><span></span><span>n</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span></span></span></span></span>, on the left hand side we\nactually get <span><span><span>c2c_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>:</p>\n<div><span><span><span>c2=∑i=0n−1Reps[i][0]⋅xi+(∑i=0n−1Reps[i][1]⋅xi)⋅T+…+(∑i=0n−1Reps[i][ℓ]⋅xi)⋅Tℓ.c_2 = \\displaystyle \\sum_{i=0}^{n-1} \\mathtt{Reps}[i][0] \\cdot x^i\n    + (\\sum_{i=0}^{n-1}\\mathtt{Reps}[i][1] \\cdot x^i) \\cdot  T+ \\ldots\n    + (\\sum_{i=0}^{n-1} \\mathtt{Reps}[i][\\ell] \\cdot x^i) \\cdot T^{\\ell}.</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>n</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span><span>R</span><span>e</span><span>p</span><span>s</span></span><span>[</span><span>i</span><span>]</span><span>[</span><span>0</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>(</span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>n</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span><span>R</span><span>e</span><span>p</span><span>s</span></span><span>[</span><span>i</span><span>]</span><span>[</span><span>1</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>T</span><span></span><span>+</span><span></span></span><span><span></span><span>…</span><span></span><span>+</span><span></span></span><span><span></span><span>(</span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>n</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span><span>R</span><span>e</span><span>p</span><span>s</span></span><span>[</span><span>i</span><span>]</span><span>[</span><span>ℓ</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span><span>ℓ</span></span></span></span></span></span></span></span></span><span>.</span></span></span></span></span></div>\n<p>So, if we denote the above sums by polynomials <span><span><span>c2(j)c_2(j)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>j</span><span>)</span></span></span></span></span>, we simply get</p>\n<div><span><span><span>c2=∑j=0ℓc2(j)⋅Tj.c_2 = \\displaystyle \\sum_{j=0}^{\\ell} c_2(j)\\cdot T^j.</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>j</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>ℓ</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>j</span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>T</span><span><span><span><span><span><span></span><span><span>j</span></span></span></span></span></span></span></span><span>.</span></span></span></span></span></div>\n<p>Phew, what a relief! Notice that the coefficients for each polynomial\n<span><span><span>c2(j)c_2(j)</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>j</span><span>)</span></span></span></span></span> are given by the <span><span><span>jj</span><span aria-hidden=\"true\"><span><span></span><span>j</span></span></span></span></span>-th column of <span><span><span>Reps\\mathtt{Reps}</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span>e</span><span>p</span><span>s</span></span></span></span></span></span>.</p>\n<p>So after all this math, we finally got the linear approximation of <span><span><span>c2⋅s2c_2 \\cdot\ns^2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> and thus, we can derive the standard ciphertext encoding the\nmultiplication of the plaintexts. Here comes the <a href=\"https://github.com/bit-ml/he-scheme/blob/main/rlwe_he_scheme_updated.py#L311\">code</a>:</p>\n<div><pre><code><span>def</span><span> </span><span>mul_cipher_v1</span><span>(</span>ct1<span>,</span><span> </span>ct2<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>T<span>,</span><span> </span>poly_mod<span>,</span><span> </span>rlk0<span>,</span><span> </span>rlk1<span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>\"\"\"Multiply<span> </span>two<span> </span>ciphertexts.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Args:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>ct1:<span> </span>first<span> </span>ciphertext.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>ct2:<span> </span>second<span> </span>ciphertext<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>q:<span> </span>ciphertext<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>t:<span> </span>plaintext<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>T:<span> </span>base<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>poly_mod:<span> </span>polynomial<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>rlk0,<span> </span>rlk1:<span> </span>output<span> </span>of<span> </span>the<span> </span>EvaluateKeygen_v1<span> </span>function.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Returns:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Tuple<span> </span>representing<span> </span>a<span> </span>ciphertext.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>\"\"\"</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>n<span> </span><span>=</span><span> </span><span>len</span><span>(</span>poly_mod<span>)</span><span> </span><span>-</span><span> </span><span>1</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>l<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>np<span>.</span>log<span>(</span>q<span>)</span><span> </span><span>/</span><span> </span>np<span>.</span>log<span>(</span>T<span>)</span><span>)</span><span> </span><span> </span><span>#l<span> </span>=<span> </span>log_T(q)</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>c_0<span>,</span><span> </span>c_1<span>,</span><span> </span>c_2<span> </span><span>=</span><span> </span>multiplication_coeffs<span>(</span>ct1<span>,</span><span> </span>ct2<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>c_2<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>np<span>.</span>concatenate<span>(</span><span> </span><span>(</span>c_2<span>,</span><span> </span><span>[</span><span>0</span><span>]</span><span> </span><span>*</span><span> </span><span>(</span>n<span> </span><span>-</span><span> </span><span>len</span><span>(</span>c_2<span>)</span><span>)</span><span>)</span><span> </span><span>)</span><span>)</span><span> </span><span>#pad</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#Next,<span> </span>we<span> </span>decompose<span> </span>c_2<span> </span>in<span> </span>base<span> </span>T:<span> </span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#more<span> </span>precisely,<span> </span>each<span> </span>coefficient<span> </span>of<span> </span>c_2<span> </span>is<span> </span>decomposed<span> </span>in<span> </span>base<span> </span>T<span> </span>such<span> </span>that<span> </span>c_2<span> </span>=<span> </span>sum<span> </span>T**i<span> </span>*<span> </span>c_2(i)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Reps<span> </span><span>=</span><span> </span>np<span>.</span>zeros<span>(</span><span>(</span>n<span>,</span><span> </span>l<span> </span><span>+</span><span> </span><span>1</span><span>)</span><span>,</span><span> </span>dtype<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>for</span><span> </span>i<span> </span><span>in</span><span> </span><span>range</span><span>(</span>n<span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>rep<span> </span><span>=</span><span> </span>int2base<span>(</span>c_2<span>[</span>i<span>]</span><span>,</span><span> </span>T<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>rep2<span> </span><span>=</span><span> </span>rep<span> </span><span>+</span><span> </span><span>[</span><span>0</span><span>]</span><span> </span><span>*</span><span> </span><span>(</span>l<span> </span><span>+</span><span> </span><span>1</span><span> </span><span>-</span><span> </span><span>len</span><span>(</span>rep<span>)</span><span>)</span><span> </span><span>#pad<span> </span>with<span> </span>0</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Reps<span>[</span>i<span>]</span><span> </span><span>=</span><span> </span>np<span>.</span>array<span>(</span>rep2<span>,</span><span> </span>dtype<span>=</span>np<span>.</span>int64<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>Each<span> </span>row<span> </span>Reps[i]<span> </span>is<span> </span>the<span> </span>base<span> </span>T<span> </span>representation<span> </span>of<span> </span>the<span> </span>i-th<span> </span>coefficient<span> </span>c_2[i].</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>The<span> </span>polynomials<span> </span>c_2(j)<span> </span>are<span> </span>given<span> </span>by<span> </span>the<span> </span>columns<span> </span>Reps[:,j].</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>c_20<span> </span><span>=</span><span> </span>np<span>.</span>zeros<span>(</span>shape<span>=</span>n<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>c_21<span> </span><span>=</span><span> </span>np<span>.</span>zeros<span>(</span>shape<span>=</span>n<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>Here<span> </span>we<span> </span>compute<span> </span>the<span> </span>sums:<span> </span>rlk[j][0]<span> </span>*<span> </span>c_2(j)<span> </span>and<span> </span>rlk[j][1]<span> </span>*<span> </span>c_2(j)<span> </span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>for</span><span> </span>j<span> </span><span>in</span><span> </span><span>range</span><span>(</span>l<span> </span><span>+</span><span> </span><span>1</span><span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>c_20<span> </span><span>=</span><span> </span>polyadd_wm<span>(</span>c_20<span>,</span><span> </span>polymul_wm<span>(</span>rlk0<span>[</span>j<span>]</span><span>,</span><span> </span>Reps<span>[</span><span>:</span><span>,</span>j<span>]</span><span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span> </span>poly_mod<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>c_21<span> </span><span>=</span><span> </span>polyadd_wm<span>(</span>c_21<span>,</span><span> </span>polymul_wm<span>(</span>rlk1<span>[</span>j<span>]</span><span>,</span><span> </span>Reps<span>[</span><span>:</span><span>,</span>j<span>]</span><span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span> </span>poly_mod<span>)</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>c_20<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>np<span>.</span><span>round</span><span>(</span>c_20<span>)</span><span>)</span><span> </span><span>%</span><span> </span>q<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>c_21<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>np<span>.</span><span>round</span><span>(</span>c_21<span>)</span><span>)</span><span> </span><span>%</span><span> </span>q<span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>new_c0<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>polyadd_wm<span>(</span>c_0<span>,</span><span> </span>c_20<span>,</span><span> </span>poly_mod<span>)</span><span>)</span><span> </span><span>%</span><span> </span>q<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>new_c1<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>polyadd_wm<span>(</span>c_1<span>,</span><span> </span>c_21<span>,</span><span> </span>poly_mod<span>)</span><span>)</span><span> </span><span>%</span><span> </span>q<span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span><span>(</span>new_c0<span>,</span><span> </span>new_c1<span>)</span><span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>\n</code></pre></div>\n<h3>💥 Relinearization: Version 2</h3>\n<p>This version is much simpler and cleaner than the previous one (yay!) and uses the so-called <em>modulus switching</em> technique. Recall that if we try to naively mask <span><span><span>s2s^2</span><span aria-hidden=\"true\"><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> in the reliniarization key, then there is a large blow-up in the noise because of the <span><span><span>c2c_2</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> multiplication. We want to avoid this to get a correct decryption.</p>\n<p>In this version we mask <span><span><span>s2s^2</span><span aria-hidden=\"true\"><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> modulo a a different modulus, <span><span><span>p⋅qp\\cdot q</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span></span><span>⋅</span><span></span></span><span><span></span><span>q</span></span></span></span></span>, with a much larger <span><span><span>p≫qp\\gg q</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span></span><span>≫</span><span></span></span><span><span></span><span>q</span></span></span></span></span>, as shown below.</p>\n<div><span><span><span>rlk=(rlk0,rlk1)=([−(a′⋅s+e′)+p⋅s2]p⋅q,a′),rlk = (rlk_0, rlk_1) = ([-(a' \\cdot s + e') + p\\cdot s^2]_{p\\cdot q}, a'),</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span>l</span><span>k</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>[</span><span>−</span><span>(</span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>p</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>p</span><span>⋅</span><span>q</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span>,</span></span></span></span></span></div>\n<p>for a uniform <span><span><span>a′a'</span><span aria-hidden=\"true\"><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> in <span><span><span>Rp⋅qR_{p\\cdot q}</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span><span>p</span><span>⋅</span><span>q</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and <span><span><span>e′e'</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> drawn according to an error distribution <span><span><span>χ′\\chi'</span><span aria-hidden=\"true\"><span><span></span><span><span>χ</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> over <span><span><span>R.R.</span><span aria-hidden=\"true\"><span><span></span><span>R</span><span>.</span></span></span></span></span>\nRemember that our goal is to produce an approximation of <span><span><span>[c2⋅s2]q[c_2\\cdot s^2]_q</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. The idea is that when we scale from <span><span><span>p⋅qp\\cdot q</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span></span><span>⋅</span><span></span></span><span><span></span><span>q</span></span></span></span></span> back to <span><span><span>qq</span><span aria-hidden=\"true\"><span><span></span><span>q</span></span></span></span></span>, the noise gets divided by the large integer <span><span><span>pp</span><span aria-hidden=\"true\"><span><span></span><span>p</span></span></span></span></span>, significantly reducing its size.</p>\n<p>In a safe implementation the distribution <span><span><span>χ′\\chi'</span><span aria-hidden=\"true\"><span><span></span><span><span>χ</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> should be distinct from\n<span><span><span>χ\\chi</span><span aria-hidden=\"true\"><span><span></span><span>χ</span></span></span></span></span> and its parameters should be carefully chosen for security reasons.\nSince security is not our main goal in this blog post, you can check the\npaper for further details.</p>\n<div><pre><code><span>def</span><span> </span><span>evaluate_keygen_v2</span><span>(</span>sk<span>,</span><span> </span>size<span>,</span><span> </span>modulus<span>,</span><span> </span>poly_mod<span>,</span><span> </span>extra_modulus<span>,</span><span> </span>std2<span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>\"\"\"Generate<span> </span>a<span> </span>relinearization<span> </span>key<span> </span>using<span> </span>version<span> </span>2.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Args:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>sk:<span> </span>secret<span> </span>key<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>size:<span> </span>size<span> </span>of<span> </span>the<span> </span>polynomials.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>modulus:<span> </span>coefficient<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>poly_mod:<span> </span>polynomial<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>extra_modulus:<span> </span>the<span> </span>\"p\"<span> </span>modulus<span> </span>for<span> </span>modulus<span> </span>switching.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>st2:<span> </span>standard<span> </span>deviation<span> </span>for<span> </span>the<span> </span>error<span> </span>distribution.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Returns:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>rlk0,<span> </span>rlk1:<span> </span>relinearization<span> </span>key.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>\"\"\"</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>new_modulus<span> </span><span>=</span><span> </span>modulus<span> </span><span>*</span><span> </span>extra_modulus<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>a<span> </span><span>=</span><span> </span>gen_uniform_poly<span>(</span>size<span>,</span><span> </span>new_modulus<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>e<span> </span><span>=</span><span> </span>gen_normal_poly<span>(</span>size<span>,</span><span> </span><span>0</span><span>,</span><span> </span>std2<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>secret_part<span> </span><span>=</span><span> </span>extra_modulus<span> </span><span>*</span><span> </span>poly<span>.</span>polymul<span>(</span>sk<span>,</span><span> </span>sk<span>)</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>b<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>polyadd_wm<span>(</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>polymul_wm<span>(</span><span>-</span>a<span>,</span><span> </span>sk<span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>polyadd_wm<span>(</span><span>-</span>e<span>,</span><span> </span>secret_part<span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span> </span>poly_mod<span>)</span><span>)</span><span> </span><span>%</span><span> </span>new_modulus<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span>b<span>,</span><span> </span>a<span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>\n</code></pre></div>\n<p>The linear approximation of <span><span><span>[c2⋅s2]q[c_2 \\cdot s^2]_q</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> can be computed from the pair:</p>\n<div><span><span><span>(c20,c21)=([⌊c2⋅rlk0p⌉]q,[⌊c2⋅rlk1p⌉]q).(c_{20}, c_{21}) = \\Big(\\Big[\\Big\\lfloor\\frac{c_2 \\cdot rlk_0}{p}\\Big\\rceil\\Big]_q, \\Big[\\Big\\lfloor\\frac{c_2 \\cdot rlk_1}{p}\\Big\\rceil\\Big]_q\\Big).</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>(</span></span><span><span>[</span></span><span><span>⌊</span></span><span><span></span><span><span><span><span><span><span></span><span><span>p</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>⌉</span></span><span><span><span>]</span></span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>[</span></span><span><span>⌊</span></span><span><span></span><span><span><span><span><span><span></span><span><span>p</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span><span>⌉</span></span><span><span><span>]</span></span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>)</span></span><span>.</span></span></span></span></span></div>\n<p>Indeed, <span><span><span>[c20+c21⋅s]q=[c2⋅s2]q+erelin_v2,[c_{20} + c_{21} \\cdot s]_q = [c_2 \\cdot s^2]_q + e_{\\text{relin\\_v2}},</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>[</span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin_v2</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span></span></span></span></span> for a \"small\" error <span><span><span>erelin_v2e_{\\text{relin\\_v2}}</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin_v2</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> in <span><span><span>RqR_q</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<div><span><span><span>c2⋅rlk0p+c2⋅rlk1p⋅s=c2⋅[−(a′⋅s+e′)+p⋅s2]p⋅q+c2⋅a′⋅sp=c2⋅s2+−c2⋅e′p+q⋅K,\\begin{aligned}\n\\frac{c_2 \\cdot rlk_0}{p} + \\frac{c_2 \\cdot rlk_1}{p} \\cdot s \n    &#x26;= \\frac{c_2\\cdot [-(a'\\cdot s+e') + p\\cdot s^2]_{p\\cdot q}+c_2 \\cdot a' \\cdot s}{p}\\\\\n    &#x26;= c_2\\cdot s^2 +\\frac{-c_2\\cdot e'}{p} + q \\cdot K,\n\\end{aligned}</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span><span>p</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>p</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>r</span><span>l</span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>⋅</span><span></span><span>s</span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>p</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>[</span><span>−</span><span>(</span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span><span></span><span>+</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>p</span><span></span><span>⋅</span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>p</span><span>⋅</span><span>q</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span>s</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>p</span></span></span><span><span></span><span></span></span><span><span></span><span><span>−</span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>+</span><span></span><span>q</span><span></span><span>⋅</span><span></span><span>K</span><span>,</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<p>where <span><span><span>K∈RK \\in R</span><span aria-hidden=\"true\"><span><span></span><span>K</span><span></span><span>∈</span><span></span></span><span><span></span><span>R</span></span></span></span></span> such that <span><span><span>[−(a′⋅s+e′)+p⋅s2]pq=−(a′⋅s+e′)+p⋅s2+pq⋅K[-(a'\\cdot s+e') + p\\cdot s^2]_{pq} = -(a'\\cdot s+e') + p\\cdot s^2 + pq\\cdot K</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>−</span><span>(</span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>p</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span><span>p</span><span>q</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>−</span><span>(</span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>s</span><span></span><span>+</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>p</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>s</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>p</span><span>q</span><span></span><span>⋅</span><span></span></span><span><span></span><span>K</span></span></span></span></span>.</p>\n<p>We're cheating a bit here, since the pair involves the <em>roundings of the terms to their nearest integers</em>. Still, we're not far from the truth, since for any real number <span><span><span>aa</span><span aria-hidden=\"true\"><span><span></span><span>a</span></span></span></span></span>, <span><span><span>⌊a⌉\\lfloor a \\rceil</span><span aria-hidden=\"true\"><span><span></span><span>⌊</span><span>a</span><span>⌉</span></span></span></span></span> differs from <span><span><span>aa</span><span aria-hidden=\"true\"><span><span></span><span>a</span></span></span></span></span> by a small quantity\n<span><span><span>ε∈[−12,12]\\varepsilon \\in [-\\frac{1}{2},\\frac{1}{2}]</span><span aria-hidden=\"true\"><span><span></span><span>ε</span><span></span><span>∈</span><span></span></span><span><span></span><span>[</span><span>−</span><span><span></span><span><span><span><span><span><span></span><span><span><span>2</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>,</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>2</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>]</span></span></span></span></span>. (we can also extend this coefficient-wise to polynomials).</p>\n<p>💡 We get a \"small\" <strong>relinearization noise</strong>,\n<span><span><span>erelin_v2≈(c2⋅e′)/pe_{\\text{relin\\_v2}} \\approx (c_2\\cdot e')/p</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin_v2</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>)</span><span>/</span><span>p</span></span></span></span></span>, for large <span><span><span>p:p:</span><span aria-hidden=\"true\"><span><span></span><span>p</span><span></span><span>:</span></span></span></span></span>\n<span><span><span>∥erelin_v2∥≤q⋅B′⋅np+n+12.\\|e_{\\text{relin\\_v2}}\\| \\leq \\frac{q \\cdot B' \\cdot n}{p}+\\frac{n+1}{2}.</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin_v2</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∥</span><span></span><span>≤</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>p</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>q</span><span>⋅</span><span><span>B</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>⋅</span><span>n</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>2</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>n</span><span>+</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>.</span></span></span></span></span></p>\n<p>Next, we provide the easy <a href=\"https://github.com/bit-ml/he-scheme/blob/main/rlwe_he_scheme_updated.py#L355\">code</a> implementation for multiplying ciphertexts using this version.</p>\n<div><pre><code><span>def</span><span> </span><span>mul_cipher_v2</span><span>(</span>ct1<span>,</span><span> </span>ct2<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>p<span>,</span><span> </span>poly_mod<span>,</span><span> </span>rlk0<span>,</span><span> </span>rlk1<span>)</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>\"\"\"Multiply<span> </span>two<span> </span>ciphertexts.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Args:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>ct1:<span> </span>first<span> </span>ciphertext.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>ct2:<span> </span>second<span> </span>ciphertext.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>q:<span> </span>ciphertext<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>t:<span> </span>plaintext<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>p:<span> </span>modulus-swithcing<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>poly_mod:<span> </span>polynomial<span> </span>modulus.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>rlk0,<span> </span>rlk1:<span> </span>output<span> </span>of<span> </span>the<span> </span>EvaluateKeygen_v2<span> </span>function.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>Returns:<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>Tuple<span> </span>representing<span> </span>a<span> </span>ciphertext.<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>\"\"\"</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>c_0<span>,</span><span> </span>c_1<span>,</span><span> </span>c_2<span> </span><span>=</span><span> </span>multiplication_coeffs<span>(</span>ct1<span>,</span><span> </span>ct2<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>)</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>c_20<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>np<span>.</span><span>round</span><span>(</span>polymul_wm<span>(</span>c_2<span>,</span><span> </span>rlk0<span>,</span><span> </span>poly_mod<span>)</span><span> </span><span>/</span><span> </span>p<span>)</span><span>)</span><span> </span><span>%</span><span> </span>q<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>c_21<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>np<span>.</span><span>round</span><span>(</span>polymul_wm<span>(</span>c_2<span>,</span><span> </span>rlk1<span>,</span><span> </span>poly_mod<span>)</span><span> </span><span>/</span><span> </span>p<span>)</span><span>)</span><span> </span><span>%</span><span> </span>q<span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>new_c0<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>polyadd_wm<span>(</span>c_0<span>,</span><span> </span>c_20<span>,</span><span> </span>poly_mod<span>)</span><span>)</span><span> </span><span>%</span><span> </span>q<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>new_c1<span> </span><span>=</span><span> </span>np<span>.</span>int64<span>(</span>polyadd_wm<span>(</span>c_1<span>,</span><span> </span>c_21<span>,</span><span> </span>poly_mod<span>)</span><span>)</span><span> </span><span>%</span><span> </span>q<span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>return</span><span> </span><span>(</span>new_c0<span>,</span><span> </span>new_c1<span>)</span><span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>\n</code></pre></div>\n<h3>Version 1 vs. Version 2 🥊</h3>\n<p>Recall that we can derive a fresh standard ciphertext that decrypts to\n<span><span><span>[mm′]t[mm']_t</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> as <span><span><span>cmul=(c0+c20,c1+c21)c_{mul} =(c_0+c_{20}, c_1+c_{21})</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>m</span><span>u</span><span>l</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>, since</p>\n<div><span><span><span>c0+c20+s⋅(c1+c21)=Δ⋅[mm′]t+vmult,c_0 + c_{20} + s\\cdot (c_1 + c_{21}) = \\Delta \\cdot [mm']_t + v_{mult},</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>s</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span><span>c</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>2</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>Δ</span><span></span><span>⋅</span><span></span></span><span><span></span><span>[</span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>m</span><span>u</span><span>l</span><span>t</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span></span></span></span></span></div>\n<p>where <span><span><span>vmult=u3+erelinv_{mult} = u_3 + e_{\\text{relin}}</span><span aria-hidden=\"true\"><span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span><span>m</span><span>u</span><span>l</span><span>t</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and <span><span><span>erelin∈{erelin_v1,erelin_v2}e_{\\text{relin}} \\in \\{e_{\\text{relin\\_v1}}, e_{\\text{relin\\_v2}}\\}</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>∈</span><span></span></span><span><span></span><span>{</span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin_v1</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin_v2</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>}</span></span></span></span></span>.</p>\n<p>We need to make sure that <span><span><span>cmulc_{mul}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>m</span><span>u</span><span>l</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> decrypts <em>correctly</em> to <span><span><span>[mm′]t[mm']_t</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>m</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span><span>]</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. For\nthis, it suffices to choose the parameters such that\n<span><span><span>∥u3∥+∥erelin∥≤Δ/2.\\|u_3\\| + \\|e_{\\text{relin}}\\| \\leq \\Delta/2.</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span><span>u</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∥</span><span></span><span>+</span><span></span></span><span><span></span><span>∥</span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∥</span><span></span><span>≤</span><span></span></span><span><span></span><span>Δ</span><span>/</span><span>2</span><span>.</span></span></span></span></span></p>\n<p>Now that we have <strong>two</strong> versions of relinearization, which help us in\nderiving <span><span><span>cmulc_{mul}</span><span aria-hidden=\"true\"><span><span></span><span><span>c</span><span><span><span><span><span><span></span><span><span><span>m</span><span>u</span><span>l</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, we may wonder which one we can use:</p>\n<table>\n<thead>\n<tr>\n<th>Relinearization</th>\n<th align=\"left\">Size of <span><span><span>rlkrlk</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span>l</span><span>k</span></span></span></span></span> (in bits)</th>\n<th>Bound of <span><span><span>ereline_{\\text{relin}}</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Version 1</strong></td>\n<td align=\"left\"><span><span><span>2(ℓ+1)⋅n⋅log⁡q2(\\ell+1)\\cdot n \\cdot \\log q</span><span aria-hidden=\"true\"><span><span></span><span>2</span><span>(</span><span>ℓ</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>n</span><span></span><span>⋅</span><span></span></span><span><span></span><span>lo<span>g</span></span><span></span><span>q</span></span></span></span></span></td>\n<td><span><span><span>(ℓ+1)⋅B⋅T⋅n/2(\\ell+1)\\cdot B \\cdot T \\cdot n/2</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>ℓ</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>B</span><span></span><span>⋅</span><span></span></span><span><span></span><span>T</span><span></span><span>⋅</span><span></span></span><span><span></span><span>n</span><span>/</span><span>2</span></span></span></span></span></td>\n</tr>\n<tr>\n<td><strong>Version 2</strong></td>\n<td align=\"left\"><span><span><span>2n⋅log⁡pq2n \\cdot \\log pq</span><span aria-hidden=\"true\"><span><span></span><span>2</span><span>n</span><span></span><span>⋅</span><span></span></span><span><span></span><span>lo<span>g</span></span><span></span><span>p</span><span>q</span></span></span></span></span></td>\n<td><span><span><span>q⋅B′⋅np+n+12\\frac{q \\cdot B' \\cdot n}{p}+\\frac{n+1}{2}</span><span aria-hidden=\"true\"><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>p</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>q</span><span>⋅</span><span><span>B</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span>⋅</span><span>n</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>2</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>n</span><span>+</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></td>\n</tr>\n</tbody>\n</table>\n<p>➡️ <strong>size of <span><span><span>rlkrlk</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span>l</span><span>k</span></span></span></span></span>:</strong> <strong>Version 1</strong> gives a relinearization key as <span><span><span>ℓ+1\\ell+1</span><span aria-hidden=\"true\"><span><span></span><span>ℓ</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> pairs of polynomials in <span><span><span>Rq,R_q,</span><span aria-hidden=\"true\"><span><span></span><span><span>R</span><span><span><span><span><span><span></span><span><span>q</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span></span></span></span></span> whereas <strong>Version 2</strong> gives just one such pair. Recall that <span><span><span>ℓ=⌊log⁡Tq⌋\\ell=\\lfloor \\log_T{q}\\rfloor</span><span aria-hidden=\"true\"><span><span></span><span>ℓ</span><span></span><span>=</span><span></span></span><span><span></span><span>⌊</span><span><span>lo<span>g</span></span><span><span><span><span><span><span></span><span><span>T</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span><span>q</span></span><span>⌋</span></span></span></span></span> and see that this decreases as long as the base <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> increases.</p>\n<p>➡️ <strong>bound of <span><span><span>ereline_{\\text{relin}}</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>:</strong> The upper bounds of <span><span><span>ereline_{\\text{relin}}</span><span aria-hidden=\"true\"><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> for both versions are according to <a href=\"https://eprint.iacr.org/2012/144.pdf\">[FV12], Lem.3</a>. We consider <span><span><span>BB</span><span aria-hidden=\"true\"><span><span></span><span>B</span></span></span></span></span> as a bound taken so that the error distribution <span><span><span>χ\\chi</span><span aria-hidden=\"true\"><span><span></span><span>χ</span></span></span></span></span> takes values in <span><span><span>[−B,B][-B,B]</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>−</span><span>B</span><span>,</span><span></span><span>B</span><span>]</span></span></span></span></span> with high probability. We similarly define <span><span><span>B′B'</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> for the case of the error distribution <span><span><span>χ′\\chi'</span><span aria-hidden=\"true\"><span><span></span><span><span>χ</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span>, used in <strong>Version 2</strong>. Notice that for <strong>Version 1</strong>, a larger <span><span><span>TT</span><span aria-hidden=\"true\"><span><span></span><span>T</span></span></span></span></span> leads to more noise (but smaller <span><span><span>rlkrlk</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span>l</span><span>k</span></span></span></span></span>), whereas in <strong>Version 2</strong>, a larger <span><span><span>pp</span><span aria-hidden=\"true\"><span><span></span><span>p</span></span></span></span></span> leads to smaller noise (but larger <span><span><span>rlkrlk</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span>l</span><span>k</span></span></span></span></span>). For choosing the parameters in safe implementation, we refer the reader to <a href=\"https://eprint.iacr.org/2012/144.pdf\">[FV12] Sec. Realinearisation Version 2.</a></p>\n<h3>Setting the parameters</h3>\n<p>We set the parameters for our toy implementation just to make sure it always\ncorrectly decrypts at least one ciphertext multiplication. For that, we made\nsure that <span><span><span>∥u3∥+∥erelin∥&#x3C;Δ/2\\|u_3\\| + \\|e_{\\text{relin}}\\|&#x3C; \\Delta /2</span><span aria-hidden=\"true\"><span><span></span><span>∥</span><span><span>u</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∥</span><span></span><span>+</span><span></span></span><span><span></span><span>∥</span><span><span>e</span><span><span><span><span><span><span></span><span><span><span><span>relin</span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∥</span><span></span><span>&#x3C;</span><span></span></span><span><span></span><span>Δ</span><span>/</span><span>2</span></span></span></span></span>. In practice, for the\ncurrent choice it seems that decryption always works for <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span> ciphertext\nmultiplications when using V2 relinearization, for example. This is due to\nthe fact that the theoretical bounds are worst-case bounds. For the same\nparameters we can make hundreds of addition (in practice it seems that\ndecryption works even for <span><span><span>10001000</span><span aria-hidden=\"true\"><span><span></span><span>1</span><span>0</span><span>0</span><span>0</span></span></span></span></span> additions 😮). Ciphertext addition\nis almost for free in terms of noise growth! 💥 We invite you to play\naround with the parameters and the bounds and try to see how many\nmultiplications you can get (as they are the costly operations).</p>\n<h3>Let's play! 🎉</h3>\n<p>Now we can multiply ciphertexts, as we have implemented two versions of this:\n<span><span><span>mul_cipher_v1\\texttt{mul\\_cipher\\_v1}</span><span aria-hidden=\"true\"><span><span></span><span><span>mul_cipher_v1</span></span></span></span></span></span> and <span><span><span>mul_cipher_v2\\texttt{mul\\_cipher\\_v2}</span><span aria-hidden=\"true\"><span><span></span><span><span>mul_cipher_v2</span></span></span></span></span></span>, using\nrelinearization. We can further add ciphertexts by using\n<span><span><span>add_cipher\\texttt{add\\_cipher}</span><span aria-hidden=\"true\"><span><span></span><span><span>add_cipher</span></span></span></span></span></span>. So yay! we can finally perform computations on\nencrypted data.</p>\n<p><strong>Bonus:</strong> if you're curious, you can try computing more complex (polynomial)\noperations on encrypted data, such as <em>multiplying three ciphertexts</em>. Here\nwe only wanted to show how to perform one multiplication. For more levels of\nmultiplications, you should set the parameters as in\n<a href=\"https://eprint.iacr.org/2012/144.pdf\">[FV12, Thm1]</a> so that you decrypt\ncorrectly 😉.</p>\n<p><strong>Bonus2:</strong> you can also perform <em>plain operations</em>, such as adding or\nmultiplying plaintexts to ciphertexts, by using <span><span><span>add_plain\\texttt{add\\_plain}</span><span aria-hidden=\"true\"><span><span></span><span><span>add_plain</span></span></span></span></span></span> and\n<span><span><span>mul_plain,\\texttt{mul\\_plain},</span><span aria-hidden=\"true\"><span><span></span><span><span>mul_plain</span></span><span>,</span></span></span></span></span> (with a <em>reduced noise growth</em>) both from\n<a href=\"https://github.com/Bitdefender-Crypto-Team/he-scheme/blob/main/rlwe_he_scheme_updated.py\">here</a>.\nFor further details on how these work, you should check\n<a href=\"https://blog.openmined.org/build-an-homomorphic-encryption-scheme-from-scratch-with-python/#buildanhomomorphicencryptionscheme\">this</a>. 🤓</p>\n<p>So what are you waiting for? Go check it out!</p>\n<div><pre><code><span>import</span><span> </span>rlwe_he_scheme_updated<span> </span><span>as</span><span> </span>rlwe_updated<span></span>\n<span></span><span>import</span><span> </span>numpy<span> </span><span>as</span><span> </span>np<span></span>\n<span></span><span></span>\n<span></span><span>if</span><span> </span>__name__<span> </span><span>==</span><span> </span><span>'__main__'</span><span>:</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>Scheme's<span> </span>parameters</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>polynomial<span> </span>modulus<span> </span>degree</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>n<span> </span><span>=</span><span> </span><span>2</span><span> </span><span>**</span><span> </span><span>2</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>ciphertext<span> </span>modulus</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>q<span> </span><span>=</span><span> </span><span>2</span><span> </span><span>**</span><span> </span><span>14</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>plaintext<span> </span>modulus</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>t<span> </span><span>=</span><span> </span><span>2</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>base<span> </span>for<span> </span>relin_v1</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>T<span> </span><span>=</span><span> </span><span>int</span><span>(</span>np<span>.</span>sqrt<span>(</span>q<span>)</span><span>)</span><span> </span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#modulusswitching<span> </span>modulus</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>p<span> </span><span>=</span><span> </span>q<span> </span><span>**</span><span> </span><span>3</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>polynomial<span> </span>modulus</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>poly_mod<span> </span><span>=</span><span> </span>np<span>.</span>array<span>(</span><span>[</span><span>1</span><span>]</span><span> </span><span>+</span><span> </span><span>[</span><span>0</span><span>]</span><span> </span><span>*</span><span> </span><span>(</span>n<span> </span><span>-</span><span> </span><span>1</span><span>)</span><span> </span><span>+</span><span> </span><span>[</span><span>1</span><span>]</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#standard<span> </span>deviation<span> </span>for<span> </span>the<span> </span>error<span> </span>in<span> </span>the<span> </span>encryption</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>std1<span> </span><span>=</span><span> </span><span>1</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#standard<span> </span>deviation<span> </span>for<span> </span>the<span> </span>error<span> </span>in<span> </span>the<span> </span>evaluateKeyGen_v2</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>std2<span> </span><span>=</span><span> </span><span>1</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>Keygen</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>pk<span>,</span><span> </span>sk<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>keygen<span>(</span>n<span>,</span><span> </span>q<span>,</span><span> </span>poly_mod<span>,</span><span> </span>std1<span>)</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#EvaluateKeygen_version1</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>rlk0_v1<span>,</span><span> </span>rlk1_v1<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>evaluate_keygen_v1<span>(</span>sk<span>,</span><span> </span>n<span>,</span><span> </span>q<span>,</span><span> </span>T<span>,</span><span> </span>poly_mod<span>,</span><span> </span>std1<span>)</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#EvaluateKeygen_version2</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>rlk0_v2<span>,</span><span> </span>rlk1_v2<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>evaluate_keygen_v2<span>(</span>sk<span>,</span><span> </span>n<span>,</span><span> </span>q<span>,</span><span> </span>poly_mod<span>,</span><span> </span>p<span>,</span><span> </span>std2<span>)</span><span></span>\n<span></span><span> </span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>Encryption</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>pt1<span>,</span><span> </span>pt2<span> </span><span>=</span><span> </span><span>[</span><span>1</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>1</span><span>]</span><span>,</span><span> </span><span>[</span><span>1</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>1</span><span>]</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>cst1<span>,</span><span> </span>cst2<span> </span><span>=</span><span> </span><span>[</span><span>0</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>0</span><span>]</span><span>,</span><span> </span><span>[</span><span>0</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>0</span><span>]</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>ct1<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>encrypt<span>(</span>pk<span>,</span><span> </span>n<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>,</span><span> </span>pt1<span>,</span><span> </span>std1<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>ct2<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>encrypt<span>(</span>pk<span>,</span><span> </span>n<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>,</span><span> </span>pt2<span>,</span><span> </span>std1<span>)</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"[+]<span> </span>Ciphertext<span> </span>ct1({}):\"</span><span>.</span><span>format</span><span>(</span>pt1<span>)</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"\"</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"\\t<span> </span>ct1_0:\"</span><span>,</span><span> </span>ct1<span>[</span><span>0</span><span>]</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"\\t<span> </span>ct1_1:\"</span><span>,</span><span> </span>ct1<span>[</span><span>1</span><span>]</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"\"</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"[+]<span> </span>Ciphertext<span> </span>ct2({}):\"</span><span>.</span><span>format</span><span>(</span>pt2<span>)</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"\"</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"\\t<span> </span>ct1_0:\"</span><span>,</span><span> </span>ct2<span>[</span><span>0</span><span>]</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"\\t<span> </span>ct1_1:\"</span><span>,</span><span> </span>ct2<span>[</span><span>1</span><span>]</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"\"</span><span>)</span><span></span>\n<span></span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>Evaluation</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>ct3<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>add_plain<span>(</span>ct1<span>,</span><span> </span>cst1<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>ct4<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>mul_plain<span>(</span>ct2<span>,</span><span> </span>cst2<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#ct5<span> </span>=<span> </span>(ct1<span> </span>+<span> </span>cst1)<span> </span>+<span> </span>(cst2<span> </span>*<span> </span>ct2)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>ct5<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>add_cipher<span>(</span>ct3<span>,</span><span> </span>ct4<span>,</span><span> </span>q<span>,</span><span> </span>poly_mod<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>ct6<span> </span>=<span> </span>ct1<span> </span>*<span> </span>ct2</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>ct6<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>mul_cipher_v1<span>(</span>ct1<span>,</span><span> </span>ct2<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>T<span>,</span><span> </span>poly_mod<span>,</span><span> </span>rlk0_v1<span>,</span><span> </span>rlk1_v1<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>ct7<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>mul_cipher_v2<span>(</span>ct1<span>,</span><span> </span>ct2<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>p<span>,</span><span> </span>poly_mod<span>,</span><span> </span>rlk0_v2<span>,</span><span> </span>rlk1_v2<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>#<span> </span>Decryption</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>decrypted_ct3<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>decrypt<span>(</span>sk<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>,</span><span> </span>ct3<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>decrypted_ct4<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>decrypt<span>(</span>sk<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>,</span><span> </span>ct4<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>decrypted_ct5<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>decrypt<span>(</span>sk<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>,</span><span> </span>ct5<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>decrypted_ct6<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>decrypt<span>(</span>sk<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>,</span><span> </span>ct6<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span>decrypted_ct7<span> </span><span>=</span><span> </span>rlwe_updated<span>.</span>decrypt<span>(</span>sk<span>,</span><span> </span>q<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>,</span><span> </span>ct7<span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"[+]<span> </span>Decrypted<span> </span>ct3=(ct1<span> </span>+<span> </span>{}):<span> </span>{}\"</span><span>.</span><span>format</span><span>(</span>cst1<span>,</span><span> </span>decrypted_ct3<span>)</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"[+]<span> </span>Decrypted<span> </span>ct4=(ct2<span> </span>*<span> </span>{}):<span> </span>{}\"</span><span>.</span><span>format</span><span>(</span>cst2<span>,</span><span> </span>decrypted_ct4<span>)</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"[+]<span> </span>Decrypted<span> </span>ct5=(ct1<span> </span>+<span> </span>{}<span> </span>+<span> </span>{}<span> </span>*<span> </span>ct2):<span> </span>{}\"</span><span>.</span><span>format</span><span>(</span>cst1<span>,</span><span> </span>cst2<span>,</span><span> </span>decrypted_ct5<span>)</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"[+]<span> </span>pt1<span> </span>+<span> </span>{}<span> </span>+<span> </span>{}<span> </span>*<span> </span>pt2):<span> </span>{}\"</span><span>.</span><span>format</span><span>(</span>cst1<span>,</span><span> </span>cst2<span>,</span><span> </span>rlwe_updated<span>.</span>polyadd<span>(</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>rlwe_updated<span>.</span>polyadd<span>(</span>pt1<span>,</span><span> </span>cst1<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>rlwe_updated<span>.</span>polymul<span>(</span>cst2<span>,</span><span> </span>pt2<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>)</span><span>,</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>t<span>,</span><span> </span>poly_mod<span>)</span><span>)</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"[+]<span> </span>Decrypted<span> </span>ct6=(ct1<span> </span>*<span> </span>ct2):<span> </span>{}\"</span><span>.</span><span>format</span><span>(</span>decrypted_ct6<span>)</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"[+]<span> </span>Decrypted<span> </span>ct7=(ct1<span> </span>*<span> </span>ct2):<span> </span>{}\"</span><span>.</span><span>format</span><span>(</span>decrypted_ct7<span>)</span><span>)</span><span></span>\n<span></span><span> </span><span> </span><span> </span><span> </span><span>print</span><span>(</span><span>\"[+]<span> </span>pt1<span> </span>*<span> </span>pt2:<span> </span>{}\"</span><span>.</span><span>format</span><span>(</span>rlwe_updated<span>.</span>polymul<span>(</span>pt1<span>,</span><span> </span>pt2<span>,</span><span> </span>t<span>,</span><span> </span>poly_mod<span>)</span><span>)</span><span>)</span><span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>\n</code></pre></div>\n"},{"data":{"slug":"private-set-intersection-an-implementation-in-python","authors":"Mădălina Bolboceanu, Miruna Roșca, Radu Țițiu","categories":"blog","featured_img":"/galleries/private_set2021/monolith.jpg","date":"May-21-2021","title":"Private Set Intersection from Homomorphic Encryption: A Python Implementation","id":5},"messages":[],"history":["./content/collections/posts/private_set_intersection2021.md","content/collections/posts/private_set_intersection2021.html"],"cwd":"/Users/fbrad/bit/bit-ml","contents":"<h1>Private Set Intersection from Homomorphic Encryption: A Python Implementation</h1>\n<p>Check out our <strong>Private Set Intersection (PSI)</strong> implementation in Python <a href=\"https://github.com/bit-ml/Private-Set-Intersection\">here</a>!</p>\n<p>In this blog post, we will first motivate our interest in <strong>PSI</strong>, by providing a list of applications: password checkup, private contact discovery for Whatsapp or Signal, measuring ads efficiency privately or DNA pattern matching. Secondly, we will show how to build a <strong>PSI</strong> protocol using a <strong>HE</strong> encryption scheme. Thirdly, we will describe our Python implementation of a specific <strong>PSI</strong> protocol.</p>\n<p>Our implementation is based on the protocol described in this <a href=\"https://eprint.iacr.org/2017/299.pdf\">paper</a> and its <a href=\"https://eprint.iacr.org/2018/787.pdf\">follow-up</a>. This protocol uses <strong>Homomorphic Encryption (HE)</strong>, a powerful cryptographic primitive which allows performing computations on encrypted data in such a way that only the secret key holder has access to the decryption of the result of these computations. If you are curious about <strong>HE</strong>, check out <a href=\"https://bit-ml.github.io/blog/post/homomorphic-encryption-toy-implementation-in-python/\">our previous blog post</a>! Our implementation uses the <a href=\"https://eprint.iacr.org/2012/144.pdf\">BFV</a> Brakerski-Fan-Vercauteren  <strong>HE</strong> scheme from the <a href=\"https://github.com/OpenMined/TenSEAL\">TenSEAL</a> library. You can also check out a concurrent <a href=\"https://github.com/microsoft/SEAL\">SEAL</a>-based <a href=\"https://github.com/microsoft/APSI\">C++ implementation</a> of the same protocol that has been recently published by   Microsoft.</p>\n<p><strong>Disclaimer:</strong> Our implementation is not meant for production use. Use it at your own risk.</p>\n<h2>1. Private Set Intersection (<strong>PSI</strong>)</h2>\n<p>Private Set Intersection (<strong>PSI</strong>) is an interactive protocol between a client and a server. The client holds a set of items <span><span><span>YY</span><span aria-hidden=\"true\"><span><span></span><span>Y</span></span></span></span></span> and the server holds a set of items <span><span><span>XX</span><span aria-hidden=\"true\"><span><span></span><span>X</span></span></span></span></span>. By the end of the protocol, the client learns the intersection of <span><span><span>XX</span><span aria-hidden=\"true\"><span><span></span><span>X</span></span></span></span></span> and <span><span><span>YY</span><span aria-hidden=\"true\"><span><span></span><span>Y</span></span></span></span></span> and nothing else about the server's set, while the server learns nothing about the client's data.</p>\n<h3>Motivation</h3>\n<p>Imagine that a WhatsApp client would like to check who among his phone contacts also uses WhatsApp. To get this information, he could send his entire contact list to the WhatsApp server and the server could answer him back with the list of his contacts who use the app. In this way, the server learns the client's list of contacts ⚠️. The client may not be happy about this because he values his privacy. Ideally, a client would like to <strong>privately</strong> learn who, among his contacts, uses the app, <strong>without revealing his entire list to the WhatsApp server</strong>. Here is the place where Private Set Intersection comes to the rescue.</p>\n<p><img src=\"https://i.imgur.com/CRyDlK2.png\" alt=\"\"></p>\n<h3>What is <strong>PSI</strong>?</h3>\n<p>Suppose Alice has a list of friends <strong>A</strong> and Bob has a list of friends <strong>B</strong>. Alice is interested in finding out their mutual friends and Bob is ok to share this information with her. Of course, Alice would easily find this out if Bob gave her his list. Or, Alice could send her list to Bob and Bob could answer her back with the information that she is interested in. But both Alice and Bob value their privacy and neither of them wants to reveal his/her entire list of friends to the other.</p>\n<p><img src=\"https://i.imgur.com/QSq2yxQ.png\" alt=\"\"></p>\n<p><strong>PSI</strong> is an interactive cryptographic protocol which allows Alice to find out the friends that she has in common with Bob and nothing else about the rest of Bob's friends and prevents Bob from learning any information about Alice's list of friends. As you can see now, a <strong>PSI</strong> protocol is everything we need to solve the Whatsapp problem that we have described in the last section.</p>\n<h3>Applications of <strong>PSI</strong></h3>\n<p><strong>PSI</strong> may be used in many practical applications:</p>\n<ol>\n<li>\n<p>🔑 <strong>Password Checkup</strong>: A client wants to check if his credentials are leaked somewhere on the internet. <strong>PSI</strong> allows the client to query a database of leaked passwords, without revealing his actual password to the database owner.</p>\n</li>\n<li>\n<p>🔬 <strong>DNA private matching</strong>: A client gets his DNA sequenced and wants to find out if his sequence is related to some genetic disease. <strong>PSI</strong> allows the client to query a database of disease-linked sequences, without revealing his DNA sequence.</p>\n</li>\n<li>\n<p>🚗 <strong>Measuring ads efficiency</strong>: A car company owners want to measure how efficient are the ads for which they have paid. <strong>PSI</strong> allows the company to find out who among its clients have seen a specific ad on social media (on Facebook for instance), while the car company keeps its list of clients private and Facebook also keeps its list of users private.</p>\n</li>\n</ol>\n<h2>2. <strong>PSI</strong> from <strong>HE</strong></h2>\n<p>One of the first <strong>PSI</strong> protocols in the literature was proposed by Meadows in <a href=\"https://www.computer.org/csdl/proceedings-article/sp/1986/07160134/12OmNAYoKof%5D\">this paper</a> and uses as building block the Diffie-Hellman exchange protocol. As we said, in this blog post, we focus on a <strong>PSI</strong> protocol that uses <strong>HE</strong>. The <strong>HE</strong> approach works really well in the <em>asymmetric</em> case (i.e. the case where the size of the server's set is much larger than the size of the client's set), with especially great results in terms of communication costs. As you can imagine, this is exactly the case we are interested in: the WhatsApp's database is much larger than the database of a particular client.</p>\n<h3>Short recap on <strong>HE</strong></h3>\n<p>Let's recap a bit what <strong>HE</strong> is, first.  As nicely explained <a href=\"https://bit-ml.github.io/blog/post/homomorphic-encryption-toy-implementation-in-python/\">here</a> 😉, this cryptographic primitive allows you to compute on encrypted data.</p>\n<p>In our implementation we use the <a href=\"https://eprint.iacr.org/2012/144.pdf\">BFV</a> <strong>HE</strong> scheme. This scheme encodes plaintexts as <strong>polynomials of degree less than</strong> <code>poly_modulus_degree</code> (which is a power of 2) with integer coefficients modulo <code>plain_modulus</code>. Because of the <em>homomorphic properties</em> of the scheme, for any plaintexts <span><span><span>m1,m2,mm_1, m_2, m</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>m</span></span></span></span></span> and <span><span><span>pp</span><span aria-hidden=\"true\"><span><span></span><span>p</span></span></span></span></span>, we have that:</p>\n<div><span><span><span>Enc(m1)+Enc(m2)≡Enc(m1+m2)Enc(m1)⋅Enc(m2)≡Enc(m1⋅m2)p+Enc(m)≡Enc(p+m)p⋅Enc(m)≡Enc(p⋅m),\\begin{aligned}\n\\mathsf{Enc}(m_1) + \\mathsf{Enc}(m_2) &#x26;\\equiv \\mathsf{Enc}(m_1 + m_2)\\\\\n\\mathsf{Enc}(m_1) \\cdot \\mathsf{Enc}(m_2) &#x26;\\equiv \\mathsf{Enc}(m_1 \\cdot m_2)\\\\\np+\\mathsf{Enc}(m) &#x26;\\equiv \\mathsf{Enc}(p+ m)\\\\\np\\cdot\\mathsf{Enc}(m) &#x26;\\equiv \\mathsf{Enc}(p\\cdot m)\n\\end{aligned},</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span><span><span></span><span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span><span><span></span><span><span>p</span><span></span><span>+</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>m</span><span>)</span></span></span><span><span></span><span><span>p</span><span></span><span>⋅</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>m</span><span>)</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>≡</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>≡</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>≡</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span></span><span>+</span><span></span><span>m</span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>≡</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span></span><span>⋅</span><span></span><span>m</span><span>)</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>,</span></span></span></span></span></div>\n<p>Since using <a href=\"https://eprint.iacr.org/2012/144.pdf\">BFV</a> we can perform additions and multiplications homomorphically on ciphertexts, then we can also evaluate polynomials homomorphically. So cool, no? Still, keep in mind that the parameters of the scheme usually allow performing only a limited number of multiplications! We will get back to this observation soon.</p>\n<h3>How to get <strong>PSI</strong> from <strong>HE</strong></h3>\n<p>In the rest of this section, we will show you the intuition behind building a <strong>PSI</strong> protocol from a <strong>HE</strong> scheme. We will build this intuition step by step, by starting with very particular cases.</p>\n<p>Case <strong>a.</strong> Alice has just one friend <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> and Bob also has just one friend <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span> (it's unlikely, but who knows, maybe they are both extremely selective 🧐 when it comes to friendships).</p>\n<p>💡 <strong>Let's see how they may use the magic of HE</strong>: Alice encrypts her <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> using a <strong>HE</strong> scheme, gets <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> and sends it to Bob. Now Bob subtracts his <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span> from <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> and multiplies this result by a random nonzero integer <span><span><span>rr</span><span aria-hidden=\"true\"><span><span></span><span>r</span></span></span></span></span>. Due to the 💪 of <strong>HE</strong>, the result of Bob's computation is actually an encryption of <span><span><span>r⋅(y−x)r\\cdot(y-x)</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>y</span><span></span><span>−</span><span></span></span><span><span></span><span>x</span><span>)</span></span></span></span></span>. He sends <span><span><span>Enc(r⋅(y−x))\\mathsf{Enc}(r\\cdot(y-x))</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>r</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>y</span><span></span><span>−</span><span></span></span><span><span></span><span>x</span><span>)</span><span>)</span></span></span></span></span> back to Alice. Alice now decrypts this element using her secret key and she checks whether she gets a <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span> or not. If she gets a <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span>, her friend <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> is the same as Bob's friend <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span>. Otherwise, their friends are different.</p>\n<p><img src=\"https://i.imgur.com/kH6ixJv.png\" alt=\"\"></p>\n<p>❗ For the ease of understanding, throughout this section, we will assume that both the plaintexts (<span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span>, <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span>, etc.) and the ciphertexts produced by the <strong>HE</strong> scheme are integers.</p>\n<p>🤔 <strong>Why does it work?</strong>  When she decrypts, Alice recovers the product <span><span><span>r⋅(y−x)r\\cdot(y-x)</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>y</span><span></span><span>−</span><span></span></span><span><span></span><span>x</span><span>)</span></span></span></span></span>. If this product is <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span>, it means that one of its terms (<span><span><span>rr</span><span aria-hidden=\"true\"><span><span></span><span>r</span></span></span></span></span> or <span><span><span>y−xy-x</span><span aria-hidden=\"true\"><span><span></span><span>y</span><span></span><span>−</span><span></span></span><span><span></span><span>x</span></span></span></span></span>) is <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span>. Since <span><span><span>rr</span><span aria-hidden=\"true\"><span><span></span><span>r</span></span></span></span></span> is chosen to be nonzero, it automatically means that <span><span><span>y−x=0y-x=0</span><span aria-hidden=\"true\"><span><span></span><span>y</span><span></span><span>−</span><span></span></span><span><span></span><span>x</span><span></span><span>=</span><span></span></span><span><span></span><span>0</span></span></span></span></span> and Alice will know that her friend <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> is also Bob's friend.</p>\n<p>If the product is not <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span>, it means that <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span> and <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> are for sure different. Moreover, if we assume that the <strong>HE</strong> scheme has \"circuit privacy\" (in other words, if we assume that Alice may never find out information about the random element <span><span><span>rr</span><span aria-hidden=\"true\"><span><span></span><span>r</span></span></span></span></span> used by Bob), then the value <span><span><span>r⋅(y−x)r\\cdot(y-x)</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>y</span><span></span><span>−</span><span></span></span><span><span></span><span>x</span><span>)</span></span></span></span></span> recovered by Alice will look random to her and she will never learn any information about Bob's <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span>.</p>\n<p>Case <strong>b</strong>. Alice still has one friend <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span>, but Bob has many friends <span><span><span>x0,...,xnx_0,...,x_n</span><span aria-hidden=\"true\"><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span>,</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>Let's assume that Bob has 10 friends (<span><span><span>n=9n=9</span><span aria-hidden=\"true\"><span><span></span><span>n</span><span></span><span>=</span><span></span></span><span><span></span><span>9</span></span></span></span></span>). He chooses a random nonzero integer <span><span><span>rr</span><span aria-hidden=\"true\"><span><span></span><span>r</span></span></span></span></span> and associates to his list of friends the monic polynomial</p>\n<div><span><span><span>P(X)=r⋅(X−x0)⋅…⋅(X−x9).P(X) = r\\cdot (X-x_0) \\cdot \\ldots \\cdot (X-x_9).</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span>X</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>r</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>−</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>…</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>−</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>9</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>.</span></span></span></span></span></div>\n<p>❗ Keep in mind that <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> vanishes at <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span> if and only if <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span> belongs to the set <span><span><span>{x0,…,x9}\\{x_0,\\ldots,x_9\\}</span><span aria-hidden=\"true\"><span><span></span><span>{</span><span><span>x</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>9</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>}</span></span></span></span></span>.</p>\n<p><strong>💡 Here is the place where HE comes into play</strong>: Alice encrypts her element <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> with a <strong>HE</strong> scheme, gets <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> and sends it to Bob. Bob now evaluates his secret polynomial <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> at <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> and sends the result back to Alice. Because of the homomorphic properties of the encryption scheme, <span><span><span>P(Enc(y))≡Enc(P(y))P(\\mathsf{Enc}(y)) \\equiv \\mathsf{Enc}(P(y))</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span><span>)</span><span></span><span>≡</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>P</span><span>(</span><span>y</span><span>)</span><span>)</span></span></span></span></span>, which means that Bob actually sends to Alice an encryption of <span><span><span>P(y)P(y)</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span>y</span><span>)</span></span></span></span></span>. When Alice decrypts this value, she checks if it is equal to <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span> or not. If it is <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span>, it means that her friend <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> is also a friend of Bob. Otherwise, <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> is not among Bob's friends.</p>\n<p><img src=\"https://i.imgur.com/X8vMiPk.png\" alt=\"\"></p>\n<p>🤔 <strong>Why does it work?</strong>  When she decrypts, Alice recovers the product <span><span><span>r⋅(y−x0)⋅…⋅(y−x9)r\\cdot(y-x_0)\\cdot \\ldots \\cdot(y-x_9)</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>y</span><span></span><span>−</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>…</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>y</span><span></span><span>−</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>9</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>. As in Case <strong>a</strong>, this product is <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span> if and only if <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> is one of Bob's friends.</p>\n<p>Case <strong>c</strong>. Alice has many friends, Bob has many friends too.</p>\n<p>This is the more general case. At this point you may already have an idea  🤓 on how to solve it! Indeed, Alice and Bob could just repeat the protocol from Case <strong>b</strong> for every friend of Alice! So easy, right?</p>\n<p>Still, at this moment you already ask yourself:</p>\n<ol>\n<li>What happens if Alice has a lot of friends?</li>\n</ol>\n<p>In this case, the communication size will grow dramatically since you should repeat the protocol from Case <strong>b</strong> for every friend of Alice. In conclusion, this trivial solution may not be efficient in practice.</p>\n<ol start=\"2\">\n<li>What happens if Bob has a lot of friends?</li>\n</ol>\n<p>In this case, Bob has to evaluate homomorphically a polynomial of a very large degree. But this may be impossible, since a typical homomorphic encryption scheme allows performing homomorphically only a limited number of multiplications. The reason for this is not hard to understand, read about the noise growing in <strong>HE</strong> <a href=\"https://bit-ml.github.io/blog/post/homomorphic-encryption-toy-implementation-in-python/\">here</a>!</p>\n<p><strong>Towards a more practical PSI protocol</strong>. In the next section, we will show you how to tackle the above two problems. Concretely, we will describe a range of <strong>optimizations</strong> that we can apply in order to make the above solution work in practice.</p>\n<h2>3. Implementing the <strong>PSI</strong> protocol</h2>\n<p>Before giving more details about the actual implementation, we are going to discuss some of the ideas that enable the basic protocol (Case <strong>c</strong>) to become practical. We will also give an intuition on how <strong>HE</strong> and Oblivious Pseudorandom Functions (<strong>OPRFs</strong>) provide privacy for both the client and the server.</p>\n<h3>Optimizations for a practical protocol ⚙️</h3>\n<p>Suppose the server holds a set of items <span><span><span>XX</span><span aria-hidden=\"true\"><span><span></span><span>X</span></span></span></span></span> and the client has a much smaller set <span><span><span>YY</span><span aria-hidden=\"true\"><span><span></span><span>Y</span></span></span></span></span>. In the basic protocol (Case <strong>c</strong>), the client has to send an individual encryption for each element in the set <span><span><span>Y={y0,y1,y2,…}Y=\\{y_0,y_1,y_2,\\ldots\\}</span><span aria-hidden=\"true\"><span><span></span><span>Y</span><span></span><span>=</span><span></span></span><span><span></span><span>{</span><span><span>y</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>…</span><span>}</span></span></span></span></span>. This means that the communication cost is proportional to <span><span><span>∣Y∣|Y|</span><span aria-hidden=\"true\"><span><span></span><span>∣</span><span>Y</span><span>∣</span></span></span></span></span> and we write this as <span><span><span>O(∣Y∣)O(|Y|)</span><span aria-hidden=\"true\"><span><span></span><span>O</span><span>(</span><span>∣</span><span>Y</span><span>∣</span><span>)</span></span></span></span></span>. The server has to homomorphically evaluate the polynomial <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> at each ciphertext. This implies a computational cost proportional to <span><span><span>∣Y∣×Homomorphic.Evaluation(P)|Y|\\times \\mathsf{Homomorphic.Evaluation}(P)</span><span aria-hidden=\"true\"><span><span></span><span>∣</span><span>Y</span><span>∣</span><span></span><span>×</span><span></span></span><span><span></span><span><span>H</span><span>o</span><span>m</span><span>o</span><span>m</span><span>o</span><span>r</span><span>p</span><span>h</span><span>i</span><span>c</span><span>.</span><span>E</span><span>v</span><span>a</span><span>l</span><span>u</span><span>a</span><span>t</span><span>i</span><span>o</span><span>n</span></span><span>(</span><span>P</span><span>)</span></span></span></span></span>. For simplicity let's assume that the computational cost of evaluating the polynomial <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> is proportional to its degree, which is just the size of the server set <span><span><span>∣X∣|X|</span><span aria-hidden=\"true\"><span><span></span><span>∣</span><span>X</span><span>∣</span></span></span></span></span>. So we can simply say that the computational cost of the server is <span><span><span>O(∣X∣⋅∣Y∣)O(|X|\\cdot |Y|)</span><span aria-hidden=\"true\"><span><span></span><span>O</span><span>(</span><span>∣</span><span>X</span><span>∣</span><span></span><span>⋅</span><span></span></span><span><span></span><span>∣</span><span>Y</span><span>∣</span><span>)</span></span></span></span></span>.</p>\n<h4>Batching</h4>\n<p>The <em>batching</em> technique in Homomorphic Encryption is usually used to enable <em>Single Instruction Multiple Data (SIMD)</em> operations on ciphertexts. Broadly speaking, this allows the client to 'batch' <span><span><span>NN</span><span aria-hidden=\"true\"><span><span></span><span>N</span></span></span></span></span> items from the set <span><span><span>YY</span><span aria-hidden=\"true\"><span><span></span><span>Y</span></span></span></span></span> into a single ciphertext and the server can simultaneously do computations on the encrypted items. For the <strong>PSI</strong> protocol, it means that batching can reduce the client to server communication as well as the computational cost of the server.\n<img src=\"https://i.imgur.com/Ece1O9c.png\" alt=\"\"></p>\n<p>In the above diagram you can see how batching works for multiplication. But it works similarly for addition or any homomorphic operation supported by the scheme.</p>\n<p><img src=\"https://i.imgur.com/E1VHdc4.png\" alt=\"\"></p>\n<p>Notice that running the basic protocol using a <strong>HE</strong> scheme that supports batching, the client is able to send fewer ciphertexts <span><span><span>∣Y∣/N|Y|/N</span><span aria-hidden=\"true\"><span><span></span><span>∣</span><span>Y</span><span>∣</span><span>/</span><span>N</span></span></span></span></span> and the computational cost of the server drops as well, proportionally to <span><span><span>∣X∣⋅∣Y∣/N|X|\\cdot |Y| /N</span><span aria-hidden=\"true\"><span><span></span><span>∣</span><span>X</span><span>∣</span><span></span><span>⋅</span><span></span></span><span><span></span><span>∣</span><span>Y</span><span>∣</span><span>/</span><span>N</span></span></span></span></span> because the server can homomorphically evaluate the polynomial <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> at all the <span><span><span>NN</span><span aria-hidden=\"true\"><span><span></span><span>N</span></span></span></span></span> inputs simultaneously.</p>\n<p>Conveniently, the <strong>HE</strong> scheme <a href=\"https://eprint.iacr.org/2012/144.pdf\">BFV</a> supports batching and the TenSEAL library makes it very easy to take advantage of it. In fact, when using TenSEAL, you don't need to know how batching actually works under the hood (it uses the <a href=\"https://en.wikipedia.org/wiki/Chinese_remainder_theorem\">CRT representation</a>), as the implementation does the batching by default (plaintexts are represented as vectors of integers and homomorphic operations act component-wise on the plaintexts).</p>\n<h4>Hashing</h4>\n<p>Remember that the <strong>HE</strong> scheme can't support too many multiplications. Concretely, the scheme correctly works only when the homomorphic computation  is expressed as a circuit (additions/multiplications gates) with <em>'small' multiplication depth</em>. To be more precise, in our case, the multiplicative depth corresponding to the parameters of the Brakerski-Fan-Vercauteren scheme implemented in TenSEAL is <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span> or <span><span><span>44</span><span aria-hidden=\"true\"><span><span></span><span>4</span></span></span></span></span>. So, for the rest of the blog post, we will assume that the <strong>HE scheme supports only computations of multiplicative depth <span><span><span>≤3\\leq 3</span><span aria-hidden=\"true\"><span><span></span><span>≤</span><span></span></span><span><span></span><span>3</span></span></span></span></span></strong>. You have below two examples for which decryption  works correctly.\n<img src=\"https://i.imgur.com/1eDqyRF.png\" alt=\"\"></p>\n<p>This is a major problem if we want to use the basic protocol because the server is limited to homomorphic evaluations of polynomials of degree at most <span><span><span>88</span><span aria-hidden=\"true\"><span><span></span><span>8</span></span></span></span></span>. So the set of the server can't be larger than <span><span><span>88</span><span aria-hidden=\"true\"><span><span></span><span>8</span></span></span></span></span>. This is not really satisfying as we would like the server to have millions of items 🤯. So how to increase the number of items on the server side? 🤔</p>\n<p>The first thing one can do is to partition the set of the server <span><span><span>X=X0∪X1∪…∪Xm−1X=X_{0} \\cup X_{1} \\cup \\ldots \\cup X_{m-1}</span><span aria-hidden=\"true\"><span><span></span><span>X</span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>∪</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>∪</span><span></span></span><span><span></span><span>…</span><span></span><span>∪</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>m</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and the set of the client <span><span><span>Y=Y0∪Y1∪…∪Ym−1Y=Y_0\\cup Y_1 \\cup \\ldots \\cup Y_{m-1}</span><span aria-hidden=\"true\"><span><span></span><span>Y</span><span></span><span>=</span><span></span></span><span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>∪</span><span></span></span><span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>∪</span><span></span></span><span><span></span><span>…</span><span></span><span>∪</span><span></span></span><span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span><span>m</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> into 'bins', using some agreed upon hash function <span><span><span>h:U→{0,1,2,…,m−1}h:\\mathcal{U} \\to \\{0,1,2,\\ldots,m-1\\}</span><span aria-hidden=\"true\"><span><span></span><span>h</span><span></span><span>:</span><span></span></span><span><span></span><span><span>U</span></span><span></span><span>→</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>,</span><span></span><span>2</span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span>m</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>}</span></span></span></span></span>, with both sets <span><span><span>X,YX,Y</span><span aria-hidden=\"true\"><span><span></span><span>X</span><span>,</span><span></span><span>Y</span></span></span></span></span> contained in <span><span><span>U\\mathcal{U}</span><span aria-hidden=\"true\"><span><span></span><span><span>U</span></span></span></span></span></span>. Items fall into the same 'bin' if they hash to the same value.\n<img src=\"https://i.imgur.com/AJO8FOu.png\" alt=\"\"></p>\n<p>Now we can run the basic protocol (Case <strong>c</strong>) <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span> times on the pairs of sets <span><span><span>(Xi,Yi)(X_i ,Y_i)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> to find the intersection of <span><span><span>XX</span><span aria-hidden=\"true\"><span><span></span><span>X</span></span></span></span></span> and <span><span><span>YY</span><span aria-hidden=\"true\"><span><span></span><span>Y</span></span></span></span></span>. Notice that this optimization can dramatically reduce the computational cost of the server from <span><span><span>∣X∣⋅∣Y∣|X|\\cdot |Y|</span><span aria-hidden=\"true\"><span><span></span><span>∣</span><span>X</span><span>∣</span><span></span><span>⋅</span><span></span></span><span><span></span><span>∣</span><span>Y</span><span>∣</span></span></span></span></span> down to <span><span><span>∑i=0m−1∣Xi∣⋅∣Yi∣\\displaystyle \\sum_{i=0}^{m-1} |X_i|\\cdot |Y_i|</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∑</span></span></span><span><span></span><span><span><span>m</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>∣</span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∣</span><span></span><span>⋅</span><span></span></span><span><span></span><span>∣</span><span><span>Y</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∣</span></span></span></span></span>. Moreover, this strategy also allows for a much larger server set (<span><span><span>∣X∣≫8|X| \\gg 8</span><span aria-hidden=\"true\"><span><span></span><span>∣</span><span>X</span><span>∣</span><span></span><span>≫</span><span></span></span><span><span></span><span>8</span></span></span></span></span>), because the server runs the basic protocol on the smaller sets <span><span><span>XiX_i</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. So it's enough to have <span><span><span>∣Xi∣≤8|X_i|\\leq 8</span><span aria-hidden=\"true\"><span><span></span><span>∣</span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∣</span><span></span><span>≤</span><span></span></span><span><span></span><span>8</span></span></span></span></span> for all bins to be able to intersect <span><span><span>X∩YX\\cap Y</span><span aria-hidden=\"true\"><span><span></span><span>X</span><span></span><span>∩</span><span></span></span><span><span></span><span>Y</span></span></span></span></span> in this way.</p>\n<p>For security reasons, the client must pad its bins with some dummy messages to hide the cardinality of each bin, before engaging in the interaction with the server. By doing the padding, all the client's bins have the same number of items, let's call this number <span><span><span>BYB_Y</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> (notice that <span><span><span>∣Y∣&#x3C;m⋅BY|Y| &#x3C; m\\cdot B_Y</span><span aria-hidden=\"true\"><span><span></span><span>∣</span><span>Y</span><span>∣</span><span></span><span>&#x3C;</span><span></span></span><span><span></span><span>m</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>). For example, for <span><span><span>X=Y={0,1,…,m−1}X=Y=\\{0,1,\\ldots,m-1\\}</span><span aria-hidden=\"true\"><span><span></span><span>X</span><span></span><span>=</span><span></span></span><span><span></span><span>Y</span><span></span><span>=</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span>m</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>}</span></span></span></span></span> and a uniformly random 'hash' function <span><span><span>h:{0,1,2,…,m−1}→{0,1,2,…,m−1}h:\\{0,1,2,\\ldots,m-1\\} \\to \\{0,1,2,\\ldots,m-1\\}</span><span aria-hidden=\"true\"><span><span></span><span>h</span><span></span><span>:</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>,</span><span></span><span>2</span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span>m</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>}</span><span></span><span>→</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>,</span><span></span><span>2</span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span>m</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>}</span></span></span></span></span>, we have <span><span><span>BY=O(log⁡m)B_Y=O(\\log m)</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>O</span><span>(</span><span>lo<span>g</span></span><span></span><span>m</span><span>)</span></span></span></span></span> with high probability (see the <a href=\"https://en.wikipedia.org/wiki/Balls_into_bins_problem\">Balls and Bins Problem</a>). In this setting, the computational cost of the server is now <span><span><span>O(mlog⁡m)O(m\\log m)</span><span aria-hidden=\"true\"><span><span></span><span>O</span><span>(</span><span>m</span><span></span><span>lo<span>g</span></span><span></span><span>m</span><span>)</span></span></span></span></span> and the client to server communication is <span><span><span>O(mlog⁡m)O(m\\log m)</span><span aria-hidden=\"true\"><span><span></span><span>O</span><span>(</span><span>m</span><span></span><span>lo<span>g</span></span><span></span><span>m</span><span>)</span></span></span></span></span>.</p>\n<p>❗ Using batching, both costs go down by a factor of <span><span><span>NN</span><span aria-hidden=\"true\"><span><span></span><span>N</span></span></span></span></span>. To keep the exposition simple we ignore that for now. But keep in mind that we can always use it to get better performance.</p>\n<p>To get a feel for why the padding is necessary, suppose that the bin <span><span><span>Y3Y_3</span><span aria-hidden=\"true\"><span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> is empty and the client doesn't pad it. This means that nothing is sent corresponding to this bin and the server will be able to learn that the client doesn't hold any elements that hash to <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>. This is valuable information that the server should not be able to learn from the execution of the protocol😟.</p>\n<p>In general, if we do the padding on the client side, the actual computational cost of the server is proportional to <span><span><span>∑i=0m−1∣Xi∣⋅BY\\sum_{i=0}^{m-1} |X_i|\\cdot B_Y</span><span aria-hidden=\"true\"><span><span></span><span><span>∑</span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span><span>m</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>∣</span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∣</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and the communication cost is actually proportional to <span><span><span>∑i=0m−1BY=m⋅BY\\sum_{i=0}^{m-1} B_Y= m\\cdot B_Y</span><span aria-hidden=\"true\"><span><span></span><span><span>∑</span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span><span>m</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>m</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>To minimize the costs, we would like some kind of hash function (table) with a range <span><span><span>{0,1,…,m−1}\\{0,1,\\ldots,m-1\\}</span><span aria-hidden=\"true\"><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span>m</span><span></span><span>−</span><span></span></span><span><span></span><span>1</span><span>}</span></span></span></span></span> as small as possible but sufficiently large to map the set of the client with few collisions as possible. A good candidate is the so-called <a href=\"https://en.wikipedia.org/wiki/Cuckoo_hashing#cite_note-Cuckoo-1\">Cuckoo Hash table</a> 🐦, which works for <span><span><span>∣Y∣≈23⋅m|Y|\\approx \\frac{2}{3} \\cdot m</span><span aria-hidden=\"true\"><span><span></span><span>∣</span><span>Y</span><span>∣</span><span></span><span>≈</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>3</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>2</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>m</span></span></span></span></span> and guarantees that there are no collisions (i.e. <span><span><span>BY=1B_Y=1</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>1</span></span></span></span></span>) when hashing the client set <span><span><span>YY</span><span aria-hidden=\"true\"><span><span></span><span>Y</span></span></span></span></span>. For <span><span><span>∣X∣=m|X|=m</span><span aria-hidden=\"true\"><span><span></span><span>∣</span><span>X</span><span>∣</span><span></span><span>=</span><span></span></span><span><span></span><span>m</span></span></span></span></span> and <span><span><span>∣Y∣=2/3⋅m|Y|=2/3\\cdot m</span><span aria-hidden=\"true\"><span><span></span><span>∣</span><span>Y</span><span>∣</span><span></span><span>=</span><span></span></span><span><span></span><span>2</span><span>/</span><span>3</span><span></span><span>⋅</span><span></span></span><span><span></span><span>m</span></span></span></span></span>, using Cuckoo hash tables, the computational cost and communication drop to <span><span><span>O(m)O(m)</span><span aria-hidden=\"true\"><span><span></span><span>O</span><span>(</span><span>m</span><span>)</span></span></span></span></span>, compared to the similar parameters of the previous example.</p>\n<p>In the actual protocol only the client uses Cuckoo hash tables. The server has to compute simple hash values that are compatible with the Cuckoo hash table structure.</p>\n<h4>Windowing</h4>\n<p>Let's suppose that the set <span><span><span>XX</span><span aria-hidden=\"true\"><span><span></span><span>X</span></span></span></span></span> of the server is partitioned into many bins <span><span><span>X=X0∪X1∪…∪Xm−1X=X_{0} \\cup X_{1} \\cup \\ldots \\cup X_{m-1}</span><span aria-hidden=\"true\"><span><span></span><span>X</span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>∪</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>∪</span><span></span></span><span><span></span><span>…</span><span></span><span>∪</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>m</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. We denote the maximum bin capacity (load) by <span><span><span>BX=max⁡0≤i&#x3C;m∣Xi∣B_X=\\displaystyle \\max_{0\\leq i &#x3C;m} |X_i|</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>0</span><span>≤</span><span>i</span><span>&#x3C;</span><span>m</span></span></span></span><span><span></span><span><span>max</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>∣</span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∣</span></span></span></span></span>. We can currently run the protocol only when the parameters are chosen such that the maximum bin capacity is less than <span><span><span>88</span><span aria-hidden=\"true\"><span><span></span><span>8</span></span></span></span></span>. But the bound <span><span><span>88</span><span aria-hidden=\"true\"><span><span></span><span>8</span></span></span></span></span> can actually be <strong>increased</strong> for the <strong>same multiplicative depth</strong> 💥! This can be done by increasing the communication cost from the client to the server by the logarithmic factor <span><span><span>log⁡BX\\log B_X</span><span aria-hidden=\"true\"><span><span></span><span>lo<span>g</span></span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>💡The idea is the following. The server needs to homomorphically evaluate the polynomials corresponding to each bin <span><span><span>XiX_i</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. This means that the server must be able to do homomorphic evaluations of polynomials of degree <span><span><span>BXB_X</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. Let's denote by <span><span><span>n=⌊log⁡BX⌋n=\\lfloor \\log B_X \\rfloor</span><span aria-hidden=\"true\"><span><span></span><span>n</span><span></span><span>=</span><span></span></span><span><span></span><span>⌊</span><span>lo<span>g</span></span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>⌋</span></span></span></span></span>. To intersect with one item <span><span><span>Y={y}Y = \\{y\\}</span><span aria-hidden=\"true\"><span><span></span><span>Y</span><span></span><span>=</span><span></span></span><span><span></span><span>{</span><span>y</span><span>}</span></span></span></span></span>, the client encrypts the powers <span><span><span>{y,y2,y22,y23,…,y2n}\\{y,y^2,y^{2^2},y^{2^3},\\ldots, y^{2^{n}}\\}</span><span aria-hidden=\"true\"><span><span></span><span>{</span><span>y</span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>}</span></span></span></span></span> and sends them to the server.\n<img src=\"https://i.imgur.com/KiIToNb.png\" alt=\"\"></p>\n<p>Now, for any power <span><span><span>k≤BXk\\leq B_X</span><span aria-hidden=\"true\"><span><span></span><span>k</span><span></span><span>≤</span><span></span></span><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> the server uses the binary representation of <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span>: <span><span><span>k=k0+k1⋅21+k2⋅22+⋯+kn⋅2nk=k_0+k_1\\cdot 2^{1} + k_2\\cdot 2^{2} + \\cdots + k_n\\cdot 2^n</span><span aria-hidden=\"true\"><span><span></span><span>k</span><span></span><span>=</span><span></span></span><span><span></span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>1</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>k</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>2</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>⋯</span><span></span><span>+</span><span></span></span><span><span></span><span><span>k</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span>, with <span><span><span>ki∈{0,1}k_i \\in \\{0,1\\}</span><span aria-hidden=\"true\"><span><span></span><span><span>k</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>∈</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>}</span></span></span></span></span>, to compute the encryption of <span><span><span>yky^k</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span></span></span></span></span></span></span></span></span> as <span><span><span>yk=yk0⋅(y21)k1⋅(y22)k2⋅(y23)k3⋅…⋅(y2n)kny^k=y^{k_0} \\cdot \\left( y^{2^1} \\right)^{k_1}\\cdot \\left( y^{2^2}\\right)^{k_2} \\cdot \\left(y^{2^3} \\right)^{k_3}\\cdot\\ldots \\cdot \\left(y^{2^n}\\right)^{k_n}</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span><span><span>(</span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span><span><span>(</span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span><span><span>k</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span><span><span>(</span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span><span><span>k</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>…</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span><span><span>(</span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span><span><span>k</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>\nThis computation can be done in multiplicative depth equal to <span><span><span>⌈log⁡(n+1)⌉\\lceil\\log (n+1)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>⌈</span><span>lo<span>g</span></span><span>(</span><span>n</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>⌉</span></span></span></span></span>. By keeping the multiplicative depth the same as before, equal to <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>, we can afford <span><span><span>n≤7n\\leq 7</span><span aria-hidden=\"true\"><span><span></span><span>n</span><span></span><span>≤</span><span></span></span><span><span></span><span>7</span></span></span></span></span>, which gives <span><span><span>BX≤255B_X\\leq 255</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>≤</span><span></span></span><span><span></span><span>2</span><span>5</span><span>5</span></span></span></span></span> . This means we can run the basic protocol on each bin as long as the maximum load <span><span><span>BXB_X</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> satisfies this bound.</p>\n<p>❗ Windowing <strong>is compatible</strong> with Batching. Do you see why? Suppose that at some point during the protocol, the client encrypts the batch <span><span><span>y\\bf{y}</span><span aria-hidden=\"true\"><span><span></span><span><span><span>y</span></span></span></span></span></span></span>=<span><span><span>(y0,y1,…,yN−1)(y_0,y_1,\\ldots,y_{N-1})</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>N</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> and sends it to the server. To also make use of the windowing technique, the client first computes all the powers <span><span><span>{yi,yi2,yi4,…,yi2n}\\{y_i,y_i^2,y_i^4,\\ldots, y_i^{2^n}\\}</span><span aria-hidden=\"true\"><span><span></span><span>{</span><span><span>y</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>i</span></span></span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>i</span></span></span><span><span></span><span><span>4</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>i</span></span></span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>}</span></span></span></span></span> needed for windowing and applies batching as below. Then the client sends all the ciphertexts to the server, as in the picture below.</p>\n<p><img src=\"https://i.imgur.com/DXpM0PU.png\" alt=\"\"></p>\n<p>Notice that the server is able to compute the encryption of <span><span><span>yk\\bf{y}^k</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span>y</span></span><span><span><span><span><span><span></span><span><span>k</span></span></span></span></span></span></span></span></span></span></span></span></span>, for any <span><span><span>k≤BXk \\leq B_X</span><span aria-hidden=\"true\"><span><span></span><span>k</span><span></span><span>≤</span><span></span></span><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, by using the binary representation of <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span> and the ciphertexts sent by the client. In fact, the server can homomorphically evaluate its polynomial <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> at <span><span><span>y\\bf{y}</span><span aria-hidden=\"true\"><span><span></span><span><span><span>y</span></span></span></span></span></span></span> and send back the answer to the client. Now the client can decrypt to recover <span><span><span>P(y)P(\\bf{y})</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span><span><span>y</span></span><span>)</span></span></span></span></span></span>, then applies <span><span><span>Batch_decode\\texttt{Batch\\_decode}</span><span aria-hidden=\"true\"><span><span></span><span><span>Batch_decode</span></span></span></span></span></span> to recover <span><span><span>(P(y0),P(y1),…,P(yN−1))(P(y_0),P(y_1),\\ldots, P(y_{N-1}))</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>P</span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>P</span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span>P</span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>N</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>)</span></span></span></span></span>.</p>\n<p>🌻 In TenSEAL, <span><span><span>Batch_encode\\texttt{Batch\\_encode}</span><span aria-hidden=\"true\"><span><span></span><span><span>Batch_encode</span></span></span></span></span></span> and <span><span><span>Batch_decode\\texttt{Batch\\_decode}</span><span aria-hidden=\"true\"><span><span></span><span><span>Batch_decode</span></span></span></span></span></span> are done automatically, so we don't need to worry about them. You can simply think that when you evaluate the polynomial <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> at a ciphertext that encrypts <span><span><span>(y0,y1,…,yN)(y_0,y_1,\\ldots,y_N)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>, the evaluation is done component-wise, obtaining <span><span><span>(P(y0),P(y1),…,P(yN−1))(P(y_0), P(y_1),\\ldots, P(y_{N-1}))</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>P</span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>P</span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span>P</span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>N</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>)</span></span></span></span></span>.</p>\n<h4>Partitioning</h4>\n<p>We have seen how to increase the size of the server's set <span><span><span>∣X∣|X|</span><span aria-hidden=\"true\"><span><span></span><span>∣</span><span>X</span><span>∣</span></span></span></span></span> by using Hashing techniques and Windowing. We can increase it even further, but this time we increase it by paying an extra cost 💰 for the server to client communication.</p>\n<p>To this end, let <span><span><span>α\\alpha</span><span aria-hidden=\"true\"><span><span></span><span>α</span></span></span></span></span> be a positive integer, the partitioning parameter. The idea is to further partition each bin <span><span><span>XiX_i</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> into <span><span><span>α\\alpha</span><span aria-hidden=\"true\"><span><span></span><span>α</span></span></span></span></span> mini bins, each of size less than <span><span><span>BX/αB_X/\\alpha</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>/</span><span>α</span></span></span></span></span>. We get a total number of <span><span><span>m⋅αm\\cdot \\alpha</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span></span><span>⋅</span><span></span></span><span><span></span><span>α</span></span></span></span></span> mini bins (<span><span><span>α\\alpha</span><span aria-hidden=\"true\"><span><span></span><span>α</span></span></span></span></span> mini bins for each of the <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span> bins). Then, for each mini bin, the corresponding polynomial is computed. Therefore to answer the client's query, the server has to homomorphically evaluate <span><span><span>m⋅αm\\cdot \\alpha</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span></span><span>⋅</span><span></span></span><span><span></span><span>α</span></span></span></span></span> polynomials. Notice that the degrees of all these polynomials are less than <span><span><span>BX/αB_X/\\alpha</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>/</span><span>α</span></span></span></span></span>. Now the server runs the basic protocol (+ windowing) for these mini bins. Notice that as long as <span><span><span>BX/α≤255B_X /\\alpha \\leq 255</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>/</span><span>α</span><span></span><span>≤</span><span></span></span><span><span></span><span>2</span><span>5</span><span>5</span></span></span></span></span> the protocol works. The effects of this change are:</p>\n<p>✔️ With partitioning the protocol supports even larger server sets. The reason is that the bins <span><span><span>XiX_i</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> can now handle up to <span><span><span>α⋅255\\alpha \\cdot 255</span><span aria-hidden=\"true\"><span><span></span><span>α</span><span></span><span>⋅</span><span></span></span><span><span></span><span>2</span><span>5</span><span>5</span></span></span></span></span> items. Since the bins are much larger, the server set can now be much larger!</p>\n<p>❌ The downside of using partitioning is that the server to client communication is increased by a factor of <span><span><span>α\\alpha</span><span aria-hidden=\"true\"><span><span></span><span>α</span></span></span></span></span>, because for each mini bin the server has to send back a corresponding answer to the client.</p>\n<h3>Security 🔐</h3>\n<p>The security of the protocol prevents a potentially malicious server (one that is able to deviate from the honest protocol) from learning any information about the set of the client. Vice versa, the server's privacy is also protected against a possibly malicious client.</p>\n<p>Intuitively, the set of the client is encrypted when it is sent to the server, so a potentially malicious server is not able to learn anything from the ciphertexts, regardless of what the server does with these encryptions.</p>\n<p>When it comes to the privacy of the server, first recall that the server homomorphically evaluates a polynomial (closely related to its set) at the ciphertexts sent by the client.\nA malicious client who also has access to the randomness used for encryption and to the secret decryption key may use the result of this computation to infer information about the computation done by the server, in particular about the server's set. This is possible because the <a href=\"https://eprint.iacr.org/2012/144.pdf\">BFV</a> homomorphic encryption scheme does not have <em>circuit privacy</em>, which means that the scheme itself does not hide the computation that has been carried out on a ciphertext. The privacy of the server is guaranteed by the use of <em>Oblivious Pseudorandom Functions (OPRFs)</em>.</p>\n<h4>Oblivious PRFs</h4>\n<p>Let's consider a <a href=\"https://en.wikipedia.org/wiki/Pseudorandom_function_family\">Pseudorandom Function (PRF)</a> <span><span><span>FF</span><span aria-hidden=\"true\"><span><span></span><span>F</span></span></span></span></span>, that takes as input a secret key <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span> and some input and efficiently computes some output. As long as the key remains secret, the values that the <strong>PRF</strong> outputs 'look' completely 'random'. For intuition, you can think of the <a href=\"https://en.wikipedia.org/wiki/Advanced_Encryption_Standard\">AES</a> function.</p>\n<p>Assume that only the server knows the secret key <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span>. The server precomputes the set <span><span><span>X′:={Fk(x) : for all x∈X}X':=\\{ F_k(x) \\text{ : for all } x \\in X\\}</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>:</span></span><span><span></span><span>=</span><span></span></span><span><span></span><span>{</span><span><span>F</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>x</span><span>)</span><span><span> : for all </span></span><span>x</span><span></span><span>∈</span><span></span></span><span><span></span><span>X</span><span>}</span></span></span></span></span>. Now, assume that through some magic 🔮(i.e. <strong>without having access to any information about the secret key</strong> <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span>), the client can compute <span><span><span>Fk(y)F_k(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>F</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> for all <span><span><span>y∈Yy \\in Y</span><span aria-hidden=\"true\"><span><span></span><span>y</span><span></span><span>∈</span><span></span></span><span><span></span><span>Y</span></span></span></span></span>  and further create the set <span><span><span>Y′={Fk(y) : for all y∈Y}Y'=\\{F_k(y)\\text{ : for all } y \\in Y \\}</span><span aria-hidden=\"true\"><span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>{</span><span><span>F</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>y</span><span>)</span><span><span> : for all </span></span><span>y</span><span></span><span>∈</span><span></span></span><span><span></span><span>Y</span><span>}</span></span></span></span></span>. Now the two can engage in the <strong>PSI</strong> protocol for the sets <span><span><span>X′X'</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> and <span><span><span>Y′Y'</span><span aria-hidden=\"true\"><span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> to find their intersection, from which the client can deduce <span><span><span>X∩YX\\cap Y</span><span aria-hidden=\"true\"><span><span></span><span>X</span><span></span><span>∩</span><span></span></span><span><span></span><span>Y</span></span></span></span></span>.</p>\n<p>❗ One important thing is that in the eyes 👀 of the client the set <span><span><span>X′X'</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>′</span></span></span></span></span></span></span></span></span></span></span></span></span> does not leak any information about the server set <span><span><span>XX</span><span aria-hidden=\"true\"><span><span></span><span>X</span></span></span></span></span>, as the secret key is unknown to the client. Therefore the privacy of the server is protected against a potentially malicious client!</p>\n<p><img src=\"https://i.imgur.com/P10n43A.png\" alt=\"\"></p>\n<p><strong>Oblivious PRF</strong> is an interactive protocol that replaces the above 'magic' 🔮. Namely, it allows the client to learn the <strong>PRF</strong> values <span><span><span>Fk(y)F_k(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>F</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> (for some particular <strong>PRF</strong>), without having access to the secret key. In our implementation we use a Diffie-Hellman like <strong>OPRF</strong> protocol that is implemented using elliptic curve point additions.</p>\n<h3>The protocol</h3>\n<p>🔍 Let's take a closer look at the <strong>PSI</strong> protocol. The server holds a list of <code>server_size</code> items, while the client holds a list of <code>client_size</code> items.</p>\n<p>Let us give you a bird's eye view on the protocol with all the steps:</p>\n<p><img src=\"https://i.imgur.com/OCnd34n.png\" alt=\"\"></p>\n<p>In the offline phase, both the server and the client preprocess their datasets. This offline preprocessing needs to be done only once by each party. The server preprocesses its set of items and then can engage in the online phase of the protocol many times with possible many clients. The vice-versa is also possible.</p>\n<ol>\n<li><strong>Oblivious Pseudorandom Function</strong> (<strong>OPRF</strong>): First, they apply an <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/oprf.py\">OPRF</a> layer to their inputs. For this, the two parties engage in a Diffie-Hellman-like interactive protocol on elliptic curves. The client and the server end up having their entries encoded in a <em>special way</em>, using the secret key of the server, <code>oprf_server_key</code>.  Basically, using a generator <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> of an elliptic curve, an entry (which is an integer) <code>item</code> is first encoded as the point <code>item</code><span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> on the elliptic curve. Then, it is further multiplied <em>interactively</em> by the secret integer <code>oprf_server_key</code>. Then, they both take <code>sigma_max</code> bits out of the first coordinate of each such point.</li>\n</ol>\n<p>After this step, both the server and the client have new datasets, <code>PRFed_server_set</code> and <code>PRFed_client_set</code>, each of <code>sigma_max</code>-bit integers. Check our code for this <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/client_online.py#L51\">here</a> and <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/server_offline.py#L22\">here</a>.</p>\n<p>The OPRF protocol is as follows:</p>\n<ul>\n<li>The server gets his <code>PRFed_server_set</code> by doing for each of his items the following:</li>\n</ul>\n<p><code>server_item</code> <span><span><span>→\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>→</span></span></span></span></span> <code>server_item</code><span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>→\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>→</span></span></span></span></span> <code>oprf_server_key</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>server_item</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span>  <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>→\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>→</span></span></span></span></span> <code>sigma_max</code> bits out of the first coordinate.</p>\n<ul>\n<li>The client creates a set to send to the server by doing for each of his items the following:</li>\n</ul>\n<p><code>client_item</code> <span><span><span>→\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>→</span></span></span></span></span> <code>client_item</code><span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>→\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>→</span></span></span></span></span> <code>oprf_client_key</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>client_item</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span>.</p>\n<ul>\n<li>The server obtains the client's points, multiplies them by <code>oprf_server_key</code> and sends them back to the client.</li>\n</ul>\n<p><code>oprf_client_key</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>client_item</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>→\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>→</span></span></span></span></span> <code>oprf_server_key</code><span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>oprf_client_key</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>client_item</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span>.</p>\n<ul>\n<li>The client gets his <code>PRFed_client_set</code> by doing:</li>\n</ul>\n<p><code>oprf_server_key</code><span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>oprf_client_key</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>client_item</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>→\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>→</span></span></span></span></span> <code>oprf_client_key</code><span><span><span>−1^{-1}</span><span aria-hidden=\"true\"><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>−</span><span>1</span></span></span></span></span></span></span></span></span></span></span></span></span> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span><code>oprf_server_key</code><span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>oprf_client_key</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>client_item</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>→\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>→</span></span></span></span></span> <code>oprf_server_key</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>client_item</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>→\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>→</span></span></span></span></span> <code>sigma_max</code> bits out of the first coordinate</p>\n<ol start=\"2\">\n<li><strong>Hashing</strong>: The server and the client both agree on using a total number of <code>number_of_hashes</code> hash functions with <code>output_bits</code> bits of output.</li>\n</ol>\n<ul>\n<li>The client performs <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/cuckoo_hash.py\"><em>Cuckoo hashing</em></a>. You can check the implementation <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/client_online.py#L56\">here</a>. By the end of this step, each of his bins has at most <span><span><span>11</span><span aria-hidden=\"true\"><span><span></span><span>1</span></span></span></span></span> element. For security reasons, empty bins are padded with one dummy message. You may think of his database as a column vector with <code>number_of_bins</code> rows.</li>\n<li>The server performs <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/simple_hash.py\"><em>Simple hashing</em></a>; each of his bins has <code>bin_capacity</code> elements. Think of its database as a matrix with <code>number_of_bins</code> rows and <code>bin_capacity</code> columns. Roughly speaking, for each element and each hash function, the server inserts the element in a bin corresponding to its hash value. You can check its implementation <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/server_offline.py#L33\">here</a>.</li>\n</ul>\n<p>Recall that after the <strong>OPRF</strong> step, the database entries of both the client and the server have <code>sigma_max</code> bits. In order to reduce the storage of the items in the hash tables, both the client and the server perform a <em>permutation-based hashing</em> step. In this way, they reduce the length of the items to <code>sigma_max</code> - <code>output_bits</code> + <span><span><span>⌊log(\\lfloor \\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span><code>number_of_hashes</code><span><span><span>)⌋+1)\\rfloor+1</span><span aria-hidden=\"true\"><span><span></span><span>)</span><span>⌋</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> bits, by encoding a part of the item in the index of the bin where the item belongs.</p>\n<p>❗  The bins correspond to all the possible values that the hash functions can take. This means that <code>number_of_bins</code> = 2 ** <code>output_bits</code>.</p>\n<p>We describe here shortly the steps for their insertion:</p>\n<ul>\n<li>We write <code>item</code> as <code>item_left||item_right</code>, where <code>item_right</code> has <code>output_bits</code> bits and <code>item_left</code> has <code>sigma_max</code> - <code>output_bits</code> bits.</li>\n<li>For a specific index <span><span><span>ii</span><span aria-hidden=\"true\"><span><span></span><span>i</span></span></span></span></span> less than <code>number_of_hashes</code>, we compute the so-called <em>location function</em> <span><span><span>Loc\\mathsf{Loc}</span><span aria-hidden=\"true\"><span><span></span><span><span>L</span><span>o</span><span>c</span></span></span></span></span></span>(<span><span><span>i,i,</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span>,</span></span></span></span></span> <code>item</code>):</li>\n</ul>\n<p><code>item</code> <span><span><span>→\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>→</span></span></span></span></span> <code>item_left||item_right</code> <span><span><span>→\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>→</span></span></span></span></span> <span><span><span>Loc\\mathsf{Loc}</span><span aria-hidden=\"true\"><span><span></span><span><span>L</span><span>o</span><span>c</span></span></span></span></span></span>(<span><span><span>i,i,</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span>,</span></span></span></span></span> <code>item</code>) = <span><span><span>HiH_i</span><span aria-hidden=\"true\"><span><span></span><span><span>H</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>(<code>item_left</code>) <span><span><span>⊕\\oplus</span><span aria-hidden=\"true\"><span><span></span><span>⊕</span></span></span></span></span> <code>item_right</code>.</p>\n<ul>\n<li>We insert <code>item</code> in a bin corresponding to its location as <code>item_left||i</code>, which has <code>sigma_max</code> - <code>output_bits</code> + <span><span><span>⌊log\\lfloor \\mathsf{log}</span><span aria-hidden=\"true\"><span><span></span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span></span></span></span></span>(<code>number_of_hashes</code>)<span><span><span>⌋\\rfloor</span><span aria-hidden=\"true\"><span><span></span><span>⌋</span></span></span></span></span> + 1 bits.</li>\n</ul>\n<p>Notice that given <code>item_left||i</code> and the location, <span><span><span>Loc\\mathsf{Loc}</span><span aria-hidden=\"true\"><span><span></span><span><span>L</span><span>o</span><span>c</span></span></span></span></span></span>(<span><span><span>i,i,</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span>,</span></span></span></span></span> <code>item</code>), you can recover the initial <code>item,</code>, by computing <code>item_right</code> = <span><span><span>Loc\\mathsf{Loc}</span><span aria-hidden=\"true\"><span><span></span><span><span>L</span><span>o</span><span>c</span></span></span></span></span></span>(<span><span><span>i,i,</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span>,</span></span></span></span></span> <code>item</code>) <span><span><span>⊕\\oplus</span><span aria-hidden=\"true\"><span><span></span><span>⊕</span></span></span></span></span> <span><span><span>HiH_i</span><span aria-hidden=\"true\"><span><span></span><span><span>H</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>(<code>item_left</code>).</p>\n<p><strong>Why does it work?</strong> Let's say that the server has stored <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span> as <span><span><span>(xL∣∣i)(x_L || i)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>L</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∣</span><span>∣</span><span>i</span><span>)</span></span></span></span></span> in a bin, whereas the client has stored <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> as <span><span><span>(yL∣∣j)(y_L || j)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>L</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∣</span><span>∣</span><span>j</span><span>)</span></span></span></span></span> in the same bin. Then, <span><span><span>(xL∣∣i)=(yL∣∣j)(x_L || i) = (y_L || j)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>L</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∣</span><span>∣</span><span>i</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>L</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>∣</span><span>∣</span><span>j</span><span>)</span></span></span></span></span> leads to <span><span><span>xL=yLx_L = y_L</span><span aria-hidden=\"true\"><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>L</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>L</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and <span><span><span>i=ji = j</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span></span><span>=</span><span></span></span><span><span></span><span>j</span></span></span></span></span> and hence, <span><span><span>x=yx = y</span><span aria-hidden=\"true\"><span><span></span><span>x</span><span></span><span>=</span><span></span></span><span><span></span><span>y</span></span></span></span></span>.</p>\n<p>❗ One solution to avoid hashing failures in <em>Cuckoo hashing</em> is to use at least <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span> hash functions for inserting items into the Cuckoo table. While increasing the number of hashses above <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span> may reduce the hashing failures, this will significantly increase the simple hashing cost of the server. Hence, a good choice seems to be <code>number_of_hashes</code> = <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>.</p>\n<p>❗ For <code>number_of_hashes</code> = <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>, we can insert the client's items into the <em>Cuckoo hash table</em> with a failure probability of <span><span><span>2−402^{-40}</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span>4</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>, in a total number of bins equal to <code>number_of_bins</code>= <span><span><span>3/2⋅3/2 \\cdot</span><span aria-hidden=\"true\"><span><span></span><span>3</span><span>/</span><span>2</span><span>⋅</span></span></span></span></span> <code>client_size</code>  . For more details, check <strong>Hashing failures</strong> <a href=\"https://eprint.iacr.org/2017/299.pdf\">here</a>.</p>\n<p>❗ For <code>number_of_hashes</code> = <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>, we should choose <code>bin_capacity</code> carefully so that inserting <code>number_of_hashes</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>server_size</code> items via <em>simple hashing</em> succeeds with a failure probability of <span><span><span>2−302^{-30}</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span>3</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>. For example, for <code>server_size</code> = <span><span><span>220,2^{20},</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span></span></span></span></span><span>,</span></span></span></span></span> we must pick <code>bin_capacity</code> = <span><span><span>536536</span><span aria-hidden=\"true\"><span><span></span><span>5</span><span>3</span><span>6</span></span></span></span></span>. To see how to choose the <code>bin_capacity</code> parameter as a function of the security parameter, the output size of the hash functions and the server's maximum set size , check <a href=\"https://eprint.iacr.org/2017/299.pdf\">Table 1</a> or you can also run the <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/bin_capacity_estimator.py\">bin_capacity_estimator.py </a> script to obtain more values.</p>\n<p><strong>Example</strong>: Let's take <code>bin_capacity</code> = <span><span><span>66</span><span aria-hidden=\"true\"><span><span></span><span>6</span></span></span></span></span>. Throughout this blog post, we will show the bins as rows: the server's bins contain items represented as red balls, whereas the client's bins contain items represented as green balls.🎨</p>\n<p><img src=\"https://i.imgur.com/NamEMEX.png\" alt=\"\"></p>\n<p>💡 A <em>padding step</em> with dummy messages might be required to get <em>all the bins of the server full.</em> Server padding is important for <em>batching</em>, as you will see soon.</p>\n<p>Hence, the server can run the <strong>PSI</strong> protocol <strong>on each bin.</strong> As discussed above, the server can associate to each bin a polynomial and evaluate it at an encrypted query. The degree of the polynomial is in this case <code>bin_capacity</code>, the number of elements in each of the server's bins. But this degree can be pretty big and the encryption scheme that we use may not allow us to correctly compute the polynomial evaluation. So we <em>partition</em> the bins into mini bins and associate to each mini bin a polynomial of a lower degree.</p>\n<ol start=\"3\">\n<li><strong>Partitioning</strong>: The server partitions each bin into <code>alpha</code> mini bins, having <code>bin_capacity</code>/<code>alpha</code> elements.</li>\n</ol>\n<p>❗ There will be <code>number_of_bins</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>alpha</code> mini bins.</p>\n<p>Hence, performing the <strong>PSI</strong> protocol for each bin reduces to <strong>performing</strong> <code>alpha</code> <strong>PSI</strong> protocols for each mini bin.</p>\n<p><strong>Example</strong>: Let's assume that each bin is partitioned into <code>alpha</code> = <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span> mini bins. In this case, each mini bin has <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> elements, as it is shown in the picture.</p>\n<p><img src=\"https://i.imgur.com/7EGZcog.png\" alt=\"\"></p>\n<ol start=\"4\">\n<li><strong>Finding the polynomials</strong>: For each mini bin, the server computes the coefficients of the monic polynomial that vanishes at the elements of that mini bin, see <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/auxiliary_functions.py#L76\">this</a>. This means that each mini bin can now be described by <code>bin_capacity</code>/<code>alpha</code> +1 coefficients. By convention, the coefficients are written in decreasing order, namely the first column in the mini bin corresponds to the leading coefficient of the polynomial, the second column to the next coefficient and so on. You can see how both finding the polynomials and partitioning are implemented on the server side <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/server_offline.py#L51\">here</a>.</li>\n</ol>\n<p>The coefficients of the polynomials are computed modulo <code>plain_modulus</code>, a parameter involved in the homomorphic encryption scheme. More on this parameter will follow soon.</p>\n<p><strong>Example</strong>: In our case, each mini bin has <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> elements, which means that it can be represented by  the coefficients of a monic polynomial <span><span><span>P(X)=X2+a1X+a0P(X) = X^2 + a_1X + a_0</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span>X</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>X</span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> of degree <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span>, i.e. by <span><span><span>[1,a1,a0][1, a_1, a_0]</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>1</span><span>,</span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>]</span></span></span></span></span>.</p>\n<p><img src=\"https://i.imgur.com/0etGFYY.png\" alt=\"\"></p>\n<p>At this step, both the server and the client perform the actual <strong>PSI</strong> protocol, as in Case <strong>b</strong>, but with the optimizations described above.</p>\n<p>So far, we said that the <strong>PSI</strong> protocol can be performed per each bin of client, against a corresponding mini bin of server. But we can do better 💪.</p>\n<ol start=\"5\">\n<li><strong>Batching</strong>: The <strong>HE</strong> scheme that we use benefits from a special property, called <em>batching</em>, that helps the client to pack his bins and to perform <strong>many queries simultaneously</strong>.</li>\n</ol>\n<p>Recall that the scheme <a href=\"https://eprint.iacr.org/2012/144\">BFV</a> allows encrypting polynomials of degree less than <code>poly_modulus_degree</code> modulo <code>plain_modulus</code>. The <code>plain_modulus</code> is chosen so that it is a prime congruent with 1 modulo 2 <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>poly_modulus_degree</code>, which helps identifying each such polynomial with a vector of <code>poly_modulus_degree</code> integer entries modulo <code>plain_modulus</code>. <em>This is what batching is about.</em>  <a href=\"https://github.com/OpenMined/TenSEAL/blob/master/tutorials%2FTutorial%200%20-%20Getting%20Started.ipynb\">TenSEAL</a> allows encryption of <strong>vectors of integers</strong>, by first performing the above correspondence and then performing the actual encryption. Also, in a similar way, decrypting in TenSEAL works for <strong>vectors of integers</strong>.</p>\n<p>The plaintext space is the ring of integer polynomials <span><span><span>Zt[X](XN+1),\\frac{\\mathbb{Z_t}[X]}{(X^N+1)},</span><span aria-hidden=\"true\"><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>(</span><span><span>X</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span></span></span></span></span><span>+</span><span>1</span><span>)</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span><span><span>Z</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span>[</span><span>X</span><span>]</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span>,</span></span></span></span></span> where <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span> = <code>plain_modulus</code> and <span><span><span>NN</span><span aria-hidden=\"true\"><span><span></span><span>N</span></span></span></span></span> = <code>poly_modulus_degree</code>.</p>\n<p>💡Since <span><span><span>t≡1t \\equiv 1</span><span aria-hidden=\"true\"><span><span></span><span>t</span><span></span><span>≡</span><span></span></span><span><span></span><span>1</span></span></span></span></span> mod <span><span><span>2⋅N2\\cdot N</span><span aria-hidden=\"true\"><span><span></span><span>2</span><span></span><span>⋅</span><span></span></span><span><span></span><span>N</span></span></span></span></span>, the polynomial <span><span><span>XN+1X^N+1</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> factorizes as a product of <em>linear polynomials</em> modulo <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span>, i.e.</p>\n<div><span><span><span>XN+1=(X−u1)⋅(X−u2)⋅…⋅(X−uN) mod t.X^N+1 = (X-u_1) \\cdot (X-u_2)\\cdot \\ldots \\cdot (X-u_N) \\text{ mod } t.</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>−</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>−</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>…</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>−</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span><span> mod </span></span><span>t</span><span>.</span></span></span></span></span></div>\n<p>Therefore, there is a ring <em>isomorphism</em>, given by the <a href=\"https://en.wikipedia.org/wiki/Chinese_remainder_theorem\">Chinese Remainder Theorem (CRT)</a>:</p>\n<div><span><span><span>Zt[X](XN+1)→ZtN,\\frac{\\mathbb{Z}_t[X]}{(X^N+1)} \\rightarrow \\mathbb{Z}_t^{N},</span><span aria-hidden=\"true\"><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>(</span><span><span>X</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>1</span><span>)</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span><span>Z</span></span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>X</span><span>]</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>→</span><span></span></span><span><span></span><span><span><span>Z</span></span><span><span><span><span><span><span></span><span><span>t</span></span></span><span><span></span><span><span><span>N</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span></span></span></span></span></div>\n<p>where a polynomial <span><span><span>pp</span><span aria-hidden=\"true\"><span><span></span><span>p</span></span></span></span></span> is <em>encoded</em> as <span><span><span>[p(u1),p(u2),…,p(uN)].[p(u_1), p(u_2), \\ldots, p(u_N)].</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>p</span><span>(</span><span><span>u</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>p</span><span>(</span><span><span>u</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span>p</span><span>(</span><span><span>u</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>]</span><span>.</span></span></span></span></span></p>\n<p>This map behaves nicely with respect to addition and multiplication: addition of polynomials corresponds to addition of vectors, whereas multiplication of polynomials corresponds to component-wise multiplication of vectors.</p>\n<p><strong>Example</strong>: If <span><span><span>NN</span><span aria-hidden=\"true\"><span><span></span><span>N</span></span></span></span></span> = <code>poly_modulus_degree</code> = 2 and <span><span><span>t≡1t\\equiv 1</span><span aria-hidden=\"true\"><span><span></span><span>t</span><span></span><span>≡</span><span></span></span><span><span></span><span>1</span></span></span></span></span> mod <span><span><span>44</span><span aria-hidden=\"true\"><span><span></span><span>4</span></span></span></span></span>, then <span><span><span>XN+1=(X−u1)⋅(X−u2)X^N+1 = (X-u_1) \\cdot (X-u_2)</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>−</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>−</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> mod <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span>. In this case, a <em>polynomial</em> <span><span><span>pp</span><span aria-hidden=\"true\"><span><span></span><span>p</span></span></span></span></span> corresponds to the <em>vector of integers</em> <span><span><span>[p(u1),p(u2)][p(u_1), p(u_2)]</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>p</span><span>(</span><span><span>u</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>p</span><span>(</span><span><span>u</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>]</span></span></span></span></span> modulo <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span>.</p>\n<ul>\n<li>The client batches his bins (having each 1 integer entry)  into <code>number_of_bins</code>/<code>poly_modulus_degree</code> vectors.</li>\n<li>The client encodes each such batch as a plaintext.</li>\n<li>The client encrypts these plaintexts and sends them to the server.</li>\n<li>The server batches his minibins in minibatches.</li>\n</ul>\n<p><strong>Example</strong>: For simplicity of exposition, let's take <code>poly_modulus_degree</code> = <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span>. This means that the client batches together vectors of <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> elements. The server matches this on his side, by batching together <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> mini bins into a <em>mini batch</em>.</p>\n<p><img src=\"https://i.imgur.com/WuPvEAt.png\" alt=\"\"></p>\n<p>In our implementation, we choose <code>number_of_bins</code> = <code>poly_modulus_degree</code>, so all the client's bins are batched into just one plaintext.</p>\n<p>🔍 The <strong>PSI</strong> protocol is now performed on a client's batch and on one of the corresponding server's mini batches.</p>\n<p><img src=\"https://i.imgur.com/qGFbEuA.png\" alt=\"\"></p>\n<p>❗ In general there are <code>alpha</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>number_of_bins</code>/<code>poly_modulus_degree</code> mini batches so the PSI protocol si apllied the same number of times.</p>\n<p>Batching lowers the <em>communication and computation costs on the client side.</em></p>\n<p>⚠️ Before going into the next step, <em>windowing</em>, let's take a deep breath now and recall a bit what we have so far. You can forget about batching for a minute. Each mini bin has <code>bin_capacity</code>/<code>alpha</code> elements, so it is represented by a monic polynomial of degree<code>bin_capacity</code>/<code>alpha</code>. Let's call this degree shortly as <span><span><span>DD</span><span aria-hidden=\"true\"><span><span></span><span>D</span></span></span></span></span>.</p>\n<p>Therefore, each polynomial looks like</p>\n<div><span><span><span>P(X)=XD+aD−1XD−1+…+a1X+a0.P(X) = X^D + a_{D-1}X^{D-1}+\\ldots+a_{1}X+a_0.</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span>X</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>D</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>D</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>D</span><span>−</span><span>1</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>…</span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>X</span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>.</span></span></span></span></span></div>\n<p>for some integer coefficients <span><span><span>aia_i</span><span aria-hidden=\"true\"><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>As in Case <strong>b</strong>, the client should send an encryption <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> of one bin containing an integer <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span>, and the server should evaluate the polynomial <span><span><span>P(X)P(X)</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span>X</span><span>)</span></span></span></span></span> at this encrypted value.</p>\n<p>Performing this evaluation requires, in particular, to compute <span><span><span>Enc(y)D≡Enc(yD)\\mathsf{Enc}(y)^D \\equiv \\mathsf{Enc}(y^D)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span><span>)</span><span><span><span><span><span><span></span><span><span>D</span></span></span></span></span></span></span></span><span></span><span>≡</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>D</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span>, which can be done in multiplicative depth <span><span><span>⌈log(D)⌉\\lceil \\mathsf{log}(D)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>⌈</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>⌉</span></span></span></span></span>. But this multiplicative depth may be too large to be handled by the <strong>HE</strong> scheme. In this case, the client may come to the rescue and send the encryptions of all powers:</p>\n<div><span><span><span>Enc(y),Enc(y2),Enc(y3),…,Enc(yD)\\mathsf{Enc}(y), \\mathsf{Enc}(y^2), \\mathsf{Enc}(y^3),\\ldots, \\mathsf{Enc}(y^D)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>D</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span></div>\n<p>So by using the magic powers of the <strong>HE</strong> scheme 🔮, the evaluation of the polynomial turns out to be just a <em>scalar product</em> of these encryptions with the vector of coefficients of the polynomial:</p>\n<div><span><span><span>P(Enc(y))=⟨(1,aD−1,…,a0),(Enc(yD),Enc(yD−1),…,Enc(1))⟩.P(\\mathsf{Enc}(y)) = \\langle (1, a_{D-1},\\ldots,a_0), (\\mathsf{Enc}(y^D), \\mathsf{Enc}(y^{D-1}),\\ldots,\\mathsf{Enc}(1)) \\rangle.</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>⟨</span><span>(</span><span>1</span><span>,</span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>D</span><span>−</span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>(</span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>D</span></span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>D</span><span>−</span><span>1</span></span></span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>1</span><span>)</span><span>)</span><span>⟩</span><span>.</span></span></span></span></span></div>\n<p>Still, the client needs to send <span><span><span>DD</span><span aria-hidden=\"true\"><span><span></span><span>D</span></span></span></span></span> encryptions (per bin), which means <em>a lot of communication on the client side</em> 😱.</p>\n<p><strong>We need to look for a tradeoff</strong> ⚖️. Notice that if the client sends the <span><span><span>⌊log(D)⌋+1\\lfloor\\mathsf{log}(D)\\rfloor+1</span><span aria-hidden=\"true\"><span><span></span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>⌋</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> encryptions</p>\n<div><span><span><span>Enc(y),Enc(y2),Enc(y4)…,Enc(y2⌊log(D)⌋),\\mathsf{Enc}(y), \\mathsf{Enc}(y^2), \\mathsf{Enc}(y^4) \\ldots, \\mathsf{Enc}(y^{2^{\\lfloor\\mathsf{log}(D)\\rfloor}}),</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span>)</span><span></span><span>…</span><span></span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>⌋</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>)</span><span>,</span></span></span></span></span></div>\n<p>then each power <span><span><span>Enc(y)e≡Enc(ye)\\mathsf{Enc}(y)^e \\equiv \\mathsf{Enc}(y^e)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span><span>)</span><span><span><span><span><span><span></span><span><span>e</span></span></span></span></span></span></span></span><span></span><span>≡</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>e</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span>, for any <span><span><span>e≤De\\leq D</span><span aria-hidden=\"true\"><span><span></span><span>e</span><span></span><span>≤</span><span></span></span><span><span></span><span>D</span></span></span></span></span>, can be computed by writing <span><span><span>ee</span><span aria-hidden=\"true\"><span><span></span><span>e</span></span></span></span></span> in binary decomposition. The server recovers any <span><span><span>Enc(ye)\\mathsf{Enc}(y^e)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>e</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span>, in the worst case, by multiplying all the <span><span><span>⌊log(D)⌋+1\\lfloor\\mathsf{log}(D)\\rfloor + 1</span><span aria-hidden=\"true\"><span><span></span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>⌋</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> (encrypted) powers, which requires a circuit of multiplicative depth <span><span><span>⌈log(⌊log(D)⌋+1)⌉\\lceil\\mathsf{log}(\\lfloor\\mathsf{log}(D)\\rfloor +1)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>⌈</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>⌋</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>⌉</span></span></span></span></span>.</p>\n<p>So yay! we <strong>lowered</strong> the initial multiplicative depth of the polynomial, from <span><span><span>⌈log(D)⌉\\lceil\\mathsf{log}(D)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>⌈</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>⌉</span></span></span></span></span>, to <span><span><span>⌈log(⌊log(D)⌋+1)⌉\\lceil\\mathsf{log}(\\lfloor\\mathsf{log}(D)\\rfloor +1)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>⌈</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>⌋</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>⌉</span></span></span></span></span>, while incurring a only <strong>a small <span><span><span>log⁡D\\log D</span><span aria-hidden=\"true\"><span><span></span><span>lo<span>g</span></span><span></span><span>D</span></span></span></span></span> factor communication cost</strong>. It turns out that we can do this even better: we can lower the depth to <span><span><span>⌈log(⌊log(D)⌋/ℓ+1)⌉,\\lceil\\mathsf{log}(\\lfloor\\mathsf{log}(D)\\rfloor/\\ell+1)\\rceil,</span><span aria-hidden=\"true\"><span><span></span><span>⌈</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>⌋</span><span>/</span><span>ℓ</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>⌉</span><span>,</span></span></span></span></span> for some so-called <em>windowing</em> parameter <span><span><span>ℓ\\ell</span><span aria-hidden=\"true\"><span><span></span><span>ℓ</span></span></span></span></span> if we are willing to pay some extra communication cost.</p>\n<p>Now it's time to come back to the protocol and tell you how this idea is used, combined with batching:</p>\n<ol start=\"6\">\n<li><strong>Windowing</strong>: It lowers the depth of the arithmetic circuit above (i.e. of the polynomial of degree <span><span><span>DD</span><span aria-hidden=\"true\"><span><span></span><span>D</span></span></span></span></span>). The client sends <em>sufficiently many (encrypted) powers</em> so that the server can recover all the missing powers, (i.e. the ones of exponent less than <span><span><span>DD</span><span aria-hidden=\"true\"><span><span></span><span>D</span></span></span></span></span>) by <em>computing circuits of low multiplicative depth</em>. We will generalize a bit the discussion above, but don't worry, we'll take it step-by-step.</li>\n</ol>\n<p>As you have seen, if the client sends the encryptions <span><span><span>Enc(yk)\\mathsf{Enc}(y^{k})</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>k</span></span></span></span></span></span></span></span></span><span>)</span></span></span></span></span>, for <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span> a power of <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span>, the server can recover any missing power. This can be done by writing the exponent in base <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> and by multiplying the received encrypted powers accordingly. But we can think of writing the exponent in a bigger base, let's say  <span><span><span>2ℓ2^\\ell</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span>ℓ</span></span></span></span></span></span></span></span></span></span></span></span>, for some parameter <span><span><span>ℓ\\ell</span><span aria-hidden=\"true\"><span><span></span><span>ℓ</span></span></span></span></span> (which is <code>ell</code>, in our implementation). Each term that appears in such a decomposition is of type <span><span><span>i⋅2ℓji\\cdot 2^{\\ell j}</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>ℓ</span><span>j</span></span></span></span></span></span></span></span></span></span></span></span></span>, where <span><span><span>0≤i≤2ℓ−10 \\leq i \\leq 2^{\\ell}-1</span><span aria-hidden=\"true\"><span><span></span><span>0</span><span></span><span>≤</span><span></span></span><span><span></span><span>i</span><span></span><span>≤</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>ℓ</span></span></span></span></span></span></span></span></span><span></span><span>−</span><span></span></span><span><span></span><span>1</span></span></span></span></span> and <span><span><span>0≤j≤⌊log(D)/ℓ⌋0\\leq j \\leq \\lfloor \\mathsf{log}(D)/\\ell\\rfloor</span><span aria-hidden=\"true\"><span><span></span><span>0</span><span></span><span>≤</span><span></span></span><span><span></span><span>j</span><span></span><span>≤</span><span></span></span><span><span></span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>ℓ</span><span>⌋</span></span></span></span></span>. Therefore, the client should send <span><span><span>Enc(yk)\\mathsf{Enc}(y^k)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> for each such term <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span>. Check the code for this <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/auxiliary_functions.py#L61\">here</a>.</p>\n<p>For each batched plaintext <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span>, the client sends <span><span><span>Enc(yi⋅2ℓ⋅j)\\mathsf{Enc}(y^{i \\cdot 2^{\\ell \\cdot j}})</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>i</span><span>⋅</span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>ℓ</span><span>⋅</span><span>j</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>)</span></span></span></span></span>, for each <span><span><span>1≤i≤2ℓ−11 \\leq i \\leq 2^{\\ell} -1</span><span aria-hidden=\"true\"><span><span></span><span>1</span><span></span><span>≤</span><span></span></span><span><span></span><span>i</span><span></span><span>≤</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>ℓ</span></span></span></span></span></span></span></span></span><span></span><span>−</span><span></span></span><span><span></span><span>1</span></span></span></span></span> and <span><span><span>0≤j≤⌊log(D)/ℓ⌋0\\leq j \\leq \\lfloor \\mathsf{log}(D)/\\ell\\rfloor</span><span aria-hidden=\"true\"><span><span></span><span>0</span><span></span><span>≤</span><span></span></span><span><span></span><span>j</span><span></span><span>≤</span><span></span></span><span><span></span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>ℓ</span><span>⌋</span></span></span></span></span>. Notice that if <span><span><span>i=0i=0</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span></span><span>=</span><span></span></span><span><span></span><span>0</span></span></span></span></span>, then <span><span><span>yi⋅2ℓj=1y^{i\\cdot 2^{\\ell j}} =1</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>i</span><span>⋅</span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>ℓ</span><span>j</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>1</span></span></span></span></span>, hence no need of sending an encryption of <span><span><span>11</span><span aria-hidden=\"true\"><span><span></span><span>1</span></span></span></span></span>. 😄</p>\n<p>You can see how both batching and windowing work together <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/client_online.py#L67\">here</a>.</p>\n<ol start=\"7\">\n<li><strong>Recover all powers</strong>: The server computes all the necessary powers in order to evaluate the polynomials, see the code <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/auxiliary_functions.py#L45\">here</a>.</li>\n</ol>\n<p>Given the <span><span><span>2ℓ2^{\\ell}</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>ℓ</span></span></span></span></span></span></span></span></span></span></span></span></span> base representation of <span><span><span>ee</span><span aria-hidden=\"true\"><span><span></span><span>e</span></span></span></span></span>,</p>\n<div><span><span><span>e=e0+2ℓ⋅e1+22ℓ⋅e2+…+2⌊log(D)/ℓ⌋ℓe⌊log(D)/ℓ⌋  e = e_0 + 2^{\\ell}\\cdot e_1  + 2^{2\\ell}\\cdot e_2 + \\ldots + 2^{\\lfloor \\mathsf{log}(D)/\\ell\\rfloor\\ell} e_{\\lfloor \\mathsf{log}(D)/\\ell\\rfloor}</span><span aria-hidden=\"true\"><span><span></span><span>e</span><span></span><span>=</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>ℓ</span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>2</span><span>ℓ</span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>…</span><span></span><span>+</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>ℓ</span><span>⌋</span><span>ℓ</span></span></span></span></span></span></span></span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>ℓ</span><span>⌋</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></div>\n<p>where <span><span><span>0≤e0,e1,…,e⌊log(D)/ℓ⌋≤2ℓ−10 \\leq e_0, e_1,\\ldots,e_{\\lfloor \\mathsf{log}(D)/\\ell\\rfloor} \\leq 2^{\\ell} -1</span><span aria-hidden=\"true\"><span><span></span><span>0</span><span></span><span>≤</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>…</span><span></span><span>,</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>ℓ</span><span>⌋</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>≤</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>ℓ</span></span></span></span></span></span></span></span></span><span></span><span>−</span><span></span></span><span><span></span><span>1</span></span></span></span></span>, we can compute</p>\n<div><span><span><span>ye=∏i=0⌊log⁡(D)/ℓ⌋(y2i)ei.\\displaystyle y^e=\\prod_{i=0}^{\\lfloor \\log (D)/\\ell \\rfloor} \\left(y^{2^i} \\right)^{e_i}.</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>e</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>∏</span></span></span><span><span></span><span><span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>ℓ</span><span>⌋</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span><span><span><span>(</span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>.</span></span></span></span></span></div>\n<p>Therefore recovering <span><span><span>Enc(ye)\\mathsf{Enc}(y^e)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>e</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> for each such <span><span><span>ee</span><span aria-hidden=\"true\"><span><span></span><span>e</span></span></span></span></span> involves, in the worst case, multiplying <span><span><span>⌊log(D)/ℓ⌋+1\\lfloor \\mathsf{log}(D)/\\ell\\rfloor+1</span><span aria-hidden=\"true\"><span><span></span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>ℓ</span><span>⌋</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> (encrypted) powers. Therefore, the server computes a circuit of multiplicative depth of <span><span><span>⌈log(⌊log(D)/ℓ⌋+1)⌉\\lceil\\mathsf{log}(\\lfloor\\mathsf{log}(D)/\\ell\\rfloor+1)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>⌈</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>ℓ</span><span>⌋</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>⌉</span></span></span></span></span>! 😄</p>\n<p>You can check how this step is implemented <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/server_online.py#L80\">here</a>.</p>\n<p>This depth should be supported by the encryption scheme. So the parameters <code>bin_capacity</code>, <code>alpha</code> and <code>ell</code> should be chosen so that\n<span><span><span>⌈log(⌊log(\\lceil\\mathsf{log}(\\lfloor\\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>⌈</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span><code>bin_capacity</code>/<code>alpha</code><span><span><span>))</span><span aria-hidden=\"true\"><span><span></span><span>)</span></span></span></span></span>/<code>ell</code><span><span><span>⌋+1)⌉\\rfloor+1)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>⌋</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>⌉</span></span></span></span></span> doesn't exceed the allowed depth of the scheme, which is <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>.</p>\n<p>A tradeoff appears here in choosing the right <code>ell</code>. Notice that the bigger <code>ell</code>, the lower the depth of the circuit the server computes, i.e. <em>smaller computation time</em>, but the more powers the client needs to send, i.e <em>bigger communication cost</em>.</p>\n<p>Another tradeoff is possible when choosing the right partitioning parameter <code>alpha</code>. Notice that the bigger <code>alpha</code>, the smaller the degree <span><span><span>DD</span><span aria-hidden=\"true\"><span><span></span><span>D</span></span></span></span></span> = <code>bin_capacity</code>/<code>alpha</code>, i.e <em>lower computation time</em> on the server side, but the more ciphertexts the server needs to send, i.e. <em>bigger communication cost</em>.</p>\n<ol start=\"8\">\n<li><strong>Doing the scalar product</strong>: This is the last step  on the server side. The server evaluates the polynomials corresponding to the mini bins in a scalar-product fashion, as explained above. However, <strong>due to batching</strong>, this scalar product is a bit trickier; you can check the code <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/server_online.py#L94\">here</a>.</li>\n</ol>\n<p>❗ Recall that the <a href=\"https://eprint.iacr.org/2012/144.pdf\">BFV</a> encryption scheme that we use allows multiplying ciphertexts by plaintexts which means that</p>\n<div><span><span><span>Enc(p⋅m)≡p⋅Enc(m),\\mathsf{Enc}(p \\cdot m) \\equiv p \\cdot \\mathsf{Enc}(m),</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span></span><span>⋅</span><span></span></span><span><span></span><span>m</span><span>)</span><span></span><span>≡</span><span></span></span><span><span></span><span>p</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>m</span><span>)</span><span>,</span></span></span></span></span></div>\n<p>for any <span><span><span>pp</span><span aria-hidden=\"true\"><span><span></span><span>p</span></span></span></span></span> and <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span> <strong>polynomials</strong> of degree less than <code>poly_modulus_degree</code> of coefficients modulo <code>plain_modulus</code>. Hence TenSEAL allows multiplying ciphertexts by <strong>vectors of integers</strong> modulo <code>plain_modulus</code>.</p>\n<p>Let's recap all these steps and see how performing the scalar product  works in our example.</p>\n<p><strong>Example:</strong> Let's go back to the example where each mini bin has <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> elements, which corresponds to a monic polynomial of degree <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span>. Consider a mini batch of mini bins whose corresponding polynomials are <span><span><span>P1=X2+a1X+a0P_1 = X^2 + a_1X + a_0</span><span aria-hidden=\"true\"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>X</span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and <span><span><span>P2=X2+b1X+b0P_2 = X^2 + b_1X+b_0</span><span aria-hidden=\"true\"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>X</span><span></span><span>+</span><span></span></span><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p><img src=\"https://i.imgur.com/34YIWaY.png\" alt=\"\"></p>\n<p>This means that the client encodes a batch <span><span><span>[y1,y2][y_1, y_2]</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>]</span></span></span></span></span> as a plaintext <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> and sends <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span>. Because of windowing, the client also sends <span><span><span>Enc(y2)\\mathsf{Enc}(y^2)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> to the server. In this case, the server can <em>simultaneously</em> check if <span><span><span>y1y_1</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> belongs to the first mini bin (i.e. <span><span><span>P1P_1</span><span aria-hidden=\"true\"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> evaluates to <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span> at <span><span><span>y1y_1</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>) and <span><span><span>y2y_2</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> belongs to the second mini bin (i.e. <span><span><span>P2P_2</span><span aria-hidden=\"true\"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> evaluates to <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span> at <span><span><span>y2y_2</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>). Indeed, the server takes the first column of the mini batch and multiplies <span><span><span>Enc(y2)\\mathsf{Enc}(y^2)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> by it, takes the second column and multiplies <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> by it and adds them to the third column:</p>\n<div><span><span><span>[1,1]⋅Enc(y2)+[a1,b1]⋅Enc(y)+[a0,b0].[1,1]\\cdot \\mathsf{Enc}(y^2) + [a_1, b_1] \\cdot \\mathsf{Enc}(y) + [a_0, b_0].</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>1</span><span>,</span><span></span><span>1</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>[</span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>[</span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span>.</span></span></span></span></span></div>\n<p>This is the result that the server sends to the client.</p>\n<p><strong>In general</strong>, for any mini batch, in order to evaluate the corresponding polynomials, the server computes the sum over <span><span><span>ii</span><span aria-hidden=\"true\"><span><span></span><span>i</span></span></span></span></span> of  <span><span><span>Enc(yi)×(D+1−i)\\mathsf{Enc}(y^i)\\times (D+1-i)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span>)</span><span></span><span>×</span><span></span></span><span><span></span><span>(</span><span>D</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span></span><span>−</span><span></span></span><span><span></span><span>i</span><span>)</span></span></span></span></span>-th column of the mini batch. In total, the server computes and then sends <code>alpha</code> <span><span><span>⋅\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>⋅</span></span></span></span></span> <code>number_of_bins</code>/ <code>poly_modulus_degree</code> encrypted results to the client (Notice that the communication is increased by a factor of <span><span><span>α\\alpha</span><span aria-hidden=\"true\"><span><span></span><span>α</span></span></span></span></span>).</p>\n<ol start=\"9\">\n<li><strong>Verdict</strong>: It's time for the client to find out the intersection of the two lists of elements.</li>\n</ol>\n<p>The client decrypts the results that he gets from the server and recovers a vector of integers (corresponding to the underlying polynomial plaintext). The client checks  if this vector contains any zeroes. A zero corresponds to an element from the intersection. To recover such an element we use the index where the zero is found. You can check how the client gets the intersection in the code <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/client_online.py#L132\">here</a>.</p>\n<p>Let's go back to the example!</p>\n<p><strong>Example</strong>:  Recall that <span><span><span>P1(X)=X2+a1X+a0P_1(X) = X^2 + a_1X+a_0</span><span aria-hidden=\"true\"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>X</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>X</span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and <span><span><span>P2(X)=X2+b1X+b0P_2(X) = X^2 + b_1X+b_0</span><span aria-hidden=\"true\"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>X</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>X</span><span></span><span>+</span><span></span></span><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. Also, remember that <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> was encoded from <span><span><span>[y1,y2].[y_1, y_2].</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span>.</span></span></span></span></span> Due to the encoding, <span><span><span>y2y^2</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> corresponds to <span><span><span>[y12,y22].[y^2_1, y^2_2].</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span>.</span></span></span></span></span> Consider <span><span><span>p2,p1p_2, p_1</span><span aria-hidden=\"true\"><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, respectively <span><span><span>p0p_0</span><span aria-hidden=\"true\"><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> the encodings of <span><span><span>[1,1],[a1,b1],[1,1], [a_1, b_1],</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>1</span><span>,</span><span></span><span>1</span><span>]</span><span>,</span><span></span><span>[</span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span>,</span></span></span></span></span> respectively <span><span><span>[a0,b0][a_0, b_0]</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>]</span></span></span></span></span>.</p>\n<p>The server computes <span><span><span>p2⋅Enc(y2)+p1⋅Enc(y)+p0.p_2 \\cdot \\mathsf{Enc}(y^2) + p_1 \\cdot \\mathsf{Enc}(y) +p_0.</span><span aria-hidden=\"true\"><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>.</span></span></span></span></span> and sends back the result to the client. When the client decrypts it, he gets the result <span><span><span>p2⋅y2+p1⋅y+p0p_2 \\cdot y^2 + p_1 \\cdot y + p_0</span><span aria-hidden=\"true\"><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span>y</span><span></span><span>+</span><span></span></span><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, which, after batch decoding, equals to:</p>\n<p><span><span><span>[1,1]⋅[y12,y22]+[a1,b1]⋅[y1,y2]+[a0,b0],[1,1] \\cdot [y^2_1, y^2_2] + [a_1, b_1] \\cdot [y_1, y_2] + [a_0, b_0],</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>1</span><span>,</span><span></span><span>1</span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span>[</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span></span><span>+</span><span></span></span><span><span></span><span>[</span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span></span><span>⋅</span><span></span></span><span><span></span><span>[</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span></span><span>+</span><span></span></span><span><span></span><span>[</span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span>,</span></span></span></span></span></p>\n<p>where the additions and multiplications are done component-wise, so the above computatation is equal to <span><span><span>[y12+a1⋅y1+a0,y22+b1⋅y2+b0][y_1^2+a_1\\cdot y_1 + a_0, y_2^2+b_1\\cdot y_2 + b_0]</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>]</span></span></span></span></span> which is nothing but <span><span><span>[P1(y1),P2(y2)].[P_1(y_1), P_2(y_2)].</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>P</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>]</span><span>.</span></span></span></span></span></p>\n<h3>Setting the parameters</h3>\n<p>We know that we have introduced a lot of parameters along the way. 😱 Let's recap them a bit and see how we chose them in our implementation. 🤓</p>\n<ul>\n<li><code>server_size</code>, <code>client_size</code>: the sizes of server's and client's databases.</li>\n<li><code>sigma_max</code> appears in the <strong>OPRF</strong> layer, as this step maps the database entries to <code>sigma_max</code>-bit integers.</li>\n<li><code>number_of_hashes</code>, <code>output_bits</code>, <code>number_of_bins</code>, <code>bin_capacity</code> appear in hashing, as this step maps the previous integers, using <code>number_of_hashes</code> hash functions, to <code>sigma_max</code> - <code>output_bits</code> + <span><span><span>⌊log(\\lfloor \\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span> <code>number_of_hashes</code><span><span><span>)⌋+1)\\rfloor + 1</span><span aria-hidden=\"true\"><span><span></span><span>)</span><span>⌋</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> -bit integers in <code>number_of_bins</code> bins.</li>\n<li><code>alpha</code> appears in partitioning, as server splits the  bins in <code>alpha</code> mini bins.</li>\n<li><code>plain_modulus</code>, <code>poly_modulus_degree</code> : parameters of the <strong>HE</strong>  scheme.</li>\n<li><code>ell</code> used in windowing.</li>\n</ul>\n<p>The elements from the both hash tables (client and server) are represented on\n<code>sigma_max</code> - <code>output_bits</code> + <span><span><span>⌊log(\\lfloor \\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span> <code>number_of_hashes</code><span><span><span>)⌋+1)\\rfloor + 1</span><span aria-hidden=\"true\"><span><span></span><span>)</span><span>⌋</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> bits. The <strong>HE</strong> scheme must be able to encrypt integers of this size, so we set:</p>\n<p><code>sigma_max</code> <span><span><span>≤\\leq</span><span aria-hidden=\"true\"><span><span></span><span>≤</span></span></span></span></span> <span><span><span>⌊log(\\lfloor \\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span><code>plain_modulus</code><span><span><span>)⌋)\\rfloor</span><span aria-hidden=\"true\"><span><span></span><span>)</span><span>⌋</span></span></span></span></span> + <code>output_bits</code> - (<span><span><span>⌊log(\\lfloor \\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span> <code>number_of_hashes</code><span><span><span>)⌋+1))\\rfloor + 1)</span><span aria-hidden=\"true\"><span><span></span><span>)</span><span>⌋</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span></span></span></span></span>.</p>\n<p>Also, recall that recovering all the (encrypted) powers on the server side, we require</p>\n<p><span><span><span>⌈log(⌊log(\\lceil\\mathsf{log}(\\lfloor\\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>⌈</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>⌊</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span><code>bin_capacity</code>/<code>alpha</code><span><span><span>))</span><span aria-hidden=\"true\"><span><span></span><span>)</span></span></span></span></span>/<code>ell</code><span><span><span>⌋+1)⌉≤\\rfloor+1)\\rceil \\leq</span><span aria-hidden=\"true\"><span><span></span><span>⌋</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>⌉</span><span></span><span>≤</span></span></span></span></span> depth.</p>\n<p>Let's choose a set of these parameters step-by-step:</p>\n<ul>\n<li><code>number_of_hashes</code> = <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>.</li>\n<li><code>client_size</code> = <span><span><span>55355535</span><span aria-hidden=\"true\"><span><span></span><span>5</span><span>5</span><span>3</span><span>5</span></span></span></span></span>, so <code>number_of_bins</code> = <span><span><span>3/2⋅3/2 \\cdot</span><span aria-hidden=\"true\"><span><span></span><span>3</span><span>/</span><span>2</span><span>⋅</span></span></span></span></span> <code>number_of_bins</code> = <span><span><span>81928192</span><span aria-hidden=\"true\"><span><span></span><span>8</span><span>1</span><span>9</span><span>2</span></span></span></span></span>. (Cuckoo hashing succeeds with probability <span><span><span>1−2−401 - 2^{-40}</span><span aria-hidden=\"true\"><span><span></span><span>1</span><span></span><span>−</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span>4</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>; check <strong>Hashing failures</strong> <a href=\"https://eprint.iacr.org/2017/299.pdf\">here</a>.</li>\n<li><code>server_size</code> = <span><span><span>2202^{20}</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>, so <code>bin_capacity</code> = <span><span><span>536536</span><span aria-hidden=\"true\"><span><span></span><span>5</span><span>3</span><span>6</span></span></span></span></span>. (Simple hashing succeeds with probability <span><span><span>1−2−301-2^{-30}</span><span aria-hidden=\"true\"><span><span></span><span>1</span><span></span><span>−</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span>3</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>; check <strong>Hashing failures</strong> <a href=\"https://eprint.iacr.org/2017/299.pdf\">here</a>) or run the <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/bin_capacity_estimator.py\">bin capacity estimator script</a>.</li>\n<li><code>output_bits</code> = <span><span><span>log(\\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span><code>number_of_bins</code><span><span><span>)=13) = 13</span><span aria-hidden=\"true\"><span><span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>1</span><span>3</span></span></span></span></span>.</li>\n<li><code>poly_modulus_degree</code> = <span><span><span>81928192</span><span aria-hidden=\"true\"><span><span></span><span>8</span><span>1</span><span>9</span><span>2</span></span></span></span></span> and <code>plain_modulus</code> = <span><span><span>536903681536903681</span><span aria-hidden=\"true\"><span><span></span><span>5</span><span>3</span><span>6</span><span>9</span><span>0</span><span>3</span><span>6</span><span>8</span><span>1</span></span></span></span></span>.</li>\n<li><code>sigma_max</code> = <span><span><span>4040</span><span aria-hidden=\"true\"><span><span></span><span>4</span><span>0</span></span></span></span></span>.</li>\n<li>For safety, we can think of depth = <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>. If <code>ell</code> = <span><span><span>11</span><span aria-hidden=\"true\"><span><span></span><span>1</span></span></span></span></span>, <code>alpha</code> is lower bounded by <span><span><span>55</span><span aria-hidden=\"true\"><span><span></span><span>5</span></span></span></span></span>, since <code>bin_capacity</code>/<code>alpha</code> <span><span><span>≤128.\\leq 128.</span><span aria-hidden=\"true\"><span><span></span><span>≤</span><span></span></span><span><span></span><span>1</span><span>2</span><span>8</span><span>.</span></span></span></span></span></li>\n</ul>\n<p>We chose this <span><span><span>2929</span><span aria-hidden=\"true\"><span><span></span><span>2</span><span>9</span></span></span></span></span>-bit <code>plain_modulus</code> to get <code>sigma_max</code> as large as possible. A large <code>sigma_max</code> guarantees that the protocol runs without any false-positives. For example, keeping <code>client_size</code><span><span><span>=5535=5535</span><span aria-hidden=\"true\"><span><span></span><span>=</span><span></span></span><span><span></span><span>5</span><span>5</span><span>3</span><span>5</span></span></span></span></span> and <code>server_size</code><span><span><span>=220=2^{20}</span><span aria-hidden=\"true\"><span><span></span><span>=</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>, a <span><span><span>5252</span><span aria-hidden=\"true\"><span><span></span><span>5</span><span>2</span></span></span></span></span>-bit <code>plain_modulus</code> guarantees that the protocol can't give false-positives, except with probability less than <span><span><span>2−302^{-30}</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span>3</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>. The current TenSEAL implementation does not allow us to choose a <span><span><span>5252</span><span aria-hidden=\"true\"><span><span></span><span>5</span><span>2</span></span></span></span></span>-bit <code>plain_modulus</code> while keeping the <code>poly_modulus_degree</code><span><span><span>=8192=8192</span><span aria-hidden=\"true\"><span><span></span><span>=</span><span></span></span><span><span></span><span>8</span><span>1</span><span>9</span><span>2</span></span></span></span></span>.</p>\n<h3>Let's play! 🎉</h3>\n<p>You can generate the datasets of the client and the server by running <code>set_gen.py</code>. Then run <code>server_offline.py</code> and <code>client_offline.py</code> to preprocess them. Now go to the online phase of the protocol by running <code>server_online.py</code> and <code>client_online.py</code>. Go check it out! 😄</p>\n"},{"data":{"slug":"recurrent-space-time-graph-neural-nets","authors":"Iulia Duță, Andrei Nicolicioiu","categories":"blog","featured_img":"/galleries/rstg_pictures/featured_graph_nets.jpg","date":"November-26-2019","title":"Recurrent Space-time Graph Neural Network","id":6},"messages":[],"history":["./content/collections/posts/rstg2019.md","content/collections/posts/rstg2019.html"],"cwd":"/Users/fbrad/bit/bit-ml","contents":"<h1>Recurrent Space-time Graph Neural Network</h1>\n<p>We introduce in this post our <strong>Recurrent Space-time Graph Neural Network</strong> (RSTG) architecture designed for learning video representation and  especially suited for tasks heavily relying on interactions.</p>\n<p>Let’s begin by considering the key components of video understanding that our method should include. Being able to detect and localise objects is the first crucial thing that we need to do, then we should combine them in various ways to create complex scenes. <em>Whole is greater than the sum of its parts</em>, but is it always true, and what are the conditions of this happening?</p>\n<p>In order to form a greater whole, objects must have some kind of connections between them. A set of random objects that do not correlate in any way doesn’t bring much additional information.  Entities could form different types of connections, they could be semantically related or they could be related by their physical position in space and in time. These kinds of relations happen in both image and video, with the time dimension of the video adding more difficulty, greatly increasing the amount and complexity of interactions happening in the scene.</p>\n<p>Let’s define the kind of interaction happening in the video by examining a few examples.</p>\n<p><img src=\"/galleries/rstg_pictures/interaction_videos.gif\" alt=\"eeml2019_group_photo\" title=\"Temporal interaction.\"></p>\n<p>Above, the yellow car and the grass appear together during the whole video, but the event <em>the car crosses the line</em> is characterized by a specific interaction. We call those types of interactions happening at the frame level <strong>spatial</strong> interactions. On the other hand, the event <em>the yellow car overtakes the red car</em> can not be captured from a single frame as it only makes sense across time. We call this <strong>temporal</strong> interactions.</p>\n<p>The entities that interact shouldn’t necessary be close to each other, either in time or in space, since there could also exist <strong>long-range</strong> interactions. In the above picture, the man and the moon are connected regardless of their distance in the image.</p>\n<h2>Analysing videos with spatio-temporal graph models</h2>\n<p>Models commonly used in Computer Vision, based on convolutional networks, implicitly capture interactions in both space and time dimension, but they are biased towards local, short-range relations.</p>\n<p>We propose a method designed to explicitly model relations and that is capable of capturing long range connections. Our model fits into the broader category of <strong>graph neural networks</strong> (GNNs). We process the video imposing a graph structure in order to explicitly model interactions between different entities. GNNs usually send  messages between each pair of  nodes, thus easily modeling binary interactions. Higher order interactions could be achieved by multiple such message-passing iterations.</p>\n<p>The animation below illustrates the main components of our model.</p>\n<p>At each time step, we <strong>create nodes</strong> by extracting information from features given by a convolutional network. Each node corresponds to a different fixed region of the input and we connect them if they come from neighbouring regions or if they overlap, as shown in the figure above. Using multiple scales helps us to capture entities of different sizes  and also to connect distant regions more easily.</p>\n<p>For the two types of interactions described above, we create two separate processing components. For each time step, we design a <strong>space processing</strong> stage to model the spatial interaction by iteratively  message-passing. This involves 3 steps: sending messages between each pair of connecting nodes, aggregating the messages received at each node by an attention mechanism and updating each node based on the current state and the aggregated message. We design a <strong>time processing</strong> stage to model temporal interactions by sending messages in time, only between the states of the same node, in a recurrent fashion. More specifically, at each time step, each node receives information only from its corresponding state from the previous time step.</p>\n<p>To model more expressive spatio-temporal interactions and to give it the ability to reason about all the information in the scene, with knowledge about past states, we alternate the two processing stages, as shown in the animation below.</p>\n<p><img src=\"/galleries/rstg_pictures/rstg_stages.gif\" alt=\"rstg_stages\" title=\"Alternative Space and Time Processing Stages.\"></p>\n<p>By having multiple space iteration, we go from local to more global processing, modeling interactions happening between an increasing number of entities situated at increasingly longer distances. We want to have some temporal information at every such steps, in order to model interactions that takes into account the history.  In order to combine the same kind of features from different time steps, we only connect the k-th spatial stage with the k-th stage from the previous step as shown in the animation.</p>\n<p>We can pool all the nodes into a vector representation used for the final prediction or we could project back each node into its initial corresponding region, forming a feature volume with the same size as the graph input so that our model could be used as a module inside any other architecture.</p>\n<h2>Synthetic Dataset</h2>\n<p>Training on a large real world dataset takes a lot of time and computational resources and could also involves hidden biases that could mask the capabilities of a model. For example, because of an unbalanced dataset, the activity of skiing could be detected only from the context of a snowy scene.  Thus, we designed a synthetic dataset where the complexity comes from the necessity of explicitly modeling spatial and temporal interactions but in a cleaner, simpler environment.</p>\n<p>Our SyncMNIST datasets involves videos where the goal is to detect a pair of digits that move synchronous among others that move randomly. On this dataset, we validate our key design choices by conducting ablation studies.</p>\n<p>We show that it is important to have both processing stages, each having its own set of parameters and to have multiple alternating temporal and spatial stages. We note that our model is also improved by incorporating positional embeddings in the node features. Our final model, that includes all these elements  surpasses strong models such as I3D and Non-Local.</p>\n<h2>Real world experiments</h2>\n<p><img src=\"/galleries/rstg_pictures/smt-smt2.gif\" alt=\"smt_example\" title=\"a) Failing to put something into something because something does not fit b) pretending to put something into something\"></p>\n<p>To validate the capability of our model, we evaluate the RSTG model on a human-object interaction dataset - Something-Something v1 . This dataset contains fine-grained actions, that can not be distinguished solely on their context, where the interactions between entities across the entire video are essential.  We compare against top-models in the literature and obtain state of the art results.</p>\n<p><img src=\"/galleries/rstg_pictures/chart.svg\" alt=\"results\" title=\"Something-Something Results\"></p>\n<h2>Conclusion</h2>\n<p>We hope that graph based methods would be more broadly  adopted in visual domain tasks, especially those where interactions play a crucial role and that our methods brings more evidence that such models could be successfully applied in such tasks.</p>\n<p>Our proposed RSTG model, seen as a spatio-temporal processing module, could be used for other various problems. Key aspects proved by our experiments,  such as the creation of a graph structure from convolutional features or the coupled but factorised time and space processing could be integrated into other models.</p>\n<p>We released the code of our models and SyncMNIST dataset\nhere.</p>\n<p>More details  about our work could be found in our\npaper:</p>\n<p>Andrei Nicolicioiu, Iulia Duta, Marius Leordeanu, <em>Recurrent Space-time Graph Neural Networks</em>,   In Advances in neural information processing systems (<em>NeurIPS 2019</em>).</p>\n"},{"data":{"slug":"bitdefender_at_tmlss2018","authors":"Elena Burceanu","categories":"event","galleries":"tmlss2018_posters:5, tmlss2018_pictures:5","featured_img":"/galleries/tmlss2018_pictures/salina_1.jpg","date":"August-2-2018","title":"Bitdefender at TMLSS2018","id":7},"messages":[],"history":["./content/collections/posts/tmlss2018.md","content/collections/posts/tmlss2018.html"],"cwd":"/Users/fbrad/bit/bit-ml","contents":"<h1>Bitdefender at TMLSS2018</h1>\n<p><strong>Bitdefender's Machine Learning Unit</strong> participated with eight of its members\nat the first edition of the <a href=\"https://tmlss.ro/\">Transylvania Machine Learning Summer\nSchool</a> that took place at the end of July 2018 in\nCluj-Napoca.</p>\n<p>The organizers are well known DeepMind figures (and also Romanians :D), Doina\nPrecup, Razvan Pascanu and Viorica Patraucean and RIST institute from Cluj -\nLuigi Malago and Razvan Florian.</p>\n<p>The motivation for the Summer School was to facilitate new relations between\nthe Machine Learning research community of Eastern Europe with the rest of\nthe world by encouraging collaboration between students and researchers\nfrom Eastern Europe with other more developed research centers and also by\noffering more accessible fees to the school attendees.</p>\n<p>Since the school had excellent lecturers, the competition was tough. From over\n800 participants, only 100 were selected to participate and to present a poster\nwith his/hers research results or work in progress. The diversity of the\nparticipants was a keypoint in the selection, roughly half of the\nparticipants were Romanians.</p>\n<p>Some words about the schedule. Each day we attended to several lectures, some\nof them introductory, other more advanced. At the end of the day we had lab\nsessions on Math, Computer Vision, Language, Generative Models, Unsupervised\nLearning and Reinforcement Learning. At the poster sessions, each of us had up\nto 4h30 to present the poster to anyone interested walking by. A detailed\nprogram can be found here tmlss.ro/programme.php.</p>\n<p>Even though there were six full and exhausting days, our team really enjoyed it\nand tried to get the most out of the lecturers and from the interactions with\nthe participants and the lecturers. Bitdefender was very well represented and\nwe came back home inspired and eager to continue our research.  More, we also\ngot a Best Poster award for Computer Vision (yey!).</p>\n<p>Actually our team enjoyed this experience so much that some of them decided to\ngive an individual account of some of the highlights of TMLSS2018 and the\nlectures that gave them a long lasting impression.</p>\n<p><strong>Tudor Berariu</strong>:</p>\n<p><em>The Transylvanian Machine Learning Summer School represents the perfect venue\nfor all who are interested in pursuing a research career in machine learning.\nFor those that are yet unfamiliar with the field TMLLSS gives the chance to\ngrasp the fundamental theory of a broad set of core topics. At the same time,\nthe more experienced participants are being offered a glimpse of the top\nresearchers' reflections on the open problems in the field. All in all, Cluj\nwas the place to be this July if interested in machine learning.</em></p>\n<p><em>Amidst all those captivating lectures spanned over six days one caught my eye\nin particular: <strong>Ulrich Paquet's</strong> introduction to Variational Autoencoders.\nAlthough I held some lectures on the topic myself in the past years, I found\nUlrich's <a href=\"https://youtu.be/xTsnNcctvmU\">presentation</a> remarkable for its\nconcise, visual, extremely clear, while at the same time strongly theoretical\nelucidation of what and how VAEs do achieve. I wish my lectures were half as\ngood as his.</em></p>\n<p><em>Later that day, while visiting the boring salt mine near Turda, I also had the\nchance to chat with Ulrich and ask him a few questions regarding generative\nmodels, especially Boltzmann Machines. His exact words <em>Do not give up research\non Boltzmann Machines.</em> convinced me to recommence my efforts on training\ndifferent flavours of energy-based models to structure knowledge in\nreinforcement learning setups.</em></p>\n<p><strong>Iulia Duță</strong>:</p>\n<p><em>The main focus of the summer school was to popularize the machine learning\nfields in Eastern Europe, so the lectures' content was a mixture of\nintroductory and more advanced topics. Knowing that beforehand, I arrived in\nCluj both with the goal of capturing speaker's intuitions on fundamental\nconcepts in machine learning and insights on open, more recent challenges in\nthe field.</em></p>\n<p><em>One of the lectures that I remarked as being well structured and\ncreated exactly for this purpose was <strong>Dumitru Erhan's</strong> presentation: \"Computer\nVision: Way  Beyond  Classification\". He build the lecture incrementally, from\na classical computer vision problem (Object Detection) to a much hotter topic\n<a href=\"https://arxiv.org/abs/1612.05424\">Domain Adaptation</a>. Both of them were\npresented in terms of how the field evolved over time, highlighting advantages\nand disadvantages of each approaches. While the first part addresses a common\nproblem for computer vision researchers, Domain adaptation is a topic\nextremely important for all machine learning subfields, being a worth studying\nopen problem. So besides useful knowledge and interactions, TMLSS showed us a\nglimpse of novel research and a long bibliography to follow.</em></p>\n<p><strong>Andrei Nicolicioiu</strong>:</p>\n<p><em>The lecture that impressed me the most was the one about Graph Networks\npresented by <strong>Răzvan Pașcanu</strong>. He showed intuitions about the priors existing\nin deep networks and the need for models better suited for domains having\nstrong <a href=\"http://arxiv.org/abs/1806.01261v2\">relational priors</a>. We were\npresented in a unified way different views of the domain from general graph\nnetworks to simpler graph convolutional architectures, showing the usefulness\nof relations both in problems involving data with a more obvious graph\nstructure as molecules and in unexpected places like the interactions of\nmemories in a recurrent model. The presentation certainly inspired me to study\nmore about these approaches and how can they be applied in my research.</em></p>\n<p><strong>Dana Axinte</strong>:</p>\n<p><em>Neural networks, gradients, posters, enthusiasm, magic. These are some of the\nsettings of the first Transylvanian Machine Learning Summer School held in\nCluj, Romania. Looking through the schedule and speakers, I expected the school\nto be strong and that I would have the chance to settle new concepts while I\nwould engage with other participants with different backgrounds, but same\ninterests.</em></p>\n<p><em>I liked the balance between theoretically focused lectures and the ones that\npresented the industry usage of those concepts. Such pair of lectures that I\nparticularly appreciated were the ones by <strong>Doina Precup</strong> who took a\nprogressive approach in presenting value-based methods with function\napproximation for reinforcement learning and the one of <strong>Raia Hadsell</strong> who\nshowed how deep reinforcement learning can be applied into\n<a href=\"http://arxiv.org/abs/1610.04286v2\">robotics</a>, with the challenges that exists\nand the possible <a href=\"http://arxiv.org/abs/1804.00168v2\">solutions</a>.</em></p>\n<p><em>One of the parts of the summer school that I especially enjoyed was the panel\nsession where some lecturers shared their opinion on different interesting\ntopics. The reproducibility of experiments, the future of AI research and\nadvices to increase the local AI ecosystems, as what could be the involvement\nof governments, companies and teachers were few of the issues discussed. There\nwere no hype or buzzwords, but the lecturers were people who know today’s\nlimitations, needs and questions and get things done step by step, with an\nengineering mindset. A fundamental feeling with which I left is that it is not\nonly about learning, but sharing the experience and knowledge gained to empower\nothers to create and to strengthen the community and motivation.</em></p>\n<h3>Conclusions</h3>\n<p>It was only the first edition, but every detail was at a very high standard. In\nthe last days, we presented with Traian Rebedea the advantages of having the\nnext Summer School edition here in Bucharest. Looking forward to TMLSS2019 :)</p>\n"}]},"siteData":{"title":"Bitdefender Machine Learning & Crypto Research Unit","description":"Bitdefender Machine Learning & Crypto Research Unit goals are to further the fields of machine learning and criptography while engaging with the international research community and to develop the local AI&ML scene by supporting and participating in local conferences, lecture and research groups.","tagline":"Engaging with the broader Machine Learning Community.","tags":["machine-learning","research","bitdefender"]}};</script><script defer="" type="text/javascript" src="https://bit-ml.github.io/bootstrap.627376fc.js"></script><script defer="" type="text/javascript" src="https://bit-ml.github.io/templates/src/pages/Blog.f1b2c635.js"></script><script defer="" type="text/javascript" src="https://bit-ml.github.io/main.6dead43a.js"></script></body></html>