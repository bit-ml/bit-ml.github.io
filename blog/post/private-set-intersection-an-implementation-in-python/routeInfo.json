{"path":"blog/post/private-set-intersection-an-implementation-in-python","templateID":2,"sharedPropsHashes":{"galleries":"ZHT1Kz"},"localProps":{"post":{"data":{"slug":"private-set-intersection-an-implementation-in-python","authors":"MƒÉdƒÉlina Bolboceanu, Miruna Ro»ôca, Radu »öi»õiu","categories":"blog","featured_img":"/galleries/private_set2021/monolith.jpg","date":"May-21-2021","title":"Private Set Intersection from Homomorphic Encryption: A Python Implementation","id":5},"messages":[],"history":["./content/collections/posts/private_set_intersection2021.md","content/collections/posts/private_set_intersection2021.html"],"cwd":"/Users/fbrad/bit/bit-ml","contents":"<h1>Private Set Intersection from Homomorphic Encryption: A Python Implementation</h1>\n<p>Check out our <strong>Private Set Intersection (PSI)</strong> implementation in Python <a href=\"https://github.com/bit-ml/Private-Set-Intersection\">here</a>!</p>\n<p>In this blog post, we will first motivate our interest in <strong>PSI</strong>, by providing a list of applications: password checkup, private contact discovery for Whatsapp or Signal, measuring ads efficiency privately or DNA pattern matching. Secondly, we will show how to build a <strong>PSI</strong> protocol using a <strong>HE</strong> encryption scheme. Thirdly, we will describe our Python implementation of a specific <strong>PSI</strong> protocol.</p>\n<p>Our implementation is based on the protocol described in this <a href=\"https://eprint.iacr.org/2017/299.pdf\">paper</a> and its <a href=\"https://eprint.iacr.org/2018/787.pdf\">follow-up</a>. This protocol uses <strong>Homomorphic Encryption (HE)</strong>, a powerful cryptographic primitive which allows performing computations on encrypted data in such a way that only the secret key holder has access to the decryption of the result of these computations. If you are curious about <strong>HE</strong>, check out <a href=\"https://bit-ml.github.io/blog/post/homomorphic-encryption-toy-implementation-in-python/\">our previous blog post</a>! Our implementation uses the <a href=\"https://eprint.iacr.org/2012/144.pdf\">BFV</a> Brakerski-Fan-Vercauteren  <strong>HE</strong> scheme from the <a href=\"https://github.com/OpenMined/TenSEAL\">TenSEAL</a> library. You can also check out a concurrent <a href=\"https://github.com/microsoft/SEAL\">SEAL</a>-based <a href=\"https://github.com/microsoft/APSI\">C++ implementation</a> of the same protocol that has been recently published by   Microsoft.</p>\n<p><strong>Disclaimer:</strong> Our implementation is not meant for production use. Use it at your own risk.</p>\n<h2>1. Private Set Intersection (<strong>PSI</strong>)</h2>\n<p>Private Set Intersection (<strong>PSI</strong>) is an interactive protocol between a client and a server. The client holds a set of items <span><span><span>YY</span><span aria-hidden=\"true\"><span><span></span><span>Y</span></span></span></span></span> and the server holds a set of items <span><span><span>XX</span><span aria-hidden=\"true\"><span><span></span><span>X</span></span></span></span></span>. By the end of the protocol, the client learns the intersection of <span><span><span>XX</span><span aria-hidden=\"true\"><span><span></span><span>X</span></span></span></span></span> and <span><span><span>YY</span><span aria-hidden=\"true\"><span><span></span><span>Y</span></span></span></span></span> and nothing else about the server's set, while the server learns nothing about the client's data.</p>\n<h3>Motivation</h3>\n<p>Imagine that a WhatsApp client would like to check who among his phone contacts also uses WhatsApp. To get this information, he could send his entire contact list to the WhatsApp server and the server could answer him back with the list of his contacts who use the app. In this way, the server learns the client's list of contacts ‚ö†Ô∏è. The client may not be happy about this because he values his privacy. Ideally, a client would like to <strong>privately</strong> learn who, among his contacts, uses the app, <strong>without revealing his entire list to the WhatsApp server</strong>. Here is the place where Private Set Intersection comes to the rescue.</p>\n<p><img src=\"https://i.imgur.com/CRyDlK2.png\" alt=\"\"></p>\n<h3>What is <strong>PSI</strong>?</h3>\n<p>Suppose Alice has a list of friends <strong>A</strong> and Bob has a list of friends <strong>B</strong>. Alice is interested in finding out their mutual friends and Bob is ok to share this information with her. Of course, Alice would easily find this out if Bob gave her his list. Or, Alice could send her list to Bob and Bob could answer her back with the information that she is interested in. But both Alice and Bob value their privacy and neither of them wants to reveal his/her entire list of friends to the other.</p>\n<p><img src=\"https://i.imgur.com/QSq2yxQ.png\" alt=\"\"></p>\n<p><strong>PSI</strong> is an interactive cryptographic protocol which allows Alice to find out the friends that she has in common with Bob and nothing else about the rest of Bob's friends and prevents Bob from learning any information about Alice's list of friends. As you can see now, a <strong>PSI</strong> protocol is everything we need to solve the Whatsapp problem that we have described in the last section.</p>\n<h3>Applications of <strong>PSI</strong></h3>\n<p><strong>PSI</strong> may be used in many practical applications:</p>\n<ol>\n<li>\n<p>üîë <strong>Password Checkup</strong>: A client wants to check if his credentials are leaked somewhere on the internet. <strong>PSI</strong> allows the client to query a database of leaked passwords, without revealing his actual password to the database owner.</p>\n</li>\n<li>\n<p>üî¨ <strong>DNA private matching</strong>: A client gets his DNA sequenced and wants to find out if his sequence is related to some genetic disease. <strong>PSI</strong> allows the client to query a database of disease-linked sequences, without revealing his DNA sequence.</p>\n</li>\n<li>\n<p>üöó <strong>Measuring ads efficiency</strong>: A car company owners want to measure how efficient are the ads for which they have paid. <strong>PSI</strong> allows the company to find out who among its clients have seen a specific ad on social media (on Facebook for instance), while the car company keeps its list of clients private and Facebook also keeps its list of users private.</p>\n</li>\n</ol>\n<h2>2. <strong>PSI</strong> from <strong>HE</strong></h2>\n<p>One of the first <strong>PSI</strong> protocols in the literature was proposed by Meadows in <a href=\"https://www.computer.org/csdl/proceedings-article/sp/1986/07160134/12OmNAYoKof%5D\">this paper</a> and uses as building block the Diffie-Hellman exchange protocol. As we said, in this blog post, we focus on a <strong>PSI</strong> protocol that uses <strong>HE</strong>. The <strong>HE</strong> approach works really well in the <em>asymmetric</em> case (i.e. the case where the size of the server's set is much larger than the size of the client's set), with especially great results in terms of communication costs. As you can imagine, this is exactly the case we are interested in: the WhatsApp's database is much larger than the database of a particular client.</p>\n<h3>Short recap on <strong>HE</strong></h3>\n<p>Let's recap a bit what <strong>HE</strong> is, first.  As nicely explained <a href=\"https://bit-ml.github.io/blog/post/homomorphic-encryption-toy-implementation-in-python/\">here</a> üòâ, this cryptographic primitive allows you to compute on encrypted data.</p>\n<p>In our implementation we use the <a href=\"https://eprint.iacr.org/2012/144.pdf\">BFV</a> <strong>HE</strong> scheme. This scheme encodes plaintexts as <strong>polynomials of degree less than</strong> <code>poly_modulus_degree</code> (which is a power of 2) with integer coefficients modulo <code>plain_modulus</code>. Because of the <em>homomorphic properties</em> of the scheme, for any plaintexts <span><span><span>m1,m2,mm_1, m_2, m</span><span aria-hidden=\"true\"><span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>m</span></span></span></span></span> and <span><span><span>pp</span><span aria-hidden=\"true\"><span><span></span><span>p</span></span></span></span></span>, we have that:</p>\n<div><span><span><span>Enc(m1)+Enc(m2)‚â°Enc(m1+m2)Enc(m1)‚ãÖEnc(m2)‚â°Enc(m1‚ãÖm2)p+Enc(m)‚â°Enc(p+m)p‚ãÖEnc(m)‚â°Enc(p‚ãÖm),\\begin{aligned}\n\\mathsf{Enc}(m_1) + \\mathsf{Enc}(m_2) &#x26;\\equiv \\mathsf{Enc}(m_1 + m_2)\\\\\n\\mathsf{Enc}(m_1) \\cdot \\mathsf{Enc}(m_2) &#x26;\\equiv \\mathsf{Enc}(m_1 \\cdot m_2)\\\\\np+\\mathsf{Enc}(m) &#x26;\\equiv \\mathsf{Enc}(p+ m)\\\\\np\\cdot\\mathsf{Enc}(m) &#x26;\\equiv \\mathsf{Enc}(p\\cdot m)\n\\end{aligned},</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span><span><span></span><span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>‚ãÖ</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span><span><span></span><span><span>p</span><span></span><span>+</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>m</span><span>)</span></span></span><span><span></span><span><span>p</span><span></span><span>‚ãÖ</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>m</span><span>)</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>‚â°</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>‚â°</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span><span><span>m</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>‚â°</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span></span><span>+</span><span></span><span>m</span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>‚â°</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span></span><span>‚ãÖ</span><span></span><span>m</span><span>)</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span><span>,</span></span></span></span></span></div>\n<p>Since using <a href=\"https://eprint.iacr.org/2012/144.pdf\">BFV</a> we can perform additions and multiplications homomorphically on ciphertexts, then we can also evaluate polynomials homomorphically. So cool, no? Still, keep in mind that the parameters of the scheme usually allow performing only a limited number of multiplications! We will get back to this observation soon.</p>\n<h3>How to get <strong>PSI</strong> from <strong>HE</strong></h3>\n<p>In the rest of this section, we will show you the intuition behind building a <strong>PSI</strong> protocol from a <strong>HE</strong> scheme. We will build this intuition step by step, by starting with very particular cases.</p>\n<p>Case <strong>a.</strong> Alice has just one friend <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> and Bob also has just one friend <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span> (it's unlikely, but who knows, maybe they are both extremely selective üßê when it comes to friendships).</p>\n<p>üí° <strong>Let's see how they may use the magic of HE</strong>: Alice encrypts her <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> using a <strong>HE</strong> scheme, gets <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> and sends it to Bob. Now Bob subtracts his <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span> from <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> and multiplies this result by a random nonzero integer <span><span><span>rr</span><span aria-hidden=\"true\"><span><span></span><span>r</span></span></span></span></span>. Due to the üí™ of <strong>HE</strong>, the result of Bob's computation is actually an encryption of <span><span><span>r‚ãÖ(y‚àíx)r\\cdot(y-x)</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>(</span><span>y</span><span></span><span>‚àí</span><span></span></span><span><span></span><span>x</span><span>)</span></span></span></span></span>. He sends <span><span><span>Enc(r‚ãÖ(y‚àíx))\\mathsf{Enc}(r\\cdot(y-x))</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>r</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>(</span><span>y</span><span></span><span>‚àí</span><span></span></span><span><span></span><span>x</span><span>)</span><span>)</span></span></span></span></span> back to Alice. Alice now decrypts this element using her secret key and she checks whether she gets a <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span> or not. If she gets a <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span>, her friend <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> is the same as Bob's friend <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span>. Otherwise, their friends are different.</p>\n<p><img src=\"https://i.imgur.com/kH6ixJv.png\" alt=\"\"></p>\n<p>‚ùó For the ease of understanding, throughout this section, we will assume that both the plaintexts (<span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span>, <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span>, etc.) and the ciphertexts produced by the <strong>HE</strong> scheme are integers.</p>\n<p>ü§î <strong>Why does it work?</strong>  When she decrypts, Alice recovers the product <span><span><span>r‚ãÖ(y‚àíx)r\\cdot(y-x)</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>(</span><span>y</span><span></span><span>‚àí</span><span></span></span><span><span></span><span>x</span><span>)</span></span></span></span></span>. If this product is <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span>, it means that one of its terms (<span><span><span>rr</span><span aria-hidden=\"true\"><span><span></span><span>r</span></span></span></span></span> or <span><span><span>y‚àíxy-x</span><span aria-hidden=\"true\"><span><span></span><span>y</span><span></span><span>‚àí</span><span></span></span><span><span></span><span>x</span></span></span></span></span>) is <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span>. Since <span><span><span>rr</span><span aria-hidden=\"true\"><span><span></span><span>r</span></span></span></span></span> is chosen to be nonzero, it automatically means that <span><span><span>y‚àíx=0y-x=0</span><span aria-hidden=\"true\"><span><span></span><span>y</span><span></span><span>‚àí</span><span></span></span><span><span></span><span>x</span><span></span><span>=</span><span></span></span><span><span></span><span>0</span></span></span></span></span> and Alice will know that her friend <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> is also Bob's friend.</p>\n<p>If the product is not <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span>, it means that <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span> and <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> are for sure different. Moreover, if we assume that the <strong>HE</strong> scheme has \"circuit privacy\" (in other words, if we assume that Alice may never find out information about the random element <span><span><span>rr</span><span aria-hidden=\"true\"><span><span></span><span>r</span></span></span></span></span> used by Bob), then the value <span><span><span>r‚ãÖ(y‚àíx)r\\cdot(y-x)</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>(</span><span>y</span><span></span><span>‚àí</span><span></span></span><span><span></span><span>x</span><span>)</span></span></span></span></span> recovered by Alice will look random to her and she will never learn any information about Bob's <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span>.</p>\n<p>Case <strong>b</strong>. Alice still has one friend <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span>, but Bob has many friends <span><span><span>x0,...,xnx_0,...,x_n</span><span aria-hidden=\"true\"><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>.</span><span>.</span><span>.</span><span>,</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>Let's assume that Bob has 10 friends (<span><span><span>n=9n=9</span><span aria-hidden=\"true\"><span><span></span><span>n</span><span></span><span>=</span><span></span></span><span><span></span><span>9</span></span></span></span></span>). He chooses a random nonzero integer <span><span><span>rr</span><span aria-hidden=\"true\"><span><span></span><span>r</span></span></span></span></span> and associates to his list of friends the monic polynomial</p>\n<div><span><span><span>P(X)=r‚ãÖ(X‚àíx0)‚ãÖ‚Ä¶‚ãÖ(X‚àíx9).P(X) = r\\cdot (X-x_0) \\cdot \\ldots \\cdot (X-x_9).</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span>X</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>r</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>‚àí</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>‚Ä¶</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>‚àí</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>9</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>.</span></span></span></span></span></div>\n<p>‚ùó Keep in mind that <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> vanishes at <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span> if and only if <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span> belongs to the set <span><span><span>{x0,‚Ä¶,x9}\\{x_0,\\ldots,x_9\\}</span><span aria-hidden=\"true\"><span><span></span><span>{</span><span><span>x</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>9</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>}</span></span></span></span></span>.</p>\n<p><strong>üí° Here is the place where HE comes into play</strong>: Alice encrypts her element <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> with a <strong>HE</strong> scheme, gets <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> and sends it to Bob. Bob now evaluates his secret polynomial <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> at <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> and sends the result back to Alice. Because of the homomorphic properties of the encryption scheme, <span><span><span>P(Enc(y))‚â°Enc(P(y))P(\\mathsf{Enc}(y)) \\equiv \\mathsf{Enc}(P(y))</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span><span>)</span><span></span><span>‚â°</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>P</span><span>(</span><span>y</span><span>)</span><span>)</span></span></span></span></span>, which means that Bob actually sends to Alice an encryption of <span><span><span>P(y)P(y)</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span>y</span><span>)</span></span></span></span></span>. When Alice decrypts this value, she checks if it is equal to <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span> or not. If it is <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span>, it means that her friend <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> is also a friend of Bob. Otherwise, <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> is not among Bob's friends.</p>\n<p><img src=\"https://i.imgur.com/X8vMiPk.png\" alt=\"\"></p>\n<p>ü§î <strong>Why does it work?</strong>  When she decrypts, Alice recovers the product <span><span><span>r‚ãÖ(y‚àíx0)‚ãÖ‚Ä¶‚ãÖ(y‚àíx9)r\\cdot(y-x_0)\\cdot \\ldots \\cdot(y-x_9)</span><span aria-hidden=\"true\"><span><span></span><span>r</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>(</span><span>y</span><span></span><span>‚àí</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>‚Ä¶</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>(</span><span>y</span><span></span><span>‚àí</span><span></span></span><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>9</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>. As in Case <strong>a</strong>, this product is <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span> if and only if <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> is one of Bob's friends.</p>\n<p>Case <strong>c</strong>. Alice has many friends, Bob has many friends too.</p>\n<p>This is the more general case. At this point you may already have an idea  ü§ì on how to solve it! Indeed, Alice and Bob could just repeat the protocol from Case <strong>b</strong> for every friend of Alice! So easy, right?</p>\n<p>Still, at this moment you already ask yourself:</p>\n<ol>\n<li>What happens if Alice has a lot of friends?</li>\n</ol>\n<p>In this case, the communication size will grow dramatically since you should repeat the protocol from Case <strong>b</strong> for every friend of Alice. In conclusion, this trivial solution may not be efficient in practice.</p>\n<ol start=\"2\">\n<li>What happens if Bob has a lot of friends?</li>\n</ol>\n<p>In this case, Bob has to evaluate homomorphically a polynomial of a very large degree. But this may be impossible, since a typical homomorphic encryption scheme allows performing homomorphically only a limited number of multiplications. The reason for this is not hard to understand, read about the noise growing in <strong>HE</strong> <a href=\"https://bit-ml.github.io/blog/post/homomorphic-encryption-toy-implementation-in-python/\">here</a>!</p>\n<p><strong>Towards a more practical PSI protocol</strong>. In the next section, we will show you how to tackle the above two problems. Concretely, we will describe a range of <strong>optimizations</strong> that we can apply in order to make the above solution work in practice.</p>\n<h2>3. Implementing the <strong>PSI</strong> protocol</h2>\n<p>Before giving more details about the actual implementation, we are going to discuss some of the ideas that enable the basic protocol (Case <strong>c</strong>) to become practical. We will also give an intuition on how <strong>HE</strong> and Oblivious Pseudorandom Functions (<strong>OPRFs</strong>) provide privacy for both the client and the server.</p>\n<h3>Optimizations for a practical protocol ‚öôÔ∏è</h3>\n<p>Suppose the server holds a set of items <span><span><span>XX</span><span aria-hidden=\"true\"><span><span></span><span>X</span></span></span></span></span> and the client has a much smaller set <span><span><span>YY</span><span aria-hidden=\"true\"><span><span></span><span>Y</span></span></span></span></span>. In the basic protocol (Case <strong>c</strong>), the client has to send an individual encryption for each element in the set <span><span><span>Y={y0,y1,y2,‚Ä¶}Y=\\{y_0,y_1,y_2,\\ldots\\}</span><span aria-hidden=\"true\"><span><span></span><span>Y</span><span></span><span>=</span><span></span></span><span><span></span><span>{</span><span><span>y</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>‚Ä¶</span><span>}</span></span></span></span></span>. This means that the communication cost is proportional to <span><span><span>‚à£Y‚à£|Y|</span><span aria-hidden=\"true\"><span><span></span><span>‚à£</span><span>Y</span><span>‚à£</span></span></span></span></span> and we write this as <span><span><span>O(‚à£Y‚à£)O(|Y|)</span><span aria-hidden=\"true\"><span><span></span><span>O</span><span>(</span><span>‚à£</span><span>Y</span><span>‚à£</span><span>)</span></span></span></span></span>. The server has to homomorphically evaluate the polynomial <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> at each ciphertext. This implies a computational cost proportional to <span><span><span>‚à£Y‚à£√óHomomorphic.Evaluation(P)|Y|\\times \\mathsf{Homomorphic.Evaluation}(P)</span><span aria-hidden=\"true\"><span><span></span><span>‚à£</span><span>Y</span><span>‚à£</span><span></span><span>√ó</span><span></span></span><span><span></span><span><span>H</span><span>o</span><span>m</span><span>o</span><span>m</span><span>o</span><span>r</span><span>p</span><span>h</span><span>i</span><span>c</span><span>.</span><span>E</span><span>v</span><span>a</span><span>l</span><span>u</span><span>a</span><span>t</span><span>i</span><span>o</span><span>n</span></span><span>(</span><span>P</span><span>)</span></span></span></span></span>. For simplicity let's assume that the computational cost of evaluating the polynomial <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> is proportional to its degree, which is just the size of the server set <span><span><span>‚à£X‚à£|X|</span><span aria-hidden=\"true\"><span><span></span><span>‚à£</span><span>X</span><span>‚à£</span></span></span></span></span>. So we can simply say that the computational cost of the server is <span><span><span>O(‚à£X‚à£‚ãÖ‚à£Y‚à£)O(|X|\\cdot |Y|)</span><span aria-hidden=\"true\"><span><span></span><span>O</span><span>(</span><span>‚à£</span><span>X</span><span>‚à£</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>‚à£</span><span>Y</span><span>‚à£</span><span>)</span></span></span></span></span>.</p>\n<h4>Batching</h4>\n<p>The <em>batching</em> technique in Homomorphic Encryption is usually used to enable <em>Single Instruction Multiple Data (SIMD)</em> operations on ciphertexts. Broadly speaking, this allows the client to 'batch' <span><span><span>NN</span><span aria-hidden=\"true\"><span><span></span><span>N</span></span></span></span></span> items from the set <span><span><span>YY</span><span aria-hidden=\"true\"><span><span></span><span>Y</span></span></span></span></span> into a single ciphertext and the server can simultaneously do computations on the encrypted items. For the <strong>PSI</strong> protocol, it means that batching can reduce the client to server communication as well as the computational cost of the server.\n<img src=\"https://i.imgur.com/Ece1O9c.png\" alt=\"\"></p>\n<p>In the above diagram you can see how batching works for multiplication. But it works similarly for addition or any homomorphic operation supported by the scheme.</p>\n<p><img src=\"https://i.imgur.com/E1VHdc4.png\" alt=\"\"></p>\n<p>Notice that running the basic protocol using a <strong>HE</strong> scheme that supports batching, the client is able to send fewer ciphertexts <span><span><span>‚à£Y‚à£/N|Y|/N</span><span aria-hidden=\"true\"><span><span></span><span>‚à£</span><span>Y</span><span>‚à£</span><span>/</span><span>N</span></span></span></span></span> and the computational cost of the server drops as well, proportionally to <span><span><span>‚à£X‚à£‚ãÖ‚à£Y‚à£/N|X|\\cdot |Y| /N</span><span aria-hidden=\"true\"><span><span></span><span>‚à£</span><span>X</span><span>‚à£</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>‚à£</span><span>Y</span><span>‚à£</span><span>/</span><span>N</span></span></span></span></span> because the server can homomorphically evaluate the polynomial <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> at all the <span><span><span>NN</span><span aria-hidden=\"true\"><span><span></span><span>N</span></span></span></span></span> inputs simultaneously.</p>\n<p>Conveniently, the <strong>HE</strong> scheme <a href=\"https://eprint.iacr.org/2012/144.pdf\">BFV</a> supports batching and the TenSEAL library makes it very easy to take advantage of it. In fact, when using TenSEAL, you don't need to know how batching actually works under the hood (it uses the <a href=\"https://en.wikipedia.org/wiki/Chinese_remainder_theorem\">CRT representation</a>), as the implementation does the batching by default (plaintexts are represented as vectors of integers and homomorphic operations act component-wise on the plaintexts).</p>\n<h4>Hashing</h4>\n<p>Remember that the <strong>HE</strong> scheme can't support too many multiplications. Concretely, the scheme correctly works only when the homomorphic computation  is expressed as a circuit (additions/multiplications gates) with <em>'small' multiplication depth</em>. To be more precise, in our case, the multiplicative depth corresponding to the parameters of the Brakerski-Fan-Vercauteren scheme implemented in TenSEAL is <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span> or <span><span><span>44</span><span aria-hidden=\"true\"><span><span></span><span>4</span></span></span></span></span>. So, for the rest of the blog post, we will assume that the <strong>HE scheme supports only computations of multiplicative depth <span><span><span>‚â§3\\leq 3</span><span aria-hidden=\"true\"><span><span></span><span>‚â§</span><span></span></span><span><span></span><span>3</span></span></span></span></span></strong>. You have below two examples for which decryption  works correctly.\n<img src=\"https://i.imgur.com/1eDqyRF.png\" alt=\"\"></p>\n<p>This is a major problem if we want to use the basic protocol because the server is limited to homomorphic evaluations of polynomials of degree at most <span><span><span>88</span><span aria-hidden=\"true\"><span><span></span><span>8</span></span></span></span></span>. So the set of the server can't be larger than <span><span><span>88</span><span aria-hidden=\"true\"><span><span></span><span>8</span></span></span></span></span>. This is not really satisfying as we would like the server to have millions of items ü§Ø. So how to increase the number of items on the server side? ü§î</p>\n<p>The first thing one can do is to partition the set of the server <span><span><span>X=X0‚à™X1‚à™‚Ä¶‚à™Xm‚àí1X=X_{0} \\cup X_{1} \\cup \\ldots \\cup X_{m-1}</span><span aria-hidden=\"true\"><span><span></span><span>X</span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>0</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚à™</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚à™</span><span></span></span><span><span></span><span>‚Ä¶</span><span></span><span>‚à™</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>m</span><span>‚àí</span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and the set of the client <span><span><span>Y=Y0‚à™Y1‚à™‚Ä¶‚à™Ym‚àí1Y=Y_0\\cup Y_1 \\cup \\ldots \\cup Y_{m-1}</span><span aria-hidden=\"true\"><span><span></span><span>Y</span><span></span><span>=</span><span></span></span><span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚à™</span><span></span></span><span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚à™</span><span></span></span><span><span></span><span>‚Ä¶</span><span></span><span>‚à™</span><span></span></span><span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span><span>m</span><span>‚àí</span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> into 'bins', using some agreed upon hash function <span><span><span>h:U‚Üí{0,1,2,‚Ä¶,m‚àí1}h:\\mathcal{U} \\to \\{0,1,2,\\ldots,m-1\\}</span><span aria-hidden=\"true\"><span><span></span><span>h</span><span></span><span>:</span><span></span></span><span><span></span><span><span>U</span></span><span></span><span>‚Üí</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>,</span><span></span><span>2</span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span>m</span><span></span><span>‚àí</span><span></span></span><span><span></span><span>1</span><span>}</span></span></span></span></span>, with both sets <span><span><span>X,YX,Y</span><span aria-hidden=\"true\"><span><span></span><span>X</span><span>,</span><span></span><span>Y</span></span></span></span></span> contained in <span><span><span>U\\mathcal{U}</span><span aria-hidden=\"true\"><span><span></span><span><span>U</span></span></span></span></span></span>. Items fall into the same 'bin' if they hash to the same value.\n<img src=\"https://i.imgur.com/AJO8FOu.png\" alt=\"\"></p>\n<p>Now we can run the basic protocol (Case <strong>c</strong>) <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span> times on the pairs of sets <span><span><span>(Xi,Yi)(X_i ,Y_i)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> to find the intersection of <span><span><span>XX</span><span aria-hidden=\"true\"><span><span></span><span>X</span></span></span></span></span> and <span><span><span>YY</span><span aria-hidden=\"true\"><span><span></span><span>Y</span></span></span></span></span>. Notice that this optimization can dramatically reduce the computational cost of the server from <span><span><span>‚à£X‚à£‚ãÖ‚à£Y‚à£|X|\\cdot |Y|</span><span aria-hidden=\"true\"><span><span></span><span>‚à£</span><span>X</span><span>‚à£</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>‚à£</span><span>Y</span><span>‚à£</span></span></span></span></span> down to <span><span><span>‚àëi=0m‚àí1‚à£Xi‚à£‚ãÖ‚à£Yi‚à£\\displaystyle \\sum_{i=0}^{m-1} |X_i|\\cdot |Y_i|</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>‚àë</span></span></span><span><span></span><span><span><span>m</span><span>‚àí</span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span><span></span><span>‚à£</span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>‚à£</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>‚à£</span><span><span>Y</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>‚à£</span></span></span></span></span>. Moreover, this strategy also allows for a much larger server set (<span><span><span>‚à£X‚à£‚â´8|X| \\gg 8</span><span aria-hidden=\"true\"><span><span></span><span>‚à£</span><span>X</span><span>‚à£</span><span></span><span>‚â´</span><span></span></span><span><span></span><span>8</span></span></span></span></span>), because the server runs the basic protocol on the smaller sets <span><span><span>XiX_i</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. So it's enough to have <span><span><span>‚à£Xi‚à£‚â§8|X_i|\\leq 8</span><span aria-hidden=\"true\"><span><span></span><span>‚à£</span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>‚à£</span><span></span><span>‚â§</span><span></span></span><span><span></span><span>8</span></span></span></span></span> for all bins to be able to intersect <span><span><span>X‚à©YX\\cap Y</span><span aria-hidden=\"true\"><span><span></span><span>X</span><span></span><span>‚à©</span><span></span></span><span><span></span><span>Y</span></span></span></span></span> in this way.</p>\n<p>For security reasons, the client must pad its bins with some dummy messages to hide the cardinality of each bin, before engaging in the interaction with the server. By doing the padding, all the client's bins have the same number of items, let's call this number <span><span><span>BYB_Y</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> (notice that <span><span><span>‚à£Y‚à£&#x3C;m‚ãÖBY|Y| &#x3C; m\\cdot B_Y</span><span aria-hidden=\"true\"><span><span></span><span>‚à£</span><span>Y</span><span>‚à£</span><span></span><span>&#x3C;</span><span></span></span><span><span></span><span>m</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>). For example, for <span><span><span>X=Y={0,1,‚Ä¶,m‚àí1}X=Y=\\{0,1,\\ldots,m-1\\}</span><span aria-hidden=\"true\"><span><span></span><span>X</span><span></span><span>=</span><span></span></span><span><span></span><span>Y</span><span></span><span>=</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span>m</span><span></span><span>‚àí</span><span></span></span><span><span></span><span>1</span><span>}</span></span></span></span></span> and a uniformly random 'hash' function <span><span><span>h:{0,1,2,‚Ä¶,m‚àí1}‚Üí{0,1,2,‚Ä¶,m‚àí1}h:\\{0,1,2,\\ldots,m-1\\} \\to \\{0,1,2,\\ldots,m-1\\}</span><span aria-hidden=\"true\"><span><span></span><span>h</span><span></span><span>:</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>,</span><span></span><span>2</span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span>m</span><span></span><span>‚àí</span><span></span></span><span><span></span><span>1</span><span>}</span><span></span><span>‚Üí</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>,</span><span></span><span>2</span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span>m</span><span></span><span>‚àí</span><span></span></span><span><span></span><span>1</span><span>}</span></span></span></span></span>, we have <span><span><span>BY=O(log‚Å°m)B_Y=O(\\log m)</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>O</span><span>(</span><span>lo<span>g</span></span><span></span><span>m</span><span>)</span></span></span></span></span> with high probability (see the <a href=\"https://en.wikipedia.org/wiki/Balls_into_bins_problem\">Balls and Bins Problem</a>). In this setting, the computational cost of the server is now <span><span><span>O(mlog‚Å°m)O(m\\log m)</span><span aria-hidden=\"true\"><span><span></span><span>O</span><span>(</span><span>m</span><span></span><span>lo<span>g</span></span><span></span><span>m</span><span>)</span></span></span></span></span> and the client to server communication is <span><span><span>O(mlog‚Å°m)O(m\\log m)</span><span aria-hidden=\"true\"><span><span></span><span>O</span><span>(</span><span>m</span><span></span><span>lo<span>g</span></span><span></span><span>m</span><span>)</span></span></span></span></span>.</p>\n<p>‚ùó Using batching, both costs go down by a factor of <span><span><span>NN</span><span aria-hidden=\"true\"><span><span></span><span>N</span></span></span></span></span>. To keep the exposition simple we ignore that for now. But keep in mind that we can always use it to get better performance.</p>\n<p>To get a feel for why the padding is necessary, suppose that the bin <span><span><span>Y3Y_3</span><span aria-hidden=\"true\"><span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> is empty and the client doesn't pad it. This means that nothing is sent corresponding to this bin and the server will be able to learn that the client doesn't hold any elements that hash to <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>. This is valuable information that the server should not be able to learn from the execution of the protocolüòü.</p>\n<p>In general, if we do the padding on the client side, the actual computational cost of the server is proportional to <span><span><span>‚àëi=0m‚àí1‚à£Xi‚à£‚ãÖBY\\sum_{i=0}^{m-1} |X_i|\\cdot B_Y</span><span aria-hidden=\"true\"><span><span></span><span><span>‚àë</span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span><span>m</span><span>‚àí</span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚à£</span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>‚à£</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and the communication cost is actually proportional to <span><span><span>‚àëi=0m‚àí1BY=m‚ãÖBY\\sum_{i=0}^{m-1} B_Y= m\\cdot B_Y</span><span aria-hidden=\"true\"><span><span></span><span><span>‚àë</span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span><span>m</span><span>‚àí</span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>m</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>To minimize the costs, we would like some kind of hash function (table) with a range <span><span><span>{0,1,‚Ä¶,m‚àí1}\\{0,1,\\ldots,m-1\\}</span><span aria-hidden=\"true\"><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span>m</span><span></span><span>‚àí</span><span></span></span><span><span></span><span>1</span><span>}</span></span></span></span></span> as small as possible but sufficiently large to map the set of the client with few collisions as possible. A good candidate is the so-called <a href=\"https://en.wikipedia.org/wiki/Cuckoo_hashing#cite_note-Cuckoo-1\">Cuckoo Hash table</a> üê¶, which works for <span><span><span>‚à£Y‚à£‚âà23‚ãÖm|Y|\\approx \\frac{2}{3} \\cdot m</span><span aria-hidden=\"true\"><span><span></span><span>‚à£</span><span>Y</span><span>‚à£</span><span></span><span>‚âà</span><span></span></span><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>3</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>2</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>m</span></span></span></span></span> and guarantees that there are no collisions (i.e. <span><span><span>BY=1B_Y=1</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>Y</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>1</span></span></span></span></span>) when hashing the client set <span><span><span>YY</span><span aria-hidden=\"true\"><span><span></span><span>Y</span></span></span></span></span>. For <span><span><span>‚à£X‚à£=m|X|=m</span><span aria-hidden=\"true\"><span><span></span><span>‚à£</span><span>X</span><span>‚à£</span><span></span><span>=</span><span></span></span><span><span></span><span>m</span></span></span></span></span> and <span><span><span>‚à£Y‚à£=2/3‚ãÖm|Y|=2/3\\cdot m</span><span aria-hidden=\"true\"><span><span></span><span>‚à£</span><span>Y</span><span>‚à£</span><span></span><span>=</span><span></span></span><span><span></span><span>2</span><span>/</span><span>3</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>m</span></span></span></span></span>, using Cuckoo hash tables, the computational cost and communication drop to <span><span><span>O(m)O(m)</span><span aria-hidden=\"true\"><span><span></span><span>O</span><span>(</span><span>m</span><span>)</span></span></span></span></span>, compared to the similar parameters of the previous example.</p>\n<p>In the actual protocol only the client uses Cuckoo hash tables. The server has to compute simple hash values that are compatible with the Cuckoo hash table structure.</p>\n<h4>Windowing</h4>\n<p>Let's suppose that the set <span><span><span>XX</span><span aria-hidden=\"true\"><span><span></span><span>X</span></span></span></span></span> of the server is partitioned into many bins <span><span><span>X=X0‚à™X1‚à™‚Ä¶‚à™Xm‚àí1X=X_{0} \\cup X_{1} \\cup \\ldots \\cup X_{m-1}</span><span aria-hidden=\"true\"><span><span></span><span>X</span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>0</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚à™</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚à™</span><span></span></span><span><span></span><span>‚Ä¶</span><span></span><span>‚à™</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>m</span><span>‚àí</span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. We denote the maximum bin capacity (load) by <span><span><span>BX=max‚Å°0‚â§i&#x3C;m‚à£Xi‚à£B_X=\\displaystyle \\max_{0\\leq i &#x3C;m} |X_i|</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>0</span><span>‚â§</span><span>i</span><span>&#x3C;</span><span>m</span></span></span></span><span><span></span><span><span>max</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span><span></span><span>‚à£</span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>‚à£</span></span></span></span></span>. We can currently run the protocol only when the parameters are chosen such that the maximum bin capacity is less than <span><span><span>88</span><span aria-hidden=\"true\"><span><span></span><span>8</span></span></span></span></span>. But the bound <span><span><span>88</span><span aria-hidden=\"true\"><span><span></span><span>8</span></span></span></span></span> can actually be <strong>increased</strong> for the <strong>same multiplicative depth</strong> üí•! This can be done by increasing the communication cost from the client to the server by the logarithmic factor <span><span><span>log‚Å°BX\\log B_X</span><span aria-hidden=\"true\"><span><span></span><span>lo<span>g</span></span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>üí°The idea is the following. The server needs to homomorphically evaluate the polynomials corresponding to each bin <span><span><span>XiX_i</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. This means that the server must be able to do homomorphic evaluations of polynomials of degree <span><span><span>BXB_X</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. Let's denote by <span><span><span>n=‚åälog‚Å°BX‚åãn=\\lfloor \\log B_X \\rfloor</span><span aria-hidden=\"true\"><span><span></span><span>n</span><span></span><span>=</span><span></span></span><span><span></span><span>‚åä</span><span>lo<span>g</span></span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>‚åã</span></span></span></span></span>. To intersect with one item <span><span><span>Y={y}Y = \\{y\\}</span><span aria-hidden=\"true\"><span><span></span><span>Y</span><span></span><span>=</span><span></span></span><span><span></span><span>{</span><span>y</span><span>}</span></span></span></span></span>, the client encrypts the powers <span><span><span>{y,y2,y22,y23,‚Ä¶,y2n}\\{y,y^2,y^{2^2},y^{2^3},\\ldots, y^{2^{n}}\\}</span><span aria-hidden=\"true\"><span><span></span><span>{</span><span>y</span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>}</span></span></span></span></span> and sends them to the server.\n<img src=\"https://i.imgur.com/KiIToNb.png\" alt=\"\"></p>\n<p>Now, for any power <span><span><span>k‚â§BXk\\leq B_X</span><span aria-hidden=\"true\"><span><span></span><span>k</span><span></span><span>‚â§</span><span></span></span><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> the server uses the binary representation of <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span>: <span><span><span>k=k0+k1‚ãÖ21+k2‚ãÖ22+‚ãØ+kn‚ãÖ2nk=k_0+k_1\\cdot 2^{1} + k_2\\cdot 2^{2} + \\cdots + k_n\\cdot 2^n</span><span aria-hidden=\"true\"><span><span></span><span>k</span><span></span><span>=</span><span></span></span><span><span></span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>1</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>k</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>2</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>‚ãØ</span><span></span><span>+</span><span></span></span><span><span></span><span><span>k</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span>, with <span><span><span>ki‚àà{0,1}k_i \\in \\{0,1\\}</span><span aria-hidden=\"true\"><span><span></span><span><span>k</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚àà</span><span></span></span><span><span></span><span>{</span><span>0</span><span>,</span><span></span><span>1</span><span>}</span></span></span></span></span>, to compute the encryption of <span><span><span>yky^k</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span></span></span></span></span></span></span></span></span> as <span><span><span>yk=yk0‚ãÖ(y21)k1‚ãÖ(y22)k2‚ãÖ(y23)k3‚ãÖ‚Ä¶‚ãÖ(y2n)kny^k=y^{k_0} \\cdot \\left( y^{2^1} \\right)^{k_1}\\cdot \\left( y^{2^2}\\right)^{k_2} \\cdot \\left(y^{2^3} \\right)^{k_3}\\cdot\\ldots \\cdot \\left(y^{2^n}\\right)^{k_n}</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>k</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span><span><span>(</span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span><span><span>k</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span><span><span>(</span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span><span><span>k</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span><span><span>(</span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span><span><span>k</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>‚Ä¶</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span><span><span>(</span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span><span><span>k</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>\nThis computation can be done in multiplicative depth equal to <span><span><span>‚åàlog‚Å°(n+1)‚åâ\\lceil\\log (n+1)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>‚åà</span><span>lo<span>g</span></span><span>(</span><span>n</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>‚åâ</span></span></span></span></span>. By keeping the multiplicative depth the same as before, equal to <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>, we can afford <span><span><span>n‚â§7n\\leq 7</span><span aria-hidden=\"true\"><span><span></span><span>n</span><span></span><span>‚â§</span><span></span></span><span><span></span><span>7</span></span></span></span></span>, which gives <span><span><span>BX‚â§255B_X\\leq 255</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚â§</span><span></span></span><span><span></span><span>2</span><span>5</span><span>5</span></span></span></span></span> . This means we can run the basic protocol on each bin as long as the maximum load <span><span><span>BXB_X</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> satisfies this bound.</p>\n<p>‚ùó Windowing <strong>is compatible</strong> with Batching. Do you see why? Suppose that at some point during the protocol, the client encrypts the batch <span><span><span>y\\bf{y}</span><span aria-hidden=\"true\"><span><span></span><span><span><span>y</span></span></span></span></span></span></span>=<span><span><span>(y0,y1,‚Ä¶,yN‚àí1)(y_0,y_1,\\ldots,y_{N-1})</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>N</span><span>‚àí</span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> and sends it to the server. To also make use of the windowing technique, the client first computes all the powers <span><span><span>{yi,yi2,yi4,‚Ä¶,yi2n}\\{y_i,y_i^2,y_i^4,\\ldots, y_i^{2^n}\\}</span><span aria-hidden=\"true\"><span><span></span><span>{</span><span><span>y</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>i</span></span></span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>i</span></span></span><span><span></span><span><span>4</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>i</span></span></span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>n</span></span></span></span></span></span></span></span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>}</span></span></span></span></span> needed for windowing and applies batching as below. Then the client sends all the ciphertexts to the server, as in the picture below.</p>\n<p><img src=\"https://i.imgur.com/DXpM0PU.png\" alt=\"\"></p>\n<p>Notice that the server is able to compute the encryption of <span><span><span>yk\\bf{y}^k</span><span aria-hidden=\"true\"><span><span></span><span><span><span><span>y</span></span><span><span><span><span><span><span></span><span><span>k</span></span></span></span></span></span></span></span></span></span></span></span></span>, for any <span><span><span>k‚â§BXk \\leq B_X</span><span aria-hidden=\"true\"><span><span></span><span>k</span><span></span><span>‚â§</span><span></span></span><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, by using the binary representation of <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span> and the ciphertexts sent by the client. In fact, the server can homomorphically evaluate its polynomial <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> at <span><span><span>y\\bf{y}</span><span aria-hidden=\"true\"><span><span></span><span><span><span>y</span></span></span></span></span></span></span> and send back the answer to the client. Now the client can decrypt to recover <span><span><span>P(y)P(\\bf{y})</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span><span><span>y</span></span><span>)</span></span></span></span></span></span>, then applies <span><span><span>Batch_decode\\texttt{Batch\\_decode}</span><span aria-hidden=\"true\"><span><span></span><span><span>Batch_decode</span></span></span></span></span></span> to recover <span><span><span>(P(y0),P(y1),‚Ä¶,P(yN‚àí1))(P(y_0),P(y_1),\\ldots, P(y_{N-1}))</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>P</span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>P</span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span>P</span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>N</span><span>‚àí</span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>)</span></span></span></span></span>.</p>\n<p>üåª In TenSEAL, <span><span><span>Batch_encode\\texttt{Batch\\_encode}</span><span aria-hidden=\"true\"><span><span></span><span><span>Batch_encode</span></span></span></span></span></span> and <span><span><span>Batch_decode\\texttt{Batch\\_decode}</span><span aria-hidden=\"true\"><span><span></span><span><span>Batch_decode</span></span></span></span></span></span> are done automatically, so we don't need to worry about them. You can simply think that when you evaluate the polynomial <span><span><span>PP</span><span aria-hidden=\"true\"><span><span></span><span>P</span></span></span></span></span> at a ciphertext that encrypts <span><span><span>(y0,y1,‚Ä¶,yN)(y_0,y_1,\\ldots,y_N)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span>, the evaluation is done component-wise, obtaining <span><span><span>(P(y0),P(y1),‚Ä¶,P(yN‚àí1))(P(y_0), P(y_1),\\ldots, P(y_{N-1}))</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span>P</span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>P</span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span>P</span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>N</span><span>‚àí</span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>)</span></span></span></span></span>.</p>\n<h4>Partitioning</h4>\n<p>We have seen how to increase the size of the server's set <span><span><span>‚à£X‚à£|X|</span><span aria-hidden=\"true\"><span><span></span><span>‚à£</span><span>X</span><span>‚à£</span></span></span></span></span> by using Hashing techniques and Windowing. We can increase it even further, but this time we increase it by paying an extra cost üí∞ for the server to client communication.</p>\n<p>To this end, let <span><span><span>Œ±\\alpha</span><span aria-hidden=\"true\"><span><span></span><span>Œ±</span></span></span></span></span> be a positive integer, the partitioning parameter. The idea is to further partition each bin <span><span><span>XiX_i</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> into <span><span><span>Œ±\\alpha</span><span aria-hidden=\"true\"><span><span></span><span>Œ±</span></span></span></span></span> mini bins, each of size less than <span><span><span>BX/Œ±B_X/\\alpha</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>/</span><span>Œ±</span></span></span></span></span>. We get a total number of <span><span><span>m‚ãÖŒ±m\\cdot \\alpha</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>Œ±</span></span></span></span></span> mini bins (<span><span><span>Œ±\\alpha</span><span aria-hidden=\"true\"><span><span></span><span>Œ±</span></span></span></span></span> mini bins for each of the <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span> bins). Then, for each mini bin, the corresponding polynomial is computed. Therefore to answer the client's query, the server has to homomorphically evaluate <span><span><span>m‚ãÖŒ±m\\cdot \\alpha</span><span aria-hidden=\"true\"><span><span></span><span>m</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>Œ±</span></span></span></span></span> polynomials. Notice that the degrees of all these polynomials are less than <span><span><span>BX/Œ±B_X/\\alpha</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>/</span><span>Œ±</span></span></span></span></span>. Now the server runs the basic protocol (+ windowing) for these mini bins. Notice that as long as <span><span><span>BX/Œ±‚â§255B_X /\\alpha \\leq 255</span><span aria-hidden=\"true\"><span><span></span><span><span>B</span><span><span><span><span><span><span></span><span><span>X</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>/</span><span>Œ±</span><span></span><span>‚â§</span><span></span></span><span><span></span><span>2</span><span>5</span><span>5</span></span></span></span></span> the protocol works. The effects of this change are:</p>\n<p>‚úîÔ∏è With partitioning the protocol supports even larger server sets. The reason is that the bins <span><span><span>XiX_i</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> can now handle up to <span><span><span>Œ±‚ãÖ255\\alpha \\cdot 255</span><span aria-hidden=\"true\"><span><span></span><span>Œ±</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>2</span><span>5</span><span>5</span></span></span></span></span> items. Since the bins are much larger, the server set can now be much larger!</p>\n<p>‚ùå The downside of using partitioning is that the server to client communication is increased by a factor of <span><span><span>Œ±\\alpha</span><span aria-hidden=\"true\"><span><span></span><span>Œ±</span></span></span></span></span>, because for each mini bin the server has to send back a corresponding answer to the client.</p>\n<h3>Security üîê</h3>\n<p>The security of the protocol prevents a potentially malicious server (one that is able to deviate from the honest protocol) from learning any information about the set of the client. Vice versa, the server's privacy is also protected against a possibly malicious client.</p>\n<p>Intuitively, the set of the client is encrypted when it is sent to the server, so a potentially malicious server is not able to learn anything from the ciphertexts, regardless of what the server does with these encryptions.</p>\n<p>When it comes to the privacy of the server, first recall that the server homomorphically evaluates a polynomial (closely related to its set) at the ciphertexts sent by the client.\nA malicious client who also has access to the randomness used for encryption and to the secret decryption key may use the result of this computation to infer information about the computation done by the server, in particular about the server's set. This is possible because the <a href=\"https://eprint.iacr.org/2012/144.pdf\">BFV</a> homomorphic encryption scheme does not have <em>circuit privacy</em>, which means that the scheme itself does not hide the computation that has been carried out on a ciphertext. The privacy of the server is guaranteed by the use of <em>Oblivious Pseudorandom Functions (OPRFs)</em>.</p>\n<h4>Oblivious PRFs</h4>\n<p>Let's consider a <a href=\"https://en.wikipedia.org/wiki/Pseudorandom_function_family\">Pseudorandom Function (PRF)</a> <span><span><span>FF</span><span aria-hidden=\"true\"><span><span></span><span>F</span></span></span></span></span>, that takes as input a secret key <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span> and some input and efficiently computes some output. As long as the key remains secret, the values that the <strong>PRF</strong> outputs 'look' completely 'random'. For intuition, you can think of the <a href=\"https://en.wikipedia.org/wiki/Advanced_Encryption_Standard\">AES</a> function.</p>\n<p>Assume that only the server knows the secret key <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span>. The server precomputes the set <span><span><span>X‚Ä≤:={Fk(x)¬†:¬†for¬†all¬†x‚ààX}X':=\\{ F_k(x) \\text{ : for all } x \\in X\\}</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>‚Ä≤</span></span></span></span></span></span></span></span></span><span></span><span>:</span></span><span><span></span><span>=</span><span></span></span><span><span></span><span>{</span><span><span>F</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>x</span><span>)</span><span><span>¬†:¬†for¬†all¬†</span></span><span>x</span><span></span><span>‚àà</span><span></span></span><span><span></span><span>X</span><span>}</span></span></span></span></span>. Now, assume that through some magic üîÆ(i.e. <strong>without having access to any information about the secret key</strong> <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span>), the client can compute <span><span><span>Fk(y)F_k(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>F</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> for all <span><span><span>y‚ààYy \\in Y</span><span aria-hidden=\"true\"><span><span></span><span>y</span><span></span><span>‚àà</span><span></span></span><span><span></span><span>Y</span></span></span></span></span>  and further create the set <span><span><span>Y‚Ä≤={Fk(y)¬†:¬†for¬†all¬†y‚ààY}Y'=\\{F_k(y)\\text{ : for all } y \\in Y \\}</span><span aria-hidden=\"true\"><span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span><span>‚Ä≤</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>{</span><span><span>F</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>y</span><span>)</span><span><span>¬†:¬†for¬†all¬†</span></span><span>y</span><span></span><span>‚àà</span><span></span></span><span><span></span><span>Y</span><span>}</span></span></span></span></span>. Now the two can engage in the <strong>PSI</strong> protocol for the sets <span><span><span>X‚Ä≤X'</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>‚Ä≤</span></span></span></span></span></span></span></span></span></span></span></span></span> and <span><span><span>Y‚Ä≤Y'</span><span aria-hidden=\"true\"><span><span></span><span><span>Y</span><span><span><span><span><span><span></span><span><span><span>‚Ä≤</span></span></span></span></span></span></span></span></span></span></span></span></span> to find their intersection, from which the client can deduce <span><span><span>X‚à©YX\\cap Y</span><span aria-hidden=\"true\"><span><span></span><span>X</span><span></span><span>‚à©</span><span></span></span><span><span></span><span>Y</span></span></span></span></span>.</p>\n<p>‚ùó One important thing is that in the eyes üëÄ of the client the set <span><span><span>X‚Ä≤X'</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>‚Ä≤</span></span></span></span></span></span></span></span></span></span></span></span></span> does not leak any information about the server set <span><span><span>XX</span><span aria-hidden=\"true\"><span><span></span><span>X</span></span></span></span></span>, as the secret key is unknown to the client. Therefore the privacy of the server is protected against a potentially malicious client!</p>\n<p><img src=\"https://i.imgur.com/P10n43A.png\" alt=\"\"></p>\n<p><strong>Oblivious PRF</strong> is an interactive protocol that replaces the above 'magic' üîÆ. Namely, it allows the client to learn the <strong>PRF</strong> values <span><span><span>Fk(y)F_k(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>F</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> (for some particular <strong>PRF</strong>), without having access to the secret key. In our implementation we use a Diffie-Hellman like <strong>OPRF</strong> protocol that is implemented using elliptic curve point additions.</p>\n<h3>The protocol</h3>\n<p>üîç Let's take a closer look at the <strong>PSI</strong> protocol. The server holds a list of <code>server_size</code> items, while the client holds a list of <code>client_size</code> items.</p>\n<p>Let us give you a bird's eye view on the protocol with all the steps:</p>\n<p><img src=\"https://i.imgur.com/OCnd34n.png\" alt=\"\"></p>\n<p>In the offline phase, both the server and the client preprocess their datasets. This offline preprocessing needs to be done only once by each party. The server preprocesses its set of items and then can engage in the online phase of the protocol many times with possible many clients. The vice-versa is also possible.</p>\n<ol>\n<li><strong>Oblivious Pseudorandom Function</strong> (<strong>OPRF</strong>): First, they apply an <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/oprf.py\">OPRF</a> layer to their inputs. For this, the two parties engage in a Diffie-Hellman-like interactive protocol on elliptic curves. The client and the server end up having their entries encoded in a <em>special way</em>, using the secret key of the server, <code>oprf_server_key</code>.  Basically, using a generator <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> of an elliptic curve, an entry (which is an integer) <code>item</code> is first encoded as the point <code>item</code><span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> on the elliptic curve. Then, it is further multiplied <em>interactively</em> by the secret integer <code>oprf_server_key</code>. Then, they both take <code>sigma_max</code> bits out of the first coordinate of each such point.</li>\n</ol>\n<p>After this step, both the server and the client have new datasets, <code>PRFed_server_set</code> and <code>PRFed_client_set</code>, each of <code>sigma_max</code>-bit integers. Check our code for this <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/client_online.py#L51\">here</a> and <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/server_offline.py#L22\">here</a>.</p>\n<p>The OPRF protocol is as follows:</p>\n<ul>\n<li>The server gets his <code>PRFed_server_set</code> by doing for each of his items the following:</li>\n</ul>\n<p><code>server_item</code> <span><span><span>‚Üí\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>‚Üí</span></span></span></span></span> <code>server_item</code><span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>‚Üí\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>‚Üí</span></span></span></span></span> <code>oprf_server_key</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>server_item</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span>  <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>‚Üí\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>‚Üí</span></span></span></span></span> <code>sigma_max</code> bits out of the first coordinate.</p>\n<ul>\n<li>The client creates a set to send to the server by doing for each of his items the following:</li>\n</ul>\n<p><code>client_item</code> <span><span><span>‚Üí\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>‚Üí</span></span></span></span></span> <code>client_item</code><span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>‚Üí\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>‚Üí</span></span></span></span></span> <code>oprf_client_key</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>client_item</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span>.</p>\n<ul>\n<li>The server obtains the client's points, multiplies them by <code>oprf_server_key</code> and sends them back to the client.</li>\n</ul>\n<p><code>oprf_client_key</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>client_item</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>‚Üí\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>‚Üí</span></span></span></span></span> <code>oprf_server_key</code><span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>oprf_client_key</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>client_item</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span>.</p>\n<ul>\n<li>The client gets his <code>PRFed_client_set</code> by doing:</li>\n</ul>\n<p><code>oprf_server_key</code><span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>oprf_client_key</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>client_item</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>‚Üí\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>‚Üí</span></span></span></span></span> <code>oprf_client_key</code><span><span><span>‚àí1^{-1}</span><span aria-hidden=\"true\"><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>‚àí</span><span>1</span></span></span></span></span></span></span></span></span></span></span></span></span> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span><code>oprf_server_key</code><span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>oprf_client_key</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>client_item</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>‚Üí\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>‚Üí</span></span></span></span></span> <code>oprf_server_key</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>client_item</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <span><span><span>GG</span><span aria-hidden=\"true\"><span><span></span><span>G</span></span></span></span></span> <span><span><span>‚Üí\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>‚Üí</span></span></span></span></span> <code>sigma_max</code> bits out of the first coordinate</p>\n<ol start=\"2\">\n<li><strong>Hashing</strong>: The server and the client both agree on using a total number of <code>number_of_hashes</code> hash functions with <code>output_bits</code> bits of output.</li>\n</ol>\n<ul>\n<li>The client performs <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/cuckoo_hash.py\"><em>Cuckoo hashing</em></a>. You can check the implementation <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/client_online.py#L56\">here</a>. By the end of this step, each of his bins has at most <span><span><span>11</span><span aria-hidden=\"true\"><span><span></span><span>1</span></span></span></span></span> element. For security reasons, empty bins are padded with one dummy message. You may think of his database as a column vector with <code>number_of_bins</code> rows.</li>\n<li>The server performs <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/simple_hash.py\"><em>Simple hashing</em></a>; each of his bins has <code>bin_capacity</code> elements. Think of its database as a matrix with <code>number_of_bins</code> rows and <code>bin_capacity</code> columns. Roughly speaking, for each element and each hash function, the server inserts the element in a bin corresponding to its hash value. You can check its implementation <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/server_offline.py#L33\">here</a>.</li>\n</ul>\n<p>Recall that after the <strong>OPRF</strong> step, the database entries of both the client and the server have <code>sigma_max</code> bits. In order to reduce the storage of the items in the hash tables, both the client and the server perform a <em>permutation-based hashing</em> step. In this way, they reduce the length of the items to <code>sigma_max</code> - <code>output_bits</code> + <span><span><span>‚åälog(\\lfloor \\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span><code>number_of_hashes</code><span><span><span>)‚åã+1)\\rfloor+1</span><span aria-hidden=\"true\"><span><span></span><span>)</span><span>‚åã</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> bits, by encoding a part of the item in the index of the bin where the item belongs.</p>\n<p>‚ùó  The bins correspond to all the possible values that the hash functions can take. This means that <code>number_of_bins</code> = 2 ** <code>output_bits</code>.</p>\n<p>We describe here shortly the steps for their insertion:</p>\n<ul>\n<li>We write <code>item</code> as <code>item_left||item_right</code>, where <code>item_right</code> has <code>output_bits</code> bits and <code>item_left</code> has <code>sigma_max</code> - <code>output_bits</code> bits.</li>\n<li>For a specific index <span><span><span>ii</span><span aria-hidden=\"true\"><span><span></span><span>i</span></span></span></span></span> less than <code>number_of_hashes</code>, we compute the so-called <em>location function</em> <span><span><span>Loc\\mathsf{Loc}</span><span aria-hidden=\"true\"><span><span></span><span><span>L</span><span>o</span><span>c</span></span></span></span></span></span>(<span><span><span>i,i,</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span>,</span></span></span></span></span> <code>item</code>):</li>\n</ul>\n<p><code>item</code> <span><span><span>‚Üí\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>‚Üí</span></span></span></span></span> <code>item_left||item_right</code> <span><span><span>‚Üí\\rightarrow</span><span aria-hidden=\"true\"><span><span></span><span>‚Üí</span></span></span></span></span> <span><span><span>Loc\\mathsf{Loc}</span><span aria-hidden=\"true\"><span><span></span><span><span>L</span><span>o</span><span>c</span></span></span></span></span></span>(<span><span><span>i,i,</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span>,</span></span></span></span></span> <code>item</code>) = <span><span><span>HiH_i</span><span aria-hidden=\"true\"><span><span></span><span><span>H</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>(<code>item_left</code>) <span><span><span>‚äï\\oplus</span><span aria-hidden=\"true\"><span><span></span><span>‚äï</span></span></span></span></span> <code>item_right</code>.</p>\n<ul>\n<li>We insert <code>item</code> in a bin corresponding to its location as <code>item_left||i</code>, which has <code>sigma_max</code> - <code>output_bits</code> + <span><span><span>‚åälog\\lfloor \\mathsf{log}</span><span aria-hidden=\"true\"><span><span></span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span></span></span></span></span>(<code>number_of_hashes</code>)<span><span><span>‚åã\\rfloor</span><span aria-hidden=\"true\"><span><span></span><span>‚åã</span></span></span></span></span> + 1 bits.</li>\n</ul>\n<p>Notice that given <code>item_left||i</code> and the location, <span><span><span>Loc\\mathsf{Loc}</span><span aria-hidden=\"true\"><span><span></span><span><span>L</span><span>o</span><span>c</span></span></span></span></span></span>(<span><span><span>i,i,</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span>,</span></span></span></span></span> <code>item</code>), you can recover the initial <code>item,</code>, by computing <code>item_right</code> = <span><span><span>Loc\\mathsf{Loc}</span><span aria-hidden=\"true\"><span><span></span><span><span>L</span><span>o</span><span>c</span></span></span></span></span></span>(<span><span><span>i,i,</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span>,</span></span></span></span></span> <code>item</code>) <span><span><span>‚äï\\oplus</span><span aria-hidden=\"true\"><span><span></span><span>‚äï</span></span></span></span></span> <span><span><span>HiH_i</span><span aria-hidden=\"true\"><span><span></span><span><span>H</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>(<code>item_left</code>).</p>\n<p><strong>Why does it work?</strong> Let's say that the server has stored <span><span><span>xx</span><span aria-hidden=\"true\"><span><span></span><span>x</span></span></span></span></span> as <span><span><span>(xL‚à£‚à£i)(x_L || i)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>L</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>‚à£</span><span>‚à£</span><span>i</span><span>)</span></span></span></span></span> in a bin, whereas the client has stored <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> as <span><span><span>(yL‚à£‚à£j)(y_L || j)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>L</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>‚à£</span><span>‚à£</span><span>j</span><span>)</span></span></span></span></span> in the same bin. Then, <span><span><span>(xL‚à£‚à£i)=(yL‚à£‚à£j)(x_L || i) = (y_L || j)</span><span aria-hidden=\"true\"><span><span></span><span>(</span><span><span>x</span><span><span><span><span><span><span></span><span><span>L</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>‚à£</span><span>‚à£</span><span>i</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>L</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>‚à£</span><span>‚à£</span><span>j</span><span>)</span></span></span></span></span> leads to <span><span><span>xL=yLx_L = y_L</span><span aria-hidden=\"true\"><span><span></span><span><span>x</span><span><span><span><span><span><span></span><span><span>L</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>L</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and <span><span><span>i=ji = j</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span></span><span>=</span><span></span></span><span><span></span><span>j</span></span></span></span></span> and hence, <span><span><span>x=yx = y</span><span aria-hidden=\"true\"><span><span></span><span>x</span><span></span><span>=</span><span></span></span><span><span></span><span>y</span></span></span></span></span>.</p>\n<p>‚ùó One solution to avoid hashing failures in <em>Cuckoo hashing</em> is to use at least <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span> hash functions for inserting items into the Cuckoo table. While increasing the number of hashses above <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span> may reduce the hashing failures, this will significantly increase the simple hashing cost of the server. Hence, a good choice seems to be <code>number_of_hashes</code> = <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>.</p>\n<p>‚ùó For <code>number_of_hashes</code> = <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>, we can insert the client's items into the <em>Cuckoo hash table</em> with a failure probability of <span><span><span>2‚àí402^{-40}</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚àí</span><span>4</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>, in a total number of bins equal to <code>number_of_bins</code>= <span><span><span>3/2‚ãÖ3/2 \\cdot</span><span aria-hidden=\"true\"><span><span></span><span>3</span><span>/</span><span>2</span><span>‚ãÖ</span></span></span></span></span> <code>client_size</code>  . For more details, check <strong>Hashing failures</strong> <a href=\"https://eprint.iacr.org/2017/299.pdf\">here</a>.</p>\n<p>‚ùó For <code>number_of_hashes</code> = <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>, we should choose <code>bin_capacity</code> carefully so that inserting <code>number_of_hashes</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>server_size</code> items via <em>simple hashing</em> succeeds with a failure probability of <span><span><span>2‚àí302^{-30}</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚àí</span><span>3</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>. For example, for <code>server_size</code> = <span><span><span>220,2^{20},</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span></span></span></span></span><span>,</span></span></span></span></span> we must pick <code>bin_capacity</code> = <span><span><span>536536</span><span aria-hidden=\"true\"><span><span></span><span>5</span><span>3</span><span>6</span></span></span></span></span>. To see how to choose the <code>bin_capacity</code> parameter as a function of the security parameter, the output size of the hash functions and the server's maximum set size , check <a href=\"https://eprint.iacr.org/2017/299.pdf\">Table 1</a> or you can also run the <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/bin_capacity_estimator.py\">bin_capacity_estimator.py </a> script to obtain more values.</p>\n<p><strong>Example</strong>: Let's take <code>bin_capacity</code> = <span><span><span>66</span><span aria-hidden=\"true\"><span><span></span><span>6</span></span></span></span></span>. Throughout this blog post, we will show the bins as rows: the server's bins contain items represented as red balls, whereas the client's bins contain items represented as green balls.üé®</p>\n<p><img src=\"https://i.imgur.com/NamEMEX.png\" alt=\"\"></p>\n<p>üí° A <em>padding step</em> with dummy messages might be required to get <em>all the bins of the server full.</em> Server padding is important for <em>batching</em>, as you will see soon.</p>\n<p>Hence, the server can run the <strong>PSI</strong> protocol <strong>on each bin.</strong> As discussed above, the server can associate to each bin a polynomial and evaluate it at an encrypted query. The degree of the polynomial is in this case <code>bin_capacity</code>, the number of elements in each of the server's bins. But this degree can be pretty big and the encryption scheme that we use may not allow us to correctly compute the polynomial evaluation. So we <em>partition</em> the bins into mini bins and associate to each mini bin a polynomial of a lower degree.</p>\n<ol start=\"3\">\n<li><strong>Partitioning</strong>: The server partitions each bin into <code>alpha</code> mini bins, having <code>bin_capacity</code>/<code>alpha</code> elements.</li>\n</ol>\n<p>‚ùó There will be <code>number_of_bins</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>alpha</code> mini bins.</p>\n<p>Hence, performing the <strong>PSI</strong> protocol for each bin reduces to <strong>performing</strong> <code>alpha</code> <strong>PSI</strong> protocols for each mini bin.</p>\n<p><strong>Example</strong>: Let's assume that each bin is partitioned into <code>alpha</code> = <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span> mini bins. In this case, each mini bin has <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> elements, as it is shown in the picture.</p>\n<p><img src=\"https://i.imgur.com/7EGZcog.png\" alt=\"\"></p>\n<ol start=\"4\">\n<li><strong>Finding the polynomials</strong>: For each mini bin, the server computes the coefficients of the monic polynomial that vanishes at the elements of that mini bin, see <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/auxiliary_functions.py#L76\">this</a>. This means that each mini bin can now be described by <code>bin_capacity</code>/<code>alpha</code> +1 coefficients. By convention, the coefficients are written in decreasing order, namely the first column in the mini bin corresponds to the leading coefficient of the polynomial, the second column to the next coefficient and so on. You can see how both finding the polynomials and partitioning are implemented on the server side <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/server_offline.py#L51\">here</a>.</li>\n</ol>\n<p>The coefficients of the polynomials are computed modulo <code>plain_modulus</code>, a parameter involved in the homomorphic encryption scheme. More on this parameter will follow soon.</p>\n<p><strong>Example</strong>: In our case, each mini bin has <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> elements, which means that it can be represented by  the coefficients of a monic polynomial <span><span><span>P(X)=X2+a1X+a0P(X) = X^2 + a_1X + a_0</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span>X</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>X</span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> of degree <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span>, i.e. by <span><span><span>[1,a1,a0][1, a_1, a_0]</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>1</span><span>,</span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>]</span></span></span></span></span>.</p>\n<p><img src=\"https://i.imgur.com/0etGFYY.png\" alt=\"\"></p>\n<p>At this step, both the server and the client perform the actual <strong>PSI</strong> protocol, as in Case <strong>b</strong>, but with the optimizations described above.</p>\n<p>So far, we said that the <strong>PSI</strong> protocol can be performed per each bin of client, against a corresponding mini bin of server. But we can do better üí™.</p>\n<ol start=\"5\">\n<li><strong>Batching</strong>: The <strong>HE</strong> scheme that we use benefits from a special property, called <em>batching</em>, that helps the client to pack his bins and to perform <strong>many queries simultaneously</strong>.</li>\n</ol>\n<p>Recall that the scheme <a href=\"https://eprint.iacr.org/2012/144\">BFV</a> allows encrypting polynomials of degree less than <code>poly_modulus_degree</code> modulo <code>plain_modulus</code>. The <code>plain_modulus</code> is chosen so that it is a prime congruent with 1 modulo 2 <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>poly_modulus_degree</code>, which helps identifying each such polynomial with a vector of <code>poly_modulus_degree</code> integer entries modulo <code>plain_modulus</code>. <em>This is what batching is about.</em>  <a href=\"https://github.com/OpenMined/TenSEAL/blob/master/tutorials%2FTutorial%200%20-%20Getting%20Started.ipynb\">TenSEAL</a> allows encryption of <strong>vectors of integers</strong>, by first performing the above correspondence and then performing the actual encryption. Also, in a similar way, decrypting in TenSEAL works for <strong>vectors of integers</strong>.</p>\n<p>The plaintext space is the ring of integer polynomials <span><span><span>Zt[X](XN+1),\\frac{\\mathbb{Z_t}[X]}{(X^N+1)},</span><span aria-hidden=\"true\"><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>(</span><span><span>X</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span></span></span></span></span><span>+</span><span>1</span><span>)</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span><span><span>Z</span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span><span>[</span><span>X</span><span>]</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span><span></span></span><span>,</span></span></span></span></span> where <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span> = <code>plain_modulus</code> and <span><span><span>NN</span><span aria-hidden=\"true\"><span><span></span><span>N</span></span></span></span></span> = <code>poly_modulus_degree</code>.</p>\n<p>üí°Since <span><span><span>t‚â°1t \\equiv 1</span><span aria-hidden=\"true\"><span><span></span><span>t</span><span></span><span>‚â°</span><span></span></span><span><span></span><span>1</span></span></span></span></span> mod <span><span><span>2‚ãÖN2\\cdot N</span><span aria-hidden=\"true\"><span><span></span><span>2</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>N</span></span></span></span></span>, the polynomial <span><span><span>XN+1X^N+1</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> factorizes as a product of <em>linear polynomials</em> modulo <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span>, i.e.</p>\n<div><span><span><span>XN+1=(X‚àíu1)‚ãÖ(X‚àíu2)‚ãÖ‚Ä¶‚ãÖ(X‚àíuN)¬†mod¬†t.X^N+1 = (X-u_1) \\cdot (X-u_2)\\cdot \\ldots \\cdot (X-u_N) \\text{ mod } t.</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>‚àí</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>‚àí</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>‚Ä¶</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>‚àí</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span><span>¬†mod¬†</span></span><span>t</span><span>.</span></span></span></span></span></div>\n<p>Therefore, there is a ring <em>isomorphism</em>, given by the <a href=\"https://en.wikipedia.org/wiki/Chinese_remainder_theorem\">Chinese Remainder Theorem (CRT)</a>:</p>\n<div><span><span><span>Zt[X](XN+1)‚ÜíZtN,\\frac{\\mathbb{Z}_t[X]}{(X^N+1)} \\rightarrow \\mathbb{Z}_t^{N},</span><span aria-hidden=\"true\"><span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>(</span><span><span>X</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span>1</span><span>)</span></span></span><span><span></span><span></span></span><span><span></span><span><span><span><span>Z</span></span><span><span><span><span><span><span></span><span><span>t</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>[</span><span>X</span><span>]</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span><span></span></span><span></span><span>‚Üí</span><span></span></span><span><span></span><span><span><span>Z</span></span><span><span><span><span><span><span></span><span><span>t</span></span></span><span><span></span><span><span><span>N</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span></span></span></span></span></div>\n<p>where a polynomial <span><span><span>pp</span><span aria-hidden=\"true\"><span><span></span><span>p</span></span></span></span></span> is <em>encoded</em> as <span><span><span>[p(u1),p(u2),‚Ä¶,p(uN)].[p(u_1), p(u_2), \\ldots, p(u_N)].</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>p</span><span>(</span><span><span>u</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>p</span><span>(</span><span><span>u</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span>p</span><span>(</span><span><span>u</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>]</span><span>.</span></span></span></span></span></p>\n<p>This map behaves nicely with respect to addition and multiplication: addition of polynomials corresponds to addition of vectors, whereas multiplication of polynomials corresponds to component-wise multiplication of vectors.</p>\n<p><strong>Example</strong>: If <span><span><span>NN</span><span aria-hidden=\"true\"><span><span></span><span>N</span></span></span></span></span> = <code>poly_modulus_degree</code> = 2 and <span><span><span>t‚â°1t\\equiv 1</span><span aria-hidden=\"true\"><span><span></span><span>t</span><span></span><span>‚â°</span><span></span></span><span><span></span><span>1</span></span></span></span></span> mod <span><span><span>44</span><span aria-hidden=\"true\"><span><span></span><span>4</span></span></span></span></span>, then <span><span><span>XN+1=(X‚àíu1)‚ãÖ(X‚àíu2)X^N+1 = (X-u_1) \\cdot (X-u_2)</span><span aria-hidden=\"true\"><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>N</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span></span><span>=</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>‚àí</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>(</span><span>X</span><span></span><span>‚àí</span><span></span></span><span><span></span><span><span>u</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span> mod <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span>. In this case, a <em>polynomial</em> <span><span><span>pp</span><span aria-hidden=\"true\"><span><span></span><span>p</span></span></span></span></span> corresponds to the <em>vector of integers</em> <span><span><span>[p(u1),p(u2)][p(u_1), p(u_2)]</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>p</span><span>(</span><span><span>u</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>p</span><span>(</span><span><span>u</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>]</span></span></span></span></span> modulo <span><span><span>tt</span><span aria-hidden=\"true\"><span><span></span><span>t</span></span></span></span></span>.</p>\n<ul>\n<li>The client batches his bins (having each 1 integer entry)  into <code>number_of_bins</code>/<code>poly_modulus_degree</code> vectors.</li>\n<li>The client encodes each such batch as a plaintext.</li>\n<li>The client encrypts these plaintexts and sends them to the server.</li>\n<li>The server batches his minibins in minibatches.</li>\n</ul>\n<p><strong>Example</strong>: For simplicity of exposition, let's take <code>poly_modulus_degree</code> = <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span>. This means that the client batches together vectors of <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> elements. The server matches this on his side, by batching together <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> mini bins into a <em>mini batch</em>.</p>\n<p><img src=\"https://i.imgur.com/WuPvEAt.png\" alt=\"\"></p>\n<p>In our implementation, we choose <code>number_of_bins</code> = <code>poly_modulus_degree</code>, so all the client's bins are batched into just one plaintext.</p>\n<p>üîç The <strong>PSI</strong> protocol is now performed on a client's batch and on one of the corresponding server's mini batches.</p>\n<p><img src=\"https://i.imgur.com/qGFbEuA.png\" alt=\"\"></p>\n<p>‚ùó In general there are <code>alpha</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>number_of_bins</code>/<code>poly_modulus_degree</code> mini batches so the PSI protocol si apllied the same number of times.</p>\n<p>Batching lowers the <em>communication and computation costs on the client side.</em></p>\n<p>‚ö†Ô∏è Before going into the next step, <em>windowing</em>, let's take a deep breath now and recall a bit what we have so far. You can forget about batching for a minute. Each mini bin has <code>bin_capacity</code>/<code>alpha</code> elements, so it is represented by a monic polynomial of degree<code>bin_capacity</code>/<code>alpha</code>. Let's call this degree shortly as <span><span><span>DD</span><span aria-hidden=\"true\"><span><span></span><span>D</span></span></span></span></span>.</p>\n<p>Therefore, each polynomial looks like</p>\n<div><span><span><span>P(X)=XD+aD‚àí1XD‚àí1+‚Ä¶+a1X+a0.P(X) = X^D + a_{D-1}X^{D-1}+\\ldots+a_{1}X+a_0.</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span>X</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>D</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>D</span><span>‚àí</span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span><span>X</span><span><span><span><span><span><span></span><span><span><span>D</span><span>‚àí</span><span>1</span></span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>‚Ä¶</span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>X</span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>.</span></span></span></span></span></div>\n<p>for some integer coefficients <span><span><span>aia_i</span><span aria-hidden=\"true\"><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>As in Case <strong>b</strong>, the client should send an encryption <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> of one bin containing an integer <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span>, and the server should evaluate the polynomial <span><span><span>P(X)P(X)</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span>X</span><span>)</span></span></span></span></span> at this encrypted value.</p>\n<p>Performing this evaluation requires, in particular, to compute <span><span><span>Enc(y)D‚â°Enc(yD)\\mathsf{Enc}(y)^D \\equiv \\mathsf{Enc}(y^D)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span><span>)</span><span><span><span><span><span><span></span><span><span>D</span></span></span></span></span></span></span></span><span></span><span>‚â°</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>D</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span>, which can be done in multiplicative depth <span><span><span>‚åàlog(D)‚åâ\\lceil \\mathsf{log}(D)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>‚åà</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>‚åâ</span></span></span></span></span>. But this multiplicative depth may be too large to be handled by the <strong>HE</strong> scheme. In this case, the client may come to the rescue and send the encryptions of all powers:</p>\n<div><span><span><span>Enc(y),Enc(y2),Enc(y3),‚Ä¶,Enc(yD)\\mathsf{Enc}(y), \\mathsf{Enc}(y^2), \\mathsf{Enc}(y^3),\\ldots, \\mathsf{Enc}(y^D)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>3</span></span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>D</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span></div>\n<p>So by using the magic powers of the <strong>HE</strong> scheme üîÆ, the evaluation of the polynomial turns out to be just a <em>scalar product</em> of these encryptions with the vector of coefficients of the polynomial:</p>\n<div><span><span><span>P(Enc(y))=‚ü®(1,aD‚àí1,‚Ä¶,a0),(Enc(yD),Enc(yD‚àí1),‚Ä¶,Enc(1))‚ü©.P(\\mathsf{Enc}(y)) = \\langle (1, a_{D-1},\\ldots,a_0), (\\mathsf{Enc}(y^D), \\mathsf{Enc}(y^{D-1}),\\ldots,\\mathsf{Enc}(1)) \\rangle.</span><span aria-hidden=\"true\"><span><span></span><span>P</span><span>(</span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>‚ü®</span><span>(</span><span>1</span><span>,</span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span><span>D</span><span>‚àí</span><span>1</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>(</span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>D</span></span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>D</span><span>‚àí</span><span>1</span></span></span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>1</span><span>)</span><span>)</span><span>‚ü©</span><span>.</span></span></span></span></span></div>\n<p>Still, the client needs to send <span><span><span>DD</span><span aria-hidden=\"true\"><span><span></span><span>D</span></span></span></span></span> encryptions (per bin), which means <em>a lot of communication on the client side</em> üò±.</p>\n<p><strong>We need to look for a tradeoff</strong> ‚öñÔ∏è. Notice that if the client sends the <span><span><span>‚åälog(D)‚åã+1\\lfloor\\mathsf{log}(D)\\rfloor+1</span><span aria-hidden=\"true\"><span><span></span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>‚åã</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> encryptions</p>\n<div><span><span><span>Enc(y),Enc(y2),Enc(y4)‚Ä¶,Enc(y2‚åälog(D)‚åã),\\mathsf{Enc}(y), \\mathsf{Enc}(y^2), \\mathsf{Enc}(y^4) \\ldots, \\mathsf{Enc}(y^{2^{\\lfloor\\mathsf{log}(D)\\rfloor}}),</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>4</span></span></span></span></span></span></span></span><span>)</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>‚åã</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>)</span><span>,</span></span></span></span></span></div>\n<p>then each power <span><span><span>Enc(y)e‚â°Enc(ye)\\mathsf{Enc}(y)^e \\equiv \\mathsf{Enc}(y^e)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span><span>)</span><span><span><span><span><span><span></span><span><span>e</span></span></span></span></span></span></span></span><span></span><span>‚â°</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>e</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span>, for any <span><span><span>e‚â§De\\leq D</span><span aria-hidden=\"true\"><span><span></span><span>e</span><span></span><span>‚â§</span><span></span></span><span><span></span><span>D</span></span></span></span></span>, can be computed by writing <span><span><span>ee</span><span aria-hidden=\"true\"><span><span></span><span>e</span></span></span></span></span> in binary decomposition. The server recovers any <span><span><span>Enc(ye)\\mathsf{Enc}(y^e)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>e</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span>, in the worst case, by multiplying all the <span><span><span>‚åälog(D)‚åã+1\\lfloor\\mathsf{log}(D)\\rfloor + 1</span><span aria-hidden=\"true\"><span><span></span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>‚åã</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> (encrypted) powers, which requires a circuit of multiplicative depth <span><span><span>‚åàlog(‚åälog(D)‚åã+1)‚åâ\\lceil\\mathsf{log}(\\lfloor\\mathsf{log}(D)\\rfloor +1)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>‚åà</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>‚åã</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>‚åâ</span></span></span></span></span>.</p>\n<p>So yay! we <strong>lowered</strong> the initial multiplicative depth of the polynomial, from <span><span><span>‚åàlog(D)‚åâ\\lceil\\mathsf{log}(D)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>‚åà</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>‚åâ</span></span></span></span></span>, to <span><span><span>‚åàlog(‚åälog(D)‚åã+1)‚åâ\\lceil\\mathsf{log}(\\lfloor\\mathsf{log}(D)\\rfloor +1)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>‚åà</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>‚åã</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>‚åâ</span></span></span></span></span>, while incurring a only <strong>a small <span><span><span>log‚Å°D\\log D</span><span aria-hidden=\"true\"><span><span></span><span>lo<span>g</span></span><span></span><span>D</span></span></span></span></span> factor communication cost</strong>. It turns out that we can do this even better: we can lower the depth to <span><span><span>‚åàlog(‚åälog(D)‚åã/‚Ñì+1)‚åâ,\\lceil\\mathsf{log}(\\lfloor\\mathsf{log}(D)\\rfloor/\\ell+1)\\rceil,</span><span aria-hidden=\"true\"><span><span></span><span>‚åà</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>‚åã</span><span>/</span><span>‚Ñì</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>‚åâ</span><span>,</span></span></span></span></span> for some so-called <em>windowing</em> parameter <span><span><span>‚Ñì\\ell</span><span aria-hidden=\"true\"><span><span></span><span>‚Ñì</span></span></span></span></span> if we are willing to pay some extra communication cost.</p>\n<p>Now it's time to come back to the protocol and tell you how this idea is used, combined with batching:</p>\n<ol start=\"6\">\n<li><strong>Windowing</strong>: It lowers the depth of the arithmetic circuit above (i.e. of the polynomial of degree <span><span><span>DD</span><span aria-hidden=\"true\"><span><span></span><span>D</span></span></span></span></span>). The client sends <em>sufficiently many (encrypted) powers</em> so that the server can recover all the missing powers, (i.e. the ones of exponent less than <span><span><span>DD</span><span aria-hidden=\"true\"><span><span></span><span>D</span></span></span></span></span>) by <em>computing circuits of low multiplicative depth</em>. We will generalize a bit the discussion above, but don't worry, we'll take it step-by-step.</li>\n</ol>\n<p>As you have seen, if the client sends the encryptions <span><span><span>Enc(yk)\\mathsf{Enc}(y^{k})</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>k</span></span></span></span></span></span></span></span></span><span>)</span></span></span></span></span>, for <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span> a power of <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span>, the server can recover any missing power. This can be done by writing the exponent in base <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> and by multiplying the received encrypted powers accordingly. But we can think of writing the exponent in a bigger base, let's say  <span><span><span>2‚Ñì2^\\ell</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span>‚Ñì</span></span></span></span></span></span></span></span></span></span></span></span>, for some parameter <span><span><span>‚Ñì\\ell</span><span aria-hidden=\"true\"><span><span></span><span>‚Ñì</span></span></span></span></span> (which is <code>ell</code>, in our implementation). Each term that appears in such a decomposition is of type <span><span><span>i‚ãÖ2‚Ñìji\\cdot 2^{\\ell j}</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚Ñì</span><span>j</span></span></span></span></span></span></span></span></span></span></span></span></span>, where <span><span><span>0‚â§i‚â§2‚Ñì‚àí10 \\leq i \\leq 2^{\\ell}-1</span><span aria-hidden=\"true\"><span><span></span><span>0</span><span></span><span>‚â§</span><span></span></span><span><span></span><span>i</span><span></span><span>‚â§</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚Ñì</span></span></span></span></span></span></span></span></span><span></span><span>‚àí</span><span></span></span><span><span></span><span>1</span></span></span></span></span> and <span><span><span>0‚â§j‚â§‚åälog(D)/‚Ñì‚åã0\\leq j \\leq \\lfloor \\mathsf{log}(D)/\\ell\\rfloor</span><span aria-hidden=\"true\"><span><span></span><span>0</span><span></span><span>‚â§</span><span></span></span><span><span></span><span>j</span><span></span><span>‚â§</span><span></span></span><span><span></span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>‚Ñì</span><span>‚åã</span></span></span></span></span>. Therefore, the client should send <span><span><span>Enc(yk)\\mathsf{Enc}(y^k)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>k</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> for each such term <span><span><span>kk</span><span aria-hidden=\"true\"><span><span></span><span>k</span></span></span></span></span>. Check the code for this <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/auxiliary_functions.py#L61\">here</a>.</p>\n<p>For each batched plaintext <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span>, the client sends <span><span><span>Enc(yi‚ãÖ2‚Ñì‚ãÖj)\\mathsf{Enc}(y^{i \\cdot 2^{\\ell \\cdot j}})</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>i</span><span>‚ãÖ</span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚Ñì</span><span>‚ãÖ</span><span>j</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>)</span></span></span></span></span>, for each <span><span><span>1‚â§i‚â§2‚Ñì‚àí11 \\leq i \\leq 2^{\\ell} -1</span><span aria-hidden=\"true\"><span><span></span><span>1</span><span></span><span>‚â§</span><span></span></span><span><span></span><span>i</span><span></span><span>‚â§</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚Ñì</span></span></span></span></span></span></span></span></span><span></span><span>‚àí</span><span></span></span><span><span></span><span>1</span></span></span></span></span> and <span><span><span>0‚â§j‚â§‚åälog(D)/‚Ñì‚åã0\\leq j \\leq \\lfloor \\mathsf{log}(D)/\\ell\\rfloor</span><span aria-hidden=\"true\"><span><span></span><span>0</span><span></span><span>‚â§</span><span></span></span><span><span></span><span>j</span><span></span><span>‚â§</span><span></span></span><span><span></span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>‚Ñì</span><span>‚åã</span></span></span></span></span>. Notice that if <span><span><span>i=0i=0</span><span aria-hidden=\"true\"><span><span></span><span>i</span><span></span><span>=</span><span></span></span><span><span></span><span>0</span></span></span></span></span>, then <span><span><span>yi‚ãÖ2‚Ñìj=1y^{i\\cdot 2^{\\ell j}} =1</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span>i</span><span>‚ãÖ</span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚Ñì</span><span>j</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>1</span></span></span></span></span>, hence no need of sending an encryption of <span><span><span>11</span><span aria-hidden=\"true\"><span><span></span><span>1</span></span></span></span></span>. üòÑ</p>\n<p>You can see how both batching and windowing work together <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/client_online.py#L67\">here</a>.</p>\n<ol start=\"7\">\n<li><strong>Recover all powers</strong>: The server computes all the necessary powers in order to evaluate the polynomials, see the code <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/auxiliary_functions.py#L45\">here</a>.</li>\n</ol>\n<p>Given the <span><span><span>2‚Ñì2^{\\ell}</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚Ñì</span></span></span></span></span></span></span></span></span></span></span></span></span> base representation of <span><span><span>ee</span><span aria-hidden=\"true\"><span><span></span><span>e</span></span></span></span></span>,</p>\n<div><span><span><span>e=e0+2‚Ñì‚ãÖe1+22‚Ñì‚ãÖe2+‚Ä¶+2‚åälog(D)/‚Ñì‚åã‚Ñìe‚åälog(D)/‚Ñì‚åã  e = e_0 + 2^{\\ell}\\cdot e_1  + 2^{2\\ell}\\cdot e_2 + \\ldots + 2^{\\lfloor \\mathsf{log}(D)/\\ell\\rfloor\\ell} e_{\\lfloor \\mathsf{log}(D)/\\ell\\rfloor}</span><span aria-hidden=\"true\"><span><span></span><span>e</span><span></span><span>=</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚Ñì</span></span></span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>2</span><span>‚Ñì</span></span></span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span>‚Ä¶</span><span></span><span>+</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>‚Ñì</span><span>‚åã</span><span>‚Ñì</span></span></span></span></span></span></span></span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>‚Ñì</span><span>‚åã</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></div>\n<p>where <span><span><span>0‚â§e0,e1,‚Ä¶,e‚åälog(D)/‚Ñì‚åã‚â§2‚Ñì‚àí10 \\leq e_0, e_1,\\ldots,e_{\\lfloor \\mathsf{log}(D)/\\ell\\rfloor} \\leq 2^{\\ell} -1</span><span aria-hidden=\"true\"><span><span></span><span>0</span><span></span><span>‚â§</span><span></span></span><span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>‚Ä¶</span><span></span><span>,</span><span></span><span><span>e</span><span><span><span><span><span><span></span><span><span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>‚Ñì</span><span>‚åã</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚â§</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚Ñì</span></span></span></span></span></span></span></span></span><span></span><span>‚àí</span><span></span></span><span><span></span><span>1</span></span></span></span></span>, we can compute</p>\n<div><span><span><span>ye=‚àèi=0‚åälog‚Å°(D)/‚Ñì‚åã(y2i)ei.\\displaystyle y^e=\\prod_{i=0}^{\\lfloor \\log (D)/\\ell \\rfloor} \\left(y^{2^i} \\right)^{e_i}.</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>e</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>i</span><span>=</span><span>0</span></span></span></span><span><span></span><span><span>‚àè</span></span></span><span><span></span><span><span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>‚Ñì</span><span>‚åã</span></span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span><span></span><span><span><span><span>(</span></span><span><span>y</span><span><span><span><span><span><span></span><span><span><span><span>2</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span><span>)</span></span></span><span><span><span><span><span><span></span><span><span><span><span>e</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>.</span></span></span></span></span></div>\n<p>Therefore recovering <span><span><span>Enc(ye)\\mathsf{Enc}(y^e)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>e</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> for each such <span><span><span>ee</span><span aria-hidden=\"true\"><span><span></span><span>e</span></span></span></span></span> involves, in the worst case, multiplying <span><span><span>‚åälog(D)/‚Ñì‚åã+1\\lfloor \\mathsf{log}(D)/\\ell\\rfloor+1</span><span aria-hidden=\"true\"><span><span></span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>‚Ñì</span><span>‚åã</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> (encrypted) powers. Therefore, the server computes a circuit of multiplicative depth of <span><span><span>‚åàlog(‚åälog(D)/‚Ñì‚åã+1)‚åâ\\lceil\\mathsf{log}(\\lfloor\\mathsf{log}(D)/\\ell\\rfloor+1)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>‚åà</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>D</span><span>)</span><span>/</span><span>‚Ñì</span><span>‚åã</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>‚åâ</span></span></span></span></span>! üòÑ</p>\n<p>You can check how this step is implemented <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/server_online.py#L80\">here</a>.</p>\n<p>This depth should be supported by the encryption scheme. So the parameters <code>bin_capacity</code>, <code>alpha</code> and <code>ell</code> should be chosen so that\n<span><span><span>‚åàlog(‚åälog(\\lceil\\mathsf{log}(\\lfloor\\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>‚åà</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span><code>bin_capacity</code>/<code>alpha</code><span><span><span>))</span><span aria-hidden=\"true\"><span><span></span><span>)</span></span></span></span></span>/<code>ell</code><span><span><span>‚åã+1)‚åâ\\rfloor+1)\\rceil</span><span aria-hidden=\"true\"><span><span></span><span>‚åã</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>‚åâ</span></span></span></span></span> doesn't exceed the allowed depth of the scheme, which is <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>.</p>\n<p>A tradeoff appears here in choosing the right <code>ell</code>. Notice that the bigger <code>ell</code>, the lower the depth of the circuit the server computes, i.e. <em>smaller computation time</em>, but the more powers the client needs to send, i.e <em>bigger communication cost</em>.</p>\n<p>Another tradeoff is possible when choosing the right partitioning parameter <code>alpha</code>. Notice that the bigger <code>alpha</code>, the smaller the degree <span><span><span>DD</span><span aria-hidden=\"true\"><span><span></span><span>D</span></span></span></span></span> = <code>bin_capacity</code>/<code>alpha</code>, i.e <em>lower computation time</em> on the server side, but the more ciphertexts the server needs to send, i.e. <em>bigger communication cost</em>.</p>\n<ol start=\"8\">\n<li><strong>Doing the scalar product</strong>: This is the last step  on the server side. The server evaluates the polynomials corresponding to the mini bins in a scalar-product fashion, as explained above. However, <strong>due to batching</strong>, this scalar product is a bit trickier; you can check the code <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/server_online.py#L94\">here</a>.</li>\n</ol>\n<p>‚ùó Recall that the <a href=\"https://eprint.iacr.org/2012/144.pdf\">BFV</a> encryption scheme that we use allows multiplying ciphertexts by plaintexts which means that</p>\n<div><span><span><span>Enc(p‚ãÖm)‚â°p‚ãÖEnc(m),\\mathsf{Enc}(p \\cdot m) \\equiv p \\cdot \\mathsf{Enc}(m),</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>p</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>m</span><span>)</span><span></span><span>‚â°</span><span></span></span><span><span></span><span>p</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>m</span><span>)</span><span>,</span></span></span></span></span></div>\n<p>for any <span><span><span>pp</span><span aria-hidden=\"true\"><span><span></span><span>p</span></span></span></span></span> and <span><span><span>mm</span><span aria-hidden=\"true\"><span><span></span><span>m</span></span></span></span></span> <strong>polynomials</strong> of degree less than <code>poly_modulus_degree</code> of coefficients modulo <code>plain_modulus</code>. Hence TenSEAL allows multiplying ciphertexts by <strong>vectors of integers</strong> modulo <code>plain_modulus</code>.</p>\n<p>Let's recap all these steps and see how performing the scalar product  works in our example.</p>\n<p><strong>Example:</strong> Let's go back to the example where each mini bin has <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span> elements, which corresponds to a monic polynomial of degree <span><span><span>22</span><span aria-hidden=\"true\"><span><span></span><span>2</span></span></span></span></span>. Consider a mini batch of mini bins whose corresponding polynomials are <span><span><span>P1=X2+a1X+a0P_1 = X^2 + a_1X + a_0</span><span aria-hidden=\"true\"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>X</span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and <span><span><span>P2=X2+b1X+b0P_2 = X^2 + b_1X+b_0</span><span aria-hidden=\"true\"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>X</span><span></span><span>+</span><span></span></span><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p><img src=\"https://i.imgur.com/34YIWaY.png\" alt=\"\"></p>\n<p>This means that the client encodes a batch <span><span><span>[y1,y2][y_1, y_2]</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>]</span></span></span></span></span> as a plaintext <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> and sends <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span>. Because of windowing, the client also sends <span><span><span>Enc(y2)\\mathsf{Enc}(y^2)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> to the server. In this case, the server can <em>simultaneously</em> check if <span><span><span>y1y_1</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> belongs to the first mini bin (i.e. <span><span><span>P1P_1</span><span aria-hidden=\"true\"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> evaluates to <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span> at <span><span><span>y1y_1</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>) and <span><span><span>y2y_2</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> belongs to the second mini bin (i.e. <span><span><span>P2P_2</span><span aria-hidden=\"true\"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> evaluates to <span><span><span>00</span><span aria-hidden=\"true\"><span><span></span><span>0</span></span></span></span></span> at <span><span><span>y2y_2</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>). Indeed, the server takes the first column of the mini batch and multiplies <span><span><span>Enc(y2)\\mathsf{Enc}(y^2)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span></span></span></span></span> by it, takes the second column and multiplies <span><span><span>Enc(y)\\mathsf{Enc}(y)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> by it and adds them to the third column:</p>\n<div><span><span><span>[1,1]‚ãÖEnc(y2)+[a1,b1]‚ãÖEnc(y)+[a0,b0].[1,1]\\cdot \\mathsf{Enc}(y^2) + [a_1, b_1] \\cdot \\mathsf{Enc}(y) + [a_0, b_0].</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>1</span><span>,</span><span></span><span>1</span><span>]</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>[</span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>[</span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span>.</span></span></span></span></span></div>\n<p>This is the result that the server sends to the client.</p>\n<p><strong>In general</strong>, for any mini batch, in order to evaluate the corresponding polynomials, the server computes the sum over <span><span><span>ii</span><span aria-hidden=\"true\"><span><span></span><span>i</span></span></span></span></span> of  <span><span><span>Enc(yi)√ó(D+1‚àíi)\\mathsf{Enc}(y^i)\\times (D+1-i)</span><span aria-hidden=\"true\"><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>i</span></span></span></span></span></span></span></span><span>)</span><span></span><span>√ó</span><span></span></span><span><span></span><span>(</span><span>D</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span></span><span>‚àí</span><span></span></span><span><span></span><span>i</span><span>)</span></span></span></span></span>-th column of the mini batch. In total, the server computes and then sends <code>alpha</code> <span><span><span>‚ãÖ\\cdot</span><span aria-hidden=\"true\"><span><span></span><span>‚ãÖ</span></span></span></span></span> <code>number_of_bins</code>/ <code>poly_modulus_degree</code> encrypted results to the client (Notice that the communication is increased by a factor of <span><span><span>Œ±\\alpha</span><span aria-hidden=\"true\"><span><span></span><span>Œ±</span></span></span></span></span>).</p>\n<ol start=\"9\">\n<li><strong>Verdict</strong>: It's time for the client to find out the intersection of the two lists of elements.</li>\n</ol>\n<p>The client decrypts the results that he gets from the server and recovers a vector of integers (corresponding to the underlying polynomial plaintext). The client checks  if this vector contains any zeroes. A zero corresponds to an element from the intersection. To recover such an element we use the index where the zero is found. You can check how the client gets the intersection in the code <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/client_online.py#L132\">here</a>.</p>\n<p>Let's go back to the example!</p>\n<p><strong>Example</strong>:  Recall that <span><span><span>P1(X)=X2+a1X+a0P_1(X) = X^2 + a_1X+a_0</span><span aria-hidden=\"true\"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>X</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>X</span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> and <span><span><span>P2(X)=X2+b1X+b0P_2(X) = X^2 + b_1X+b_0</span><span aria-hidden=\"true\"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>X</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>X</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>X</span><span></span><span>+</span><span></span></span><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>. Also, remember that <span><span><span>yy</span><span aria-hidden=\"true\"><span><span></span><span>y</span></span></span></span></span> was encoded from <span><span><span>[y1,y2].[y_1, y_2].</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span>.</span></span></span></span></span> Due to the encoding, <span><span><span>y2y^2</span><span aria-hidden=\"true\"><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span></span></span> corresponds to <span><span><span>[y12,y22].[y^2_1, y^2_2].</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span>.</span></span></span></span></span> Consider <span><span><span>p2,p1p_2, p_1</span><span aria-hidden=\"true\"><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, respectively <span><span><span>p0p_0</span><span aria-hidden=\"true\"><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> the encodings of <span><span><span>[1,1],[a1,b1],[1,1], [a_1, b_1],</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>1</span><span>,</span><span></span><span>1</span><span>]</span><span>,</span><span></span><span>[</span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span>,</span></span></span></span></span> respectively <span><span><span>[a0,b0][a_0, b_0]</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>]</span></span></span></span></span>.</p>\n<p>The server computes <span><span><span>p2‚ãÖEnc(y2)+p1‚ãÖEnc(y)+p0.p_2 \\cdot \\mathsf{Enc}(y^2) + p_1 \\cdot \\mathsf{Enc}(y) +p_0.</span><span aria-hidden=\"true\"><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>E</span><span>n</span><span>c</span></span><span>(</span><span>y</span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>.</span></span></span></span></span> and sends back the result to the client. When the client decrypts it, he gets the result <span><span><span>p2‚ãÖy2+p1‚ãÖy+p0p_2 \\cdot y^2 + p_1 \\cdot y + p_0</span><span aria-hidden=\"true\"><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>y</span><span></span><span>+</span><span></span></span><span><span></span><span><span>p</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span>, which, after batch decoding, equals to:</p>\n<p><span><span><span>[1,1]‚ãÖ[y12,y22]+[a1,b1]‚ãÖ[y1,y2]+[a0,b0],[1,1] \\cdot [y^2_1, y^2_2] + [a_1, b_1] \\cdot [y_1, y_2] + [a_0, b_0],</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span>1</span><span>,</span><span></span><span>1</span><span>]</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>[</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span></span><span>+</span><span></span></span><span><span></span><span>[</span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span>[</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span></span><span>+</span><span></span></span><span><span></span><span>[</span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>]</span><span>,</span></span></span></span></span></p>\n<p>where the additions and multiplications are done component-wise, so the above computatation is equal to <span><span><span>[y12+a1‚ãÖy1+a0,y22+b1‚ãÖy2+b0][y_1^2+a_1\\cdot y_1 + a_0, y_2^2+b_1\\cdot y_2 + b_0]</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>a</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>‚ãÖ</span><span></span></span><span><span></span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span>0</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>]</span></span></span></span></span> which is nothing but <span><span><span>[P1(y1),P2(y2)].[P_1(y_1), P_2(y_2)].</span><span aria-hidden=\"true\"><span><span></span><span>[</span><span><span>P</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>,</span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span><span>y</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>‚Äã</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span>]</span><span>.</span></span></span></span></span></p>\n<h3>Setting the parameters</h3>\n<p>We know that we have introduced a lot of parameters along the way. üò± Let's recap them a bit and see how we chose them in our implementation. ü§ì</p>\n<ul>\n<li><code>server_size</code>, <code>client_size</code>: the sizes of server's and client's databases.</li>\n<li><code>sigma_max</code> appears in the <strong>OPRF</strong> layer, as this step maps the database entries to <code>sigma_max</code>-bit integers.</li>\n<li><code>number_of_hashes</code>, <code>output_bits</code>, <code>number_of_bins</code>, <code>bin_capacity</code> appear in hashing, as this step maps the previous integers, using <code>number_of_hashes</code> hash functions, to <code>sigma_max</code> - <code>output_bits</code> + <span><span><span>‚åälog(\\lfloor \\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span> <code>number_of_hashes</code><span><span><span>)‚åã+1)\\rfloor + 1</span><span aria-hidden=\"true\"><span><span></span><span>)</span><span>‚åã</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> -bit integers in <code>number_of_bins</code> bins.</li>\n<li><code>alpha</code> appears in partitioning, as server splits the  bins in <code>alpha</code> mini bins.</li>\n<li><code>plain_modulus</code>, <code>poly_modulus_degree</code> : parameters of the <strong>HE</strong>  scheme.</li>\n<li><code>ell</code> used in windowing.</li>\n</ul>\n<p>The elements from the both hash tables (client and server) are represented on\n<code>sigma_max</code> - <code>output_bits</code> + <span><span><span>‚åälog(\\lfloor \\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span> <code>number_of_hashes</code><span><span><span>)‚åã+1)\\rfloor + 1</span><span aria-hidden=\"true\"><span><span></span><span>)</span><span>‚åã</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span></span></span></span></span> bits. The <strong>HE</strong> scheme must be able to encrypt integers of this size, so we set:</p>\n<p><code>sigma_max</code> <span><span><span>‚â§\\leq</span><span aria-hidden=\"true\"><span><span></span><span>‚â§</span></span></span></span></span> <span><span><span>‚åälog(\\lfloor \\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span><code>plain_modulus</code><span><span><span>)‚åã)\\rfloor</span><span aria-hidden=\"true\"><span><span></span><span>)</span><span>‚åã</span></span></span></span></span> + <code>output_bits</code> - (<span><span><span>‚åälog(\\lfloor \\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span> <code>number_of_hashes</code><span><span><span>)‚åã+1))\\rfloor + 1)</span><span aria-hidden=\"true\"><span><span></span><span>)</span><span>‚åã</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span></span></span></span></span>.</p>\n<p>Also, recall that recovering all the (encrypted) powers on the server side, we require</p>\n<p><span><span><span>‚åàlog(‚åälog(\\lceil\\mathsf{log}(\\lfloor\\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span>‚åà</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>‚åä</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span><code>bin_capacity</code>/<code>alpha</code><span><span><span>))</span><span aria-hidden=\"true\"><span><span></span><span>)</span></span></span></span></span>/<code>ell</code><span><span><span>‚åã+1)‚åâ‚â§\\rfloor+1)\\rceil \\leq</span><span aria-hidden=\"true\"><span><span></span><span>‚åã</span><span></span><span>+</span><span></span></span><span><span></span><span>1</span><span>)</span><span>‚åâ</span><span></span><span>‚â§</span></span></span></span></span> depth.</p>\n<p>Let's choose a set of these parameters step-by-step:</p>\n<ul>\n<li><code>number_of_hashes</code> = <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>.</li>\n<li><code>client_size</code> = <span><span><span>55355535</span><span aria-hidden=\"true\"><span><span></span><span>5</span><span>5</span><span>3</span><span>5</span></span></span></span></span>, so <code>number_of_bins</code> = <span><span><span>3/2‚ãÖ3/2 \\cdot</span><span aria-hidden=\"true\"><span><span></span><span>3</span><span>/</span><span>2</span><span>‚ãÖ</span></span></span></span></span> <code>number_of_bins</code> = <span><span><span>81928192</span><span aria-hidden=\"true\"><span><span></span><span>8</span><span>1</span><span>9</span><span>2</span></span></span></span></span>. (Cuckoo hashing succeeds with probability <span><span><span>1‚àí2‚àí401 - 2^{-40}</span><span aria-hidden=\"true\"><span><span></span><span>1</span><span></span><span>‚àí</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚àí</span><span>4</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>; check <strong>Hashing failures</strong> <a href=\"https://eprint.iacr.org/2017/299.pdf\">here</a>.</li>\n<li><code>server_size</code> = <span><span><span>2202^{20}</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>, so <code>bin_capacity</code> = <span><span><span>536536</span><span aria-hidden=\"true\"><span><span></span><span>5</span><span>3</span><span>6</span></span></span></span></span>. (Simple hashing succeeds with probability <span><span><span>1‚àí2‚àí301-2^{-30}</span><span aria-hidden=\"true\"><span><span></span><span>1</span><span></span><span>‚àí</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚àí</span><span>3</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>; check <strong>Hashing failures</strong> <a href=\"https://eprint.iacr.org/2017/299.pdf\">here</a>) or run the <a href=\"https://github.com/bit-ml/Private-Set-Intersection/blob/main/bin_capacity_estimator.py\">bin capacity estimator script</a>.</li>\n<li><code>output_bits</code> = <span><span><span>log(\\mathsf{log}(</span><span aria-hidden=\"true\"><span><span></span><span><span>l</span><span>o</span><span>g</span></span><span>(</span></span></span></span></span><code>number_of_bins</code><span><span><span>)=13) = 13</span><span aria-hidden=\"true\"><span><span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>1</span><span>3</span></span></span></span></span>.</li>\n<li><code>poly_modulus_degree</code> = <span><span><span>81928192</span><span aria-hidden=\"true\"><span><span></span><span>8</span><span>1</span><span>9</span><span>2</span></span></span></span></span> and <code>plain_modulus</code> = <span><span><span>536903681536903681</span><span aria-hidden=\"true\"><span><span></span><span>5</span><span>3</span><span>6</span><span>9</span><span>0</span><span>3</span><span>6</span><span>8</span><span>1</span></span></span></span></span>.</li>\n<li><code>sigma_max</code> = <span><span><span>4040</span><span aria-hidden=\"true\"><span><span></span><span>4</span><span>0</span></span></span></span></span>.</li>\n<li>For safety, we can think of depth = <span><span><span>33</span><span aria-hidden=\"true\"><span><span></span><span>3</span></span></span></span></span>. If <code>ell</code> = <span><span><span>11</span><span aria-hidden=\"true\"><span><span></span><span>1</span></span></span></span></span>, <code>alpha</code> is lower bounded by <span><span><span>55</span><span aria-hidden=\"true\"><span><span></span><span>5</span></span></span></span></span>, since <code>bin_capacity</code>/<code>alpha</code> <span><span><span>‚â§128.\\leq 128.</span><span aria-hidden=\"true\"><span><span></span><span>‚â§</span><span></span></span><span><span></span><span>1</span><span>2</span><span>8</span><span>.</span></span></span></span></span></li>\n</ul>\n<p>We chose this <span><span><span>2929</span><span aria-hidden=\"true\"><span><span></span><span>2</span><span>9</span></span></span></span></span>-bit <code>plain_modulus</code> to get <code>sigma_max</code> as large as possible. A large <code>sigma_max</code> guarantees that the protocol runs without any false-positives. For example, keeping <code>client_size</code><span><span><span>=5535=5535</span><span aria-hidden=\"true\"><span><span></span><span>=</span><span></span></span><span><span></span><span>5</span><span>5</span><span>3</span><span>5</span></span></span></span></span> and <code>server_size</code><span><span><span>=220=2^{20}</span><span aria-hidden=\"true\"><span><span></span><span>=</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>2</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>, a <span><span><span>5252</span><span aria-hidden=\"true\"><span><span></span><span>5</span><span>2</span></span></span></span></span>-bit <code>plain_modulus</code> guarantees that the protocol can't give false-positives, except with probability less than <span><span><span>2‚àí302^{-30}</span><span aria-hidden=\"true\"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>‚àí</span><span>3</span><span>0</span></span></span></span></span></span></span></span></span></span></span></span></span>. The current TenSEAL implementation does not allow us to choose a <span><span><span>5252</span><span aria-hidden=\"true\"><span><span></span><span>5</span><span>2</span></span></span></span></span>-bit <code>plain_modulus</code> while keeping the <code>poly_modulus_degree</code><span><span><span>=8192=8192</span><span aria-hidden=\"true\"><span><span></span><span>=</span><span></span></span><span><span></span><span>8</span><span>1</span><span>9</span><span>2</span></span></span></span></span>.</p>\n<h3>Let's play! üéâ</h3>\n<p>You can generate the datasets of the client and the server by running <code>set_gen.py</code>. Then run <code>server_offline.py</code> and <code>client_offline.py</code> to preprocess them. Now go to the online phase of the protocol by running <code>server_online.py</code> and <code>client_online.py</code>. Go check it out! üòÑ</p>\n"}}}
